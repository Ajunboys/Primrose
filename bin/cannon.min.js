!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else{var b;"undefined"!=typeof window?b=window:"undefined"!=typeof global?b=global:"undefined"!=typeof self&&(b=self),b.CANNON=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){b.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(a,b){b.exports={version:a("../package.json").version,AABB:a("./collision/AABB"),ArrayCollisionMatrix:a("./collision/ArrayCollisionMatrix"),Body:a("./objects/Body"),Box:a("./shapes/Box"),Broadphase:a("./collision/Broadphase"),Constraint:a("./constraints/Constraint"),ContactEquation:a("./equations/ContactEquation"),Narrowphase:a("./world/Narrowphase"),ConeTwistConstraint:a("./constraints/ConeTwistConstraint"),ContactMaterial:a("./material/ContactMaterial"),ConvexPolyhedron:a("./shapes/ConvexPolyhedron"),Cylinder:a("./shapes/Cylinder"),DistanceConstraint:a("./constraints/DistanceConstraint"),Equation:a("./equations/Equation"),EventTarget:a("./utils/EventTarget"),FrictionEquation:a("./equations/FrictionEquation"),GSSolver:a("./solver/GSSolver"),GridBroadphase:a("./collision/GridBroadphase"),Heightfield:a("./shapes/Heightfield"),HingeConstraint:a("./constraints/HingeConstraint"),LockConstraint:a("./constraints/LockConstraint"),Mat3:a("./math/Mat3"),Material:a("./material/Material"),NaiveBroadphase:a("./collision/NaiveBroadphase"),ObjectCollisionMatrix:a("./collision/ObjectCollisionMatrix"),Pool:a("./utils/Pool"),Particle:a("./shapes/Particle"),Plane:a("./shapes/Plane"),PointToPointConstraint:a("./constraints/PointToPointConstraint"),Quaternion:a("./math/Quaternion"),Ray:a("./collision/Ray"),RaycastVehicle:a("./objects/RaycastVehicle"),RaycastResult:a("./collision/RaycastResult"),RigidVehicle:a("./objects/RigidVehicle"),RotationalEquation:a("./equations/RotationalEquation"),RotationalMotorEquation:a("./equations/RotationalMotorEquation"),SAPBroadphase:a("./collision/SAPBroadphase"),SPHSystem:a("./objects/SPHSystem"),Shape:a("./shapes/Shape"),Solver:a("./solver/Solver"),Sphere:a("./shapes/Sphere"),SplitSolver:a("./solver/SplitSolver"),Spring:a("./objects/Spring"),Trimesh:a("./shapes/Trimesh"),Vec3:a("./math/Vec3"),Vec3Pool:a("./utils/Vec3Pool"),World:a("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(a,b){function c(a){a=a||{},this.lowerBound=new d,a.lowerBound&&this.lowerBound.copy(a.lowerBound),this.upperBound=new d,a.upperBound&&this.upperBound.copy(a.upperBound)}{var d=a("../math/Vec3");a("../utils/Utils")}b.exports=c;var e=new d;c.prototype.setFromPoints=function(a,b,c,d){var f=this.lowerBound,g=this.upperBound,h=c;f.copy(a[0]),h&&h.vmult(f,f),g.copy(f);for(var i=1;i<a.length;i++){var j=a[i];h&&(h.vmult(j,e),j=e),j.x>g.x&&(g.x=j.x),j.x<f.x&&(f.x=j.x),j.y>g.y&&(g.y=j.y),j.y<f.y&&(f.y=j.y),j.z>g.z&&(g.z=j.z),j.z<f.z&&(f.z=j.z)}return b&&(b.vadd(f,f),b.vadd(g,g)),d&&(f.x-=d,f.y-=d,f.z-=d,g.x+=d,g.y+=d,g.z+=d),this},c.prototype.copy=function(a){return this.lowerBound.copy(a.lowerBound),this.upperBound.copy(a.upperBound),this},c.prototype.clone=function(){return(new c).copy(this)},c.prototype.extend=function(a){var b=a.lowerBound.x;this.lowerBound.x>b&&(this.lowerBound.x=b);var c=a.upperBound.x;this.upperBound.x<c&&(this.upperBound.x=c);var b=a.lowerBound.y;this.lowerBound.y>b&&(this.lowerBound.y=b);var c=a.upperBound.y;this.upperBound.y<c&&(this.upperBound.y=c);var b=a.lowerBound.z;this.lowerBound.z>b&&(this.lowerBound.z=b);var c=a.upperBound.z;this.upperBound.z<c&&(this.upperBound.z=c)},c.prototype.overlaps=function(a){var b=this.lowerBound,c=this.upperBound,d=a.lowerBound,e=a.upperBound;return(d.x<=c.x&&c.x<=e.x||b.x<=e.x&&e.x<=c.x)&&(d.y<=c.y&&c.y<=e.y||b.y<=e.y&&e.y<=c.y)&&(d.z<=c.z&&c.z<=e.z||b.z<=e.z&&e.z<=c.z)},c.prototype.contains=function(a){var b=this.lowerBound,c=this.upperBound,d=a.lowerBound,e=a.upperBound;return b.x<=d.x&&c.x>=e.x&&b.y<=d.y&&c.y>=e.y&&b.z<=d.z&&c.z>=e.z},c.prototype.getCorners=function(a,b,c,d,e,f,g,h){var i=this.lowerBound,j=this.upperBound;a.copy(i),b.set(j.x,i.y,i.z),c.set(j.x,j.y,i.z),d.set(i.x,j.y,j.z),e.set(j.x,i.y,i.z),f.set(i.x,j.y,i.z),g.set(i.x,i.y,j.z),h.copy(j)};var f=[new d,new d,new d,new d,new d,new d,new d,new d];c.prototype.toLocalFrame=function(a,b){var c=f,d=c[0],e=c[1],g=c[2],h=c[3],i=c[4],j=c[5],k=c[6],l=c[7];this.getCorners(d,e,g,h,i,j,k,l);for(var m=0;8!==m;m++){var n=c[m];a.pointToLocal(n,n)}return b.setFromPoints(c)},c.prototype.toWorldFrame=function(a,b){var c=f,d=c[0],e=c[1],g=c[2],h=c[3],i=c[4],j=c[5],k=c[6],l=c[7];this.getCorners(d,e,g,h,i,j,k,l);for(var m=0;8!==m;m++){var n=c[m];a.pointToWorld(n,n)}return b.setFromPoints(c)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(a,b){function c(){this.matrix=[]}b.exports=c,c.prototype.get=function(a,b){if(a=a.index,b=b.index,b>a){var c=b;b=a,a=c}return this.matrix[(a*(a+1)>>1)+b-1]},c.prototype.set=function(a,b,c){if(a=a.index,b=b.index,b>a){var d=b;b=a,a=d}this.matrix[(a*(a+1)>>1)+b-1]=c?1:0},c.prototype.reset=function(){for(var a=0,b=this.matrix.length;a!==b;a++)this.matrix[a]=0},c.prototype.setNumObjects=function(a){this.matrix.length=a*(a-1)>>1}},{}],5:[function(a,b){function c(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}{var d=a("../objects/Body"),e=a("../math/Vec3"),f=a("../math/Quaternion");a("../shapes/Shape"),a("../shapes/Plane")}b.exports=c,c.prototype.collisionPairs=function(){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var g=d.STATIC|d.KINEMATIC;c.prototype.needBroadphaseCollision=function(a,b){return 0===(a.collisionFilterGroup&b.collisionFilterMask)||0===(b.collisionFilterGroup&a.collisionFilterMask)?!1:0===(a.type&g)&&a.sleepState!==d.SLEEPING||0===(b.type&g)&&b.sleepState!==d.SLEEPING?!0:!1},c.prototype.intersectionTest=function(a,b,c,d){this.useBoundingBoxes?this.doBoundingBoxBroadphase(a,b,c,d):this.doBoundingSphereBroadphase(a,b,c,d)};{var h=new e;new e,new f,new e}c.prototype.doBoundingSphereBroadphase=function(a,b,c,d){var e=h;b.position.vsub(a.position,e);var f=Math.pow(a.boundingRadius+b.boundingRadius,2),g=e.norm2();f>g&&(c.push(a),d.push(b))},c.prototype.doBoundingBoxBroadphase=function(a,b,c,d){a.aabbNeedsUpdate&&a.computeAABB(),b.aabbNeedsUpdate&&b.computeAABB(),a.aabb.overlaps(b.aabb)&&(c.push(a),d.push(b))};var i={keys:[]},j=[],k=[];c.prototype.makePairsUnique=function(a,b){for(var c=i,d=j,e=k,f=a.length,g=0;g!==f;g++)d[g]=a[g],e[g]=b[g];a.length=0,b.length=0;for(var g=0;g!==f;g++){var h=d[g].id,l=e[g].id,m=l>h?h+","+l:l+","+h;c[m]=g,c.keys.push(m)}for(var g=0;g!==c.keys.length;g++){var m=c.keys.pop(),n=c[m];a.push(d[n]),b.push(e[n]),delete c[m]}},c.prototype.setWorld=function(){};var l=new e;c.boundingSphereCheck=function(a,b){var c=l;return a.position.vsub(b.position,c),Math.pow(a.shape.boundingSphereRadius+b.shape.boundingSphereRadius,2)>c.norm2()},c.prototype.aabbQuery=function(){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(a,b){function c(a,b,c,f,g){d.apply(this),this.nx=c||10,this.ny=f||10,this.nz=g||10,this.aabbMin=a||new e(100,100,100),this.aabbMax=b||new e(-100,-100,-100);var h=this.nx*this.ny*this.nz;if(0>=h)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=h,this.binLengths.length=h;for(var i=0;h>i;i++)this.bins[i]=[],this.binLengths[i]=0}b.exports=c;var d=a("./Broadphase"),e=a("../math/Vec3"),f=a("../shapes/Shape");c.prototype=new d,c.prototype.constructor=c;{var g=new e;new e}c.prototype.collisionPairs=function(a,b,c){function d(a,b,c,d,e,f,g){var h=(a-t)*w|0,i=(b-u)*x|0,j=(c-v)*y|0,q=K((d-t)*w),r=K((e-u)*x),s=K((f-v)*y);0>h?h=0:h>=k&&(h=k-1),0>i?i=0:i>=l&&(i=l-1),0>j?j=0:j>=m&&(j=m-1),0>q?q=0:q>=k&&(q=k-1),0>r?r=0:r>=l&&(r=l-1),0>s?s=0:s>=m&&(s=m-1),h*=n,i*=o,j*=p,q*=n,r*=o,s*=p;for(var z=h;q>=z;z+=n)for(var A=i;r>=A;A+=o)for(var B=j;s>=B;B+=p){var C=z+A+B;G[C][H[C]++]=g}}for(var e=a.numObjects(),h=a.bodies,i=this.aabbMax,j=this.aabbMin,k=this.nx,l=this.ny,m=this.nz,n=l*m,o=m,p=1,q=i.x,r=i.y,s=i.z,t=j.x,u=j.y,v=j.z,w=k/(q-t),x=l/(r-u),y=m/(s-v),z=(q-t)/k,A=(r-u)/l,B=(s-v)/m,C=.5*Math.sqrt(z*z+A*A+B*B),D=f.types,E=D.SPHERE,F=D.PLANE,G=(D.BOX,D.COMPOUND,D.CONVEXPOLYHEDRON,this.bins),H=this.binLengths,I=this.bins.length,J=0;J!==I;J++)H[J]=0;for(var K=Math.ceil,j=Math.min,i=Math.max,J=0;J!==e;J++){var L=h[J],M=L.shape;switch(M.type){case E:var N=L.position.x,O=L.position.y,P=L.position.z,Q=M.radius;d(N-Q,O-Q,P-Q,N+Q,O+Q,P+Q,L);break;case F:M.worldNormalNeedsUpdate&&M.computeWorldNormal(L.quaternion);var R=M.worldNormal,S=t+.5*z-L.position.x,T=u+.5*A-L.position.y,U=v+.5*B-L.position.z,V=g;V.set(S,T,U);for(var W=0,X=0;W!==k;W++,X+=n,V.y=T,V.x+=z)for(var Y=0,Z=0;Y!==l;Y++,Z+=o,V.z=U,V.y+=A)for(var $=0,_=0;$!==m;$++,_+=p,V.z+=B)if(V.dot(R)<C){var ab=X+Z+_;G[ab][H[ab]++]=L}break;default:L.aabbNeedsUpdate&&L.computeAABB(),d(L.aabb.lowerBound.x,L.aabb.lowerBound.y,L.aabb.lowerBound.z,L.aabb.upperBound.x,L.aabb.upperBound.y,L.aabb.upperBound.z,L)}}for(var J=0;J!==I;J++){var bb=H[J];if(bb>1)for(var cb=G[J],W=0;W!==bb;W++)for(var L=cb[W],Y=0;Y!==W;Y++){var db=cb[Y];this.needBroadphaseCollision(L,db)&&this.intersectionTest(L,db,b,c)}}this.makePairsUnique(b,c)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(a,b){function c(){d.apply(this)}b.exports=c;var d=a("./Broadphase"),e=a("./AABB");c.prototype=new d,c.prototype.constructor=c,c.prototype.collisionPairs=function(a,b,c){var d,e,f,g,h=a.bodies,i=h.length;for(d=0;d!==i;d++)for(e=0;e!==d;e++)f=h[d],g=h[e],this.needBroadphaseCollision(f,g)&&this.intersectionTest(f,g,b,c)};new e;c.prototype.aabbQuery=function(a,b,c){c=c||[];for(var d=0;d<a.bodies.length;d++){var e=a.bodies[d];e.aabbNeedsUpdate&&e.computeAABB(),e.aabb.overlaps(b)&&c.push(e)}return c}},{"./AABB":3,"./Broadphase":5}],8:[function(a,b){function c(){this.matrix={}}b.exports=c,c.prototype.get=function(a,b){if(a=a.id,b=b.id,b>a){var c=b;b=a,a=c}return a+"-"+b in this.matrix},c.prototype.set=function(a,b,c){if(a=a.id,b=b.id,b>a){var d=b;b=a,a=d}c?this.matrix[a+"-"+b]=!0:delete this.matrix[a+"-"+b]},c.prototype.reset=function(){this.matrix={}},c.prototype.setNumObjects=function(){}},{}],9:[function(a,b){function c(a,b){this.from=a?a.clone():new f,this.to=b?b.clone():new f,this._direction=new f,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=c.ANY,this.result=new i,this.hasHit=!1,this.callback=function(){}}function d(a,b,c,d){d.vsub(b,I),c.vsub(b,n),a.vsub(b,o);var e,f,g=I.dot(I),h=I.dot(n),i=I.dot(o),j=n.dot(n),k=n.dot(o);return(e=j*i-h*k)>=0&&(f=g*k-h*i)>=0&&g*j-h*h>e+f}function e(a,b,c){c.vsub(a,I);var d=I.dot(b);b.mult(d,J),J.vadd(a,J);var e=c.distanceTo(J);return e}b.exports=c;var f=a("../math/Vec3"),g=a("../math/Quaternion"),h=a("../math/Transform"),i=(a("../shapes/ConvexPolyhedron"),a("../shapes/Box"),a("../collision/RaycastResult")),j=a("../shapes/Shape"),k=a("../collision/AABB");c.prototype.constructor=c,c.CLOSEST=1,c.ANY=2,c.ALL=4;var l=new k,m=[];c.prototype.intersectWorld=function(a,b){return this.mode=b.mode||c.ANY,this.result=b.result||new i,this.skipBackfaces=!!b.skipBackfaces,this.collisionFilterMask="undefined"!=typeof b.collisionFilterMask?b.collisionFilterMask:-1,this.collisionFilterGroup="undefined"!=typeof b.collisionFilterGroup?b.collisionFilterGroup:-1,b.from&&this.from.copy(b.from),b.to&&this.to.copy(b.to),this.callback=b.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(l),m.length=0,a.broadphase.aabbQuery(a,l,m),this.intersectBodies(m),this.hasHit};var n=new f,o=new f;c.pointInTriangle=d;var p=new f,q=new g;c.prototype.intersectBody=function(a,b){b&&(this.result=b,this._updateDirection());var c=this.checkCollisionResponse;if((!c||a.collisionResponse)&&0!==(this.collisionFilterGroup&a.collisionFilterMask)&&0!==(a.collisionFilterGroup&this.collisionFilterMask))for(var d=p,e=q,f=0,g=a.shapes.length;g>f;f++){var h=a.shapes[f];if((!c||h.collisionResponse)&&(a.quaternion.mult(a.shapeOrientations[f],e),a.quaternion.vmult(a.shapeOffsets[f],d),d.vadd(a.position,d),this.intersectShape(h,e,d,a),this.result._shouldStop))break}},c.prototype.intersectBodies=function(a,b){b&&(this.result=b,this._updateDirection());for(var c=0,d=a.length;!this.result._shouldStop&&d>c;c++)this.intersectBody(a[c])},c.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},c.prototype.intersectShape=function(a,b,c,d){var f=this.from,g=e(f,this._direction,c);if(!(g>a.boundingSphereRadius)){var h=this[a.type];h&&h.call(this,a,b,c,d)}};{var r=(new f,new f,new f),s=new f,t=new f,u=new f;new f,new i}c.prototype.intersectBox=function(a,b,c,d){return this.intersectConvex(a.convexPolyhedronRepresentation,b,c,d)},c.prototype[j.types.BOX]=c.prototype.intersectBox,c.prototype.intersectPlane=function(a,b,c,d){var e=this.from,g=this.to,h=this._direction,i=new f(0,0,1);b.vmult(i,i);var j=new f;e.vsub(c,j);var k=j.dot(i);g.vsub(c,j);var l=j.dot(i);if(!(k*l>0||e.distanceTo(g)<k)){var m=i.dot(h);if(!(Math.abs(m)<this.precision)){var n=new f,o=new f,p=new f;e.vsub(c,n);var q=-i.dot(n)/m;h.scale(q,o),e.vadd(o,p),this.reportIntersection(i,p,a,d,-1)}}},c.prototype[j.types.PLANE]=c.prototype.intersectPlane,c.prototype.getAABB=function(a){var b=this.to,c=this.from;a.lowerBound.x=Math.min(b.x,c.x),a.lowerBound.y=Math.min(b.y,c.y),a.lowerBound.z=Math.min(b.z,c.z),a.upperBound.x=Math.max(b.x,c.x),a.upperBound.y=Math.max(b.y,c.y),a.upperBound.z=Math.max(b.z,c.z)};var v={faceList:[0]};c.prototype.intersectHeightfield=function(a,b,d,e){var g=(a.data,a.elementSize,new f),i=new c(this.from,this.to);h.pointToLocalFrame(d,b,i.from,i.from),h.pointToLocalFrame(d,b,i.to,i.to);var j=[],k=null,l=null,m=null,n=null,o=a.getIndexOfPosition(i.from.x,i.from.y,j,!1);if(o&&(k=j[0],l=j[1],m=j[0],n=j[1]),o=a.getIndexOfPosition(i.to.x,i.to.y,j,!1),o&&((null===k||j[0]<k)&&(k=j[0]),(null===m||j[0]>m)&&(m=j[0]),(null===l||j[1]<l)&&(l=j[1]),(null===n||j[1]>n)&&(n=j[1])),null!==k){var p=[];a.getRectMinMax(k,l,m,n,p);for(var q=(p[0],p[1],k);m>=q;q++)for(var r=l;n>=r;r++){if(this.result._shouldStop)return;if(a.getConvexTrianglePillar(q,r,!1),h.pointToWorldFrame(d,b,a.pillarOffset,g),this.intersectConvex(a.pillarConvex,b,g,e,v),this.result._shouldStop)return;a.getConvexTrianglePillar(q,r,!0),h.pointToWorldFrame(d,b,a.pillarOffset,g),this.intersectConvex(a.pillarConvex,b,g,e,v)}}},c.prototype[j.types.HEIGHTFIELD]=c.prototype.intersectHeightfield;var w=new f,x=new f;c.prototype.intersectSphere=function(a,b,c,d){var e=this.from,f=this.to,g=a.radius,h=Math.pow(f.x-e.x,2)+Math.pow(f.y-e.y,2)+Math.pow(f.z-e.z,2),i=2*((f.x-e.x)*(e.x-c.x)+(f.y-e.y)*(e.y-c.y)+(f.z-e.z)*(e.z-c.z)),j=Math.pow(e.x-c.x,2)+Math.pow(e.y-c.y,2)+Math.pow(e.z-c.z,2)-Math.pow(g,2),k=Math.pow(i,2)-4*h*j,l=w,m=x;if(!(0>k))if(0===k)e.lerp(f,k,l),l.vsub(c,m),m.normalize(),this.reportIntersection(m,l,a,d,-1);else{var n=(-i-Math.sqrt(k))/(2*h),o=(-i+Math.sqrt(k))/(2*h);if(n>=0&&1>=n&&(e.lerp(f,n,l),l.vsub(c,m),m.normalize(),this.reportIntersection(m,l,a,d,-1)),this.result._shouldStop)return;o>=0&&1>=o&&(e.lerp(f,o,l),l.vsub(c,m),m.normalize(),this.reportIntersection(m,l,a,d,-1))}},c.prototype[j.types.SPHERE]=c.prototype.intersectSphere;var y=new f,z=(new f,new f,new f);c.prototype.intersectConvex=function(a,b,c,e,f){for(var g=y,h=z,i=f&&f.faceList||null,j=a.faces,k=a.vertices,l=a.faceNormals,m=this._direction,n=this.from,o=this.to,p=n.distanceTo(o),q=i?i.length:j.length,v=this.result,w=0;!v._shouldStop&&q>w;w++){var x=i?i[w]:w,A=j[x],B=l[x],C=b,D=c;h.copy(k[A[0]]),C.vmult(h,h),h.vadd(D,h),h.vsub(n,h),C.vmult(B,g);var E=m.dot(g);if(!(Math.abs(E)<this.precision)){var F=g.dot(h)/E;if(!(0>F)){m.mult(F,r),r.vadd(n,r),s.copy(k[A[0]]),C.vmult(s,s),D.vadd(s,s);for(var G=1;!v._shouldStop&&G<A.length-1;G++){t.copy(k[A[G]]),u.copy(k[A[G+1]]),C.vmult(t,t),C.vmult(u,u),D.vadd(t,t),D.vadd(u,u);var H=r.distanceTo(n);!d(r,s,t,u)&&!d(r,t,s,u)||H>p||this.reportIntersection(g,r,a,e,x)}}}}},c.prototype[j.types.CONVEXPOLYHEDRON]=c.prototype.intersectConvex;var A=new f,B=new f,C=new f,D=new f,E=new f,F=new f,G=(new k,[]),H=new h;c.prototype.intersectTrimesh=function(a,b,c,e,f){var g=A,i=G,j=H,k=z,l=B,m=C,n=D,o=F,p=E,q=(f&&f.faceList||null,a.indices),v=(a.vertices,a.faceNormals,this.from),w=this.to,x=this._direction;j.position.copy(c),j.quaternion.copy(b),h.vectorToLocalFrame(c,b,x,l),h.pointToLocalFrame(c,b,v,m),h.pointToLocalFrame(c,b,w,n);var y=m.distanceSquared(n);a.tree.rayQuery(this,j,i);for(var I=0,J=i.length;!this.result._shouldStop&&I!==J;I++){var K=i[I];a.getNormal(K,g),a.getVertex(q[3*K],s),s.vsub(m,k);var L=l.dot(g),M=g.dot(k)/L;if(!(0>M)){l.scale(M,r),r.vadd(m,r),a.getVertex(q[3*K+1],t),a.getVertex(q[3*K+2],u);var N=r.distanceSquared(m);!d(r,t,s,u)&&!d(r,s,t,u)||N>y||(h.vectorToWorldFrame(b,g,p),h.pointToWorldFrame(c,b,r,o),this.reportIntersection(p,o,a,e,K))}}i.length=0},c.prototype[j.types.TRIMESH]=c.prototype.intersectTrimesh,c.prototype.reportIntersection=function(a,b,d,e,f){var g=this.from,h=this.to,i=g.distanceTo(b),j=this.result;if(!(this.skipBackfaces&&a.dot(this._direction)>0))switch(j.hitFaceIndex="undefined"!=typeof f?f:-1,this.mode){case c.ALL:this.hasHit=!0,j.set(g,h,a,b,d,e,i),j.hasHit=!0,this.callback(j);break;case c.CLOSEST:(i<j.distance||!j.hasHit)&&(this.hasHit=!0,j.hasHit=!0,j.set(g,h,a,b,d,e,i));break;case c.ANY:this.hasHit=!0,j.hasHit=!0,j.set(g,h,a,b,d,e,i),j._shouldStop=!0}};var I=new f,J=new f},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(a,b){function c(){this.rayFromWorld=new d,this.rayToWorld=new d,this.hitNormalWorld=new d,this.hitPointWorld=new d,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}var d=a("../math/Vec3");b.exports=c,c.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},c.prototype.abort=function(){this._shouldStop=!0},c.prototype.set=function(a,b,c,d,e,f,g){this.rayFromWorld.copy(a),this.rayToWorld.copy(b),this.hitNormalWorld.copy(c),this.hitPointWorld.copy(d),this.shape=e,this.body=f,this.distance=g}},{"../math/Vec3":30}],11:[function(a,b){function c(a){d.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var b=this.axisList;this._addBodyHandler=function(a){b.push(a.body)},this._removeBodyHandler=function(a){var c=b.indexOf(a.body);-1!==c&&b.splice(c,1)},a&&this.setWorld(a)}var d=(a("../shapes/Shape"),a("../collision/Broadphase"));b.exports=c,c.prototype=new d,c.prototype.setWorld=function(a){this.axisList.length=0;for(var b=0;b<a.bodies.length;b++)this.axisList.push(a.bodies[b]);a.removeEventListener("addBody",this._addBodyHandler),a.removeEventListener("removeBody",this._removeBodyHandler),a.addEventListener("addBody",this._addBodyHandler),a.addEventListener("removeBody",this._removeBodyHandler),this.world=a,this.dirty=!0},c.insertionSortX=function(a){for(var b=1,c=a.length;c>b;b++){for(var d=a[b],e=b-1;e>=0&&!(a[e].aabb.lowerBound.x<=d.aabb.lowerBound.x);e--)a[e+1]=a[e];a[e+1]=d}return a},c.insertionSortY=function(a){for(var b=1,c=a.length;c>b;b++){for(var d=a[b],e=b-1;e>=0&&!(a[e].aabb.lowerBound.y<=d.aabb.lowerBound.y);e--)a[e+1]=a[e];a[e+1]=d}return a},c.insertionSortZ=function(a){for(var b=1,c=a.length;c>b;b++){for(var d=a[b],e=b-1;e>=0&&!(a[e].aabb.lowerBound.z<=d.aabb.lowerBound.z);e--)a[e+1]=a[e];a[e+1]=d}return a},c.prototype.collisionPairs=function(a,b,d){var e,f,g=this.axisList,h=g.length,i=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),e=0;e!==h;e++){var j=g[e];for(f=e+1;h>f;f++){var k=g[f];if(this.needBroadphaseCollision(j,k)){if(!c.checkBounds(j,k,i))break;this.intersectionTest(j,k,b,d)}}}},c.prototype.sortList=function(){for(var a=this.axisList,b=this.axisIndex,d=a.length,e=0;e!==d;e++){var f=a[e];f.aabbNeedsUpdate&&f.computeAABB()}0===b?c.insertionSortX(a):1===b?c.insertionSortY(a):2===b&&c.insertionSortZ(a)},c.checkBounds=function(a,b,c){var d,e;0===c?(d=a.position.x,e=b.position.x):1===c?(d=a.position.y,e=b.position.y):2===c&&(d=a.position.z,e=b.position.z);var f=a.boundingRadius,g=b.boundingRadius,h=d+f,i=e-g;return h>i},c.prototype.autoDetectAxis=function(){for(var a=0,b=0,c=0,d=0,e=0,f=0,g=this.axisList,h=g.length,i=1/h,j=0;j!==h;j++){var k=g[j],l=k.position.x;a+=l,b+=l*l;var m=k.position.y;c+=m,d+=m*m;var n=k.position.z;e+=n,f+=n*n}var o=b-a*a*i,p=d-c*c*i,q=f-e*e*i;this.axisIndex=o>p?o>q?0:2:p>q?1:2},c.prototype.aabbQuery=function(a,b,c){c=c||[],this.dirty&&(this.sortList(),this.dirty=!1);var d=this.axisIndex,e="x";1===d&&(e="y"),2===d&&(e="z");for(var f=this.axisList,g=(b.lowerBound[e],b.upperBound[e],0);g<f.length;g++){var h=f[g];h.aabbNeedsUpdate&&h.computeAABB(),h.aabb.overlaps(b)&&c.push(h)}return c}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(a,b){function c(a,b,c){c=c||{};var h="undefined"!=typeof c.maxForce?c.maxForce:1e6,i=c.pivotA?c.pivotA.clone():new g,j=c.pivotB?c.pivotB.clone():new g;this.axisA=c.axisA?c.axisA.clone():new g,this.axisB=c.axisB?c.axisB.clone():new g,d.call(this,a,i,b,j,h),this.collideConnected=!!c.collideConnected,this.angle="undefined"!=typeof c.angle?c.angle:0;var k=this.coneEquation=new e(a,b,c),l=this.twistEquation=new f(a,b,c);this.twistAngle="undefined"!=typeof c.twistAngle?c.twistAngle:0,k.maxForce=0,k.minForce=-h,l.maxForce=0,l.minForce=-h,this.equations.push(k,l)}b.exports=c;var d=(a("./Constraint"),a("./PointToPointConstraint")),e=a("../equations/ConeEquation"),f=a("../equations/RotationalEquation"),g=(a("../equations/ContactEquation"),a("../math/Vec3"));c.prototype=new d,c.constructor=c;new g,new g;c.prototype.update=function(){var a=this.bodyA,b=this.bodyB,c=this.coneEquation,e=this.twistEquation;d.prototype.update.call(this),a.vectorToWorldFrame(this.axisA,c.axisA),b.vectorToWorldFrame(this.axisB,c.axisB),this.axisA.tangents(e.axisA,e.axisA),a.vectorToWorldFrame(e.axisA,e.axisA),this.axisB.tangents(e.axisB,e.axisB),b.vectorToWorldFrame(e.axisB,e.axisB),c.angle=this.angle,e.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(a,b){function c(a,b,e){e=d.defaults(e,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=a,this.bodyB=b,this.id=c.idCounter++,this.collideConnected=e.collideConnected,e.wakeUpBodies&&(a&&a.wakeUp(),b&&b.wakeUp())}b.exports=c;var d=a("../utils/Utils");c.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},c.prototype.enable=function(){for(var a=this.equations,b=0;b<a.length;b++)a[b].enabled=!0},c.prototype.disable=function(){for(var a=this.equations,b=0;b<a.length;b++)a[b].enabled=!1},c.idCounter=0},{"../utils/Utils":53}],14:[function(a,b){function c(a,b,c,f){d.call(this,a,b),"undefined"==typeof c&&(c=a.position.distanceTo(b.position)),"undefined"==typeof f&&(f=1e6),this.distance=c;var g=this.distanceEquation=new e(a,b);this.equations.push(g),g.minForce=-f,g.maxForce=f}b.exports=c;var d=a("./Constraint"),e=a("../equations/ContactEquation");c.prototype=new d,c.prototype.update=function(){var a=this.bodyA,b=this.bodyB,c=this.distanceEquation,d=.5*this.distance,e=c.ni;b.position.vsub(a.position,e),e.normalize(),e.mult(d,c.ri),e.mult(-d,c.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(a,b){function c(a,b,c){c=c||{};var h="undefined"!=typeof c.maxForce?c.maxForce:1e6,i=c.pivotA?c.pivotA.clone():new g,j=c.pivotB?c.pivotB.clone():new g;d.call(this,a,i,b,j,h);var k=this.axisA=c.axisA?c.axisA.clone():new g(1,0,0);k.normalize();var l=this.axisB=c.axisB?c.axisB.clone():new g(1,0,0);l.normalize();var m=this.rotationalEquation1=new e(a,b,c),n=this.rotationalEquation2=new e(a,b,c),o=this.motorEquation=new f(a,b,h);o.enabled=!1,this.equations.push(m,n,o)}b.exports=c;var d=(a("./Constraint"),a("./PointToPointConstraint")),e=a("../equations/RotationalEquation"),f=a("../equations/RotationalMotorEquation"),g=(a("../equations/ContactEquation"),a("../math/Vec3"));c.prototype=new d,c.constructor=c,c.prototype.enableMotor=function(){this.motorEquation.enabled=!0},c.prototype.disableMotor=function(){this.motorEquation.enabled=!1},c.prototype.setMotorSpeed=function(a){this.motorEquation.targetVelocity=a},c.prototype.setMotorMaxForce=function(a){this.motorEquation.maxForce=a,this.motorEquation.minForce=-a};var h=new g,i=new g;c.prototype.update=function(){var a=this.bodyA,b=this.bodyB,c=this.motorEquation,e=this.rotationalEquation1,f=this.rotationalEquation2,g=h,j=i,k=this.axisA,l=this.axisB;d.prototype.update.call(this),a.quaternion.vmult(k,g),b.quaternion.vmult(l,j),g.tangents(e.axisA,f.axisA),e.axisB.copy(j),f.axisB.copy(j),this.motorEquation.enabled&&(a.quaternion.vmult(this.axisA,c.axisA),b.quaternion.vmult(this.axisB,c.axisB))}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(a,b){function c(a,b,c){c=c||{};var g="undefined"!=typeof c.maxForce?c.maxForce:1e6,h=new f,i=new f,j=new f;a.position.vadd(b.position,j),j.scale(.5,j),b.pointToLocalFrame(j,i),a.pointToLocalFrame(j,h),d.call(this,a,h,b,i,g);var k=this.rotationalEquation1=new e(a,b,c),l=this.rotationalEquation2=new e(a,b,c),m=this.rotationalEquation3=new e(a,b,c);this.equations.push(k,l,m)}b.exports=c;var d=(a("./Constraint"),a("./PointToPointConstraint")),e=a("../equations/RotationalEquation"),f=(a("../equations/RotationalMotorEquation"),a("../equations/ContactEquation"),a("../math/Vec3"));c.prototype=new d,c.constructor=c;new f,new f;c.prototype.update=function(){var a=this.bodyA,b=this.bodyB,c=(this.motorEquation,this.rotationalEquation1),e=this.rotationalEquation2,g=this.rotationalEquation3;d.prototype.update.call(this),a.vectorToWorldFrame(f.UNIT_X,c.axisA),b.vectorToWorldFrame(f.UNIT_Y,c.axisB),a.vectorToWorldFrame(f.UNIT_Y,e.axisA),b.vectorToWorldFrame(f.UNIT_Z,e.axisB),a.vectorToWorldFrame(f.UNIT_Z,g.axisA),b.vectorToWorldFrame(f.UNIT_X,g.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(a,b){function c(a,b,c,g,h){d.call(this,a,c),h="undefined"!=typeof h?h:1e6,this.pivotA=b?b.clone():new f,this.pivotB=g?g.clone():new f;var i=this.equationX=new e(a,c),j=this.equationY=new e(a,c),k=this.equationZ=new e(a,c);this.equations.push(i,j,k),i.minForce=j.minForce=k.minForce=-h,i.maxForce=j.maxForce=k.maxForce=h,i.ni.set(1,0,0),j.ni.set(0,1,0),k.ni.set(0,0,1)}b.exports=c;var d=a("./Constraint"),e=a("../equations/ContactEquation"),f=a("../math/Vec3");c.prototype=new d,c.prototype.update=function(){var a=this.bodyA,b=this.bodyB,c=this.equationX,d=this.equationY,e=this.equationZ;a.quaternion.vmult(this.pivotA,c.ri),b.quaternion.vmult(this.pivotB,c.rj),d.ri.copy(c.ri),d.rj.copy(c.rj),e.ri.copy(c.ri),e.rj.copy(c.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(a,b){function c(a,b,c){c=c||{};var f="undefined"!=typeof c.maxForce?c.maxForce:1e6;e.call(this,a,b,-f,f),this.axisA=c.axisA?c.axisA.clone():new d(1,0,0),this.axisB=c.axisB?c.axisB.clone():new d(0,1,0),this.angle="undefined"!=typeof c.angle?c.angle:0}b.exports=c;var d=a("../math/Vec3"),e=(a("../math/Mat3"),a("./Equation"));c.prototype=new e,c.prototype.constructor=c;var f=new d,g=new d;c.prototype.computeB=function(a){var b=this.a,c=this.b,d=this.axisA,e=this.axisB,h=f,i=g,j=this.jacobianElementA,k=this.jacobianElementB;d.cross(e,h),e.cross(d,i),j.rotational.copy(i),k.rotational.copy(h);var l=Math.cos(this.angle)-d.dot(e),m=this.computeGW(),n=this.computeGiMf(),o=-l*b-m*c-a*n;return o}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(a,b){function c(a,b,c){c="undefined"!=typeof c?c:1e6,d.call(this,a,b,0,c),this.restitution=0,this.ri=new e,this.rj=new e,this.ni=new e}b.exports=c;{var d=a("./Equation"),e=a("../math/Vec3");a("../math/Mat3")}c.prototype=new d,c.prototype.constructor=c;var f=new e,g=new e,h=new e;c.prototype.computeB=function(a){var b=this.a,c=this.b,d=this.bi,e=this.bj,i=this.ri,j=this.rj,k=f,l=g,m=d.velocity,n=d.angularVelocity,o=(d.force,d.torque,e.velocity),p=e.angularVelocity,q=(e.force,e.torque,h),r=this.jacobianElementA,s=this.jacobianElementB,t=this.ni;i.cross(t,k),j.cross(t,l),t.negate(r.spatial),k.negate(r.rotational),s.spatial.copy(t),s.rotational.copy(l),q.copy(e.position),q.vadd(j,q),q.vsub(d.position,q),q.vsub(i,q);var u=t.dot(q),v=this.restitution+1,w=v*o.dot(t)-v*m.dot(t)+p.dot(l)-n.dot(k),x=this.computeGiMf(),y=-u*b-w*c-a*x;return y};var i=new e,j=new e,k=new e,l=new e,m=new e;c.prototype.getImpactVelocityAlongNormal=function(){var a=i,b=j,c=k,d=l,e=m;return this.bi.position.vadd(this.ri,c),this.bj.position.vadd(this.rj,d),this.bi.getVelocityAtWorldPoint(c,a),this.bj.getVelocityAtWorldPoint(d,b),a.vsub(b,e),this.ni.dot(e)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(a,b){function c(a,b,e,f){this.id=c.id++,this.minForce="undefined"==typeof e?-1e6:e,this.maxForce="undefined"==typeof f?1e6:f,this.bi=a,this.bj=b,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new d,this.jacobianElementB=new d,this.enabled=!0,this.setSpookParams(1e7,4,1/60)
}b.exports=c;var d=a("../math/JacobianElement"),e=a("../math/Vec3");c.prototype.constructor=c,c.id=0,c.prototype.setSpookParams=function(a,b,c){var d=b,e=a,f=c;this.a=4/(f*(1+4*d)),this.b=4*d/(1+4*d),this.eps=4/(f*f*e*(1+4*d))},c.prototype.computeB=function(a,b,c){var d=this.computeGW(),e=this.computeGq(),f=this.computeGiMf();return-e*a-d*b-f*c},c.prototype.computeGq=function(){var a=this.jacobianElementA,b=this.jacobianElementB,c=this.bi,d=this.bj,e=c.position,f=d.position;return a.spatial.dot(e)+b.spatial.dot(f)};var f=new e;c.prototype.computeGW=function(){var a=this.jacobianElementA,b=this.jacobianElementB,c=this.bi,d=this.bj,e=c.velocity,g=d.velocity,h=c.angularVelocity||f,i=d.angularVelocity||f;return a.multiplyVectors(e,h)+b.multiplyVectors(g,i)},c.prototype.computeGWlambda=function(){var a=this.jacobianElementA,b=this.jacobianElementB,c=this.bi,d=this.bj,e=c.vlambda,g=d.vlambda,h=c.wlambda||f,i=d.wlambda||f;return a.multiplyVectors(e,h)+b.multiplyVectors(g,i)};var g=new e,h=new e,i=new e,j=new e;c.prototype.computeGiMf=function(){var a=this.jacobianElementA,b=this.jacobianElementB,c=this.bi,d=this.bj,e=c.force,f=c.torque,k=d.force,l=d.torque,m=c.invMassSolve,n=d.invMassSolve;return c.invInertiaWorldSolve?c.invInertiaWorldSolve.vmult(f,i):i.set(0,0,0),d.invInertiaWorldSolve?d.invInertiaWorldSolve.vmult(l,j):j.set(0,0,0),e.mult(m,g),k.mult(n,h),a.multiplyVectors(g,i)+b.multiplyVectors(h,j)};var k=new e;c.prototype.computeGiMGt=function(){var a=this.jacobianElementA,b=this.jacobianElementB,c=this.bi,d=this.bj,e=c.invMassSolve,f=d.invMassSolve,g=c.invInertiaWorldSolve,h=d.invInertiaWorldSolve,i=e+f;return g&&(g.vmult(a.rotational,k),i+=k.dot(a.rotational)),h&&(h.vmult(b.rotational,k),i+=k.dot(b.rotational)),i};{var l=new e;new e,new e,new e,new e,new e}c.prototype.addToWlambda=function(a){var b=this.jacobianElementA,c=this.jacobianElementB,d=this.bi,e=this.bj,f=l;b.spatial.mult(d.invMassSolve*a,f),d.vlambda.vadd(f,d.vlambda),c.spatial.mult(e.invMassSolve*a,f),e.vlambda.vadd(f,e.vlambda),d.invInertiaWorldSolve&&(d.invInertiaWorldSolve.vmult(b.rotational,f),f.mult(a,f),d.wlambda.vadd(f,d.wlambda)),e.invInertiaWorldSolve&&(e.invInertiaWorldSolve.vmult(c.rotational,f),f.mult(a,f),e.wlambda.vadd(f,e.wlambda))},c.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(a,b){function c(a,b,c){d.call(this,a,b,-c,c),this.ri=new e,this.rj=new e,this.t=new e}b.exports=c;{var d=a("./Equation"),e=a("../math/Vec3");a("../math/Mat3")}c.prototype=new d,c.prototype.constructor=c;var f=new e,g=new e;c.prototype.computeB=function(a){var b=(this.a,this.b),c=(this.bi,this.bj,this.ri),d=this.rj,e=f,h=g,i=this.t;c.cross(i,e),d.cross(i,h);var j=this.jacobianElementA,k=this.jacobianElementB;i.negate(j.spatial),e.negate(j.rotational),k.spatial.copy(i),k.rotational.copy(h);var l=this.computeGW(),m=this.computeGiMf(),n=-l*b-a*m;return n}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(a,b){function c(a,b,c){c=c||{};var f="undefined"!=typeof c.maxForce?c.maxForce:1e6;e.call(this,a,b,-f,f),this.axisA=c.axisA?c.axisA.clone():new d(1,0,0),this.axisB=c.axisB?c.axisB.clone():new d(0,1,0),this.maxAngle=Math.PI/2}b.exports=c;var d=a("../math/Vec3"),e=(a("../math/Mat3"),a("./Equation"));c.prototype=new e,c.prototype.constructor=c;var f=new d,g=new d;c.prototype.computeB=function(a){var b=this.a,c=this.b,d=this.axisA,e=this.axisB,h=f,i=g,j=this.jacobianElementA,k=this.jacobianElementB;d.cross(e,h),e.cross(d,i),j.rotational.copy(i),k.rotational.copy(h);var l=Math.cos(this.maxAngle)-d.dot(e),m=this.computeGW(),n=this.computeGiMf(),o=-l*b-m*c-a*n;return o}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(a,b){function c(a,b,c){c="undefined"!=typeof c?c:1e6,e.call(this,a,b,-c,c),this.axisA=new d,this.axisB=new d,this.targetVelocity=0}b.exports=c;var d=a("../math/Vec3"),e=(a("../math/Mat3"),a("./Equation"));c.prototype=new e,c.prototype.constructor=c,c.prototype.computeB=function(a){var b=(this.a,this.b),c=(this.bi,this.bj,this.axisA),d=this.axisB,e=this.jacobianElementA,f=this.jacobianElementB;e.rotational.copy(c),d.negate(f.rotational);var g=this.computeGW()-this.targetVelocity,h=this.computeGiMf(),i=-g*b-a*h;return i}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(a,b){function c(a,b,e){e=d.defaults(e,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=c.idCounter++,this.materials=[a,b],this.friction=e.friction,this.restitution=e.restitution,this.contactEquationStiffness=e.contactEquationStiffness,this.contactEquationRelaxation=e.contactEquationRelaxation,this.frictionEquationStiffness=e.frictionEquationStiffness,this.frictionEquationRelaxation=e.frictionEquationRelaxation}var d=a("../utils/Utils");b.exports=c,c.idCounter=0},{"../utils/Utils":53}],25:[function(a,b){function c(a){var b="";a=a||{},"string"==typeof a?(b=a,a={}):"object"==typeof a&&(b=""),this.name=b,this.id=c.idCounter++,this.friction="undefined"!=typeof a.friction?a.friction:-1,this.restitution="undefined"!=typeof a.restitution?a.restitution:-1}b.exports=c,c.idCounter=0},{}],26:[function(a,b){function c(){this.spatial=new d,this.rotational=new d}b.exports=c;var d=a("./Vec3");c.prototype.multiplyElement=function(a){return a.spatial.dot(this.spatial)+a.rotational.dot(this.rotational)},c.prototype.multiplyVectors=function(a,b){return a.dot(this.spatial)+b.dot(this.rotational)}},{"./Vec3":30}],27:[function(a,b){function c(a){this.elements=a?a:[0,0,0,0,0,0,0,0,0]}b.exports=c;var d=a("./Vec3");c.prototype.identity=function(){var a=this.elements;a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1},c.prototype.setZero=function(){var a=this.elements;a[0]=0,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=0,a[6]=0,a[7]=0,a[8]=0},c.prototype.setTrace=function(a){var b=this.elements;b[0]=a.x,b[4]=a.y,b[8]=a.z},c.prototype.getTrace=function(a){var a=a||new d,b=this.elements;a.x=b[0],a.y=b[4],a.z=b[8]},c.prototype.vmult=function(a,b){b=b||new d;var c=this.elements,e=a.x,f=a.y,g=a.z;return b.x=c[0]*e+c[1]*f+c[2]*g,b.y=c[3]*e+c[4]*f+c[5]*g,b.z=c[6]*e+c[7]*f+c[8]*g,b},c.prototype.smult=function(a){for(var b=0;b<this.elements.length;b++)this.elements[b]*=a},c.prototype.mmult=function(a,b){for(var d=b||new c,e=0;3>e;e++)for(var f=0;3>f;f++){for(var g=0,h=0;3>h;h++)g+=a.elements[e+3*h]*this.elements[h+3*f];d.elements[e+3*f]=g}return d},c.prototype.scale=function(a,b){b=b||new c;for(var d=this.elements,e=b.elements,f=0;3!==f;f++)e[3*f+0]=a.x*d[3*f+0],e[3*f+1]=a.y*d[3*f+1],e[3*f+2]=a.z*d[3*f+2];return b},c.prototype.solve=function(a,b){b=b||new d;for(var c=3,e=4,f=[],g=0;c*e>g;g++)f.push(0);var g,h;for(g=0;3>g;g++)for(h=0;3>h;h++)f[g+e*h]=this.elements[g+3*h];f[3]=a.x,f[7]=a.y,f[11]=a.z;var i,j,k=3,l=k,m=4;do{if(g=l-k,0===f[g+e*g])for(h=g+1;l>h;h++)if(0!==f[g+e*h]){i=m;do j=m-i,f[j+e*g]+=f[j+e*h];while(--i);break}if(0!==f[g+e*g])for(h=g+1;l>h;h++){var n=f[g+e*h]/f[g+e*g];i=m;do j=m-i,f[j+e*h]=g>=j?0:f[j+e*h]-f[j+e*g]*n;while(--i)}}while(--k);if(b.z=f[2*e+3]/f[2*e+2],b.y=(f[1*e+3]-f[1*e+2]*b.z)/f[1*e+1],b.x=(f[0*e+3]-f[0*e+2]*b.z-f[0*e+1]*b.y)/f[0*e+0],isNaN(b.x)||isNaN(b.y)||isNaN(b.z)||1/0===b.x||1/0===b.y||1/0===b.z)throw"Could not solve equation! Got x=["+b.toString()+"], b=["+a.toString()+"], A=["+this.toString()+"]";return b},c.prototype.e=function(a,b,c){return void 0===c?this.elements[b+3*a]:void(this.elements[b+3*a]=c)},c.prototype.copy=function(a){for(var b=0;b<a.elements.length;b++)this.elements[b]=a.elements[b];return this},c.prototype.toString=function(){for(var a="",b=",",c=0;9>c;c++)a+=this.elements[c]+b;return a},c.prototype.reverse=function(a){a=a||new c;for(var b=3,d=6,e=[],f=0;b*d>f;f++)e.push(0);var f,g;for(f=0;3>f;f++)for(g=0;3>g;g++)e[f+d*g]=this.elements[f+3*g];e[3]=1,e[9]=0,e[15]=0,e[4]=0,e[10]=1,e[16]=0,e[5]=0,e[11]=0,e[17]=1;var h,i,j=3,k=j,l=d;do{if(f=k-j,0===e[f+d*f])for(g=f+1;k>g;g++)if(0!==e[f+d*g]){h=l;do i=l-h,e[i+d*f]+=e[i+d*g];while(--h);break}if(0!==e[f+d*f])for(g=f+1;k>g;g++){var m=e[f+d*g]/e[f+d*f];h=l;do i=l-h,e[i+d*g]=f>=i?0:e[i+d*g]-e[i+d*f]*m;while(--h)}}while(--j);f=2;do{g=f-1;do{var m=e[f+d*g]/e[f+d*f];h=d;do i=d-h,e[i+d*g]=e[i+d*g]-e[i+d*f]*m;while(--h)}while(g--)}while(--f);f=2;do{var m=1/e[f+d*f];h=d;do i=d-h,e[i+d*f]=e[i+d*f]*m;while(--h)}while(f--);f=2;do{g=2;do{if(i=e[b+g+d*f],isNaN(i)||1/0===i)throw"Could not reverse! A=["+this.toString()+"]";a.e(f,g,i)}while(g--)}while(f--);return a},c.prototype.setRotationFromQuaternion=function(a){var b=a.x,c=a.y,d=a.z,e=a.w,f=b+b,g=c+c,h=d+d,i=b*f,j=b*g,k=b*h,l=c*g,m=c*h,n=d*h,o=e*f,p=e*g,q=e*h,r=this.elements;return r[0]=1-(l+n),r[1]=j-q,r[2]=k+p,r[3]=j+q,r[4]=1-(i+n),r[5]=m-o,r[6]=k-p,r[7]=m+o,r[8]=1-(i+l),this},c.prototype.transpose=function(a){a=a||new c;for(var b=a.elements,d=this.elements,e=0;3!==e;e++)for(var f=0;3!==f;f++)b[3*e+f]=d[3*f+e];return a}},{"./Vec3":30}],28:[function(a,b){function c(a,b,c,d){this.x=void 0!==a?a:0,this.y=void 0!==b?b:0,this.z=void 0!==c?c:0,this.w=void 0!==d?d:1}b.exports=c;var d=a("./Vec3");c.prototype.set=function(a,b,c,d){this.x=a,this.y=b,this.z=c,this.w=d},c.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},c.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},c.prototype.setFromAxisAngle=function(a,b){var c=Math.sin(.5*b);this.x=a.x*c,this.y=a.y*c,this.z=a.z*c,this.w=Math.cos(.5*b)},c.prototype.toAxisAngle=function(a){a=a||new d,this.normalize();var b=2*Math.acos(this.w),c=Math.sqrt(1-this.w*this.w);return.001>c?(a.x=this.x,a.y=this.y,a.z=this.z):(a.x=this.x/c,a.y=this.y/c,a.z=this.z/c),[a,b]};var e=new d,f=new d;c.prototype.setFromVectors=function(a,b){if(a.isAntiparallelTo(b)){var c=e,d=f;a.tangents(c,d),this.setFromAxisAngle(c,Math.PI)}else{var g=a.cross(b);this.x=g.x,this.y=g.y,this.z=g.z,this.w=Math.sqrt(Math.pow(a.norm(),2)*Math.pow(b.norm(),2))+a.dot(b),this.normalize()}};var g=new d,h=new d,i=new d;c.prototype.mult=function(a,b){b=b||new c;var d=this.w,e=g,f=h,j=i;return e.set(this.x,this.y,this.z),f.set(a.x,a.y,a.z),b.w=d*a.w-e.dot(f),e.cross(f,j),b.x=d*f.x+a.w*e.x+j.x,b.y=d*f.y+a.w*e.y+j.y,b.z=d*f.z+a.w*e.z+j.z,b},c.prototype.inverse=function(a){var b=this.x,d=this.y,e=this.z,f=this.w;a=a||new c,this.conjugate(a);var g=1/(b*b+d*d+e*e+f*f);return a.x*=g,a.y*=g,a.z*=g,a.w*=g,a},c.prototype.conjugate=function(a){return a=a||new c,a.x=-this.x,a.y=-this.y,a.z=-this.z,a.w=this.w,a},c.prototype.normalize=function(){var a=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);0===a?(this.x=0,this.y=0,this.z=0,this.w=0):(a=1/a,this.x*=a,this.y*=a,this.z*=a,this.w*=a)},c.prototype.normalizeFast=function(){var a=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;0===a?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=a,this.y*=a,this.z*=a,this.w*=a)},c.prototype.vmult=function(a,b){b=b||new d;var c=a.x,e=a.y,f=a.z,g=this.x,h=this.y,i=this.z,j=this.w,k=j*c+h*f-i*e,l=j*e+i*c-g*f,m=j*f+g*e-h*c,n=-g*c-h*e-i*f;return b.x=k*j+n*-g+l*-i-m*-h,b.y=l*j+n*-h+m*-g-k*-i,b.z=m*j+n*-i+k*-h-l*-g,b},c.prototype.copy=function(a){return this.x=a.x,this.y=a.y,this.z=a.z,this.w=a.w,this},c.prototype.toEuler=function(a,b){b=b||"YZX";var c,d,e,f=this.x,g=this.y,h=this.z,i=this.w;switch(b){case"YZX":var j=f*g+h*i;if(j>.499&&(c=2*Math.atan2(f,i),d=Math.PI/2,e=0),-.499>j&&(c=-2*Math.atan2(f,i),d=-Math.PI/2,e=0),isNaN(c)){var k=f*f,l=g*g,m=h*h;c=Math.atan2(2*g*i-2*f*h,1-2*l-2*m),d=Math.asin(2*j),e=Math.atan2(2*f*i-2*g*h,1-2*k-2*m)}break;default:throw new Error("Euler order "+b+" not supported yet.")}a.y=c,a.z=d,a.x=e},c.prototype.setFromEuler=function(a,b,c,d){d=d||"XYZ";var e=Math.cos(a/2),f=Math.cos(b/2),g=Math.cos(c/2),h=Math.sin(a/2),i=Math.sin(b/2),j=Math.sin(c/2);return"XYZ"===d?(this.x=h*f*g+e*i*j,this.y=e*i*g-h*f*j,this.z=e*f*j+h*i*g,this.w=e*f*g-h*i*j):"YXZ"===d?(this.x=h*f*g+e*i*j,this.y=e*i*g-h*f*j,this.z=e*f*j-h*i*g,this.w=e*f*g+h*i*j):"ZXY"===d?(this.x=h*f*g-e*i*j,this.y=e*i*g+h*f*j,this.z=e*f*j+h*i*g,this.w=e*f*g-h*i*j):"ZYX"===d?(this.x=h*f*g-e*i*j,this.y=e*i*g+h*f*j,this.z=e*f*j-h*i*g,this.w=e*f*g+h*i*j):"YZX"===d?(this.x=h*f*g+e*i*j,this.y=e*i*g+h*f*j,this.z=e*f*j-h*i*g,this.w=e*f*g-h*i*j):"XZY"===d&&(this.x=h*f*g-e*i*j,this.y=e*i*g-h*f*j,this.z=e*f*j+h*i*g,this.w=e*f*g+h*i*j),this},c.prototype.clone=function(){return new c(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(a,b){function c(a){a=a||{},this.position=new d,a.position&&this.position.copy(a.position),this.quaternion=new e,a.quaternion&&this.quaternion.copy(a.quaternion)}var d=a("./Vec3"),e=a("./Quaternion");b.exports=c;var f=new e;c.pointToLocalFrame=function(a,b,c,e){var e=e||new d;return c.vsub(a,e),b.conjugate(f),f.vmult(e,e),e},c.prototype.pointToLocal=function(a,b){return c.pointToLocalFrame(this.position,this.quaternion,a,b)},c.pointToWorldFrame=function(a,b,c,e){var e=e||new d;return b.vmult(c,e),e.vadd(a,e),e},c.prototype.pointToWorld=function(a,b){return c.pointToWorldFrame(this.position,this.quaternion,a,b)},c.prototype.vectorToWorldFrame=function(a,b){var b=b||new d;return this.quaternion.vmult(a,b),b},c.vectorToWorldFrame=function(a,b,c){return a.vmult(b,c),c},c.vectorToLocalFrame=function(a,b,c,e){var e=e||new d;return b.w*=-1,b.vmult(c,e),b.w*=-1,e}},{"./Quaternion":28,"./Vec3":30}],30:[function(a,b){function c(a,b,c){this.x=a||0,this.y=b||0,this.z=c||0}b.exports=c;var d=a("./Mat3");c.ZERO=new c(0,0,0),c.UNIT_X=new c(1,0,0),c.UNIT_Y=new c(0,1,0),c.UNIT_Z=new c(0,0,1),c.prototype.cross=function(a,b){var d=a.x,e=a.y,f=a.z,g=this.x,h=this.y,i=this.z;return b=b||new c,b.x=h*f-i*e,b.y=i*d-g*f,b.z=g*e-h*d,b},c.prototype.set=function(a,b,c){return this.x=a,this.y=b,this.z=c,this},c.prototype.setZero=function(){this.x=this.y=this.z=0},c.prototype.vadd=function(a,b){return b?(b.x=a.x+this.x,b.y=a.y+this.y,b.z=a.z+this.z,void 0):new c(this.x+a.x,this.y+a.y,this.z+a.z)},c.prototype.vsub=function(a,b){return b?(b.x=this.x-a.x,b.y=this.y-a.y,b.z=this.z-a.z,void 0):new c(this.x-a.x,this.y-a.y,this.z-a.z)},c.prototype.crossmat=function(){return new d([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},c.prototype.normalize=function(){var a=this.x,b=this.y,c=this.z,d=Math.sqrt(a*a+b*b+c*c);if(d>0){var e=1/d;this.x*=e,this.y*=e,this.z*=e}else this.x=0,this.y=0,this.z=0;return d},c.prototype.unit=function(a){a=a||new c;var b=this.x,d=this.y,e=this.z,f=Math.sqrt(b*b+d*d+e*e);return f>0?(f=1/f,a.x=b*f,a.y=d*f,a.z=e*f):(a.x=1,a.y=0,a.z=0),a},c.prototype.norm=function(){var a=this.x,b=this.y,c=this.z;return Math.sqrt(a*a+b*b+c*c)},c.prototype.length=c.prototype.norm,c.prototype.norm2=function(){return this.dot(this)},c.prototype.lengthSquared=c.prototype.norm2,c.prototype.distanceTo=function(a){var b=this.x,c=this.y,d=this.z,e=a.x,f=a.y,g=a.z;return Math.sqrt((e-b)*(e-b)+(f-c)*(f-c)+(g-d)*(g-d))},c.prototype.distanceSquared=function(a){var b=this.x,c=this.y,d=this.z,e=a.x,f=a.y,g=a.z;return(e-b)*(e-b)+(f-c)*(f-c)+(g-d)*(g-d)},c.prototype.mult=function(a,b){b=b||new c;var d=this.x,e=this.y,f=this.z;return b.x=a*d,b.y=a*e,b.z=a*f,b},c.prototype.scale=c.prototype.mult,c.prototype.dot=function(a){return this.x*a.x+this.y*a.y+this.z*a.z},c.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},c.prototype.negate=function(a){return a=a||new c,a.x=-this.x,a.y=-this.y,a.z=-this.z,a};var e=new c,f=new c;c.prototype.tangents=function(a,b){var c=this.norm();if(c>0){var d=e,g=1/c;d.set(this.x*g,this.y*g,this.z*g);var h=f;Math.abs(d.x)<.9?(h.set(1,0,0),d.cross(h,a)):(h.set(0,1,0),d.cross(h,a)),d.cross(a,b)}else a.set(1,0,0),b.set(0,1,0)},c.prototype.toString=function(){return this.x+","+this.y+","+this.z},c.prototype.toArray=function(){return[this.x,this.y,this.z]},c.prototype.copy=function(a){return this.x=a.x,this.y=a.y,this.z=a.z,this},c.prototype.lerp=function(a,b,c){var d=this.x,e=this.y,f=this.z;c.x=d+(a.x-d)*b,c.y=e+(a.y-e)*b,c.z=f+(a.z-f)*b},c.prototype.almostEquals=function(a,b){return void 0===b&&(b=1e-6),Math.abs(this.x-a.x)>b||Math.abs(this.y-a.y)>b||Math.abs(this.z-a.z)>b?!1:!0},c.prototype.almostZero=function(a){return void 0===a&&(a=1e-6),Math.abs(this.x)>a||Math.abs(this.y)>a||Math.abs(this.z)>a?!1:!0};var g=new c;c.prototype.isAntiparallelTo=function(a,b){return this.negate(g),g.almostEquals(a,b)},c.prototype.clone=function(){return new c(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(a,b){function c(a){a=a||{},d.apply(this),this.id=c.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new e,this.collisionFilterGroup="number"==typeof a.collisionFilterGroup?a.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof a.collisionFilterMask?a.collisionFilterMask:1,this.collisionResponse=!0,this.position=new e,a.position&&this.position.copy(a.position),this.previousPosition=new e,this.initPosition=new e,this.velocity=new e,a.velocity&&this.velocity.copy(a.velocity),this.initVelocity=new e,this.force=new e;var b="number"==typeof a.mass?a.mass:0;this.mass=b,this.invMass=b>0?1/b:0,this.material=a.material||null,this.linearDamping="number"==typeof a.linearDamping?a.linearDamping:.01,this.type=0>=b?c.STATIC:c.DYNAMIC,typeof a.type==typeof c.STATIC&&(this.type=a.type),this.allowSleep="undefined"!=typeof a.allowSleep?a.allowSleep:!0,this.sleepState=0,this.sleepSpeedLimit="undefined"!=typeof a.sleepSpeedLimit?a.sleepSpeedLimit:.1,this.sleepTimeLimit="undefined"!=typeof a.sleepTimeLimit?a.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new e,this.quaternion=new g,a.quaternion&&this.quaternion.copy(a.quaternion),this.initQuaternion=new g,this.angularVelocity=new e,a.angularVelocity&&this.angularVelocity.copy(a.angularVelocity),this.initAngularVelocity=new e,this.interpolatedPosition=new e,this.interpolatedQuaternion=new g,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new e,this.invInertia=new e,this.invInertiaWorld=new f,this.invMassSolve=0,this.invInertiaSolve=new e,this.invInertiaWorldSolve=new f,this.fixedRotation="undefined"!=typeof a.fixedRotation?a.fixedRotation:!1,this.angularDamping="undefined"!=typeof a.angularDamping?a.angularDamping:.01,this.aabb=new h,this.aabbNeedsUpdate=!0,this.wlambda=new e,a.shape&&this.addShape(a.shape),this.updateMassProperties()}b.exports=c;var d=a("../utils/EventTarget"),e=(a("../shapes/Shape"),a("../math/Vec3")),f=a("../math/Mat3"),g=a("../math/Quaternion"),h=(a("../material/Material"),a("../collision/AABB")),i=a("../shapes/Box");c.prototype=new d,c.prototype.constructor=c,c.DYNAMIC=1,c.STATIC=2,c.KINEMATIC=4,c.AWAKE=0,c.SLEEPY=1,c.SLEEPING=2,c.idCounter=0,c.prototype.wakeUp=function(){var a=this.sleepState;this.sleepState=0,a===c.SLEEPING&&this.dispatchEvent({type:"wakeup"})},c.prototype.sleep=function(){this.sleepState=c.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0)},c.sleepyEvent={type:"sleepy"},c.sleepEvent={type:"sleep"},c.prototype.sleepTick=function(a){if(this.allowSleep){var b=this.sleepState,d=this.velocity.norm2()+this.angularVelocity.norm2(),e=Math.pow(this.sleepSpeedLimit,2);b===c.AWAKE&&e>d?(this.sleepState=c.SLEEPY,this.timeLastSleepy=a,this.dispatchEvent(c.sleepyEvent)):b===c.SLEEPY&&d>e?this.wakeUp():b===c.SLEEPY&&a-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(c.sleepEvent))}},c.prototype.updateSolveMassProperties=function(){this.sleepState===c.SLEEPING||this.type===c.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},c.prototype.pointToLocalFrame=function(a,b){var b=b||new e;return a.vsub(this.position,b),this.quaternion.conjugate().vmult(b,b),b},c.prototype.vectorToLocalFrame=function(a,b){var b=b||new e;return this.quaternion.conjugate().vmult(a,b),b},c.prototype.pointToWorldFrame=function(a,b){var b=b||new e;return this.quaternion.vmult(a,b),b.vadd(this.position,b),b},c.prototype.vectorToWorldFrame=function(a,b){var b=b||new e;return this.quaternion.vmult(a,b),b};var j=new e,k=new g;c.prototype.addShape=function(a,b,c){var d=new e,f=new g;return b&&d.copy(b),c&&f.copy(c),this.shapes.push(a),this.shapeOffsets.push(d),this.shapeOrientations.push(f),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,this},c.prototype.updateBoundingRadius=function(){for(var a=this.shapes,b=this.shapeOffsets,c=a.length,d=0,e=0;e!==c;e++){var f=a[e];f.updateBoundingSphereRadius();var g=b[e].norm(),h=f.boundingSphereRadius;g+h>d&&(d=g+h)}this.boundingRadius=d};var l=new h;c.prototype.computeAABB=function(){for(var a=this.shapes,b=this.shapeOffsets,c=this.shapeOrientations,d=a.length,e=j,f=k,g=this.quaternion,h=this.aabb,i=l,m=0;m!==d;m++){var n=a[m];c[m].mult(g,f),f.vmult(b[m],e),e.vadd(this.position,e),n.calculateWorldAABB(e,f,i.lowerBound,i.upperBound),0===m?h.copy(i):h.extend(i)}this.aabbNeedsUpdate=!1};{var m=new f,n=new f;new f}c.prototype.updateInertiaWorld=function(a){var b=this.invInertia;if(b.x!==b.y||b.y!==b.z||a){var c=m,d=n;c.setRotationFromQuaternion(this.quaternion),c.transpose(d),c.scale(b,c),c.mmult(d,this.invInertiaWorld)}else;};var o=new e,p=new e;c.prototype.applyForce=function(a,b){if(this.type===c.DYNAMIC){var d=o;b.vsub(this.position,d);var e=p;d.cross(a,e),this.force.vadd(a,this.force),this.torque.vadd(e,this.torque)}};var q=new e,r=new e;c.prototype.applyLocalForce=function(a,b){if(this.type===c.DYNAMIC){var d=q,e=r;this.vectorToWorldFrame(a,d),this.pointToWorldFrame(b,e),this.applyForce(d,e)}};var s=new e,t=new e,u=new e;c.prototype.applyImpulse=function(a,b){if(this.type===c.DYNAMIC){var d=s;b.vsub(this.position,d);var e=t;e.copy(a),e.mult(this.invMass,e),this.velocity.vadd(e,this.velocity);var f=u;d.cross(a,f),this.invInertiaWorld.vmult(f,f),this.angularVelocity.vadd(f,this.angularVelocity)}};var v=new e,w=new e;c.prototype.applyLocalImpulse=function(a,b){if(this.type===c.DYNAMIC){var d=v,e=w;this.vectorToWorldFrame(a,d),this.pointToWorldFrame(b,e),this.applyImpulse(d,e)}};var x=new e;c.prototype.updateMassProperties=function(){var a=x;this.invMass=this.mass>0?1/this.mass:0;var b=this.inertia,c=this.fixedRotation;this.computeAABB(),a.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),i.calculateInertia(a,this.mass,b),this.invInertia.set(b.x>0&&!c?1/b.x:0,b.y>0&&!c?1/b.y:0,b.z>0&&!c?1/b.z:0),this.updateInertiaWorld(!0)},c.prototype.getVelocityAtWorldPoint=function(a,b){var c=new e;return a.vsub(this.position,c),this.angularVelocity.cross(c,b),this.velocity.vadd(b,b),b}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(a,b){function c(a){this.chassisBody=a.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis="undefined"!=typeof a.indexRightAxis?a.indexRightAxis:1,this.indexForwardAxis="undefined"!=typeof a.indexForwardAxis?a.indexForwardAxis:0,this.indexUpAxis="undefined"!=typeof a.indexUpAxis?a.indexUpAxis:2}function d(a,b,c,d,f){var g=0,h=c,i=u,j=v,k=w;a.getVelocityAtWorldPoint(h,i),b.getVelocityAtWorldPoint(h,j),i.vsub(j,k);var l=d.dot(k),m=e(a,c,d),n=e(b,c,d),o=1,p=o/(m+n);return g=-l*p,g>f&&(g=f),-f>g&&(g=-f),g}function e(a,b,c){var d=x,e=y,f=z,g=A;return b.vsub(a.position,d),d.cross(c,e),a.invInertiaWorld.vmult(e,g),g.cross(d,f),a.invMass+c.dot(f)}function f(a,b,c,d,e,f){var g=e.norm2();if(g>1.1)return 0;var h=B,i=C,j=D;a.getVelocityAtWorldPoint(b,h),c.getVelocityAtWorldPoint(d,i),h.vsub(i,j);var k=e.dot(j),l=.2,m=1/(a.invMass+c.invMass),f=-l*k*m;return f}var g=(a("./Body"),a("../math/Vec3")),h=a("../math/Quaternion"),i=(a("../collision/RaycastResult"),a("../collision/Ray")),j=a("../objects/WheelInfo");b.exports=c;{var k=(new g,new g,new g,new g),l=new g,m=new g;new i}c.prototype.addWheel=function(a){a=a||{};var b=new j(a),c=this.wheelInfos.length;return this.wheelInfos.push(b),c},c.prototype.setSteeringValue=function(a,b){var c=this.wheelInfos[b];c.steering=a};new g;c.prototype.applyEngineForce=function(a,b){this.wheelInfos[b].engineForce=a},c.prototype.setBrake=function(a,b){this.wheelInfos[b].brake=a},c.prototype.addToWorld=function(a){this.constraints;a.add(this.chassisBody);var b=this;this.preStepCallback=function(){b.updateVehicle(a.dt)},a.addEventListener("preStep",this.preStepCallback),this.world=a},c.prototype.getVehicleAxisWorld=function(a,b){b.set(0===a?1:0,1===a?1:0,2===a?1:0),this.chassisBody.vectorToWorldFrame(b,b)},c.prototype.updateVehicle=function(a){for(var b=this.wheelInfos,c=b.length,d=this.chassisBody,e=0;c>e;e++)this.updateWheelTransform(e);this.currentVehicleSpeedKmHour=3.6*d.velocity.norm();var f=new g;this.getVehicleAxisWorld(this.indexForwardAxis,f),f.dot(d.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1);for(var e=0;c>e;e++)this.castRay(b[e]);this.updateSuspension(a);for(var h=new g,i=new g,e=0;c>e;e++){var j=b[e],k=j.suspensionForce;k>j.maxSuspensionForce&&(k=j.maxSuspensionForce),j.raycastResult.hitNormalWorld.scale(k*a,h),j.raycastResult.hitPointWorld.vsub(d.position,i),d.applyImpulse(h,j.raycastResult.hitPointWorld)}this.updateFriction(a);var l=new g,m=new g,n=new g;for(e=0;c>e;e++){var j=b[e];d.getVelocityAtWorldPoint(j.chassisConnectionPointWorld,n);var o=1;switch(this.indexUpAxis){case 1:o=-1}if(j.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,m);var p=m.dot(j.raycastResult.hitNormalWorld);j.raycastResult.hitNormalWorld.scale(p,l),m.vsub(l,m);var q=m.dot(n);j.deltaRotation=o*q*a/j.radius}!j.sliding&&j.isInContact||0===j.engineForce||!j.useCustomSlidingRotationalSpeed||(j.deltaRotation=(j.engineForce>0?1:-1)*j.customSlidingRotationalSpeed*a),Math.abs(j.brake)>Math.abs(j.engineForce)&&(j.deltaRotation=0),j.rotation+=j.deltaRotation,j.deltaRotation*=.99}},c.prototype.updateSuspension=function(){for(var a=this.chassisBody,b=a.mass,c=this.wheelInfos,d=c.length,e=0;d>e;e++){var f=c[e];if(f.isInContact){var g,h=f.suspensionRestLength,i=f.suspensionLength,j=h-i;g=f.suspensionStiffness*j*f.clippedInvContactDotSuspension;var k,l=f.suspensionRelativeVelocity;k=0>l?f.dampingCompression:f.dampingRelaxation,g-=k*l,f.suspensionForce=g*b,f.suspensionForce<0&&(f.suspensionForce=0)}else f.suspensionForce=0}},c.prototype.removeFromWorld=function(a){this.constraints;a.remove(this.chassisBody),a.removeEventListener("preStep",this.preStepCallback),this.world=null};var n=new g,o=new g;c.prototype.castRay=function(a){var b=n,c=o;this.updateWheelTransformWorld(a);var d=this.chassisBody,e=-1,f=a.suspensionRestLength+a.radius;a.directionWorld.scale(f,b);var h=a.chassisConnectionPointWorld;h.vadd(b,c);var i=a.raycastResult;i.reset();var j=d.collisionResponse;d.collisionResponse=!1,this.world.rayTest(h,c,i),d.collisionResponse=j;var k=i.body;if(a.raycastResult.groundObject=0,k){e=i.distance,a.raycastResult.hitNormalWorld=i.hitNormalWorld,a.isInContact=!0;var l=i.distance;a.suspensionLength=l-a.radius;var m=a.suspensionRestLength-a.maxSuspensionTravel,p=a.suspensionRestLength+a.maxSuspensionTravel;a.suspensionLength<m&&(a.suspensionLength=m),a.suspensionLength>p&&(a.suspensionLength=p,a.raycastResult.reset());var q=a.raycastResult.hitNormalWorld.dot(a.directionWorld),r=new g;d.getVelocityAtWorldPoint(a.raycastResult.hitPointWorld,r);var s=a.raycastResult.hitNormalWorld.dot(r);if(q>=-.1)a.suspensionRelativeVelocity=0,a.clippedInvContactDotSuspension=10;else{var t=-1/q;a.suspensionRelativeVelocity=s*t,a.clippedInvContactDotSuspension=t}}else a.suspensionLength=a.suspensionRestLength+0*a.maxSuspensionTravel,a.suspensionRelativeVelocity=0,a.directionWorld.scale(-1,a.raycastResult.hitNormalWorld),a.clippedInvContactDotSuspension=1;return e},c.prototype.updateWheelTransformWorld=function(a){a.isInContact=!1;var b=this.chassisBody;b.pointToWorldFrame(a.chassisConnectionPointLocal,a.chassisConnectionPointWorld),b.vectorToWorldFrame(a.directionLocal,a.directionWorld),b.vectorToWorldFrame(a.axleLocal,a.axleWorld)},c.prototype.updateWheelTransform=function(a){var b=k,c=l,d=m,e=this.wheelInfos[a];this.updateWheelTransformWorld(e),e.directionLocal.scale(-1,b),c.copy(e.axleLocal),b.cross(c,d),d.normalize(),c.normalize();var f=e.steering,g=new h;g.setFromAxisAngle(b,f);var i=new h;i.setFromAxisAngle(c,e.rotation);var j=e.worldTransform.quaternion;this.chassisBody.quaternion.mult(g,j),j.mult(i,j),j.normalize();var n=e.worldTransform.position;n.copy(e.directionWorld),n.scale(e.suspensionLength,n),n.vadd(e.chassisConnectionPointWorld,n)};var p=[new g(1,0,0),new g(0,1,0),new g(0,0,1)];c.prototype.getWheelTransformWorld=function(a){return this.wheelInfos[a].worldTransform};var q=new g,r=[],s=[],t=1;c.prototype.updateFriction=function(a){for(var b=q,c=this.wheelInfos,e=c.length,h=this.chassisBody,i=s,j=r,k=0,l=0;e>l;l++){var m=c[l],n=m.raycastResult.body;n&&k++,m.sideImpulse=0,m.forwardImpulse=0,i[l]||(i[l]=new g),j[l]||(j[l]=new g)}for(var l=0;e>l;l++){var m=c[l],n=m.raycastResult.body;if(n){var o=j[l],u=this.getWheelTransformWorld(l);u.vectorToWorldFrame(p[this.indexRightAxis],o);var v=m.raycastResult.hitNormalWorld,w=o.dot(v);v.scale(w,b),o.vsub(b,o),o.normalize(),v.cross(o,i[l]),i[l].normalize(),m.sideImpulse=f(h,m.raycastResult.hitPointWorld,n,m.raycastResult.hitPointWorld,o),m.sideImpulse*=t}}var x=1,y=.5;this.sliding=!1;for(var l=0;e>l;l++){var m=c[l],n=m.raycastResult.body,z=0;if(m.slipInfo=1,n){var A=0,B=m.brake?m.brake:A;z=d(h,n,m.raycastResult.hitPointWorld,i[l],B),z+=m.engineForce*a;var C=B/z;m.slipInfo*=C}if(m.forwardImpulse=0,m.skidInfo=1,n){m.skidInfo=1;var D=m.suspensionForce*a*m.frictionSlip,E=D,F=D*E;m.forwardImpulse=z;var G=m.forwardImpulse*y,H=m.sideImpulse*x,I=G*G+H*H;if(m.sliding=!1,I>F){this.sliding=!0,m.sliding=!0;var C=D/Math.sqrt(I);m.skidInfo*=C}}}if(this.sliding)for(var l=0;e>l;l++){var m=c[l];0!==m.sideImpulse&&m.skidInfo<1&&(m.forwardImpulse*=m.skidInfo,m.sideImpulse*=m.skidInfo)}for(var l=0;e>l;l++){var m=c[l],J=new g;if(J.copy(m.raycastResult.hitPointWorld),0!==m.forwardImpulse){var K=new g;i[l].scale(m.forwardImpulse,K),h.applyImpulse(K,J)}if(0!==m.sideImpulse){var n=m.raycastResult.body,L=new g;L.copy(m.raycastResult.hitPointWorld);var M=new g;j[l].scale(m.sideImpulse,M),h.pointToLocalFrame(J,J),J["xyz"[this.indexUpAxis]]*=m.rollInfluence,h.pointToWorldFrame(J,J),h.applyImpulse(M,J),M.scale(-1,M),n.applyImpulse(M,L)}}};var u=new g,v=new g,w=new g,x=new g,y=new g,z=new g,A=new g,B=new g,C=new g,D=new g},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(a,b){function c(a){if(this.wheelBodies=[],this.coordinateSystem="undefined"==typeof a.coordinateSystem?new g(1,2,3):a.coordinateSystem.clone(),this.chassisBody=a.chassisBody,!this.chassisBody){var b=new f(new g(5,2,.5));this.chassisBody=new d(1,b)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}var d=a("./Body"),e=a("../shapes/Sphere"),f=a("../shapes/Box"),g=a("../math/Vec3"),h=a("../constraints/HingeConstraint");b.exports=c,c.prototype.addWheel=function(a){a=a||{};var b=a.body;b||(b=new d(1,new e(1.2))),this.wheelBodies.push(b),this.wheelForces.push(0);var c=(new g,"undefined"!=typeof a.position?a.position.clone():new g),f=new g;this.chassisBody.pointToWorldFrame(c,f),b.position.set(f.x,f.y,f.z);var i="undefined"!=typeof a.axis?a.axis.clone():new g(0,1,0);this.wheelAxes.push(i);var j=new h(this.chassisBody,b,{pivotA:c,axisA:i,pivotB:g.ZERO,axisB:i,collideConnected:!1});return this.constraints.push(j),this.wheelBodies.length-1},c.prototype.setSteeringValue=function(a,b){var c=this.wheelAxes[b],d=Math.cos(a),e=Math.sin(a),f=c.x,g=c.y;this.constraints[b].axisA.set(d*f-e*g,e*f+d*g,0)},c.prototype.setMotorSpeed=function(a,b){var c=this.constraints[b];c.enableMotor(),c.motorTargetVelocity=a},c.prototype.disableMotor=function(a){var b=this.constraints[a];
b.disableMotor()};var i=new g;c.prototype.setWheelForce=function(a,b){this.wheelForces[b]=a},c.prototype.applyWheelForce=function(a,b){var c=this.wheelAxes[b],d=this.wheelBodies[b],e=d.torque;c.scale(a,i),d.vectorToWorldFrame(i,i),e.vadd(i,e)},c.prototype.addToWorld=function(a){for(var b=this.constraints,c=this.wheelBodies.concat([this.chassisBody]),d=0;d<c.length;d++)a.add(c[d]);for(var d=0;d<b.length;d++)a.addConstraint(b[d]);a.addEventListener("preStep",this._update.bind(this))},c.prototype._update=function(){for(var a=this.wheelForces,b=0;b<a.length;b++)this.applyWheelForce(a[b],b)},c.prototype.removeFromWorld=function(a){for(var b=this.constraints,c=this.wheelBodies.concat([this.chassisBody]),d=0;d<c.length;d++)a.remove(c[d]);for(var d=0;d<b.length;d++)a.removeConstraint(b[d])};var j=new g;c.prototype.getWheelSpeed=function(a){var b=this.wheelAxes[a],c=this.wheelBodies[a],d=c.angularVelocity;return this.chassisBody.vectorToWorldFrame(b,j),d.dot(j)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(a,b){function c(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}b.exports=c;{var d=(a("../shapes/Shape"),a("../math/Vec3"));a("../math/Quaternion"),a("../shapes/Particle"),a("../objects/Body"),a("../material/Material")}c.prototype.add=function(a){this.particles.push(a),this.neighbors.length<this.particles.length&&this.neighbors.push([])},c.prototype.remove=function(a){var b=this.particles.indexOf(a);-1!==b&&(this.particles.splice(b,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var e=new d;c.prototype.getNeighbors=function(a,b){for(var c=this.particles.length,d=a.id,f=this.smoothingRadius*this.smoothingRadius,g=e,h=0;h!==c;h++){var i=this.particles[h];i.position.vsub(a.position,g),d!==i.id&&g.norm2()<f&&b.push(i)}};var f=new d,g=new d,h=new d,i=new d,j=new d,k=new d;c.prototype.update=function(){for(var a=this.particles.length,b=f,c=this.speedOfSound,d=this.eps,e=0;e!==a;e++){var l=this.particles[e],m=this.neighbors[e];m.length=0,this.getNeighbors(l,m),m.push(this.particles[e]);for(var n=m.length,o=0,p=0;p!==n;p++){l.position.vsub(m[p].position,b);var q=b.norm(),r=this.w(q);o+=m[p].mass*r}this.densities[e]=o,this.pressures[e]=c*c*(this.densities[e]-this.density)}for(var s=g,t=h,u=i,v=j,w=k,e=0;e!==a;e++){var x=this.particles[e];s.set(0,0,0),t.set(0,0,0);for(var y,z,m=this.neighbors[e],n=m.length,p=0;p!==n;p++){var A=m[p];x.position.vsub(A.position,v);var B=v.norm();y=-A.mass*(this.pressures[e]/(this.densities[e]*this.densities[e]+d)+this.pressures[p]/(this.densities[p]*this.densities[p]+d)),this.gradw(v,u),u.mult(y,u),s.vadd(u,s),A.velocity.vsub(x.velocity,w),w.mult(1/(1e-4+this.densities[e]*this.densities[p])*this.viscosity*A.mass,w),z=this.nablaw(B),w.mult(z,w),t.vadd(w,t)}t.mult(x.mass,t),s.mult(x.mass,s),x.force.vadd(t,x.force),x.force.vadd(s,x.force)}},c.prototype.w=function(a){var b=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(b,9))*Math.pow(b*b-a*a,3)},c.prototype.gradw=function(a,b){var c=a.norm(),d=this.smoothingRadius;a.mult(945/(32*Math.PI*Math.pow(d,9))*Math.pow(d*d-c*c,2),b)},c.prototype.nablaw=function(a){var b=this.smoothingRadius,c=945/(32*Math.PI*Math.pow(b,9))*(b*b-a*a)*(7*a*a-3*b*b);return c}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(a,b){function c(a,b,c){c=c||{},this.restLength="number"==typeof c.restLength?c.restLength:1,this.stiffness=c.stiffness||100,this.damping=c.damping||1,this.bodyA=a,this.bodyB=b,this.localAnchorA=new d,this.localAnchorB=new d,c.localAnchorA&&this.localAnchorA.copy(c.localAnchorA),c.localAnchorB&&this.localAnchorB.copy(c.localAnchorB),c.worldAnchorA&&this.setWorldAnchorA(c.worldAnchorA),c.worldAnchorB&&this.setWorldAnchorB(c.worldAnchorB)}var d=a("../math/Vec3");b.exports=c,c.prototype.setWorldAnchorA=function(a){this.bodyA.pointToLocalFrame(a,this.localAnchorA)},c.prototype.setWorldAnchorB=function(a){this.bodyB.pointToLocalFrame(a,this.localAnchorB)},c.prototype.getWorldAnchorA=function(a){this.bodyA.pointToWorldFrame(this.localAnchorA,a)},c.prototype.getWorldAnchorB=function(a){this.bodyB.pointToWorldFrame(this.localAnchorB,a)};var e=new d,f=new d,g=new d,h=new d,i=new d,j=new d,k=new d,l=new d,m=new d,n=new d,o=new d;c.prototype.applyForce=function(){var a=this.stiffness,b=this.damping,c=this.restLength,d=this.bodyA,p=this.bodyB,q=e,r=f,s=g,t=h,u=o,v=i,w=j,x=k,y=l,z=m,A=n;this.getWorldAnchorA(v),this.getWorldAnchorB(w),v.vsub(d.position,x),w.vsub(p.position,y),w.vsub(v,q);var B=q.norm();r.copy(q),r.normalize(),p.velocity.vsub(d.velocity,s),p.angularVelocity.cross(y,u),s.vadd(u,s),d.angularVelocity.cross(x,u),s.vsub(u,s),r.mult(-a*(B-c)-b*s.dot(r),t),d.force.vsub(t,d.force),p.force.vadd(t,p.force),x.cross(t,z),y.cross(t,A),d.torque.vsub(z,d.torque),p.torque.vadd(A,p.torque)}},{"../math/Vec3":30}],36:[function(a,b){function c(a){a=g.defaults(a,{chassisConnectionPointLocal:new d,chassisConnectionPointWorld:new d,directionLocal:new d,directionWorld:new d,axleLocal:new d,axleWorld:new d,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=a.maxSuspensionTravel,this.customSlidingRotationalSpeed=a.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=a.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=a.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=a.chassisConnectionPointWorld.clone(),this.directionLocal=a.directionLocal.clone(),this.directionWorld=a.directionWorld.clone(),this.axleLocal=a.axleLocal.clone(),this.axleWorld=a.axleWorld.clone(),this.suspensionRestLength=a.suspensionRestLength,this.suspensionMaxLength=a.suspensionMaxLength,this.radius=a.radius,this.suspensionStiffness=a.suspensionStiffness,this.dampingCompression=a.dampingCompression,this.dampingRelaxation=a.dampingRelaxation,this.frictionSlip=a.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=a.rollInfluence,this.maxSuspensionForce=a.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=a.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new f,this.worldTransform=new e,this.isInContact=!1}var d=a("../math/Vec3"),e=a("../math/Transform"),f=a("../collision/RaycastResult"),g=a("../utils/Utils");b.exports=c;var h=new d,i=new d,h=new d;c.prototype.updateWheel=function(a){var b=this.raycastResult;if(this.isInContact){var c=b.hitNormalWorld.dot(b.directionWorld);b.hitPointWorld.vsub(a.position,i),a.getVelocityAtWorldPoint(i,h);var d=b.hitNormalWorld.dot(h);if(c>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var e=-1/c;this.suspensionRelativeVelocity=d*e,this.clippedInvContactDotSuspension=e}}else b.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,b.directionWorld.scale(-1,b.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(a,b){function c(a){d.call(this),this.type=d.types.BOX,this.halfExtents=a,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}b.exports=c;var d=a("./Shape"),e=a("../math/Vec3"),f=a("./ConvexPolyhedron");c.prototype=new d,c.prototype.constructor=c,c.prototype.updateConvexPolyhedronRepresentation=function(){var a=this.halfExtents.x,b=this.halfExtents.y,c=this.halfExtents.z,d=e,g=[new d(-a,-b,-c),new d(a,-b,-c),new d(a,b,-c),new d(-a,b,-c),new d(-a,-b,c),new d(a,-b,c),new d(a,b,c),new d(-a,b,c)],h=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]],i=([new d(0,0,1),new d(0,1,0),new d(1,0,0)],new f(g,h));this.convexPolyhedronRepresentation=i,i.material=this.material},c.prototype.calculateLocalInertia=function(a,b){return b=b||new e,c.calculateInertia(this.halfExtents,a,b),b},c.calculateInertia=function(a,b,c){var d=a;c.x=1/12*b*(2*d.y*2*d.y+2*d.z*2*d.z),c.y=1/12*b*(2*d.x*2*d.x+2*d.z*2*d.z),c.z=1/12*b*(2*d.y*2*d.y+2*d.x*2*d.x)},c.prototype.getSideNormals=function(a,b){var c=a,d=this.halfExtents;if(c[0].set(d.x,0,0),c[1].set(0,d.y,0),c[2].set(0,0,d.z),c[3].set(-d.x,0,0),c[4].set(0,-d.y,0),c[5].set(0,0,-d.z),void 0!==b)for(var e=0;e!==c.length;e++)b.vmult(c[e],c[e]);return c},c.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},c.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};{var g=new e;new e}c.prototype.forEachWorldCorner=function(a,b,c){for(var d=this.halfExtents,e=[[d.x,d.y,d.z],[-d.x,d.y,d.z],[-d.x,-d.y,d.z],[-d.x,-d.y,-d.z],[d.x,-d.y,-d.z],[d.x,d.y,-d.z],[-d.x,d.y,-d.z],[d.x,-d.y,d.z]],f=0;f<e.length;f++)g.set(e[f][0],e[f][1],e[f][2]),b.vmult(g,g),a.vadd(g,g),c(g.x,g.y,g.z)};var h=[new e,new e,new e,new e,new e,new e,new e,new e];c.prototype.calculateWorldAABB=function(a,b,c,d){var e=this.halfExtents;h[0].set(e.x,e.y,e.z),h[1].set(-e.x,e.y,e.z),h[2].set(-e.x,-e.y,e.z),h[3].set(-e.x,-e.y,-e.z),h[4].set(e.x,-e.y,-e.z),h[5].set(e.x,e.y,-e.z),h[6].set(-e.x,e.y,-e.z),h[7].set(e.x,-e.y,e.z);var f=h[0];b.vmult(f,f),a.vadd(f,f),d.copy(f),c.copy(f);for(var g=1;8>g;g++){var f=h[g];b.vmult(f,f),a.vadd(f,f);var i=f.x,j=f.y,k=f.z;i>d.x&&(d.x=i),j>d.y&&(d.y=j),k>d.z&&(d.z=k),i<c.x&&(c.x=i),j<c.y&&(c.y=j),k<c.z&&(c.z=k)}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(a,b){function c(a,b,c){d.call(this),this.type=d.types.CONVEXPOLYHEDRON,this.vertices=a||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=b||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=c?c.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}b.exports=c;var d=a("./Shape"),e=a("../math/Vec3"),f=(a("../math/Quaternion"),a("../math/Transform"));c.prototype=new d,c.prototype.constructor=c;var g=new e;c.prototype.computeEdges=function(){var a=this.faces,b=this.vertices,c=(b.length,this.uniqueEdges);c.length=0;for(var d=g,e=0;e!==a.length;e++)for(var f=a[e],h=f.length,i=0;i!==h;i++){var j=(i+1)%h;b[f[i]].vsub(b[f[j]],d),d.normalize();for(var k=!1,l=0;l!==c.length;l++)if(c[l].almostEquals(d)||c[l].almostEquals(d)){k=!0;break}k||c.push(d.clone())}},c.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var a=0;a<this.faces.length;a++){for(var b=0;b<this.faces[a].length;b++)if(!this.vertices[this.faces[a][b]])throw new Error("Vertex "+this.faces[a][b]+" not found!");var c=this.faceNormals[a]||new e;this.getFaceNormal(a,c),c.negate(c),this.faceNormals[a]=c;var d=this.vertices[this.faces[a][0]];if(c.dot(d)<0){console.error(".faceNormals["+a+"] = Vec3("+c.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var b=0;b<this.faces[a].length;b++)console.warn(".vertices["+this.faces[a][b]+"] = Vec3("+this.vertices[this.faces[a][b]].toString()+")")}}};var h=new e,i=new e;c.computeNormal=function(a,b,c,d){b.vsub(a,i),c.vsub(b,h),h.cross(i,d),d.isZero()||d.normalize()},c.prototype.getFaceNormal=function(a,b){var d=this.faces[a],e=this.vertices[d[0]],f=this.vertices[d[1]],g=this.vertices[d[2]];return c.computeNormal(e,f,g,b)};var j=new e;c.prototype.clipAgainstHull=function(a,b,c,d,f,g,h,i,k){for(var l=j,m=-1,n=-Number.MAX_VALUE,o=0;o<c.faces.length;o++){l.copy(c.faceNormals[o]),f.vmult(l,l);var p=l.dot(g);p>n&&(n=p,m=o)}for(var q=[],r=c.faces[m],s=r.length,t=0;s>t;t++){var u=c.vertices[r[t]],v=new e;v.copy(u),f.vmult(v,v),d.vadd(v,v),q.push(v)}m>=0&&this.clipFaceAgainstHull(g,a,b,q,h,i,k)};var k=new e,l=new e,m=new e,n=new e,o=new e,p=new e;c.prototype.findSeparatingAxis=function(a,b,c,d,e,f,g,h){var i=k,j=l,q=m,r=n,s=o,t=p,u=Number.MAX_VALUE,v=this,w=0;if(v.uniqueAxes)for(var x=0;x!==v.uniqueAxes.length;x++){c.vmult(v.uniqueAxes[x],i);var y=v.testSepAxis(i,a,b,c,d,e);if(y===!1)return!1;u>y&&(u=y,f.copy(i))}else for(var z=g?g.length:v.faces.length,x=0;z>x;x++){var A=g?g[x]:x;i.copy(v.faceNormals[A]),c.vmult(i,i);var y=v.testSepAxis(i,a,b,c,d,e);if(y===!1)return!1;u>y&&(u=y,f.copy(i))}if(a.uniqueAxes)for(var x=0;x!==a.uniqueAxes.length;x++){e.vmult(a.uniqueAxes[x],j),w++;var y=v.testSepAxis(j,a,b,c,d,e);if(y===!1)return!1;u>y&&(u=y,f.copy(j))}else for(var B=h?h.length:a.faces.length,x=0;B>x;x++){var A=h?h[x]:x;j.copy(a.faceNormals[A]),e.vmult(j,j),w++;var y=v.testSepAxis(j,a,b,c,d,e);if(y===!1)return!1;u>y&&(u=y,f.copy(j))}for(var C=0;C!==v.uniqueEdges.length;C++){c.vmult(v.uniqueEdges[C],r);for(var D=0;D!==a.uniqueEdges.length;D++)if(e.vmult(a.uniqueEdges[D],s),r.cross(s,t),!t.almostZero()){t.normalize();var E=v.testSepAxis(t,a,b,c,d,e);if(E===!1)return!1;u>E&&(u=E,f.copy(t))}}return d.vsub(b,q),q.dot(f)>0&&f.negate(f),!0};var q=[],r=[];c.prototype.testSepAxis=function(a,b,d,e,f,g){var h=this;c.project(h,a,d,e,q),c.project(b,a,f,g,r);var i=q[0],j=q[1],k=r[0],l=r[1];if(l>i||j>k)return!1;var m=i-l,n=k-j,o=n>m?m:n;return o};var s=new e,t=new e;c.prototype.calculateLocalInertia=function(a,b){this.computeLocalAABB(s,t);var c=t.x-s.x,d=t.y-s.y,e=t.z-s.z;b.x=1/12*a*(2*d*2*d+2*e*2*e),b.y=1/12*a*(2*c*2*c+2*e*2*e),b.z=1/12*a*(2*d*2*d+2*c*2*c)},c.prototype.getPlaneConstantOfFace=function(a){var b=this.faces[a],c=this.faceNormals[a],d=this.vertices[b[0]],e=-c.dot(d);return e};var u=new e,v=new e,w=new e,x=new e,y=new e,z=new e,A=new e,B=new e;c.prototype.clipFaceAgainstHull=function(a,b,c,d,e,f,g){for(var h=u,i=v,j=w,k=x,l=y,m=z,n=A,o=B,p=this,q=[],r=d,s=q,t=-1,C=Number.MAX_VALUE,D=0;D<p.faces.length;D++){h.copy(p.faceNormals[D]),c.vmult(h,h);var E=h.dot(a);C>E&&(C=E,t=D)}if(!(0>t)){var F=p.faces[t];F.connectedFaces=[];for(var G=0;G<p.faces.length;G++)for(var H=0;H<p.faces[G].length;H++)-1!==F.indexOf(p.faces[G][H])&&G!==t&&-1===F.connectedFaces.indexOf(G)&&F.connectedFaces.push(G);for(var I=(r.length,F.length),J=0;I>J;J++){var K=p.vertices[F[J]],L=p.vertices[F[(J+1)%I]];K.vsub(L,i),j.copy(i),c.vmult(j,j),b.vadd(j,j),k.copy(this.faceNormals[t]),c.vmult(k,k),b.vadd(k,k),j.cross(k,l),l.negate(l),m.copy(K),c.vmult(m,m),b.vadd(m,m);var M,N=(-m.dot(l),F.connectedFaces[J]);n.copy(this.faceNormals[N]);var O=this.getPlaneConstantOfFace(N);o.copy(n),c.vmult(o,o);var M=O-o.dot(b);for(this.clipFaceAgainstPlane(r,s,o,M);r.length;)r.shift();for(;s.length;)r.push(s.shift())}n.copy(this.faceNormals[t]);var O=this.getPlaneConstantOfFace(t);o.copy(n),c.vmult(o,o);for(var M=O-o.dot(b),G=0;G<r.length;G++){var P=o.dot(r[G])+M;if(e>=P&&(console.log("clamped: depth="+P+" to minDist="+(e+"")),P=e),f>=P){var Q=r[G];if(0>=P){var R={point:Q,normal:o,depth:P};g.push(R)}}}}},c.prototype.clipFaceAgainstPlane=function(a,b,c,d){var f,g,h=a.length;if(2>h)return b;var i=a[a.length-1],j=a[0];f=c.dot(i)+d;for(var k=0;h>k;k++){if(j=a[k],g=c.dot(j)+d,0>f)if(0>g){var l=new e;l.copy(j),b.push(l)}else{var l=new e;i.lerp(j,f/(f-g),l),b.push(l)}else if(0>g){var l=new e;i.lerp(j,f/(f-g),l),b.push(l),b.push(j)}i=j,f=g}return b},c.prototype.computeWorldVertices=function(a,b){for(var c=this.vertices.length;this.worldVertices.length<c;)this.worldVertices.push(new e);for(var d=this.vertices,f=this.worldVertices,g=0;g!==c;g++)b.vmult(d[g],f[g]),a.vadd(f[g],f[g]);this.worldVerticesNeedsUpdate=!1};new e;c.prototype.computeLocalAABB=function(a,b){var c=this.vertices.length,d=this.vertices;a.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),b.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var e=0;c>e;e++){var f=d[e];f.x<a.x?a.x=f.x:f.x>b.x&&(b.x=f.x),f.y<a.y?a.y=f.y:f.y>b.y&&(b.y=f.y),f.z<a.z?a.z=f.z:f.z>b.z&&(b.z=f.z)}},c.prototype.computeWorldFaceNormals=function(a){for(var b=this.faceNormals.length;this.worldFaceNormals.length<b;)this.worldFaceNormals.push(new e);for(var c=this.faceNormals,d=this.worldFaceNormals,f=0;f!==b;f++)a.vmult(c[f],d[f]);this.worldFaceNormalsNeedsUpdate=!1},c.prototype.updateBoundingSphereRadius=function(){for(var a=0,b=this.vertices,c=0,d=b.length;c!==d;c++){var e=b[c].norm2();e>a&&(a=e)}this.boundingSphereRadius=Math.sqrt(a)};var C=new e;c.prototype.calculateWorldAABB=function(a,b,c,d){for(var e,f,g,h,i,j,k=this.vertices.length,l=this.vertices,m=0;k>m;m++){C.copy(l[m]),b.vmult(C,C),a.vadd(C,C);var n=C;n.x<e||void 0===e?e=n.x:(n.x>h||void 0===h)&&(h=n.x),n.y<f||void 0===f?f=n.y:(n.y>i||void 0===i)&&(i=n.y),n.z<g||void 0===g?g=n.z:(n.z>j||void 0===j)&&(j=n.z)}c.set(e,f,g),d.set(h,i,j)},c.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},c.prototype.getAveragePointLocal=function(a){a=a||new e;for(var b=this.vertices.length,c=this.vertices,d=0;b>d;d++)a.vadd(c[d],a);return a.mult(1/b,a),a},c.prototype.transformAllPoints=function(a,b){var c=this.vertices.length,d=this.vertices;if(b){for(var e=0;c>e;e++){var f=d[e];b.vmult(f,f)}for(var e=0;e<this.faceNormals.length;e++){var f=this.faceNormals[e];b.vmult(f,f)}}if(a)for(var e=0;c>e;e++){var f=d[e];f.vadd(a,f)}};var D=new e,E=new e,F=new e;c.prototype.pointIsInside=function(a){var b=this.vertices.length,c=this.vertices,d=this.faces,e=this.faceNormals,f=null,g=this.faces.length,h=D;this.getAveragePointLocal(h);for(var i=0;g>i;i++){var b=(this.faces[i].length,e[i]),j=c[d[i][0]],k=E;a.vsub(j,k);var l=b.dot(k),m=F;h.vsub(j,m);var n=b.dot(m);if(0>l&&n>0||l>0&&0>n)return!1}return f?1:-1};var G=(new e,new e),H=new e;c.project=function(a,b,c,d,e){var g=a.vertices.length,h=G,i=0,j=0,k=H,l=a.vertices;k.setZero(),f.vectorToLocalFrame(c,d,b,h),f.pointToLocalFrame(c,d,k,k);var m=k.dot(h);j=i=l[0].dot(h);for(var n=1;g>n;n++){var o=l[n].dot(h);o>i&&(i=o),j>o&&(j=o)}if(j-=m,i-=m,j>i){var p=j;j=i,i=p}e[0]=i,e[1]=j}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(a,b){function c(a,b,c,g){var h=g,i=[],j=[],k=[],l=[],m=[],n=Math.cos,o=Math.sin;i.push(new e(b*n(0),b*o(0),.5*-c)),l.push(0),i.push(new e(a*n(0),a*o(0),.5*c)),m.push(1);for(var p=0;h>p;p++){var q=2*Math.PI/h*(p+1),r=2*Math.PI/h*(p+.5);h-1>p?(i.push(new e(b*n(q),b*o(q),.5*-c)),l.push(2*p+2),i.push(new e(a*n(q),a*o(q),.5*c)),m.push(2*p+3),k.push([2*p+2,2*p+3,2*p+1,2*p])):k.push([0,1,2*p+1,2*p]),(h%2===1||h/2>p)&&j.push(new e(n(r),o(r),0))}k.push(m),j.push(new e(0,0,1));for(var s=[],p=0;p<l.length;p++)s.push(l[l.length-p-1]);k.push(s),this.type=d.types.CONVEXPOLYHEDRON,f.call(this,i,k,j)}b.exports=c;var d=a("./Shape"),e=a("../math/Vec3"),f=(a("../math/Quaternion"),a("./ConvexPolyhedron"));c.prototype=new f},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(a,b){function c(a,b){b=g.defaults(b,{maxValue:null,minValue:null,elementSize:1}),this.data=a,this.maxValue=b.maxValue,this.minValue=b.minValue,this.elementSize=b.elementSize,null===b.minValue&&this.updateMinValue(),null===b.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,d.call(this),this.pillarConvex=new e,this.pillarOffset=new f,this.type=d.types.HEIGHTFIELD,this.updateBoundingSphereRadius(),this._cachedPillars={}}var d=a("./Shape"),e=a("./ConvexPolyhedron"),f=a("../math/Vec3"),g=a("../utils/Utils");b.exports=c,c.prototype=new d,c.prototype.update=function(){this._cachedPillars={}},c.prototype.updateMinValue=function(){for(var a=this.data,b=a[0][0],c=0;c!==a.length;c++)for(var d=0;d!==a[c].length;d++){var e=a[c][d];b>e&&(b=e)}this.minValue=b},c.prototype.updateMaxValue=function(){for(var a=this.data,b=a[0][0],c=0;c!==a.length;c++)for(var d=0;d!==a[c].length;d++){var e=a[c][d];e>b&&(b=e)}this.maxValue=b},c.prototype.setHeightValueAtIndex=function(a,b,c){var d=this.data;d[a][b]=c,this.clearCachedConvexTrianglePillar(a,b,!1),a>0&&(this.clearCachedConvexTrianglePillar(a-1,b,!0),this.clearCachedConvexTrianglePillar(a-1,b,!1)),b>0&&(this.clearCachedConvexTrianglePillar(a,b-1,!0),this.clearCachedConvexTrianglePillar(a,b-1,!1)),b>0&&a>0&&this.clearCachedConvexTrianglePillar(a-1,b-1,!0)},c.prototype.getRectMinMax=function(a,b,c,d,e){e=e||[];for(var f=this.data,g=this.minValue,h=a;c>=h;h++)for(var i=b;d>=i;i++){var j=f[h][i];j>g&&(g=j)}e[0]=this.minValue,e[1]=g},c.prototype.getIndexOfPosition=function(a,b,c,d){var e=this.elementSize,f=this.data,g=Math.floor(a/e),h=Math.floor(b/e);return c[0]=g,c[1]=h,d&&(0>g&&(g=0),0>h&&(h=0),g>=f.length-1&&(g=f.length-1),h>=f[0].length-1&&(h=f[0].length-1)),0>g||0>h||g>=f.length-1||h>=f[0].length-1?!1:!0},c.prototype.getHeightAt=function(a,b,c){var d=[];this.getIndexOfPosition(a,b,d,c);var e=[];return this.getRectMinMax(d[0],d[1]+1,d[0],d[1]+1,e),(e[0]+e[1])/2},c.prototype.getCacheConvexTrianglePillarKey=function(a,b,c){return a+"_"+b+"_"+(c?1:0)},c.prototype.getCachedConvexTrianglePillar=function(a,b,c){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(a,b,c)]},c.prototype.setCachedConvexTrianglePillar=function(a,b,c,d,e){this._cachedPillars[this.getCacheConvexTrianglePillarKey(a,b,c)]={convex:d,offset:e}},c.prototype.clearCachedConvexTrianglePillar=function(a,b,c){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(a,b,c)]},c.prototype.getConvexTrianglePillar=function(a,b,c){var d=this.pillarConvex,g=this.pillarOffset;if(this.cacheEnabled){var h=this.getCachedConvexTrianglePillar(a,b,c);if(h)return this.pillarConvex=h.convex,void(this.pillarOffset=h.offset);d=new e,g=new f,this.pillarConvex=d,this.pillarOffset=g}var h=this.data,i=this.elementSize,j=d.faces;d.vertices.length=6;for(var k=0;6>k;k++)d.vertices[k]||(d.vertices[k]=new f);j.length=5;for(var k=0;5>k;k++)j[k]||(j[k]=[]);var l=d.vertices,m=(Math.min(h[a][b],h[a+1][b],h[a][b+1],h[a+1][b+1])-this.minValue)/2+this.minValue;c?(g.set((a+.75)*i,(b+.75)*i,m),l[0].set(.25*i,.25*i,h[a+1][b+1]-m),l[1].set(-.75*i,.25*i,h[a][b+1]-m),l[2].set(.25*i,-.75*i,h[a+1][b]-m),l[3].set(.25*i,.25*i,-m-1),l[4].set(-.75*i,.25*i,-m-1),l[5].set(.25*i,-.75*i,-m-1),j[0][0]=0,j[0][1]=1,j[0][2]=2,j[1][0]=5,j[1][1]=4,j[1][2]=3,j[2][0]=2,j[2][1]=5,j[2][2]=3,j[2][3]=0,j[3][0]=3,j[3][1]=4,j[3][2]=1,j[3][3]=0,j[4][0]=1,j[4][1]=4,j[4][2]=5,j[4][3]=2):(g.set((a+.25)*i,(b+.25)*i,m),l[0].set(-.25*i,-.25*i,h[a][b]-m),l[1].set(.75*i,-.25*i,h[a+1][b]-m),l[2].set(-.25*i,.75*i,h[a][b+1]-m),l[3].set(-.25*i,-.25*i,-m-1),l[4].set(.75*i,-.25*i,-m-1),l[5].set(-.25*i,.75*i,-m-1),j[0][0]=0,j[0][1]=1,j[0][2]=2,j[1][0]=5,j[1][1]=4,j[1][2]=3,j[2][0]=0,j[2][1]=2,j[2][2]=5,j[2][3]=3,j[3][0]=1,j[3][1]=0,j[3][2]=3,j[3][3]=4,j[4][0]=4,j[4][1]=5,j[4][2]=2,j[4][3]=1),d.computeNormals(),d.computeEdges(),d.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(a,b,c,d,g)},c.prototype.calculateLocalInertia=function(a,b){return b=b||new f,b.set(0,0,0),b},c.prototype.volume=function(){return Number.MAX_VALUE},c.prototype.calculateWorldAABB=function(a,b,c,d){c.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),d.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},c.prototype.updateBoundingSphereRadius=function(){var a=this.data,b=this.elementSize;this.boundingSphereRadius=new f(a.length*b,a[0].length*b,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(a,b){function c(){d.call(this),this.type=d.types.PARTICLE}b.exports=c;var d=a("./Shape"),e=a("../math/Vec3");c.prototype=new d,c.prototype.constructor=c,c.prototype.calculateLocalInertia=function(a,b){return b=b||new e,b.set(0,0,0),b},c.prototype.volume=function(){return 0},c.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},c.prototype.calculateWorldAABB=function(a,b,c,d){c.copy(a),d.copy(a)}},{"../math/Vec3":30,"./Shape":43}],42:[function(a,b){function c(){d.call(this),this.type=d.types.PLANE,this.worldNormal=new e,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}b.exports=c;var d=a("./Shape"),e=a("../math/Vec3");c.prototype=new d,c.prototype.constructor=c,c.prototype.computeWorldNormal=function(a){var b=this.worldNormal;b.set(0,0,1),a.vmult(b,b),this.worldNormalNeedsUpdate=!1},c.prototype.calculateLocalInertia=function(a,b){return b=b||new e},c.prototype.volume=function(){return Number.MAX_VALUE};var f=new e;c.prototype.calculateWorldAABB=function(a,b,c,d){f.set(0,0,1),b.vmult(f,f);var e=Number.MAX_VALUE;c.set(-e,-e,-e),d.set(e,e,e),1===f.x&&(d.x=a.x),1===f.y&&(d.y=a.y),1===f.z&&(d.z=a.z),-1===f.x&&(c.x=a.x),-1===f.y&&(c.y=a.y),-1===f.z&&(c.z=a.z)},c.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(a,b){function c(){this.id=c.idCounter++,this.type=0,this.boundingSphereRadius=0,this.collisionResponse=!0,this.material=null}b.exports=c;{var c=a("./Shape");a("../math/Vec3"),a("../math/Quaternion"),a("../material/Material")}c.prototype.constructor=c,c.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},c.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},c.prototype.calculateLocalInertia=function(){throw"calculateLocalInertia() not implemented for shape type "+this.type},c.idCounter=0,c.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(a,b){function c(a){if(d.call(this),this.radius=void 0!==a?Number(a):1,this.type=d.types.SPHERE,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}b.exports=c;var d=a("./Shape"),e=a("../math/Vec3");c.prototype=new d,c.prototype.constructor=c,c.prototype.calculateLocalInertia=function(a,b){b=b||new e;var c=2*a*this.radius*this.radius/5;return b.x=c,b.y=c,b.z=c,b},c.prototype.volume=function(){return 4*Math.PI*this.radius/3},c.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},c.prototype.calculateWorldAABB=function(a,b,c,d){for(var e=this.radius,f=["x","y","z"],g=0;g<f.length;g++){var h=f[g];c[h]=a[h]-e,d[h]=a[h]+e}}},{"../math/Vec3":30,"./Shape":43}],45:[function(a,b){function c(a,b){d.call(this),this.type=d.types.TRIMESH,this.vertices=new Float32Array(a),this.indices=new Int16Array(b),this.normals=new Float32Array(b.length),this.aabb=new g,this.edges=null,this.scale=new e(1,1,1),this.tree=new h,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}b.exports=c;var d=a("./Shape"),e=a("../math/Vec3"),f=(a("../math/Quaternion"),a("../math/Transform")),g=a("../collision/AABB"),h=a("../utils/Octree");c.prototype=new d,c.prototype.constructor=c;var i=new e;c.prototype.updateTree=function(){var a=this.tree;a.reset(),a.aabb.copy(this.aabb);var b=this.scale;a.aabb.lowerBound.x*=1/b.x,a.aabb.lowerBound.y*=1/b.y,a.aabb.lowerBound.z*=1/b.z,a.aabb.upperBound.x*=1/b.x,a.aabb.upperBound.y*=1/b.y,a.aabb.upperBound.z*=1/b.z;for(var c=new g,d=new e,f=new e,h=new e,i=[d,f,h],j=0;j<this.indices.length/3;j++){var k=3*j;this._getUnscaledVertex(this.indices[k],d),this._getUnscaledVertex(this.indices[k+1],f),this._getUnscaledVertex(this.indices[k+2],h),c.setFromPoints(i),a.insert(c,j)}a.removeEmptyNodes()};var j=new g;c.prototype.getTrianglesInAABB=function(a,b){j.copy(a);var c=this.scale,d=c.x,e=c.y,f=c.z,g=j.lowerBound,h=j.upperBound;return g.x/=d,g.y/=e,g.z/=f,h.x/=d,h.y/=e,h.z/=f,this.tree.aabbQuery(j,b)},c.prototype.setScale=function(a){var b=this.scale.x===this.scale.y===this.scale.z,c=a.x===a.y===a.z;b&&c||this.updateNormals(),this.scale.copy(a),this.updateAABB(),this.updateBoundingSphereRadius()},c.prototype.updateNormals=function(){for(var a=i,b=this.normals,d=0;d<this.indices.length/3;d++){var e=3*d,f=this.indices[e],g=this.indices[e+1],h=this.indices[e+2];this.getVertex(f,o),this.getVertex(g,p),this.getVertex(h,q),c.computeNormal(p,o,q,a),b[e]=a.x,b[e+1]=a.y,b[e+2]=a.z}},c.prototype.updateEdges=function(){for(var a={},b=function(){var b=f>e?e+"_"+f:f+"_"+e;a[b]=!0},c=0;c<this.indices.length/3;c++){var d=3*c,e=this.indices[d],f=this.indices[d+1],g=this.indices[d+2];b(e,f),b(f,g),b(g,e)}var h=Object.keys(a);this.edges=new Int16Array(2*h.length);for(var c=0;c<h.length;c++){var i=h[c].split("_");this.edges[2*c]=parseInt(i[0],10),this.edges[2*c+1]=parseInt(i[1],10)}},c.prototype.getEdgeVertex=function(a,b,c){var d=this.edges[2*a+(b?1:0)];this.getVertex(d,c)};var k=new e,l=new e;c.prototype.getEdgeVector=function(a,b){var c=k,d=l;this.getEdgeVertex(a,0,c),this.getEdgeVertex(a,1,d),d.vsub(c,b)};var m=new e,n=new e;c.computeNormal=function(a,b,c,d){b.vsub(a,n),c.vsub(b,m),m.cross(n,d),d.isZero()||d.normalize()};var o=new e,p=new e,q=new e;c.prototype.getVertex=function(a,b){var c=this.scale;return this._getUnscaledVertex(a,b),b.x*=c.x,b.y*=c.y,b.z*=c.z,b},c.prototype._getUnscaledVertex=function(a,b){var c=3*a,d=this.vertices;return b.set(d[c],d[c+1],d[c+2])},c.prototype.getWorldVertex=function(a,b,c,d){return this.getVertex(a,d),f.pointToWorldFrame(b,c,d,d),d},c.prototype.getTriangleVertices=function(a,b,c,d){var e=3*a;this.getVertex(this.indices[e],b),this.getVertex(this.indices[e+1],c),this.getVertex(this.indices[e+2],d)},c.prototype.getNormal=function(a,b){var c=3*a;return b.set(this.normals[c],this.normals[c+1],this.normals[c+2])};var r=new g;c.prototype.calculateLocalInertia=function(a,b){this.computeLocalAABB(r);var c=r.upperBound.x-r.lowerBound.x,d=r.upperBound.y-r.lowerBound.y,e=r.upperBound.z-r.lowerBound.z;return b.set(1/12*a*(2*d*2*d+2*e*2*e),1/12*a*(2*c*2*c+2*e*2*e),1/12*a*(2*d*2*d+2*c*2*c))};var s=new e;c.prototype.computeLocalAABB=function(a){var b=a.lowerBound,c=a.upperBound,d=this.vertices.length,e=(this.vertices,s);this.getVertex(0,e),b.copy(e),c.copy(e);for(var f=0;f!==d;f++)this.getVertex(f,e),e.x<b.x?b.x=e.x:e.x>c.x&&(c.x=e.x),e.y<b.y?b.y=e.y:e.y>c.y&&(c.y=e.y),e.z<b.z?b.z=e.z:e.z>c.z&&(c.z=e.z)},c.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},c.prototype.updateBoundingSphereRadius=function(){for(var a=0,b=this.vertices,c=new e,d=0,f=b.length/3;d!==f;d++){this.getVertex(d,c);var g=c.norm2();g>a&&(a=g)}this.boundingSphereRadius=Math.sqrt(a)};var t=(new e,new f),u=new g;c.prototype.calculateWorldAABB=function(a,b,c,d){var e=t,f=u;e.position=a,e.quaternion=b,this.aabb.toWorldFrame(e,f),c.copy(f.lowerBound),d.copy(f.upperBound)},c.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},c.createTorus=function(a,b,d,e,f){a=a||1,b=b||.5,d=d||8,e=e||6,f=f||2*Math.PI;for(var g=[],h=[],i=0;d>=i;i++)for(var j=0;e>=j;j++){var k=j/e*f,l=i/d*Math.PI*2,m=(a+b*Math.cos(l))*Math.cos(k),n=(a+b*Math.cos(l))*Math.sin(k),o=b*Math.sin(l);g.push(m,n,o)}for(var i=1;d>=i;i++)for(var j=1;e>=j;j++){var p=(e+1)*i+j-1,q=(e+1)*(i-1)+j-1,r=(e+1)*(i-1)+j,s=(e+1)*i+j;h.push(p,q,s),h.push(q,r,s)}return new c(g,h)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(a,b){function c(){d.call(this),this.iterations=10,this.tolerance=1e-7}b.exports=c;var d=(a("../math/Vec3"),a("../math/Quaternion"),a("./Solver"));c.prototype=new d;var e=[],f=[],g=[];c.prototype.solve=function(a,b){var c,d,h,i,j,k,l=0,m=this.iterations,n=this.tolerance*this.tolerance,o=this.equations,p=o.length,q=b.bodies,r=q.length,s=a;if(0!==p)for(var t=0;t!==r;t++)q[t].updateSolveMassProperties();var u=f,v=g,w=e;
u.length=p,v.length=p,w.length=p;for(var t=0;t!==p;t++){var x=o[t];w[t]=0,v[t]=x.computeB(s),u[t]=1/x.computeC()}if(0!==p){for(var t=0;t!==r;t++){var y=q[t],z=y.vlambda,A=y.wlambda;z.set(0,0,0),A&&A.set(0,0,0)}for(l=0;l!==m;l++){i=0;for(var B=0;B!==p;B++){var x=o[B];c=v[B],d=u[B],k=w[B],j=x.computeGWlambda(),h=d*(c-j-x.eps*k),k+h<x.minForce?h=x.minForce-k:k+h>x.maxForce&&(h=x.maxForce-k),w[B]+=h,i+=h>0?h:-h,x.addToWlambda(h)}if(n>i*i)break}for(var t=0;t!==r;t++){var y=q[t],C=y.velocity,D=y.angularVelocity;C.vadd(y.vlambda,C),D&&D.vadd(y.wlambda,D)}}return l}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(a,b){function c(){this.equations=[]}b.exports=c,c.prototype.solve=function(){return 0},c.prototype.addEquation=function(a){a.enabled&&this.equations.push(a)},c.prototype.removeEquation=function(a){var b=this.equations,c=b.indexOf(a);-1!==c&&b.splice(c,1)},c.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(a,b){function c(a){for(h.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=a,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}function d(a){for(var b=a.length,c=0;c!==b;c++){var d=a[c];if(!(d.visited||d.body.type&m))return d}return!1}function e(a,b,c,e){for(n.push(a),a.visited=!0,b(a,c,e);n.length;)for(var f,g=n.pop();f=d(g.children);)f.visited=!0,b(f,c,e),n.push(f)}function f(a,b,c){b.push(a.body);for(var d=a.eqs.length,e=0;e!==d;e++){var f=a.eqs[e];-1===c.indexOf(f)&&c.push(f)}}function g(a,b){return b.id-a.id}b.exports=c;var h=(a("../math/Vec3"),a("../math/Quaternion"),a("./Solver")),i=a("../objects/Body");c.prototype=new h;var j=[],k=[],l={bodies:[]},m=i.STATIC,n=[];c.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},c.prototype.solve=function(a,b){for(var c=j,h=this.nodePool,i=b.bodies,m=this.equations,n=m.length,o=i.length,p=this.subsolver;h.length<o;)h.push(this.createNode());c.length=o;for(var q=0;o>q;q++)c[q]=h[q];for(var q=0;q!==o;q++){var r=c[q];r.body=i[q],r.children.length=0,r.eqs.length=0,r.visited=!1}for(var s=0;s!==n;s++){var t=m[s],q=i.indexOf(t.bi),u=i.indexOf(t.bj),v=c[q],w=c[u];v.children.push(w),v.eqs.push(t),w.children.push(v),w.eqs.push(t)}var x,y=0,z=k;p.tolerance=this.tolerance,p.iterations=this.iterations;for(var A=l;x=d(c);){z.length=0,A.bodies.length=0,e(x,f,A.bodies,z);var B=z.length;z=z.sort(g);for(var q=0;q!==B;q++)p.addEquation(z[q]);{p.solve(a,A)}p.removeAllEquations(),y++}return y}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(a,b){var c=function(){};b.exports=c,c.prototype={constructor:c,addEventListener:function(a,b){void 0===this._listeners&&(this._listeners={});var c=this._listeners;return void 0===c[a]&&(c[a]=[]),-1===c[a].indexOf(b)&&c[a].push(b),this},hasEventListener:function(a,b){if(void 0===this._listeners)return!1;var c=this._listeners;return void 0!==c[a]&&-1!==c[a].indexOf(b)?!0:!1},removeEventListener:function(a,b){if(void 0===this._listeners)return this;var c=this._listeners;if(void 0===c[a])return this;var d=c[a].indexOf(b);return-1!==d&&c[a].splice(d,1),this},dispatchEvent:function(a){if(void 0===this._listeners)return this;var b=this._listeners,c=b[a.type];if(void 0!==c){a.target=this;for(var d=0,e=c.length;e>d;d++)c[d].call(this,a)}return this}}},{}],50:[function(a,b){function c(a){a=a||{},this.root=a.root||null,this.aabb=a.aabb?a.aabb.clone():new e,this.data=[],this.children=[]}function d(a,b){b=b||{},b.root=null,b.aabb=a,c.call(this,b),this.maxDepth="undefined"!=typeof b.maxDepth?b.maxDepth:8}var e=a("../collision/AABB"),f=a("../math/Vec3");b.exports=d,d.prototype=new c,c.prototype.reset=function(){this.children.length=this.data.length=0},c.prototype.insert=function(a,b,c){var d=this.data;if(c=c||0,!this.aabb.contains(a))return!1;var e=this.children;if(c<(this.maxDepth||this.root.maxDepth)){var f=!1;e.length||(this.subdivide(),f=!0);for(var g=0;8!==g;g++)if(e[g].insert(a,b,c+1))return!0;f&&(e.length=0)}return d.push(b),!0};var g=new f;c.prototype.subdivide=function(){var a=this.aabb,b=a.lowerBound,d=a.upperBound,h=this.children;h.push(new c({aabb:new e({lowerBound:new f(0,0,0)})}),new c({aabb:new e({lowerBound:new f(1,0,0)})}),new c({aabb:new e({lowerBound:new f(1,1,0)})}),new c({aabb:new e({lowerBound:new f(1,1,1)})}),new c({aabb:new e({lowerBound:new f(0,1,1)})}),new c({aabb:new e({lowerBound:new f(0,0,1)})}),new c({aabb:new e({lowerBound:new f(1,0,1)})}),new c({aabb:new e({lowerBound:new f(0,1,0)})})),d.vsub(b,g),g.scale(.5,g);for(var i=this.root||this,j=0;8!==j;j++){var k=h[j];k.root=i;var l=k.aabb.lowerBound;l.x*=g.x,l.y*=g.y,l.z*=g.z,l.vadd(b,l),l.vadd(g,k.aabb.upperBound)}},c.prototype.aabbQuery=function(a,b){for(var c=(this.data,this.children,[this]);c.length;){var d=c.pop();d.aabb.overlaps(a)&&Array.prototype.push.apply(b,d.data),Array.prototype.push.apply(c,d.children)}return b};var h=new e;c.prototype.rayQuery=function(a,b,c){return a.getAABB(h),h.toLocalFrame(b,h),this.aabbQuery(h,c),c},c.prototype.removeEmptyNodes=function(){for(var a=[this];a.length;){for(var b=a.pop(),c=b.children.length-1;c>=0;c--)b.children[c].data.length||b.children.splice(c,1);Array.prototype.push.apply(a,b.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(a,b){function c(){this.objects=[],this.type=Object}b.exports=c,c.prototype.release=function(){for(var a=arguments.length,b=0;b!==a;b++)this.objects.push(arguments[b])},c.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},c.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(a,b){function c(){this.data={keys:[]}}b.exports=c,c.prototype.get=function(a,b){if(a>b){var c=b;b=a,a=c}return this.data[a+"-"+b]},c.prototype.set=function(a,b,c){if(a>b){var d=b;b=a,a=d}var e=a+"-"+b;this.get(a,b)||this.data.keys.push(e),this.data[e]=c},c.prototype.reset=function(){for(var a=this.data,b=a.keys;b.length>0;){var c=b.pop();delete a[c]}}},{}],53:[function(a,b){function c(){}b.exports=c,c.defaults=function(a,b){a=a||{};for(var c in b)c in a||(a[c]=b[c]);return a}},{}],54:[function(a,b){function c(){e.call(this),this.type=d}b.exports=c;var d=a("../math/Vec3"),e=a("./Pool");c.prototype=new e,c.prototype.constructObject=function(){return new d}},{"../math/Vec3":30,"./Pool":51}],55:[function(a,b){function c(a){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new k,this.world=a,this.currentContactMaterial=null,this.enableFrictionReduction=!1}function d(a,b,c){for(var d=null,e=a.length,f=0;f!==e;f++){var g=a[f],h=O;a[(f+1)%e].vsub(g,h);var i=P;h.cross(b,i);var j=Q;c.vsub(g,j);var k=i.dot(j);if(!(null===d||k>0&&d===!0||0>=k&&d===!1))return!1;null===d&&(d=k>0)}return!0}b.exports=c;var e=a("../collision/AABB"),f=a("../shapes/Shape"),g=a("../collision/Ray"),h=a("../math/Vec3"),i=a("../math/Transform"),j=(a("../shapes/ConvexPolyhedron"),a("../math/Quaternion")),k=(a("../solver/Solver"),a("../utils/Vec3Pool")),l=a("../equations/ContactEquation"),m=a("../equations/FrictionEquation");c.prototype.createContactEquation=function(a,b,c,d,e,f){var g;this.contactPointPool.length?(g=this.contactPointPool.pop(),g.bi=a,g.bj=b):g=new l(a,b),g.enabled=a.collisionResponse&&b.collisionResponse&&c.collisionResponse&&d.collisionResponse;var h=this.currentContactMaterial;g.restitution=h.restitution,g.setSpookParams(h.contactEquationStiffness,h.contactEquationRelaxation,this.world.dt);var i=c.material||a.material,j=d.material||b.material;return i&&j&&i.restitution>=0&&j.restitution>=0&&(g.restitution=i.restitution*j.restitution),g.si=e||c,g.sj=f||d,g},c.prototype.createFrictionEquationsFromContact=function(a,b){var c=a.bi,d=a.bj,e=a.si,f=a.sj,g=this.world,h=this.currentContactMaterial,i=h.friction,j=e.material||c.material,k=f.material||d.material;if(j&&k&&j.friction>=0&&k.friction>=0&&(i=j.friction*k.friction),i>0){var l=i*g.gravity.length(),n=c.invMass+d.invMass;n>0&&(n=1/n);var o=this.frictionEquationPool,p=o.length?o.pop():new m(c,d,l*n),q=o.length?o.pop():new m(c,d,l*n);return p.bi=q.bi=c,p.bj=q.bj=d,p.minForce=q.minForce=-l*n,p.maxForce=q.maxForce=l*n,p.ri.copy(a.ri),p.rj.copy(a.rj),q.ri.copy(a.ri),q.rj.copy(a.rj),a.ni.tangents(p.t,q.t),p.setSpookParams(h.frictionEquationStiffness,h.frictionEquationRelaxation,g.dt),q.setSpookParams(h.frictionEquationStiffness,h.frictionEquationRelaxation,g.dt),p.enabled=q.enabled=a.enabled,b.push(p,q),!0}return!1};var n=new h,o=new h,p=new h;c.prototype.createFrictionFromAverage=function(a){var b=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(b,this.frictionResult)&&1!==a){var c=this.frictionResult[this.frictionResult.length-2],d=this.frictionResult[this.frictionResult.length-1];n.setZero(),o.setZero(),p.setZero();for(var e=b.bi,f=(b.bj,0);f!==a;f++)b=this.result[this.result.length-1-f],b.bodyA!==e?(n.vadd(b.ni,n),o.vadd(b.ri,o),p.vadd(b.rj,p)):(n.vsub(b.ni,n),o.vadd(b.rj,o),p.vadd(b.ri,p));var g=1/a;o.scale(g,c.ri),p.scale(g,c.rj),d.ri.copy(c.ri),d.rj.copy(c.rj),n.normalize(),n.tangents(c.t,d.t)}};var q=new h,r=new h,s=new j,t=new j;c.prototype.getContacts=function(a,b,c,d,e,f,g){this.contactPointPool=e,this.frictionEquationPool=g,this.result=d,this.frictionResult=f;for(var h=s,i=t,j=q,k=r,l=0,m=a.length;l!==m;l++){var n=a[l],o=b[l],p=null;n.material&&o.material&&(p=c.getContactMaterial(n.material,o.material)||null);for(var u=0;u<n.shapes.length;u++){n.quaternion.mult(n.shapeOrientations[u],h),n.quaternion.vmult(n.shapeOffsets[u],j),j.vadd(n.position,j);for(var v=n.shapes[u],w=0;w<o.shapes.length;w++){o.quaternion.mult(o.shapeOrientations[w],i),o.quaternion.vmult(o.shapeOffsets[w],k),k.vadd(o.position,k);var x=o.shapes[w];if(!(j.distanceTo(k)>v.boundingSphereRadius+x.boundingSphereRadius)){var y=null;v.material&&x.material&&(y=c.getContactMaterial(v.material,x.material)||null),this.currentContactMaterial=y||p||c.defaultContactMaterial;var z=this[v.type|x.type];z&&(v.type<x.type?z.call(this,v,x,j,k,h,i,n,o,v,x):z.call(this,x,v,k,j,i,h,o,n,v,x))}}}}};c.prototype[f.types.BOX|f.types.BOX]=c.prototype.boxBox=function(a,b,c,d,e,f,g,h){a.convexPolyhedronRepresentation.material=a.material,b.convexPolyhedronRepresentation.material=b.material,a.convexPolyhedronRepresentation.collisionResponse=a.collisionResponse,b.convexPolyhedronRepresentation.collisionResponse=b.collisionResponse,this.convexConvex(a.convexPolyhedronRepresentation,b.convexPolyhedronRepresentation,c,d,e,f,g,h,a,b)},c.prototype[f.types.BOX|f.types.CONVEXPOLYHEDRON]=c.prototype.boxConvex=function(a,b,c,d,e,f,g,h){a.convexPolyhedronRepresentation.material=a.material,a.convexPolyhedronRepresentation.collisionResponse=a.collisionResponse,this.convexConvex(a.convexPolyhedronRepresentation,b,c,d,e,f,g,h,a,b)},c.prototype[f.types.BOX|f.types.PARTICLE]=c.prototype.boxParticle=function(a,b,c,d,e,f,g,h){a.convexPolyhedronRepresentation.material=a.material,a.convexPolyhedronRepresentation.collisionResponse=a.collisionResponse,this.convexParticle(a.convexPolyhedronRepresentation,b,c,d,e,f,g,h,a,b)},c.prototype[f.types.SPHERE]=c.prototype.sphereSphere=function(a,b,c,d,e,f,g,h){var i=this.createContactEquation(g,h,a,b);d.vsub(c,i.ni),i.ni.normalize(),i.ri.copy(i.ni),i.rj.copy(i.ni),i.ri.mult(a.radius,i.ri),i.rj.mult(-b.radius,i.rj),i.ri.vadd(c,i.ri),i.ri.vsub(g.position,i.ri),i.rj.vadd(d,i.rj),i.rj.vsub(h.position,i.rj),this.result.push(i),this.createFrictionEquationsFromContact(i,this.frictionResult)};var u=new h,v=new h,w=new h;c.prototype[f.types.PLANE|f.types.TRIMESH]=c.prototype.planeTrimesh=function(a,b,c,d,e,f,g,j){var k=new h,l=u;l.set(0,0,1),e.vmult(l,l);for(var m=0;m<b.vertices.length/3;m++){b.getVertex(m,k);var n=new h;n.copy(k),i.pointToWorldFrame(d,f,n,k);var o=v;k.vsub(c,o);var p=l.dot(o);if(0>=p){var q=this.createContactEquation(g,j,a,b);q.ni.copy(l);var r=w;l.scale(o.dot(l),r),k.vsub(r,r),q.ri.copy(r),q.ri.vsub(g.position,q.ri),q.rj.copy(k),q.rj.vsub(j.position,q.rj),this.result.push(q),this.createFrictionEquationsFromContact(q,this.frictionResult)}}};var x=new h,y=new h,z=(new h,new h),A=new h,B=new h,C=new h,D=new h,E=new h,F=new h,G=new h,H=new h,I=new h,J=new h,K=new e,L=[];c.prototype[f.types.SPHERE|f.types.TRIMESH]=c.prototype.sphereTrimesh=function(a,b,c,d,e,f,h,j){var k=B,l=C,m=D,n=E,o=F,p=G,q=K,r=A,s=y,t=L;i.pointToLocalFrame(d,f,c,o);var u=a.radius;q.lowerBound.set(o.x-u,o.y-u,o.z-u),q.upperBound.set(o.x+u,o.y+u,o.z+u),b.getTrianglesInAABB(q,t);for(var v=z,w=a.radius*a.radius,M=0;M<t.length;M++)for(var N=0;3>N;N++)if(b.getVertex(b.indices[3*t[M]+N],v),v.vsub(o,s),s.norm2()<=w){r.copy(v),i.pointToWorldFrame(d,f,r,v),v.vsub(c,s);var O=this.createContactEquation(h,j,a,b);O.ni.copy(s),O.ni.normalize(),O.ri.copy(O.ni),O.ri.scale(a.radius,O.ri),O.ri.vadd(c,O.ri),O.ri.vsub(h.position,O.ri),O.rj.copy(v),O.rj.vsub(j.position,O.rj),this.result.push(O),this.createFrictionEquationsFromContact(O,this.frictionResult)}for(var M=0;M<t.length;M++)for(var N=0;3>N;N++){b.getVertex(b.indices[3*t[M]+N],k),b.getVertex(b.indices[3*t[M]+(N+1)%3],l),l.vsub(k,m),o.vsub(l,p);var P=p.dot(m);o.vsub(k,p);var Q=p.dot(m);if(Q>0&&0>P){o.vsub(k,p),n.copy(m),n.normalize(),Q=p.dot(n),n.scale(Q,p),p.vadd(k,p);var R=p.distanceTo(o);if(R<a.radius){var O=this.createContactEquation(h,j,a,b);p.vsub(o,O.ni),O.ni.normalize(),O.ni.scale(a.radius,O.ri),i.pointToWorldFrame(d,f,p,p),p.vsub(j.position,O.rj),i.vectorToWorldFrame(f,O.ni,O.ni),i.vectorToWorldFrame(f,O.ri,O.ri),this.result.push(O),this.createFrictionEquationsFromContact(O,this.frictionResult)}}}for(var S=H,T=I,U=J,V=x,M=0,W=t.length;M!==W;M++){b.getTriangleVertices(t[M],S,T,U),b.getNormal(t[M],V),o.vsub(S,p);var R=p.dot(V);if(V.scale(R,p),o.vsub(p,p),R=p.distanceTo(o),g.pointInTriangle(p,S,T,U)&&R<a.radius){var O=this.createContactEquation(h,j,a,b);p.vsub(o,O.ni),O.ni.normalize(),O.ni.scale(a.radius,O.ri),i.pointToWorldFrame(d,f,p,p),p.vsub(j.position,O.rj),i.vectorToWorldFrame(f,O.ni,O.ni),i.vectorToWorldFrame(f,O.ri,O.ri),this.result.push(O),this.createFrictionEquationsFromContact(O,this.frictionResult)}}t.length=0};var M=new h,N=new h;c.prototype[f.types.SPHERE|f.types.PLANE]=c.prototype.spherePlane=function(a,b,c,d,e,f,g,h){var i=this.createContactEquation(g,h,a,b);if(i.ni.set(0,0,1),f.vmult(i.ni,i.ni),i.ni.negate(i.ni),i.ni.normalize(),i.ni.mult(a.radius,i.ri),c.vsub(d,M),i.ni.mult(i.ni.dot(M),N),M.vsub(N,i.rj),-M.dot(i.ni)<=a.radius){var j=i.ri,k=i.rj;j.vadd(c,j),j.vsub(g.position,j),k.vadd(d,k),k.vsub(h.position,k),this.result.push(i),this.createFrictionEquationsFromContact(i,this.frictionResult)}};var O=new h,P=new h,Q=new h,R=new h,S=new h,T=new h,U=new h,V=[new h,new h,new h,new h,new h,new h],W=new h,X=new h,Y=new h,Z=new h;c.prototype[f.types.SPHERE|f.types.BOX]=c.prototype.sphereBox=function(a,b,c,d,e,f,g,h){var i=this.v3pool,j=V;c.vsub(d,R),b.getSideNormals(j,f);for(var k=a.radius,l=!1,m=X,n=Y,o=Z,p=null,q=0,r=0,s=0,t=null,u=0,v=j.length;u!==v&&l===!1;u++){var w=S;w.copy(j[u]);var x=w.norm();w.normalize();var y=R.dot(w);if(x+k>y&&y>0){var z=T,A=U;z.copy(j[(u+1)%3]),A.copy(j[(u+2)%3]);var B=z.norm(),C=A.norm();z.normalize(),A.normalize();var D=R.dot(z),E=R.dot(A);if(B>D&&D>-B&&C>E&&E>-C){var F=Math.abs(y-x-k);(null===t||t>F)&&(t=F,r=D,s=E,p=x,m.copy(w),n.copy(z),o.copy(A),q++)}}}if(q){l=!0;var G=this.createContactEquation(g,h,a,b);m.mult(-k,G.ri),G.ni.copy(m),G.ni.negate(G.ni),m.mult(p,m),n.mult(r,n),m.vadd(n,m),o.mult(s,o),m.vadd(o,G.rj),G.ri.vadd(c,G.ri),G.ri.vsub(g.position,G.ri),G.rj.vadd(d,G.rj),G.rj.vsub(h.position,G.rj),this.result.push(G),this.createFrictionEquationsFromContact(G,this.frictionResult)}for(var H=i.get(),I=W,J=0;2!==J&&!l;J++)for(var K=0;2!==K&&!l;K++)for(var L=0;2!==L&&!l;L++)if(H.set(0,0,0),J?H.vadd(j[0],H):H.vsub(j[0],H),K?H.vadd(j[1],H):H.vsub(j[1],H),L?H.vadd(j[2],H):H.vsub(j[2],H),d.vadd(H,I),I.vsub(c,I),I.norm2()<k*k){l=!0;var G=this.createContactEquation(g,h,a,b);G.ri.copy(I),G.ri.normalize(),G.ni.copy(G.ri),G.ri.mult(k,G.ri),G.rj.copy(H),G.ri.vadd(c,G.ri),G.ri.vsub(g.position,G.ri),G.rj.vadd(d,G.rj),G.rj.vsub(h.position,G.rj),this.result.push(G),this.createFrictionEquationsFromContact(G,this.frictionResult)}i.release(H),H=null;for(var M=i.get(),N=i.get(),G=i.get(),O=i.get(),F=i.get(),P=j.length,J=0;J!==P&&!l;J++)for(var K=0;K!==P&&!l;K++)if(J%3!==K%3){j[K].cross(j[J],M),M.normalize(),j[J].vadd(j[K],N),G.copy(c),G.vsub(N,G),G.vsub(d,G);var Q=G.dot(M);M.mult(Q,O);for(var L=0;L===J%3||L===K%3;)L++;F.copy(c),F.vsub(O,F),F.vsub(N,F),F.vsub(d,F);var $=Math.abs(Q),_=F.norm();if($<j[L].norm()&&k>_){l=!0;var ab=this.createContactEquation(g,h,a,b);N.vadd(O,ab.rj),ab.rj.copy(ab.rj),F.negate(ab.ni),ab.ni.normalize(),ab.ri.copy(ab.rj),ab.ri.vadd(d,ab.ri),ab.ri.vsub(c,ab.ri),ab.ri.normalize(),ab.ri.mult(k,ab.ri),ab.ri.vadd(c,ab.ri),ab.ri.vsub(g.position,ab.ri),ab.rj.vadd(d,ab.rj),ab.rj.vsub(h.position,ab.rj),this.result.push(ab),this.createFrictionEquationsFromContact(ab,this.frictionResult)}}i.release(M,N,G,O,F)};var $=new h,_=new h,ab=new h,bb=new h,cb=new h,db=new h,eb=new h,fb=new h,gb=new h,hb=new h;c.prototype[f.types.SPHERE|f.types.CONVEXPOLYHEDRON]=c.prototype.sphereConvex=function(a,b,c,e,f,g,h,i){var j=this.v3pool;c.vsub(e,$);for(var k=b.faceNormals,l=b.faces,m=b.vertices,n=a.radius,o=0;o!==m.length;o++){var p=m[o],q=cb;g.vmult(p,q),e.vadd(q,q);var r=bb;if(q.vsub(c,r),r.norm2()<n*n){t=!0;var s=this.createContactEquation(h,i,a,b);return s.ri.copy(r),s.ri.normalize(),s.ni.copy(s.ri),s.ri.mult(n,s.ri),q.vsub(e,s.rj),s.ri.vadd(c,s.ri),s.ri.vsub(h.position,s.ri),s.rj.vadd(e,s.rj),s.rj.vsub(i.position,s.rj),this.result.push(s),void this.createFrictionEquationsFromContact(s,this.frictionResult)}}for(var t=!1,o=0,u=l.length;o!==u&&t===!1;o++){var v=k[o],w=l[o],x=db;g.vmult(v,x);var y=eb;g.vmult(m[w[0]],y),y.vadd(e,y);var z=fb;x.mult(-n,z),c.vadd(z,z);var A=gb;z.vsub(y,A);var B=A.dot(x),C=hb;if(c.vsub(y,C),0>B&&C.dot(x)>0){for(var D=[],E=0,F=w.length;E!==F;E++){var G=j.get();g.vmult(m[w[E]],G),e.vadd(G,G),D.push(G)}if(d(D,x,c)){t=!0;var s=this.createContactEquation(h,i,a,b);x.mult(-n,s.ri),x.negate(s.ni);var H=j.get();x.mult(-B,H);var I=j.get();x.mult(-n,I),c.vsub(e,s.rj),s.rj.vadd(I,s.rj),s.rj.vadd(H,s.rj),s.rj.vadd(e,s.rj),s.rj.vsub(i.position,s.rj),s.ri.vadd(c,s.ri),s.ri.vsub(h.position,s.ri),j.release(H),j.release(I),this.result.push(s),this.createFrictionEquationsFromContact(s,this.frictionResult);for(var E=0,J=D.length;E!==J;E++)j.release(D[E]);return}for(var E=0;E!==w.length;E++){var K=j.get(),L=j.get();g.vmult(m[w[(E+1)%w.length]],K),g.vmult(m[w[(E+2)%w.length]],L),e.vadd(K,K),e.vadd(L,L);var M=_;L.vsub(K,M);var N=ab;M.unit(N);var O=j.get(),P=j.get();c.vsub(K,P);var Q=P.dot(N);N.mult(Q,O),O.vadd(K,O);var R=j.get();if(O.vsub(c,R),Q>0&&Q*Q<M.norm2()&&R.norm2()<n*n){var s=this.createContactEquation(h,i,a,b);O.vsub(e,s.rj),O.vsub(c,s.ni),s.ni.normalize(),s.ni.mult(n,s.ri),s.rj.vadd(e,s.rj),s.rj.vsub(i.position,s.rj),s.ri.vadd(c,s.ri),s.ri.vsub(h.position,s.ri),this.result.push(s),this.createFrictionEquationsFromContact(s,this.frictionResult);for(var E=0,J=D.length;E!==J;E++)j.release(D[E]);return j.release(K),j.release(L),j.release(O),j.release(R),void j.release(P)}j.release(K),j.release(L),j.release(O),j.release(R),j.release(P)}for(var E=0,J=D.length;E!==J;E++)j.release(D[E])}}};new h,new h;c.prototype[f.types.PLANE|f.types.BOX]=c.prototype.planeBox=function(a,b,c,d,e,f,g,h){b.convexPolyhedronRepresentation.material=b.material,b.convexPolyhedronRepresentation.collisionResponse=b.collisionResponse,this.planeConvex(a,b.convexPolyhedronRepresentation,c,d,e,f,g,h)};var ib=new h,jb=new h,kb=new h,lb=new h;c.prototype[f.types.PLANE|f.types.CONVEXPOLYHEDRON]=c.prototype.planeConvex=function(a,b,c,d,e,f,g,h){var i=ib,j=jb;j.set(0,0,1),e.vmult(j,j);for(var k=0,l=kb,m=0;m!==b.vertices.length;m++){i.copy(b.vertices[m]),f.vmult(i,i),d.vadd(i,i),i.vsub(c,l);var n=j.dot(l);if(0>=n){var o=this.createContactEquation(g,h,a,b),p=lb;j.mult(j.dot(l),p),i.vsub(p,p),p.vsub(c,o.ri),o.ni.copy(j),i.vsub(d,o.rj),o.ri.vadd(c,o.ri),o.ri.vsub(g.position,o.ri),o.rj.vadd(d,o.rj),o.rj.vsub(h.position,o.rj),this.result.push(o),k++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(o,this.frictionResult)}}this.enableFrictionReduction&&k&&this.createFrictionFromAverage(k)};var mb=new h,nb=new h;c.prototype[f.types.CONVEXPOLYHEDRON]=c.prototype.convexConvex=function(a,b,c,d,e,f,g,h,i,j,k,l){var m=mb;if(!(c.distanceTo(d)>a.boundingSphereRadius+b.boundingSphereRadius)&&a.findSeparatingAxis(b,c,e,d,f,m,k,l)){var n=[],o=nb;a.clipAgainstHull(c,e,b,d,f,m,-100,100,n);for(var p=0,q=0;q!==n.length;q++){var r=this.createContactEquation(g,h,a,b,i,j),s=r.ri,t=r.rj;m.negate(r.ni),n[q].normal.negate(o),o.mult(n[q].depth,o),n[q].point.vadd(o,s),t.copy(n[q].point),s.vsub(c,s),t.vsub(d,t),s.vadd(c,s),s.vsub(g.position,s),t.vadd(d,t),t.vsub(h.position,t),this.result.push(r),p++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(r,this.frictionResult)}this.enableFrictionReduction&&p&&this.createFrictionFromAverage(p)}};var ob=new h,pb=new h,qb=new h;c.prototype[f.types.PLANE|f.types.PARTICLE]=c.prototype.planeParticle=function(a,b,c,d,e,f,g,h){var i=ob;i.set(0,0,1),g.quaternion.vmult(i,i);var j=pb;d.vsub(g.position,j);var k=i.dot(j);if(0>=k){var l=this.createContactEquation(h,g,b,a);l.ni.copy(i),l.ni.negate(l.ni),l.ri.set(0,0,0);var m=qb;i.mult(i.dot(d),m),d.vsub(m,m),l.rj.copy(m),this.result.push(l),this.createFrictionEquationsFromContact(l,this.frictionResult)}};var rb=new h;c.prototype[f.types.PARTICLE|f.types.SPHERE]=c.prototype.sphereParticle=function(a,b,c,d,e,f,g,h){var i=rb;i.set(0,0,1),d.vsub(c,i);var j=i.norm2();if(j<=a.radius*a.radius){var k=this.createContactEquation(h,g,b,a);i.normalize(),k.rj.copy(i),k.rj.mult(a.radius,k.rj),k.ni.copy(i),k.ni.negate(k.ni),k.ri.set(0,0,0),this.result.push(k),this.createFrictionEquationsFromContact(k,this.frictionResult)}};var sb=new j,tb=new h,ub=(new h,new h),vb=new h,wb=new h;c.prototype[f.types.PARTICLE|f.types.CONVEXPOLYHEDRON]=c.prototype.convexParticle=function(a,b,c,d,e,f,g,h){var i=-1,j=ub,k=wb,l=null,m=0,n=tb;if(n.copy(d),n.vsub(c,n),e.conjugate(sb),sb.vmult(n,n),a.pointIsInside(n)){a.worldVerticesNeedsUpdate&&a.computeWorldVertices(c,e),a.worldFaceNormalsNeedsUpdate&&a.computeWorldFaceNormals(e);for(var o=0,p=a.faces.length;o!==p;o++){var q=[a.worldVertices[a.faces[o][0]]],r=a.worldFaceNormals[o];d.vsub(q[0],vb);var s=-r.dot(vb);(null===l||Math.abs(s)<Math.abs(l))&&(l=s,i=o,j.copy(r),m++)}if(-1!==i){var t=this.createContactEquation(h,g,b,a);j.mult(l,k),k.vadd(d,k),k.vsub(c,k),t.rj.copy(k),j.negate(t.ni),t.ri.set(0,0,0);var u=t.ri,v=t.rj;u.vadd(d,u),u.vsub(h.position,u),v.vadd(c,v),v.vsub(g.position,v),this.result.push(t),this.createFrictionEquationsFromContact(t,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},c.prototype[f.types.BOX|f.types.HEIGHTFIELD]=c.prototype.boxHeightfield=function(a,b,c,d,e,f,g,h){a.convexPolyhedronRepresentation.material=a.material,a.convexPolyhedronRepresentation.collisionResponse=a.collisionResponse,this.convexHeightfield(a.convexPolyhedronRepresentation,b,c,d,e,f,g,h)};var xb=new h,yb=new h,zb=[0];c.prototype[f.types.CONVEXPOLYHEDRON|f.types.HEIGHTFIELD]=c.prototype.convexHeightfield=function(a,b,c,d,e,f,g,h){var j=b.data,k=b.elementSize,l=a.boundingSphereRadius,m=yb,n=zb,o=xb;i.pointToLocalFrame(d,f,c,o);var p=Math.floor((o.x-l)/k)-1,q=Math.ceil((o.x+l)/k)+1,r=Math.floor((o.y-l)/k)-1,s=Math.ceil((o.y+l)/k)+1;if(!(0>q||0>s||p>j.length||r>j[0].length)){0>p&&(p=0),0>q&&(q=0),0>r&&(r=0),0>s&&(s=0),p>=j.length&&(p=j.length-1),q>=j.length&&(q=j.length-1),s>=j[0].length&&(s=j[0].length-1),r>=j[0].length&&(r=j[0].length-1);var t=[];b.getRectMinMax(p,r,q,s,t);var u=t[0],v=t[1];if(!(o.z-l>v||o.z+l<u))for(var w=p;q>w;w++)for(var x=r;s>x;x++)b.getConvexTrianglePillar(w,x,!1),i.pointToWorldFrame(d,f,b.pillarOffset,m),c.distanceTo(m)<b.pillarConvex.boundingSphereRadius+a.boundingSphereRadius&&this.convexConvex(a,b.pillarConvex,c,m,e,f,g,h,null,null,n,null),b.getConvexTrianglePillar(w,x,!0),i.pointToWorldFrame(d,f,b.pillarOffset,m),c.distanceTo(m)<b.pillarConvex.boundingSphereRadius+a.boundingSphereRadius&&this.convexConvex(a,b.pillarConvex,c,m,e,f,g,h,null,null,n,null)}};var Ab=new h,Bb=new h;c.prototype[f.types.SPHERE|f.types.HEIGHTFIELD]=c.prototype.sphereHeightfield=function(a,b,c,d,e,f,g,h){var j=b.data,k=a.radius,l=b.elementSize,m=Bb,n=Ab;i.pointToLocalFrame(d,f,c,n);var o=Math.floor((n.x-k)/l)-1,p=Math.ceil((n.x+k)/l)+1,q=Math.floor((n.y-k)/l)-1,r=Math.ceil((n.y+k)/l)+1;if(!(0>p||0>r||o>j.length||r>j[0].length)){0>o&&(o=0),0>p&&(p=0),0>q&&(q=0),0>r&&(r=0),o>=j.length&&(o=j.length-1),p>=j.length&&(p=j.length-1),r>=j[0].length&&(r=j[0].length-1),q>=j[0].length&&(q=j[0].length-1);var s=[];b.getRectMinMax(o,q,p,r,s);var t=s[0],u=s[1];if(!(n.z-k>u||n.z+k<t))for(var v=this.result,w=o;p>w;w++)for(var x=q;r>x;x++){var y=v.length;b.getConvexTrianglePillar(w,x,!1),i.pointToWorldFrame(d,f,b.pillarOffset,m),c.distanceTo(m)<b.pillarConvex.boundingSphereRadius+a.boundingSphereRadius&&this.sphereConvex(a,b.pillarConvex,c,m,e,f,g,h),b.getConvexTrianglePillar(w,x,!0),i.pointToWorldFrame(d,f,b.pillarOffset,m),c.distanceTo(m)<b.pillarConvex.boundingSphereRadius+a.boundingSphereRadius&&this.sphereConvex(a,b.pillarConvex,c,m,e,f,g,h);var z=v.length-y;if(z>2)return}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(a,b){function c(){i.apply(this),this.dt=-1,this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new e,this.broadphase=new r,this.bodies=[],this.solver=new g,this.constraints=[],this.narrowphase=new h(this),this.collisionMatrix=new j,this.collisionMatrixPrevious=new j,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new n,this.defaultMaterial=new k("default"),this.defaultContactMaterial=new l(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null}}b.exports=c;var d=a("../shapes/Shape"),e=a("../math/Vec3"),f=a("../math/Quaternion"),g=a("../solver/GSSolver"),h=(a("../utils/Vec3Pool"),a("../equations/ContactEquation"),a("../equations/FrictionEquation"),a("./Narrowphase")),i=a("../utils/EventTarget"),j=a("../collision/ArrayCollisionMatrix"),k=a("../material/Material"),l=a("../material/ContactMaterial"),m=a("../objects/Body"),n=a("../utils/TupleDictionary"),o=a("../collision/RaycastResult"),p=a("../collision/AABB"),q=a("../collision/Ray"),r=a("../collision/NaiveBroadphase");c.prototype=new i;var s=(new p,new q);if(c.prototype.getContactMaterial=function(a,b){return this.contactMaterialTable.get(a.id,b.id)},c.prototype.numObjects=function(){return this.bodies.length},c.prototype.collisionMatrixTick=function(){var a=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=a,this.collisionMatrix.reset()},c.prototype.add=c.prototype.addBody=function(a){-1===this.bodies.indexOf(a)&&(a.index=this.bodies.length,this.bodies.push(a),a.world=this,a.initPosition.copy(a.position),a.initVelocity.copy(a.velocity),a.timeLastSleepy=this.time,a instanceof m&&(a.initAngularVelocity.copy(a.angularVelocity),a.initQuaternion.copy(a.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=a,this.dispatchEvent(this.addBodyEvent))},c.prototype.addConstraint=function(a){this.constraints.push(a)},c.prototype.removeConstraint=function(a){var b=this.constraints.indexOf(a);-1!==b&&this.constraints.splice(b,1)},c.prototype.rayTest=function(a,b,c){c instanceof o?this.raycastClosest(a,b,{skipBackfaces:!0},c):this.raycastAll(a,b,{skipBackfaces:!0},c)},c.prototype.raycastAll=function(a,b,c,d){return c.mode=q.ALL,c.from=a,c.to=b,c.callback=d,s.intersectWorld(this,c)},c.prototype.raycastAny=function(a,b,c,d){return c.mode=q.ANY,c.from=a,c.to=b,c.result=d,s.intersectWorld(this,c)},c.prototype.raycastClosest=function(a,b,c,d){return c.mode=q.CLOSEST,c.from=a,c.to=b,c.result=d,s.intersectWorld(this,c)},c.prototype.remove=function(a){a.world=null;var b=this.bodies.length-1,c=this.bodies,d=c.indexOf(a);if(-1!==d){c.splice(d,1);for(var e=0;e!==c.length;e++)c[e].index=e;this.collisionMatrix.setNumObjects(b),this.removeBodyEvent.body=a,this.dispatchEvent(this.removeBodyEvent)}},c.prototype.removeBody=c.prototype.remove,c.prototype.addMaterial=function(a){this.materials.push(a)},c.prototype.addContactMaterial=function(a){this.contactmaterials.push(a),this.contactMaterialTable.set(a.materials[0].id,a.materials[1].id,a)},"undefined"==typeof performance&&(performance={}),!performance.now){var t=Date.now();performance.timing&&performance.timing.navigationStart&&(t=performance.timing.navigationStart),performance.now=function(){return Date.now()-t}}var u=new e;c.prototype.step=function(a,b,c){if(c=c||10,b=b||0,0===b)this.internalStep(a),this.time+=a;else{var d=Math.floor((this.time+b)/a)-Math.floor(this.time/a);d=Math.min(d,c);for(var e=performance.now(),f=0;f!==d&&(this.internalStep(a),!(performance.now()-e>1e3*a));f++);this.time+=b;for(var g=this.time%a,h=g/a,i=u,j=this.bodies,k=0;k!==j.length;k++){var l=j[k];l.type!==m.STATIC&&l.sleepState!==m.SLEEPING?(l.position.vsub(l.previousPosition,i),i.scale(h,i),l.position.vadd(i,l.interpolatedPosition)):(l.interpolatedPosition.copy(l.position),l.interpolatedQuaternion.copy(l.quaternion))}}};var v={type:"postStep"},w={type:"preStep"},x={type:"collide",body:null,contact:null},y=[],z=[],A=[],B=[],C=(new e,new e,new e,new e,new e,new e,new e,new e,new e,new f,new f),D=new f,E=new e;c.prototype.internalStep=function(a){this.dt=a;var b,c=this.contacts,e=A,f=B,g=this.numObjects(),h=this.bodies,i=this.solver,j=this.gravity,k=this.doProfiling,l=this.profile,n=m.DYNAMIC,o=this.constraints,p=z,q=(j.norm(),j.x),r=j.y,s=j.z,t=0;for(k&&(b=performance.now()),t=0;t!==g;t++){var u=h[t];if(u.type&n){var F=u.force,G=u.mass;F.x+=G*q,F.y+=G*r,F.z+=G*s}}for(var t=0,H=this.subsystems.length;t!==H;t++)this.subsystems[t].update();k&&(b=performance.now()),e.length=0,f.length=0,this.broadphase.collisionPairs(this,e,f),k&&(l.broadphase=performance.now()-b);var I=o.length;for(t=0;t!==I;t++){var J=o[t];if(!J.collideConnected)for(var K=e.length-1;K>=0;K-=1)(J.bodyA===e[K]&&J.bodyB===f[K]||J.bodyB===e[K]&&J.bodyA===f[K])&&(e.splice(K,1),f.splice(K,1))}this.collisionMatrixTick(),k&&(b=performance.now());var L=y,M=c.length;for(t=0;t!==M;t++)L.push(c[t]);c.length=0;var N=this.frictionEquations.length;for(t=0;t!==N;t++)p.push(this.frictionEquations[t]);this.frictionEquations.length=0,this.narrowphase.getContacts(e,f,this,c,L,this.frictionEquations,p),k&&(l.narrowphase=performance.now()-b),k&&(b=performance.now());for(var t=0;t<this.frictionEquations.length;t++)i.addEquation(this.frictionEquations[t]);for(var O=c.length,P=0;P!==O;P++){{var Q,J=c[P],u=J.bi,R=J.bj;J.si,J.sj}Q=u.material&&R.material?this.getContactMaterial(u.material,R.material)||this.defaultContactMaterial:this.defaultContactMaterial;var S=Q.friction;if(u.material&&R.material&&(u.material.friction>=0&&R.material.friction>=0&&(S=u.material.friction*R.material.friction),u.material.restitution>=0&&R.material.restitution>=0&&(J.restitution=u.material.restitution*R.material.restitution)),i.addEquation(J),u.allowSleep&&u.type===m.DYNAMIC&&u.sleepState===m.SLEEPING&&R.sleepState===m.AWAKE&&R.type!==m.STATIC){var T=R.velocity.norm2()+R.angularVelocity.norm2(),U=Math.pow(R.sleepSpeedLimit,2);
T>=2*U&&(u._wakeUpAfterNarrowphase=!0)}if(R.allowSleep&&R.type===m.DYNAMIC&&R.sleepState===m.SLEEPING&&u.sleepState===m.AWAKE&&u.type!==m.STATIC){var V=u.velocity.norm2()+u.angularVelocity.norm2(),W=Math.pow(u.sleepSpeedLimit,2);V>=2*W&&(R._wakeUpAfterNarrowphase=!0)}this.collisionMatrix.set(u,R,!0),this.collisionMatrixPrevious.get(u,R)||(x.body=R,x.contact=J,u.dispatchEvent(x),x.body=u,R.dispatchEvent(x))}for(k&&(l.makeContactConstraints=performance.now()-b,b=performance.now()),t=0;t!==g;t++){var u=h[t];u._wakeUpAfterNarrowphase&&(u.wakeUp(),u._wakeUpAfterNarrowphase=!1)}var I=o.length;for(t=0;t!==I;t++){var J=o[t];J.update();for(var K=0,X=J.equations.length;K!==X;K++){var Y=J.equations[K];i.addEquation(Y)}}i.solve(a,this),k&&(l.solve=performance.now()-b),i.removeAllEquations();var Z=Math.pow;for(t=0;t!==g;t++){var u=h[t];if(u.type&n){var $=Z(1-u.linearDamping,a),_=u.velocity;_.mult($,_);var ab=u.angularVelocity;if(ab){var bb=Z(1-u.angularDamping,a);ab.mult(bb,ab)}}}for(this.dispatchEvent(w),t=0;t!==g;t++){var u=h[t];u.preStep&&u.preStep.call(u)}k&&(b=performance.now());{var cb=C,db=D,eb=this.stepnumber,fb=m.DYNAMIC|m.KINEMATIC,gb=eb%(this.quatNormalizeSkip+1)===0,hb=this.quatNormalizeFast,ib=.5*a;d.types.PLANE,d.types.CONVEXPOLYHEDRON}for(t=0;t!==g;t++){var jb=h[t],kb=jb.force,lb=jb.torque;if(jb.type&fb&&jb.sleepState!==m.SLEEPING){var mb=jb.velocity,nb=jb.angularVelocity,ob=jb.position,pb=jb.quaternion,qb=jb.invMass,rb=jb.invInertiaWorld;mb.x+=kb.x*qb*a,mb.y+=kb.y*qb*a,mb.z+=kb.z*qb*a,jb.angularVelocity&&(rb.vmult(lb,E),E.mult(a,E),E.vadd(nb,nb)),ob.x+=mb.x*a,ob.y+=mb.y*a,ob.z+=mb.z*a,jb.angularVelocity&&(cb.set(nb.x,nb.y,nb.z,0),cb.mult(pb,db),pb.x+=ib*db.x,pb.y+=ib*db.y,pb.z+=ib*db.z,pb.w+=ib*db.w,gb&&(hb?pb.normalizeFast():pb.normalize())),jb.aabb&&(jb.aabbNeedsUpdate=!0),jb.updateInertiaWorld&&jb.updateInertiaWorld()}}for(this.clearForces(),this.broadphase.dirty=!0,k&&(l.integrate=performance.now()-b),this.time+=a,this.stepnumber+=1,this.dispatchEvent(v),t=0;t!==g;t++){var u=h[t],sb=u.postStep;sb&&sb.call(u)}if(this.allowSleep)for(t=0;t!==g;t++)h[t].sleepTick(this.time)},c.prototype.clearForces=function(){for(var a=this.bodies,b=a.length,c=0;c!==b;c++){{var d=a[c];d.force,d.torque}d.force.set(0,0,0),d.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2)});