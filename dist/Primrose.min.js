/*
  Primrose v0.12.0 2015-04-24
  
  Copyright (C) 2015 Sean T. McBeth <sean@seanmcbeth.com> (https://www.seanmcbeth.com)
  https://www.primroseeditor.com
  https://github.com/capnmidnight/Primrose.git
*/
var Primrose={CodePages:{},CommandPacks:{},Controls:{},Grammars:{},OperatingSystems:{},Renderers:{},Themes:{}};Primrose.CodePage=function(){"use strict";function a(a,b,c){this.name=a,this.language=b,copyObject(this,{NORMAL:{65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z"},SHIFT:{65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z"}}),copyObject(this,c);for(var d=0;9>=d;++d){var e=Primrose.Keys["NUMPAD"+d];this.NORMAL[e]=d.toString()}}return a.DEAD=function(a){return function(b){b.setDeadKeyState("DEAD"+a)}},a}(),Primrose.CommandPack=function(){"use strict";function a(a,b){this.name=a,copyObject(this,b)}return a}(),Primrose.Control=function(){"use strict";function a(){for(var b=0;b<c.length;++b)c[b].render();requestAnimationFrame(a)}function b(){c.push(this),this.focused=!1,this.changed=!1}var c=[];return requestAnimationFrame(a),b.prototype.render=function(){this.changed=!1},b.prototype.update=function(){this.changed&&this.render()},b.prototype.forceUpdate=function(){this.changed=!0,this.update()},b.prototype.dispose=function(){for(var a=c.length-1;a>=0;--a)if(c[a]===this){c.splice(a,1);break}},b.prototype.focus=function(){for(var a=0;a<c.length;++a){var b=c[a];b!==this&&b.blur()}this.focused=!0,this.forceUpdate()},b.prototype.blur=function(){this.focused=!1,this.forceUpdate()},b}(),Primrose.Cursor=function(){"use strict";function a(a,b,c){this.i=a||0,this.x=b||0,this.y=c||0,this.moved=!0}function b(a,b){for(var c=a[b],d="",e=0;e<c.length;++e)d+=c[e].value;return d}return a.min=function(a,b){return a.i<=b.i?a:b},a.max=function(a,b){return a.i>b.i?a:b},a.prototype.toString=function(){return fmt("[i:$1 x:$2 y:$3]",this.i,this.x,this.y)},a.prototype.copy=function(a){this.i=a.i,this.x=a.x,this.y=a.y,this.moved=!1},a.prototype.fullhome=function(){this.i=0,this.x=0,this.y=0,this.moved=!0},a.prototype.fullend=function(a){this.i=0;for(var c=0,d=0;d<a.length;++d){var e=b(a,d);c=e.length,this.i+=c}this.y=a.length-1,this.x=c,this.moved=!0},a.prototype.skipleft=function(a){if(0===this.x)this.left(a);else{var c=this.x-1,d=b(a,this.y),e=reverse(d.substring(0,c)),f=e.match(/(\s|\W)+/),g=f?f.index+f[0].length+1:e.length;this.i-=g,this.x-=g}this.moved=!0},a.prototype.left=function(a){if(this.i>0){if(--this.i,--this.x,this.x<0){--this.y;var c=b(a,this.y);this.x=c.length}this.reverseFromNewline(a)&&++this.i}this.moved=!0},a.prototype.skipright=function(a){var c=b(a,this.y);if(this.x===c.length||"\n"===c[this.x])this.right(a);else{var d=this.x+1;c=c.substring(d);var e=c.match(/(\s|\W)+/),f=e?e.index+e[0].length+1:c.length-this.x;this.i+=f,this.x+=f,this.reverseFromNewline(a)}this.moved=!0},a.prototype.fixCursor=function(a){this.x=this.i,this.y=0;for(var c=0,d=b(a,this.y);this.x>d.length;){if(this.x-=d.length,c+=d.length,this.y>=a.length-1){this.i=c,this.x=d.length,this.moved=!0;break}++this.y,d=b(a,this.y)}return this.moved},a.prototype.right=function(a){this.advanceN(a,1)},a.prototype.advanceN=function(a,c){var d=b(a,this.y);(this.y<a.length-1||this.x<d.length)&&(this.i+=c,this.fixCursor(a),d=b(a,this.y),this.x>0&&"\n"===d[this.x-1]&&(++this.y,this.x=0)),this.moved=!0},a.prototype.home=function(){this.i-=this.x,this.x=0,this.moved=!0},a.prototype.end=function(a){var c=b(a,this.y),d=c.length-this.x;this.i+=d,this.x+=d,this.reverseFromNewline(a),this.moved=!0},a.prototype.up=function(a){if(this.y>0){--this.y;var c=b(a,this.y),d=Math.min(0,c.length-this.x);this.x+=d,this.i-=c.length-d,this.reverseFromNewline(a)}this.moved=!0},a.prototype.down=function(a){if(this.y<a.length-1){++this.y;var c=b(a,this.y),d=b(a,this.y-1),e=Math.min(0,c.length-this.x);this.x+=e,this.i+=d.length+e,this.reverseFromNewline(a)}this.moved=!0},a.prototype.incY=function(a,c){this.y=Math.max(0,Math.min(c.length-1,this.y+a));var d=b(c,this.y);this.x=Math.max(0,Math.min(d.length,this.x)),this.i=this.x;for(var e=0;e<this.y;++e)this.i+=b(c,e).length;this.reverseFromNewline(c),this.moved=!0},a.prototype.setXY=function(a,c,d){this.y=Math.max(0,Math.min(d.length-1,c));var e=b(d,this.y);this.x=Math.max(0,Math.min(e.length,a)),this.i=this.x;for(var f=0;f<this.y;++f)this.i+=b(d,f).length;this.reverseFromNewline(d),this.moved=!0},a.prototype.setI=function(a,b){this.i=a,this.fixCursor(b),this.moved=!0},a.prototype.reverseFromNewline=function(a){var c=b(a,this.y);return this.x>0&&"\n"===c[this.x-1]?(--this.x,--this.i,!0):!1},a}(),Primrose.Grammar=function(){"use strict";function a(a,b){function c(a){for(var b=!1,c=0,d=0;d<a.length;++d){var e=a[d];e.line=c,"newlines"===e.type&&++c,b?("endBlockComments"===e.type&&(b=!1),"newlines"!==e.type&&(e.type="comments")):"startBlockComments"===e.type&&(b=!0,e.type="comments")}}this.name=a,this.grammar=b.map(function(a){return new Primrose.Rule(a[0],a[1])}),this.tokenize=function(a){for(var b=[new Primrose.Token(a,"regular",0)],d=0;d<this.grammar.length;++d)for(var e=this.grammar[d],f=0;f<b.length;++f)e.carveOutMatchedToken(b,f);return c(b),b}}return a}(),Primrose.Keys=function(){"use strict";var a={MODIFIER_KEYS:["CTRL","ALT","META","SHIFT"],SHIFT:16,CTRL:17,ALT:18,META_L:91,META_R:92,BACKSPACE:8,TAB:9,ENTER:13,SPACE:32,DELETE:46,PAUSEBREAK:19,CAPSLOCK:20,NUMLOCK:144,SCROLLLOCK:145,INSERT:45,ESCAPE:27,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,LEFTARROW:37,UPARROW:38,RIGHTARROW:39,DOWNARROW:40,SELECTKEY:93,NUMBER0:48,NUMBER1:49,NUMBER2:50,NUMBER3:51,NUMBER4:52,NUMBER5:53,NUMBER6:54,NUMBER7:55,NUMBER8:56,NUMBER9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUMPAD0:96,NUMPAD1:97,NUMPAD2:98,NUMPAD3:99,NUMPAD4:100,NUMPAD5:101,NUMPAD6:102,NUMPAD7:103,NUMPAD8:104,NUMPAD9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMALPOINT:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123};for(var b in a){var c=a[b];a.hasOwnProperty(b)&&"number"==typeof c&&(a[c]=b)}return a}(),Primrose.OperatingSystem=function(){"use strict";function a(a,b,c,d,e){var f=b+"_"+c;a[f]=function(a,b){a["cursor"+d](b,a[e+"Cursor"])}}function b(b,c,d,e){a(b,c||"NORMAL",d,e,"front"),a(b,c+"SHIFT",d,e,"back")}function c(a,c,d,e,f,g,h,i,j,k){this.name=a,this[c+"_a"]=function(a,b){a.frontCursor.fullhome(b),a.backCursor.fullend(b),a.forceUpdate()},this[e]=function(a){a.redo(),a.scrollIntoView(a.frontCursor)},this[c+"_z"]=function(a){a.undo(),a.scrollIntoView(a.frontCursor)},this[c+"_DOWNARROW"]=function(a,b){a.scroll.y<b.length&&++a.scroll.y,a.forceUpdate()},this[c+"_UPARROW"]=function(a){a.scroll.y>0&&--a.scroll.y,a.forceUpdate()},b(this,"","LEFTARROW","Left"),b(this,"","RIGHTARROW","Right"),b(this,"","UPARROW","Up"),b(this,"","DOWNARROW","Down"),b(this,"","PAGEUP","PageUp"),b(this,"","PAGEDOWN","PageDown"),b(this,d,"LEFTARROW","SkipLeft"),b(this,d,"RIGHTARROW","SkipRight"),b(this,f,g,"Home"),b(this,f,h,"End"),b(this,i,j,"FullHome"),b(this,i,k,"FullEnd")}return c}(),Primrose.Point=function(){"use strict";function a(a,b){this.set(a||0,b||0)}return a.prototype.set=function(a,b){this.x=a,this.y=b},a.prototype.copy=function(a){a&&(this.x=a.x,this.y=a.y)},a.prototype.clone=function(){return new a(this.x,this.y)},a.prototype.toString=function(){return fmt("(x:$1, y:$2)",this.x,this.y)},a}(),Primrose.Rectangle=function(){"use strict";function a(a,b,c,d){this.point=new Primrose.Point(a,b),this.size=new Primrose.Size(c,d),Object.defineProperties(this,{x:{get:function(){return this.point.x},set:function(a){this.point.x=a}},left:{get:function(){return this.point.x},set:function(a){this.point.x=a}},width:{get:function(){return this.size.width},set:function(a){this.size.width=a}},right:{get:function(){return this.point.x+this.size.width},set:function(a){this.point.x=a-this.size.width}},y:{get:function(){return this.point.y},set:function(a){this.point.y=a}},top:{get:function(){return this.point.y},set:function(a){this.point.y=a}},height:{get:function(){return this.size.height},set:function(a){this.size.height=a}},bottom:{get:function(){return this.point.y+this.size.height},set:function(a){this.point.y=a-this.size.height}}})}return a.prototype.set=function(a,b,c,d){this.point.set(a,b),this.size.set(c,d)},a.prototype.copy=function(a){a&&(this.point.copy(a.point),this.size.copy(a.size))},a.prototype.clone=function(){return new a(this.point.x,this.point.y,this.size.width,this.size.height)},a.prototype.toString=function(){return fmt("[$1 x $2]",this.point.toString(),this.size.toString())},a}(),Primrose.Rule=function(){"use strict";function a(a,b){this.name=a,this.test=b}return a.prototype.carveOutMatchedToken=function(a,b){var c=a[b];if("regular"===c.type){var d=this.test.exec(c.value);if(d){for(var e=d[d.length-1],f=d.index,g=1;g<d.length-1;++g)f+=d[g].length;var h=f+e.length;if(0===f){if(c.type=this.name,h<c.value.length){var i=c.splitAt(h);i.type="regular",a.splice(b+1,0,i)}}else{var j=c.splitAt(f);if(e.length<j.value.length){var k=j.splitAt(e.length);a.splice(b+1,0,k)}j.type=this.name,a.splice(b+1,0,j)}}}},a}(),Primrose.Size=function(){"use strict";function a(a,b){this.set(a||0,b||0)}return a.prototype.set=function(a,b){this.width=a,this.height=b},a.prototype.copy=function(a){a&&(this.width=a.width,this.height=a.height)},a.prototype.clone=function(){return new a(this.width,this.height)},a.prototype.toString=function(){return fmt("<w:$1, h:$2>",this.width,this.height)},a}(),Primrose.Token=function(){"use strict";function a(a,b,c,d){this.value=a,this.type=b,this.index=c,this.line=d}return a.prototype.clone=function(){return new a(this.value,this.type,this.index,this.line)},a.prototype.splitAt=function(b){var c=this.value.substring(b);return this.value=this.value.substring(0,b),new a(c,this.type,this.index+b,this.line)},a.prototype.toString=function(){return fmt("[$1: $2]",this.type,this.value)},a}(),Primrose.CodePages.DE_QWERTZ=function(){"use strict";var a=Primrose.CodePage;return new a("Deutsch: QWERTZ","de",{deadKeys:[220,221,160,192],NORMAL:{48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",60:"<",63:"ß",160:a.DEAD(3),163:"#",171:"+",173:"-",186:"ü",187:"+",188:",",189:"-",190:".",191:"#",192:a.DEAD(4),219:"ß",220:a.DEAD(1),221:a.DEAD(2),222:"ä",226:"<"},DEAD1NORMAL:{65:"â",69:"ê",73:"î",79:"ô",85:"û",190:"."},DEAD2NORMAL:{65:"á",69:"é",73:"í",79:"ó",83:"s",85:"ú",89:"ý"},SHIFT:{48:"=",49:"!",50:'"',51:"§",52:"$",53:"%",54:"&",55:"/",56:"(",57:")",60:">",63:"?",163:"'",171:"*",173:"_",186:"Ü",187:"*",188:";",189:"_",190:":",191:"'",192:"Ö",219:"?",222:"Ä",226:">"},CTRLALT:{48:"}",50:"²",51:"³",55:"{",56:"[",57:"]",60:"|",63:"\\",69:"€",77:"µ",81:"@",171:"~",187:"~",219:"\\",226:"|"},CTRLALTSHIFT:{63:"ẞ",219:"ẞ"},DEAD3NORMAL:{65:"a",69:"e",73:"i",79:"o",85:"u",190:"."},DEAD4NORMAL:{65:"a",69:"e",73:"i",79:"o",83:"s",85:"u",89:"y"}})}(),Primrose.CodePages.EN_UKX=function(){"use strict";var a=Primrose.CodePage;return new a("English: UK Extended","en-GB",{CTRLALT:{52:"€",65:"á",69:"é",73:"í",79:"ó",85:"ú",163:"\\",192:"¦",222:"\\",223:"¦"},CTRLALTSHIFT:{65:"Á",69:"É",73:"Í",79:"Ó",85:"Ú",222:"|"},NORMAL:{48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",61:"=",163:"#",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"'",219:"[",220:"\\",221:"]",222:"#",223:"`"},SHIFT:{48:")",49:"!",50:'"',51:"£",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",59:":",61:"+",163:"~",173:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",192:"@",219:"{",220:"|",221:"}",222:"~",223:"¬"}})}(),Primrose.CodePages.EN_US=function(){"use strict";var a=Primrose.CodePage;return new a("English: USA","en-US",{NORMAL:{48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",61:"=",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",219:"[",220:"\\",221:"]",222:"'"},SHIFT:{48:")",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",59:":",61:"+",173:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",219:"{",220:"|",221:"}",222:'"'}})}(),Primrose.CodePages.FR_AZERTY=function(){"use strict";var a=Primrose.CodePage;return new a("Français: AZERTY","fr",{deadKeys:[221,50,55],NORMAL:{48:"à",49:"&",50:"é",51:'"',52:"'",53:"(",54:"-",55:"è",56:"_",57:"ç",186:"$",187:"=",188:",",190:";",191:":",192:"ù",219:")",220:"*",221:a.DEAD(1),222:"²",223:"!",226:"<"},SHIFT:{48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",186:"£",187:"+",188:"?",190:".",191:"/",192:"%",219:"°",220:"µ",223:"§",226:">"},CTRLALT:{48:"@",50:a.DEAD(2),51:"#",52:"{",53:"[",54:"|",55:a.DEAD(3),56:"\\",57:"^",69:"€",186:"¤",187:"}",219:"]"},DEAD1NORMAL:{65:"â",69:"ê",73:"î",79:"ô",85:"û"},DEAD2NORMAL:{65:"ã",78:"ñ",79:"õ"},DEAD3NORMAL:{48:"à",50:"é",55:"è",65:"à",69:"è",73:"ì",79:"ò",85:"ù"}})}(),Primrose.CommandPacks.TextEditor=function(){"use strict";return{name:"Basic commands",NORMAL_SPACE:" ",SHIFT_SPACE:" ",NORMAL_BACKSPACE:function(a,b){a.frontCursor.i===a.backCursor.i&&a.frontCursor.left(b),a.overwriteText(),a.scrollIntoView(a.frontCursor)},NORMAL_ENTER:function(a,b){var c="",d=b[a.frontCursor.y];d.length>0&&"whitespace"===d[0].type&&(c=d[0].value),a.overwriteText("\n"+c),a.scrollIntoView(a.frontCursor)},NORMAL_DELETE:function(a,b){a.frontCursor.i===a.backCursor.i&&a.backCursor.right(b),a.overwriteText(),a.scrollIntoView(a.frontCursor)},SHIFT_DELETE:function(a,b){a.frontCursor.i===a.backCursor.i&&(a.frontCursor.home(b),a.backCursor.end(b)),a.overwriteText(),a.scrollIntoView(a.frontCursor)},NORMAL_TAB:function(a){var b=a.getTabString();a.overwriteText(b)}}}(),Primrose.CommandPacks.TextEditor=function(){"use strict";function a(a,b,c){var d={NORMAL_SPACE:" ",SHIFT_SPACE:" ",NORMAL_BACKSPACE:function(a,b){a.frontCursor.i===a.backCursor.i&&a.frontCursor.left(b),a.overwriteText(),a.scrollIntoView(a.frontCursor)},NORMAL_ENTER:function(a,b){var c="",d=b[a.frontCursor.y];d.length>0&&"whitespace"===d[0].type&&(c=d[0].value),a.overwriteText("\n"+c),a.scrollIntoView(a.frontCursor)},NORMAL_DELETE:function(a,b){a.frontCursor.i===a.backCursor.i&&a.backCursor.right(b),a.overwriteText(),a.scrollIntoView(a.frontCursor)},SHIFT_DELETE:function(a,b){a.frontCursor.i===a.backCursor.i&&(a.frontCursor.home(b),a.backCursor.end(b)),a.overwriteText(),a.scrollIntoView(a.frontCursor)},NORMAL_TAB:function(a){var b=a.getTabString();a.overwriteText(b)}},e={};copyObject(e,b),copyObject(e,a),copyObject(e,d);for(var f in e)if(e.hasOwnProperty(f)){var g=e[f];"function"!=typeof g&&(g=c.overwriteText.bind(c,g)),e[f]=g}Primrose.CommandPack.call(this,"Text editor commands",e)}return inherit(a,Primrose.CommandPack),a}(),Primrose.Controls.Keyboard=function(){"use strict";function a(){Primrose.Control.call(this)}return inherit(a,Primrose.Control),a}(),Primrose.Controls.TextBox=function(){"use strict";function a(a,b){function c(){F=E.tokenize(x.value),x.update()}function d(){if(x.scroll.y<0)x.scroll.y=0;else for(;0<x.scroll.y&&x.scroll.y>G.length-T.height;)--x.scroll.y}function e(){if(H){var a=ab.getDOMElement().getBoundingClientRect();L.style.left=px(a.left),L.style.top=px(window.scrollY+a.top),L.style.width=0,L.style.height=0,bb.style.fontFamily=H.fontFamily;var b=ab.character.height/ab.getPixelRatio();bb.style.fontSize=px(.99*b),bb.style.lineHeight=px(b)}}function f(a,b,c){x.changed=!0,N.set(b,c),ab.pixel2cell(N,x.scroll,T);var d=N.x-x.scroll.x,e=N.y-x.scroll.y,f=e>=T.height,g=0>d,h=N.x>=T.width;if(X||f||g||h){if(X||h&&!f){X=!0;var i=G.length-T.height;if(e>=0&&i>=0){var j=e*i/T.height;x.scroll.y=Math.floor(j)}}else if(f&&!g){for(var k=0,l=0;l<G.length;++l){for(var m=G[l],n=0,o=0;o<m.length;++o)n+=m[o].value.length;k=Math.max(k,n)}var p=k-T.width;if(d>=0&&p>=0){var q=d*p/T.width;x.scroll.x=Math.floor(q)}}}else a.setXY(N.x,N.y,G),t(),x.backCursor.copy(a);O.copy(N)}function g(){var a=x.frontCursor.fixCursor(G)||x.backCursor.fixCursor(G);a&&x.render()}function h(a,c){if(b.pointerEventSource){x.focus();var d=b.pointerEventSource.getBoundingClientRect();x.startPointer(a-d.left,c-d.top)}}function i(a,c){if(b.pointerEventSource){var d=b.pointerEventSource.getBoundingClientRect();x.movePointer(a-d.left,c-d.top)}}function j(a){0===a.button&&(h(a.clientX,a.clientY),a.preventDefault())}function k(a){x.focused&&i(a.clientX,a.clientY)}function l(a){x.focused&&0===a.button&&x.endPointer()}function m(a){if(x.focused&&a.touches.length>0&&!W){var b=a.touches[0];h(b.clientX,b.clientY),K=b.identifier}}function n(a){for(var b=0;b<a.changedTouches.length&&W;++b){var c=a.changedTouches[b];if(c.identifier===K){i(c.clientX,c.clientY);break}}}function o(a){for(var b=0;b<a.changedTouches.length&&W;++b){var c=a.changedTouches[b];c.identifier===K&&x.endPointer()}}function p(){C&&z&&B&&(D=new B(z,C,x))}function q(a){var b=a.toLowerCase();x["cursor"+a]=function(a,c){x.changed=!0,c[b](a),x.scrollIntoView(c)}}function r(){var a;Y?(a=Math.max(1,Math.ceil(Math.log(x.getLineCount())/Math.LN10)),U.width=1):(a=0,U.width=0),Z?$?V.set(ab.VSCROLL_WIDTH,0):V.set(ab.VSCROLL_WIDTH,1):V.set(0,0);var b=U.width+a,c=0,d=Math.floor(x.getWidth()/ab.character.width)-b-V.width,e=Math.floor(x.getHeight()/ab.character.height)-c-V.height;T.set(b+2,c,d-2,e-2);var f=ab.character.width/ab.getPixelRatio(),g=ab.character.height/ab.getPixelRatio();bb.style.left=px(T.x*f),bb.style.top=px(T.y*g),bb.style.width=px(T.width*f),bb.style.height=px(T.height*g),G=[[]];for(var h=0,i=F.slice(),j=0;j<i.length;++j){var k=i[j].clone(),l=T.width-h,m=$&&"newlines"!==k.type&&k.value.length>l,n="newlines"===k.type||m;if(m){var o=k.value.length>T.width?l:0;i.splice(j+1,0,k.splitAt(o))}k.value.length>0&&(G[G.length-1].push(k),h+=k.value.length),n&&(G.push([]),h=0)}return a}function s(a){a.returnValue=!1}function t(){bb.selectionStart=Math.min(x.frontCursor.i,x.backCursor.i),bb.selectionEnd=Math.max(x.frontCursor.i,x.backCursor.i)}function u(a,b,c){var d=a-b,e=a-c+5,f=0;return(0>d||e>=0)&&(f=Math.abs(d)<Math.abs(e)?d:e),f}function v(a,b,c,d){var e=document.createElement("span"),f=document.createElement("input");f.type="checkbox",f.checked=b,f.id=a,e.appendChild(f);var g=document.createElement("label");return g.innerHTML=c+" ",g["for"]=a,e.appendChild(g),f.addEventListener("change",function(){x[d](f.checked)}),e}function w(a,b,c,d,e,f,g){var h=cascadeElement(a,"select",window.HTMLSelectElement),i=[];for(var j in b)if(b.hasOwnProperty(j)){var k=b[j];if(!g||k instanceof g){k=k.name||j;var l=document.createElement("option");l.innerHTML=k,i.push(b[j]),k===c&&(l.selected="selected"),h.appendChild(l)}}"function"==typeof d[e]?h.addEventListener("change",function(){d[e](i[h.selectedIndex])}):h.addEventListener("change",function(){d[e]=i[h.selectedIndex]});var m=cascadeElement("container -"+a,"div",window.HTMLDivElement),n=cascadeElement("label-"+a,"span",window.HTMLSpanElement);return n.innerHTML=f+": ",n["for"]=h,h.title=f,h.alt=f,m.appendChild(n),m.appendChild(h),m}var x=this;b=b||{},"string"==typeof b&&(b={file:b}),Primrose.Control.call(this);var y,z,A,B,C,D,E,F,G,H,I,J,K,L,M=b.renderer||Primrose.Renderers.Canvas,N=new Primrose.Point,O=new Primrose.Point,P="",Q=[],R=[],S=-1,T=new Primrose.Rectangle,U=new Primrose.Size,V=new Primrose.Size,W=!1,X=!1,Y=!0,Z=!0,$=!1,_=0,ab=new M(a,b),bb=cascadeElement("primrose-surrogate-textarea-"+ab.id,"textarea",window.HTMLTextAreaElement);this.frontCursor=new Primrose.Cursor,this.backCursor=new Primrose.Cursor,this.scroll=new Primrose.Point,["Left","Right","SkipLeft","SkipRight","Up","Down","Home","End","FullHome","FullEnd"].map(q.bind(this)),this.addEventListener=function(a,c){"keydown"===a&&b.keyEventSource.addEventListener(a,c)},this.cursorPageUp=function(a,b){this.changed=!0,b.incY(-T.height,a),this.scrollIntoView(b)},this.cursorPageDown=function(a,b){this.changed=!0,b.incY(T.height,a),this.scrollIntoView(b)},this.getDOMElement=function(){return ab.getDOMElement()},this.focus=function(){bb.focus(),Primrose.Control.prototype.focus.call(this)},this.blur=function(){bb.blur(),Primrose.Control.prototype.blur.call(this)},this.getRenderer=function(){return ab},this.setWheelScrollSpeed=function(a){_=a||25},this.getWheelScrollSpeed=function(){return _},this.setWordWrap=function(a){$=a||!1,this.forceUpdate()},this.getWordWrap=function(){return $},this.setShowLineNumbers=function(a){Y=a,this.forceUpdate()},this.getShowLineNumbers=function(){return Y},this.setShowScrollBars=function(a){Z=a,this.forceUpdate()},this.getShowScrollBars=function(){return Z},this.setTheme=function(a){H=a||Primrose.Themes.Default,ab.setTheme(H),ab.resize(),this.changed=!0,this.update()},this.getTheme=function(){return H},this.setDeadKeyState=function(a){this.changed=!0,P=a||""},this.setOperatingSystem=function(a){this.changed=!0,z=a||(isOSX?Primrose.OperatingSystems.OSX:Primrose.OperatingSystems.Windows),p()},this.getOperatingSystem=function(){return z},this.setCommandSystem=function(a){this.changed=!0,B=a||Primrose.CommandPacks.TextEditor,p()},this.setSize=function(a,b){this.changed=ab.setSize(a,b)},this.getWidth=function(){return ab.getWidth()},this.getHeight=function(){return ab.getHeight()},this.setCodePage=function(a){this.changed=!0;var b,c,d,e;if(y=a,!y){var f=navigator.languages&&navigator.languages[0]||navigator.language||navigator.userLanguage||navigator.browserLanguage;f&&"en"!==f||(f="en-US");for(b in Primrose.CodePages)if(a=Primrose.CodePages[b],a.language===f){y=a;break}y||(y=Primrose.CodePages.EN_US)}Q=[];for(b in Primrose.Keys)c=Primrose.Keys[b],isNaN(c)||(Q[c]=b);C={};for(var g in y){var h=y[g];if("object"==typeof h)for(c in h){if(c.indexOf("_")>-1){var i=c.split(" "),j=i[0];c=i[1],d=y.NORMAL[c],e=j+"_"+g+" "+d}else d=y.NORMAL[c],e=g+"_"+d;Q[c]=d,C[e]=h[c]}}p()},this.getCodePage=function(){return y},this.setTokenizer=function(a){this.changed=!0,E=a||Primrose.Grammars.JavaScript,R&&R.length>0&&(c(),this.update())},this.getTokenizer=function(){return E},this.getLines=function(){return R[S].slice()},this.getLineCount=function(){return R[S].length},Object.defineProperties(this,{value:{get:function(){return R[S].join("\n")},set:function(a){a=a||"",a=a.replace(/\r\n/g,"\n");var b=a.split("\n");this.pushUndo(b),this.update(),bb.value=a,t()}},selectionStart:{get:function(){return this.frontCursor.i},set:function(a){this.frontCursor.setI(a,G)}},selectionEnd:{get:function(){return this.backCursor.i},set:function(a){this.backCursor.setI(a,G)}},selectionDirection:{get:function(){return this.frontCursor.i<=this.backCursor.i?"forward":"backward"}}}),this.pushUndo=function(a){S<R.length-1&&R.splice(S+1),R.push(a),S=R.length-1,c(),this.forceUpdate()},this.redo=function(){this.changed=!0,S<R.length-1&&++S,c(),g()},this.undo=function(){this.changed=!0,S>0&&--S,c(),g()},this.setTabWidth=function(a){I=a||4,J="";for(var b=0;I>b;++b)J+=" "},this.getTabWidth=function(){return I},this.getTabString=function(){return J},this.scrollIntoView=function(a){this.scroll.y+=u(a.y,this.scroll.y,this.scroll.y+T.height),$||(this.scroll.x+=u(a.x,this.scroll.x,this.scroll.x+T.width)),d()},this.increaseFontSize=function(){++H.fontSize,this.changed=ab.resize()},this.decreaseFontSize=function(){H.fontSize>1&&(--H.fontSize,this.changed=ab.resize())},this.setFontSize=function(a){H.fontSize=a,this.changed=ab.resize()},this.cell2i=function(a,b){for(var c=0,d=0;b>d;++d){for(var e=G[d],f=0;f<e.length;++f)c+=e[f].value.length;++c}return c+=a},this.i2cell=function(a){for(var b=0;b<G.length;++b){for(var c=G[b],d=0,e=0;e<c.length;++e)d+=c[e].value.length;if(d>=a)return{x:a,y:b};a-=d-1}},this.readWheel=function(a){this.scroll.y+=Math.floor(a.deltaY/_),d(),a.preventDefault(),this.forceUpdate()},this.startPicking=function(a,b,c){var d=ab.getPixelIndex(a,b,c);this.startPointer(d.x,d.y)},this.movePicking=function(a,b,c){var d=ab.getPixelIndex(a,b,c);this.movePointer(d.x,d.y)},this.startPointer=function(a,b){f(this.frontCursor,a,b),W=!0,this.update()},this.movePointer=function(a,b){W&&(f(this.backCursor,a,b),this.update())},this.endPointer=function(){W=!1,X=!1,bb.focus()},this.bindEvents=function(a,b,c,d){a&&a.addEventListener("keydown",this.keyDown.bind(this)),b&&(b.addEventListener("wheel",this.readWheel.bind(this)),b.addEventListener("mousedown",j),b.addEventListener("mousemove",k),b.addEventListener("mouseup",l),b.addEventListener("touchstart",m),b.addEventListener("touchmove",n),b.addEventListener("touchend",o)),c&&c.addEventListener("wheel",this.readWheel.bind(this)),d&&(bb.addEventListener("beforecopy",s),bb.addEventListener("copy",this.copySelectedText.bind(this)),bb.addEventListener("beforecut",s),bb.addEventListener("cut",this.cutSelectedText.bind(this)),a&&(a.addEventListener("beforepaste",s),a.addEventListener("paste",this.readClipboard.bind(this))))},this.overwriteText=function(a){if(a=a||"",a=a.replace(/\r\n/g,"\n"),this.frontCursor.i!==this.backCursor.i||a.length>0){var b=Primrose.Cursor.min(this.frontCursor,this.backCursor),c=Primrose.Cursor.max(this.frontCursor,this.backCursor),e=this.value,f=e.substring(0,b.i),g=e.substring(c.i);this.value=f+a+g,b.advanceN(G,Math.max(0,a.length)),this.scrollIntoView(c),d(),c.copy(b),this.render()}},this.copySelectedText=function(a){if(a.returnValue=!1,this.frontCursor.i!==this.backCursor.i){var b=Primrose.Cursor.min(this.frontCursor,this.backCursor),c=Primrose.Cursor.max(this.frontCursor,this.backCursor),d=this.value,e=d.substring(b.i,c.i),f=a.clipboardData||window.clipboardData;f.setData(window.clipboardData?"Text":"text/plain",e)}a.preventDefault()},this.cutSelectedText=function(a){this.copySelectedText(a),this.overwriteText(),this.update()},this.readClipboard=function(a){a.returnValue=!1;var b=a.clipboardData||window.clipboardData,c=b.getData(window.clipboardData?"Text":"text/plain");c&&this.overwriteText(c)},this.keyDown=function(a){if(this.focused){a=a||event;var b=a.keyCode;if(b!==Primrose.Keys.CTRL&&b!==Primrose.Keys.ALT&&b!==Primrose.Keys.META_L&&b!==Primrose.Keys.META_R&&b!==Primrose.Keys.SHIFT){var c=P,e=P;a.ctrlKey&&(e+="CTRL"),a.altKey&&(e+="ALT"),a.metaKey&&(e+="META"),a.shiftKey&&(e+="SHIFT"),e===P&&(e+="NORMAL"),e+="_"+Q[b];var f=D[A+"_"+e]||D[e];f&&(this.frontCursor.moved=!1,this.backCursor.moved=!1,f(x,G),this.frontCursor.moved&&!this.backCursor.moved&&this.backCursor.copy(this.frontCursor),d(),a.preventDefault()),P===c&&(P="")}this.update()}},this.update=function(){ab.hasResized()&&(this.changed=ab.resize(),e()),Primrose.Control.prototype.update.call(this)},this.render=function(){if(F){var a=r();ab.render(G,this.frontCursor,this.backCursor,T,this.scroll,this.focused,Y,Z,$,a),t(),Primrose.Control.prototype.render.call(this)}},this.appendControls=function(a){a.appendChild(this.lineNumberToggler),a.appendChild(this.wordWrapToggler),a.appendChild(this.scrollBarToggler),a.appendChild(this.operatingSystemSelect),a.appendChild(this.keyboardSelect),a.appendChild(this.commandSystemSelect),a.appendChild(this.tokenizerSelect),a.appendChild(this.themeSelect)},A=isChrome?"CHROMIUM":isFirefox?"FIREFOX":isIE?"IE":isOpera?"OPERA":isSafari?"SAFARI":"UNKNOWN",bb.style.position="absolute",bb.addEventListener("blur",this.blur.bind(this)),L=makeHidingContainer("primrose-surrogate-textarea-container-"+ab.id,bb),document.body.insertBefore(L,document.body.children[0]),(b.autoBindEvents||ab.autoBindEvents)&&(b.readOnly||void 0!==b.keyEventSource||(b.keyEventSource=bb),void 0===b.pointerEventSource&&(b.pointerEventSource=ab.getDOMElement()),void 0===b.wheelEventSource&&(b.wheelEventSource=ab.getDOMElement())),this.setWheelScrollSpeed(b.wheelScrollSpeed),this.setWordWrap(!b.disableWordWrap),this.setShowLineNumbers(!b.hideLineNumbers),this.setShowScrollBars(!b.hideScrollBars),this.setTabWidth(b.tabWidth),this.setTheme(b.theme),this.setFontSize(b.fontSize||14),this.setTokenizer(b.tokenizer),this.setCodePage(b.codePage),this.setOperatingSystem(b.os),this.setCommandSystem(b.commands),this.value=b.file,this.bindEvents(b.keyEventSource,b.pointerEventSource,b.wheelEventSource,!b.disableClipboard),this.lineNumberToggler=v("primrose-line-number-toggler-"+ab.id,!b.hideLineNumbers,"Line numbers","setShowLineNumbers"),this.wordWrapToggler=v("primrose-word-wrap-toggler-"+ab.id,!b.disableWordWrap,"Line wrap","setWordWrap"),this.scrollBarToggler=v("primrose-scrollbar-toggler-"+ab.id,!b.hideScrollBars,"Scroll bars","setShowScrollBars"),this.themeSelect=w("primrose-theme-selector-"+ab.id,Primrose.Themes,H.name,x,"setTheme","theme"),this.commandSystemSelect=w("primrose-command-system-selector-"+ab.id,Primrose.Commands,B.name,x,"setCommandSystem","Command system"),this.tokenizerSelect=w("primrose-tokenizer-selector-"+ab.id,Primrose.Grammars,E.name,x,"setTokenizer","Language syntax",Primrose.Grammar),this.keyboardSelect=w("primrose-keyboard-selector-"+ab.id,Primrose.CodePages,y.name,x,"setCodePage","Localization",Primrose.CodePage),this.operatingSystemSelect=w("primrose-operating-system-selector-"+ab.id,Primrose.OperatingSystems,z.name,x,"setOperatingSystem","Shortcut style",Primrose.OperatingSystem),e()}return inherit(a,Primrose.Control),a}(),Primrose.Grammars.Basic=function(){var grammar=new Primrose.Grammar("BASIC",[["newlines",/(?:\r\n|\r|\n)/],["lineNumbers",/^\d+\s+/],["comments",/^REM.*$/],["strings",/"(?:\\"|[^"])*"/],["strings",/'(?:\\'|[^'])*'/],["numbers",/-?(?:(?:\b\d*)?\.)?\b\d+\b/],["keywords",/\b(?:RESTORE|REPEAT|RETURN|LOAD|LABEL|DATA|READ|THEN|ELSE|FOR|DIM|LET|IF|TO|STEP|NEXT|WHILE|WEND|UNTIL|GOTO|GOSUB|ON|TAB|AT|END|STOP|PRINT|INPUT|RND|INT|CLS|CLK|LEN)\b/],["keywords",/^DEF FN/],["operators",/(?:\+|;|,|-|\*\*|\*|\/|>=|<=|=|<>|<|>|OR|AND|NOT|MOD|\(|\)|\[|\])/],["identifiers",/\w+\$?/]]),oldTokenize=grammar.tokenize;return grammar.tokenize=function(a){return oldTokenize.call(this,a.toUpperCase())},grammar.interpret=function(sourceCode,input,output,errorOut,next,clearScreen,loadFile,done){function toNum(a){return new Primrose.Token(a.toString(),"numbers")}function toStr(a){return new Primrose.Token('"'+a.replace("\n","\\n").replace('"','\\"')+'"',"strings")}function process(a){if(a&&a.length>0){var b=a.shift();if(b){if(commands.hasOwnProperty(b.value))return commands[b.value](a);if(isNumber(b.value))return setProgramCounter([b]);if(state[b.value]||a.length>0&&"operators"===a[0].type&&"="===a[0].value)return a.unshift(b),translate(a);error("Unknown command. >>> "+b.value)}}return pauseBeforeComplete()}function error(a){errorOut("At line "+lineNumbers[counter]+": "+a)}function getLine(a){var b=lineNumbers[a],c=program[b];return c&&c.slice()}function evaluate(line){for(var script="",i=0;i<line.length;++i){var t=line[i],nest=0;if("identifiers"===t.type&&"function"!=typeof state[t.value]&&i<line.length-1&&"("===line[i+1].value)for(var j=i+1;j<line.length;++j){var t2=line[j];if("("===t2.value?(0===nest&&(t2.value="["),++nest):")"===t2.value?(--nest,0===nest&&(t2.value="]")):","===t2.value&&1===nest&&(t2.value="]["),0===nest)break}script+=t.value}with(state)try{return eval(script)}catch(exp){console.debug(line.join(", ")),console.error(exp),console.error(script),error(exp.message+": "+script)}}function declareVariable(a){var b,c=[],d=[c],e=0;for(b=0;b<a.length;++b){var f=a[b];"("===f.value?++e:")"===f.value&&--e,0===e&&","===f.value?(c=[],d.push(c)):c.push(f)}for(b=0;b<d.length;++b){c=d[b];var g=c.shift();if("identifiers"===g.type){var h,i=null;if(g=g.value,"("===c[0].value&&")"===c[c.length-1].value){var j=[];for(h=1;h<c.length-1;++h)"numbers"===c[h].type&&j.push(0|c[h].value);if(0===j.length)i=[];else{i=new Array(j[0]);var k=[i];for(h=1;h<j.length;++h)for(var l=j[h],m=0,n=k.length;n>m;++m)for(var o=k.shift(),p=0;p<o.length;++p)o[p]=new Array(l),h<j.length-1&&k.push(o[p])}}return state[g]=i,!0}error("Identifier expected: "+g.value)}}function print(a){var b="\n",c=0;a=a.map(function(d,e){return d=d.clone(),"operators"===d.type&&(","===d.value?0===c&&(d.value='+ ", " + '):";"===d.value?(d.value='+ " "',e<a.length-1?d.value+=" + ":b=""):"("===d.value?++c:")"===d.value&&--c),d});var d=evaluate(a);return void 0===d&&(d=""),output(d+b),!0}function setProgramCounter(a){var b=parseFloat(evaluate(a));
for(counter=-1;counter<lineNumbers.length-1&&lineNumbers[counter+1]<b;)++counter;return!0}function checkConditional(a){var b,c=-1,d=-1;for(b=0;b<a.length;++b)"keywords"===a[b].type&&"THEN"===a[b].value?c=b:"keywords"===a[b].type&&"ELSE"===a[b].value&&(d=b);if(-1===c)error("Expected THEN clause.");else{var e=a.slice(0,c);for(b=0;b<e.length;++b){var f=e[b];"operators"===f.type&&"="===f.value&&(f.value="==")}var g,h;if(-1===d?g=a.slice(c+1):(g=a.slice(c+1,d),h=a.slice(d+1)),evaluate(e))return process(g);if(h)return process(h)}return!0}function pauseBeforeComplete(){return output("PROGRAM COMPLETE - PRESS RETURN TO FINISH."),input(function(){isDone=!0,done&&done()}),!1}function labelLine(a){return a.push(EQUAL_SIGN),a.push(toNum(lineNumbers[counter])),translate(a)}function waitForInput(a){var b=a.pop();return a.length>0&&print(a),input(function(a){a=a.toUpperCase();var c=null;c=isNumber(a)?toNum(a):toStr(a),evaluate([b,EQUAL_SIGN,c]),next&&next()}),!1}function onStatement(a){var b=[],c=null,d=[];try{for(;a.length>0&&("keywords"!==a[0].type||"GOTO"!==a[0].value);)b.push(a.shift());if(a.length>0){a.shift();for(var e=0;e<a.length;++e){var f=a[e];("operators"!==f.type||","!==f.value)&&d.push(f)}if(c=evaluate(b)-1,c>=0&&c<d.length)return setProgramCounter([d[c]])}}catch(g){console.error(g)}return!0}function gotoSubroutine(a){return returnStack.push(toNum(lineNumbers[counter+1])),setProgramCounter(a)}function setRepeat(){return returnStack.push(toNum(lineNumbers[counter])),!0}function conditionalReturn(a){var b=!0,c=returnStack.pop();return c&&a&&(b=setProgramCounter([c])),b}function untilLoop(a){var b=!evaluate(a);return conditionalReturn(b)}function findNext(a){for(i=counter+1;i<lineNumbers.length;++i){var b=getLine(i);if(b[0].value===a)return i}return lineNumbers.length}function whileLoop(a){var b=evaluate(a);return b?returnStack.push(toNum(lineNumbers[counter])):counter=findNext("WEND"),!0}function forLoop(a){var b=lineNumbers[counter],c=[],d=[],e=[],f=[],g=[c,d,e,f],h=0,i=0;for(i=0;i<a.length;++i){var j=a[i];j.value===FOR_LOOP_DELIMS[h]?(0===h&&c.push(j),++h):g[h].push(j)}var k=1;f.length>0&&(k=evaluate(f)),void 0===forLoopCounters[b]&&(forLoopCounters[b]=evaluate(d));var l=evaluate(e),m=forLoopCounters[b]<=l;return m?(c.push(toNum(forLoopCounters[b])),process(c),forLoopCounters[b]+=k,returnStack.push(toNum(lineNumbers[counter]))):(delete forLoopCounters[b],counter=findNext("NEXT")),!0}function stackReturn(){return conditionalReturn(!0)}function loadCodeFile(a){return loadFile(evaluate(a),function(){next&&next()}),!1}function noop(){return!0}function loadData(a){for(;a.length>0;){var b=a.shift();"operators"!==b.type&&data.push(b.value)}return!0}function readData(a){if(0===data.length){var b=findNext("DATA");process(getLine(b))}var c=data[dataCounter];return++dataCounter,a.push(EQUAL_SIGN),a.push(toNum(c)),translate(a)}function restoreData(){return dataCounter=0,!0}function defineFunction(line){for(var name=line.shift().value,signature="",body="",fillSig=!0,i=0;i<line.length;++i){var t=line[i];"operators"===t.type&&"="===t.value?fillSig=!1:fillSig?signature+=t.value:body+=t.value}name="FN"+name;var script="(function "+name+signature+"{ return "+body+"; })";return state[name]=eval(script),!0}function translate(a){return evaluate(a),!0}for(var tokens=this.tokenize(sourceCode),EQUAL_SIGN=new Primrose.Token("=","operators"),counter=0,isDone=!1,program={},lineNumbers=[],currentLine=[],lines=[currentLine],data=[],returnStack=[],forLoopCounters={},dataCounter=0,state={INT:function(a){return 0|a},RND:function(){return Math.random()},CLK:function(){return Date.now()/36e5},LEN:function(a){return a.length},LINE:function(){return lineNumbers[counter]},TAB:function(a){for(var b="",c=0;a>c;++c)b+=" ";return b},POW:function(a,b){return Math.pow(a,b)}},tokenMap={OR:"||",AND:"&&",NOT:"!",MOD:"%","<>":"!="};tokens.length>0;){var token=tokens.shift();"newlines"===token.type?(currentLine=[],lines.push(currentLine)):"regular"!==token.type&&"comments"!==token.type&&(token.value=tokenMap[token.value]||token.value,currentLine.push(token))}for(var i=0;i<lines.length;++i){var line=lines[i];if(line.length>0){var lastLine=lineNumbers[lineNumbers.length-1],lineNumber=line.shift();if("lineNumbers"!==lineNumber.type&&(line.unshift(lineNumber),void 0===lastLine&&(lastLine=-1),lineNumber=toNum(lastLine+1)),lineNumber=parseFloat(lineNumber.value),lastLine&&lastLine>=lineNumber)throw new Error("expected line number greater than "+lastLine+", but received "+lineNumber+".");line.length>0&&(lineNumbers.push(lineNumber),program[lineNumber]=line)}}var FOR_LOOP_DELIMS=["=","TO","STEP"],commands={DIM:declareVariable,LET:translate,PRINT:print,GOTO:setProgramCounter,IF:checkConditional,INPUT:waitForInput,END:pauseBeforeComplete,STOP:pauseBeforeComplete,REM:noop,"'":noop,CLS:clearScreen,ON:onStatement,GOSUB:gotoSubroutine,RETURN:stackReturn,LOAD:loadCodeFile,DATA:loadData,READ:readData,RESTORE:restoreData,REPEAT:setRepeat,UNTIL:untilLoop,"DEF FN":defineFunction,WHILE:whileLoop,WEND:stackReturn,FOR:forLoop,NEXT:stackReturn,LABEL:labelLine};return function(){if(!isDone)for(var a=!0;a;){var b=getLine(counter);a=process(b),++counter}}},grammar}(),Primrose.Grammars.JavaScript=function(){"use strict";return new Primrose.Grammar("JavaScript",[["newlines",/(?:\r\n|\r|\n)/],["comments",/\/\/.*$/],["startBlockComments",/\/\*/],["endBlockComments",/\*\//],["strings",/"(?:\\"|[^"])*"/],["strings",/'(?:\\'|[^'])*'/],["strings",/\/(?:\\\/|[^/])*\/\w*/],["numbers",/-?(?:(?:\b\d*)?\.)?\b\d+\b/],["keywords",/\b(?:break|case|catch|const|continue|debugger|default|delete|do|else|export|finally|for|function|if|import|in|instanceof|let|new|return|super|switch|this|throw|try|typeof|var|void|while|with)\b/],["functions",/(\w+)(?:\s*\()/],["members",/(?:(?:\w+\.)+)(\w+)/]])}(),Primrose.Grammars.PlainText=function(){"use strict";return new Primrose.Grammar("PlainText",[["newlines",/(?:\r\n|\r|\n)/]])}(),Primrose.Grammars.TestResults=function(){"use strict";return new Primrose.Grammar("TestResults",[["newlines",/(?:\r\n|\r|\n)/,!0],["numbers",/(\[)(o+)/,!0],["numbers",/(\d+ succeeded), 0 failed/,!0],["numbers",/^    Successes:/,!0],["functions",/(x+)\]/,!0],["functions",/[1-9]\d* failed/,!0],["functions",/^    Failures:/,!0],["comments",/(\d+ms:)(.*)/,!0],["keywords",/(Test results for )(\w+):/,!0],["strings",/        \w+/,!0]])}(),Primrose.OperatingSystems.OSX=function(){"use strict";return new Primrose.OperatingSystem("OS X","META","ALT","METASHIFT_z","META","LEFTARROW","RIGHTARROW","META","UPARROW","DOWNARROW")}(),Primrose.OperatingSystems.Windows=function(){"use strict";return new Primrose.OperatingSystem("Windows","CTRL","CTRL","CTRL_y","","HOME","END","CTRL","HOME","END")}(),Primrose.Renderers.Canvas=function(){"use strict";return function(a,b){function c(a,b,c,d,e,f){a.fillStyle=b,a.fillRect(c*g.character.width,d*g.character.height,e*g.character.width+1,f*g.character.height+1)}function d(a,b,d,e,f,i){var j=Primrose.Cursor.min(b,d),k=Primrose.Cursor.max(b,d),l=new Primrose.Cursor,m=new Primrose.Cursor,o=p.regular.backColor?"fillRect":"clearRect";p.regular.backColor&&(n.fillStyle=p.regular.backColor),n[o](0,0,h.width,h.height),n.save(),n.translate((e.x-f.x)*g.character.width,-f.y*g.character.height),i&&c(n,p.regular.currentRowBackColor||Primrose.Themes.Default.regular.currentRowBackColor,0,j.y+.2,e.width,k.y-j.y+1);for(var q=0;q<a.length;++q){for(var r=a[q],s=0;s<r.length;++s){var t=r[s];if(m.x+=t.value.length,m.i+=t.value.length,f.y<=q&&q<f.y+e.height&&f.x<=m.x&&l.x<f.x+e.width){var u=j.i<=m.i&&l.i<k.i;if(u){var v=Primrose.Cursor.max(j,l),w=Primrose.Cursor.min(k,m),x=w.i-v.i;c(n,p.regular.selectedBackColor||Primrose.Themes.Default.regular.selectedBackColor,v.x,v.y+.2,x,1)}}l.copy(m)}l.x=0,++l.y,m.copy(l)}if(i){var y=p.cursorColor||"black",z=1/g.character.width;c(n,y,j.x,j.y,z,1),c(n,y,k.x,k.y,z,1)}n.restore()}function e(a,b,c){var d=new Primrose.Cursor,e=new Primrose.Cursor,f=0;m.clearRect(0,0,h.width,h.height),m.save(),m.translate((b.x-c.x)*g.character.width,-c.y*g.character.height);for(var i=0;i<a.length;++i){for(var j=a[i],k=0;k<j.length;++k){var l=j[k];if(e.x+=l.value.length,e.i+=l.value.length,c.y<=i&&i<c.y+b.height&&c.x<=e.x&&d.x<c.x+b.width){var n=p[l.type]||{},o=(n.fontWeight||p.regular.fontWeight||"")+" "+(n.fontStyle||p.regular.fontStyle||"")+" "+g.character.height+"px "+p.fontFamily;m.font=o.trim(),m.fillStyle=n.foreColor||p.regular.foreColor,m.fillText(l.value,d.x*g.character.width,(i+1)*g.character.height)}d.copy(e)}f=Math.max(f,e.x),d.x=0,++d.y,e.copy(d)}return m.restore(),f}function f(a,b,d,e,f,i,j,k){if(o.clearRect(0,0,h.width,h.height),o.save(),o.translate(0,-d.y*g.character.height),e)for(var l=d.y,m=-1;l<d.y+b.height&&l<a.length;++l){for(var n=a[l],q=n.length>0?n[0].line:m+1,r=q.toString();r.length<j;)r=" "+r;c(o,p.regular.selectedBackColor||Primrose.Themes.Default.regular.selectedBackColor,0,l+.2,b.x,1),o.font="bold "+g.character.height+"px "+p.fontFamily,q>m&&(o.fillStyle=p.regular.foreColor,o.fillText(r,0,(l+1)*g.character.height)),m=q}if(o.restore(),f){var s=b.width*g.character.width,t=b.height*g.character.height,u=d.x*s/k+b.x*g.character.width,v=d.y*t/a.length+b.y*g.character.height;if(o.fillStyle=p.regular.selectedBackColor||Primrose.Themes.Default.regular.selectedBackColor,!i&&k>b.width){var w=s*(b.width/k);o.fillRect(u,(b.height+.25)*g.character.height,Math.max(g.character.width,w),g.character.height)}if(a.length>b.height){var x=t*(b.height/a.length);o.fillRect(h.width-g.VSCROLL_WIDTH*g.character.width,v,g.VSCROLL_WIDTH*g.character.width,Math.max(g.character.height,x))}}}var g=this,h=cascadeElement(a,"canvas",window.HTMLCanvasElement),i=cascadeElement(h.id+"-back","canvas",window.HTMLCanvasElement),j=cascadeElement(h.id+"-front","canvas",window.HTMLCanvasElement),k=cascadeElement(h.id+"-trim","canvas",window.HTMLCanvasElement),l=h.getContext("2d"),m=j.getContext("2d"),n=i.getContext("2d"),o=k.getContext("2d"),p=null,q=null,r=null,s=null,t=b.size;this.VSCROLL_WIDTH=2,this.character=new Primrose.Size,this.id=h.id,this.autoBindEvents=!0,this.setTheme=function(a){p=a},this.pixel2cell=function(a,b,c){var d=this.getPixelRatio(),e=a.x*h.width/h.clientWidth,f=a.y*h.height/h.clientHeight;a.set(Math.round(e*d/this.character.width)+b.x-c.x,Math.floor(f*d/this.character.height-.25)+b.y)},this.hasResized=function(){var a=this.getPixelRatio(),b=h.width,c=h.height,d=h.clientWidth*a,e=h.clientHeight*a;return b!==d||c!==e},this.resize=function(){var a=!1;if(p){var b=this.getPixelRatio(),c=this.character.width,d=this.character.height,e=h.width,f=h.height,g=t&&t.width||h.clientWidth*b,m=t&&t.height||h.clientHeight*b,n=l.font;this.character.height=p.fontSize*b,l.font=this.character.height+"px "+p.fontFamily,this.character.width=l.measureText("MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM").width/100,a=c!==this.character.width||d!==this.character.height||n!==l.font,g>0&&m>0&&(i.width=j.width=k.width=h.width=g,i.height=j.height=k.height=h.height=m,a=a||e!==g||f!==g)}return a},this.setSize=function(a,b){return h.style.width=a+"px",h.style.height=b+"px",this.resize()},this.getWidth=function(){return h.width},this.getHeight=function(){return h.height},this.render=function(a,b,c,g,m,n,o,r,s,t){if(p){var u=0;d(a,b,c,g,m,n),u=e(a,g,m),f(a,g,m,o,r,s,t,u),l.clearRect(0,0,h.width,h.height),l.drawImage(i,0,0),l.drawImage(j,0,0),l.drawImage(k,0,0),q&&(q.needsUpdate=!0)}},this.getDOMElement=function(){return h},this.getTexture=function(a){return"undefined"==typeof window.THREE||q||(q=new THREE.Texture(h),q.anisotropy=a||8,q.needsUpdate=!0),q},this.getPickingTexture=function(){if(!r){var a=document.createElement("canvas"),b=this.getWidth(),c=this.getHeight();a.width=b,a.height=c;for(var d=a.getContext("2d"),e=d.createImageData(b,c),f=0,g=0,h=b*c;h>f;++f,g+=4)e.data[g]=(16711680&f)>>16,e.data[g+1]=(65280&f)>>8,e.data[g+2]=(255&f)>>0,e.data[g+3]=255;d.putImageData(e,0,0),r=new THREE.Texture(a,THREE.UVMapping,THREE.RepeatWrapping,THREE.RepeatWrapping,THREE.NearestFilter,THREE.NearestMipMapNearestFilter,THREE.RGBAFormat,THREE.UnsignedByteType,0),r.needsUpdate=!0}return r},this.getPixelRatio=function(){return window.devicePixelRatio||1},this.getPixelIndex=function(a,b,c){s||(s=new Uint8Array(4)),a.readPixels(b,c,1,1,a.RGBA,a.UNSIGNED_BYTE,s);var d=s[0]<<16|s[1]<<8|s[2]<<0;return{x:d%h.clientWidth,y:d/h.clientWidth}},a instanceof window.HTMLCanvasElement||!t||(h.style.position="absolute",h.style.width=t.width,h.style.height=t.height),h.parentElement||(this.autoBindEvents=!1,document.body.appendChild(makeHidingContainer("primrose-container-"+h.id,h)))}}(),Primrose.Renderers.DOM=function(){"use strict";function a(a){function c(a){a.style.font=d.font,a.style.lineHeight=px(parseInt(d.font,10)),a.style.padding="0",a.style.margin="0"}var d=this;this.font=null,this.fillStyle=null;var e=[new Point];this.measureText=function(a){var d=document.createElement("div");c(d),d.style.position="absolute",d.style.visibility="hidden",d.innerHTML=a,document.body.appendChild(d);var e=new b(d.clientWidth,d.clientHeight);return document.body.removeChild(d),e},this.clearRect=function(){a.innerHTML=""},this.drawImage=function(b,c,d){var f=e[e.length-1];b.style.position="absolute",b.style.left=px(c+f.x),b.style.top=px(d+f.y),a.appendChild(b)},this.fillRect=function(b,c,d,f){var g=e[e.length-1],h=document.createElement("div");h.style.position="absolute",h.style.left=px(b+g.x),h.style.top=px(c+g.y),h.style.width=px(d),h.style.height=px(f),h.style.backgroundColor=this.fillStyle,a.appendChild(h)},this.fillText=function(b,d,f){var g=e[e.length-1],h=document.createElement("span");h.style.position="absolute",h.style.left=px(d+g.x),h.style.top=px(f+g.y),c(h),h.style.color=this.fillStyle,h.appendChild(document.createTextNode(b)),a.appendChild(h)},this.save=function(){var a=e[e.length-1];e.push(a.clone())},this.restore=function(){e.pop()},this.translate=function(a,b){var c=e[e.length-1];c.x+=a,c.y+=b}}var b=Primrose.Size,c=Primrose.Cursor,d=Primrose.Themes.Default;return window.HTMLDivElement.prototype.getContext=function(b){if("2d"!==b)throw new Exception("type parameter needs to be '2d'.");return this.style.width=pct(100),this.style.height=pct(100),new a(this)},function(a,e){function f(a,b,c,d,e,f){a.fillStyle=b,a.fillRect(c*j.character.width,d*j.character.height,e*j.character.width+1,f*j.character.height+1)}function g(a,b,e,g,h,i){var k=c.min(b,e),m=c.max(b,e),n=new c,o=new c;s.regular.backColor&&(q.fillStyle=s.regular.backColor,l.style.backgroundColor=s.regular.backColor),q.clearRect(0,0,t,u),q.save(),q.translate((g.x-h.x)*j.character.width,-h.y*j.character.height),i&&f(q,s.regular.currentRowBackColor||d.regular.currentRowBackColor,0,k.y+.2,g.width,m.y-k.y+1);for(var p=0;p<a.length;++p){for(var r=a[p],v=0;v<r.length;++v){var w=r[v];if(o.x+=w.value.length,o.i+=w.value.length,h.y<=p&&p<h.y+g.height&&h.x<=o.x&&n.x<h.x+g.width){var x=k.i<=o.i&&n.i<m.i;if(x){var y=c.max(k,n),z=c.min(m,o),A=z.i-y.i;f(q,s.regular.selectedBackColor||d.regular.selectedBackColor,y.x,y.y+.2,A,1)}}n.copy(o)}n.x=0,++n.y,o.copy(n)}if(i){var B=s.cursorColor||"black",C=1/j.character.width;f(q,B,k.x,k.y,C,1),f(q,B,m.x,m.y,C,1)}q.restore()}function h(a,b,d){var e=new c,f=new c,g=0;p.clearRect(0,0,t,u),p.save(),p.translate((b.x-d.x)*j.character.width,-d.y*j.character.height);for(var h=0;h<a.length;++h){for(var i=a[h],k=0;k<i.length;++k){var l=i[k];if(f.x+=l.value.length,f.i+=l.value.length,d.y<=h&&h<d.y+b.height&&d.x<=f.x&&e.x<d.x+b.width){var m=s[l.type]||{},n=(m.fontWeight||s.regular.fontWeight||"")+" "+(m.fontStyle||s.regular.fontStyle||"")+" "+j.character.height+"px "+s.fontFamily;p.font=n.trim(),p.fillStyle=m.foreColor||s.regular.foreColor,p.fillText(l.value,e.x*j.character.width,h*j.character.height)}e.copy(f)}g=Math.max(g,f.x),e.x=0,++e.y,f.copy(e)}return p.restore(),g}function i(a,b,c,e,g,h,i,k){if(r.clearRect(0,0,t,u),r.save(),r.translate(0,-c.y*j.character.height),e)for(var l=c.y,m=-1;l<c.y+b.height&&l<a.length;++l){for(var n=a[l],o=n.length>0?n[0].line:m+1,p=o.toString();p.length<i;)p=" "+p;f(r,s.regular.selectedBackColor||d.regular.selectedBackColor,0,l+.2,b.x,1),r.font="bold "+j.character.height+"px "+s.fontFamily,o>m&&(r.fillStyle=s.regular.foreColor,r.fillText(p,0,l*j.character.height)),m=o}if(r.restore(),g){var q=b.width*j.character.width,v=b.height*j.character.height,w=c.x*q/k+b.x*j.character.width,x=c.y*v/a.length+b.y*j.character.height;if(r.fillStyle=s.regular.selectedBackColor||d.regular.selectedBackColor,!h&&k>b.width){var y=q*(b.width/k);r.fillRect(w,(b.height+.25)*j.character.height,Math.max(j.character.width,y),j.character.height)}if(a.length>b.height){var z=v*(b.height/a.length);r.fillRect(t-j.VSCROLL_WIDTH*j.character.width,x,j.VSCROLL_WIDTH*j.character.width,Math.max(j.character.height,z))}}}var j=this,k=cascadeElement(a,"div",window.HTMLDivElement),l=cascadeElement(k.id+"-back","div",window.HTMLDivElement),m=cascadeElement(k.id+"-front","div",window.HTMLDivElement),n=cascadeElement(k.id+"-trim","div",window.HTMLDivElement),o=k.getContext("2d"),p=m.getContext("2d"),q=l.getContext("2d"),r=n.getContext("2d"),s=null,t=null,u=null;this.VSCROLL_WIDTH=2,this.character=new b,this.id=k.id,this.autoBindEvents=!0,this.setTheme=function(a){s=a},this.pixel2cell=function(a,b,c){a.set(Math.round(a.x/this.character.width)+b.x-c.x,Math.floor(a.y/this.character.height-.25)+b.y)},this.hasResized=function(){var a=k.clientWidth,b=k.clientHeight;return t!==a||u!==b},this.resize=function(){var a=!1;if(s){var b=this.character.width,c=this.character.height,d=k.clientWidth,e=k.clientHeight,f=o.font;this.character.height=s.fontSize,o.font=px(this.character.height)+" "+s.fontFamily,this.character.width=o.measureText("MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM").width/100,a=b!==this.character.width||c!==this.character.height||f!==o.font,d>0&&e>0&&(l.width=m.width=n.width=d,l.height=m.height=n.height=e,a=a||t!==d||u!==d,t=d,u=e)}return a},this.setSize=function(a,b){return k.style.width=px(a),k.style.height=px(b),this.resize()},this.getWidth=function(){return t},this.getHeight=function(){return u},this.render=function(a,b,c,d,e,f,j,k,p,q){var r=0;g(a,b,c,d,e,f),r=h(a,d,e),i(a,d,e,j,k,p,q,r),o.clearRect(0,0,t,u),o.drawImage(l,0,0),o.drawImage(m,0,0),o.drawImage(n,0,0)},this.getDOMElement=function(){return k},this.getPixelRatio=function(){return 1},a instanceof window.HTMLDivElement||!e.width||!e.height||(k.style.position="absolute",k.style.width=e.width,k.style.height=e.height),k.parentElement||(this.autoBindEvents=!1,document.body.appendChild(makeHidingContainer("primrose-container-"+k.id,k)))}},Primrose.Themes.Dark=function(){"use strict";return{name:"Dark",fontFamily:"monospace",cursorColor:"white",fontSize:14,lineNumbers:{foreColor:"white"},regular:{backColor:"black",foreColor:"#c0c0c0",currentRowBackColor:"#202020",selectedBackColor:"#404040"},strings:{foreColor:"#aa9900",fontStyle:"italic"},numbers:{foreColor:"green"},comments:{foreColor:"yellow",fontStyle:"italic"},keywords:{foreColor:"cyan"},functions:{foreColor:"brown",fontWeight:"bold"},members:{foreColor:"green"},error:{foreColor:"red",fontStyle:"underline italic"}}}(),Primrose.Themes.Default=function(){"use strict";return{name:"Light",fontFamily:"monospace",cursorColor:"black",fontSize:14,regular:{backColor:"white",foreColor:"black",currentRowBackColor:"#f0f0f0",selectedBackColor:"#c0c0c0"},strings:{foreColor:"#aa9900",fontStyle:"italic"},numbers:{foreColor:"green"},comments:{foreColor:"grey",fontStyle:"italic"},keywords:{foreColor:"blue"},functions:{foreColor:"brown",fontWeight:"bold"},members:{foreColor:"green"},error:{foreColor:"red",fontStyle:"underline italic"}}}(),Primrose.VERSION="v0.12.0";