"use strict";function axis(e,t){var n=hub();return put(brick(16711680,e,t,t)).on(n),put(brick(65280,t,e,t)).on(n),put(brick(255,t,t,e)).on(n),n}function box(e,t,n){return void 0===t&&(t=e),void 0===n&&(n=e),cache("BoxGeometry("+e+", "+t+", "+n+")",function(){return new THREE.BoxGeometry(e,t,n)})}function brick(e,t,n,i){return textured(box(t||1,n||1,i||1),e,{txtRepeatS:t,txtRepeatT:i})}function clone(e){return JSON.parse(JSON.stringify(e))}function cloud(e,t,n){for(var i=new THREE.Geometry,r=0;r<e.length;++r)i.vertices.push(e[r]);var o=cache("PointsMaterial("+t+", "+n+")",function(){return new THREE.PointsMaterial({color:t,size:n})});return new THREE.Points(i,o)}function cylinder(e,t,n,i,r,o,s,a){return cache("CylinderGeometry("+e+", "+t+", "+n+", "+i+", "+r+", "+o+", "+s+", "+a+")",function(){return new THREE.CylinderGeometry(e,t,n,i,r,o,s,a)})}function findProperty(e,t){for(var n=0;n<t.length;++n)if(void 0!==e[t[n]])return t[n]}function sigfig(e,t){var n=Math.pow(10,t),i=(Math.round(e*n)/n).toString();if(t>0){var r=i.indexOf(".");for(-1===r&&(i+=".",r=i.length-1);i.length-r-1<t;)i+="0"}return i}function getSetting(e,t){if(window.localStorage){var n=window.localStorage.getItem(e);if(n)try{return JSON.parse(n)}catch(i){console.error("getSetting",e,n,"undefined"==typeof n?"undefined":_typeof(n),i)}}return t}function setSetting(e,t){if(window.localStorage&&t)try{window.localStorage.setItem(e,JSON.stringify(t))}catch(n){console.error("setSetting",e,t,"undefined"==typeof t?"undefined":_typeof(t),n)}}function deleteSetting(e){window.localStorage&&window.localStorage.removeItem(e)}function readForm(e){var t={};if(e)for(var n in e){var i=e[n];"INPUT"!==i.tagName&&"SELECT"!==i.tagName||i.dataset&&i.dataset.skipcache||("text"===i.type||"password"===i.type||"SELECT"===i.tagName?t[n]=i.value:"checkbox"!==i.type&&"radio"!==i.type||(t[n]=i.checked))}return t}function writeForm(e,t){if(t)for(var n in e){var i=e[n];null===t[n]||void 0===t[n]||"INPUT"!==i.tagName&&"SELECT"!==i.tagName||i.dataset&&i.dataset.skipcache||("text"===i.type||"password"===i.type||"SELECT"===i.tagName?i.value=t[n]:"checkbox"!==i.type&&"radio"!==i.type||(i.checked=t[n]))}}function hub(){return new THREE.Object3D}function InsideSphereGeometry(e,t,n,i,r,o,s){THREE.Geometry.call(this),this.type="InsideSphereGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:n,phiStart:i,phiLength:r,thetaStart:o,thetaLength:s},e=e||50,t=Math.max(3,Math.floor(t)||8),n=Math.max(2,Math.floor(n)||6),i=void 0!==i?i:0,r=void 0!==r?r:2*Math.PI,o=void 0!==o?o:0,s=void 0!==s?s:Math.PI;var a,u,c=[],l=[];for(u=0;n>=u;u++){var h=[],d=[];for(a=t;a>=0;a--){var f=a/t,m=u/n,p=new THREE.Vector3;p.x=-e*Math.cos(i+f*r)*Math.sin(o+m*s),p.y=e*Math.cos(o+m*s),p.z=e*Math.sin(i+f*r)*Math.sin(o+m*s),this.vertices.push(p),h.push(this.vertices.length-1),d.push(new THREE.Vector2(1-f,1-m))}c.push(h),l.push(d)}for(u=0;n>u;u++)for(a=0;t>a;a++){var g=c[u][a+1],y=c[u][a],v=c[u+1][a],b=c[u+1][a+1],w=this.vertices[g].clone().normalize(),x=this.vertices[y].clone().normalize(),E=this.vertices[v].clone().normalize(),P=this.vertices[b].clone().normalize(),C=l[u][a+1].clone(),_=l[u][a].clone(),R=l[u+1][a].clone(),T=l[u+1][a+1].clone();Math.abs(this.vertices[g].y)===e?(C.x=(C.x+_.x)/2,this.faces.push(new THREE.Face3(g,v,b,[w,E,P])),this.faceVertexUvs[0].push([C,R,T])):Math.abs(this.vertices[v].y)===e?(R.x=(R.x+T.x)/2,this.faces.push(new THREE.Face3(g,y,v,[w,x,E])),this.faceVertexUvs[0].push([C,_,R])):(this.faces.push(new THREE.Face3(g,y,b,[w,x,P])),this.faceVertexUvs[0].push([C,_,T]),this.faces.push(new THREE.Face3(y,v,b,[x.clone(),E,P.clone()])),this.faceVertexUvs[0].push([_.clone(),R,T.clone()]))}this.computeFaceNormals();for(var M=0;M<this.faces.length;++M){var k=this.faces[M];k.normal.multiplyScalar(-1);for(var S=0;S<k.vertexNormals.length;++S)k.vertexNormals[S].multiplyScalar(-1)}this.boundingSphere=new THREE.Sphere(new THREE.Vector3,e)}function light(e,t,n,i){return new THREE.PointLight(e,t,n,i)}function copyObject(e,t){for(var n=[{dest:e,source:t}];n.length>0;){var i=n.pop();t=i.source,e=i.dest;for(var r in t)t.hasOwnProperty(r)&&("object"!==_typeof(t[r])?e[r]=t[r]:(e[r]||(e[r]={}),n.push({dest:e[r],source:t[r]})))}}function range(e,t,n,i){for(var r=n&&e||0,o=n&&t||e,s=i&&n||1,a=i||n||t,u=r;o>u;u+=s)a(u)}function emit(e,t){for(var n=this.listeners&&this.listeners[e]||this._listeners&&this._listeners[e],i=0;n&&i<n.length;++i)n[i](t)}function overwrite(e,t){e=e||{};for(var n in t)e[n]=t[n];return e}function patch(e,t){e=e||{};for(var n in t)void 0!==e[n]&&null!==e[n]||(e[n]=t[n]);return e}function put(e){return{on:function(t){return t.add(e),{at:function(t,n,i){return e.position.set(t,n,i),e}}}}}function quad(e,t,n,i){return void 0===t&&(t=e),cache("PlaneBufferGeometry("+e+", "+t+", "+n+", "+i+")",function(){return new THREE.PlaneBufferGeometry(e,t,n,i)})}function shell(e,t,n,i,r){var o=.45;void 0===i&&(i=Math.PI*o),void 0===r&&(r=Math.PI*o);var s=1.5*Math.PI-.5*i,a=.5*(Math.PI-r);return cache("InsideSphereGeometry("+e+", "+t+", "+n+", "+i+", "+r+")",function(){return new InsideSphereGeometry(e,t,n,s,i,a,r,!0)})}function sphere(e,t,n){return cache("SphereGeometry("+e+", "+t+", "+n+")",function(){return new THREE.SphereGeometry(e,t,n)})}function v3(e,t,n){return new THREE.Vector3(e,t,n)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var setFalse=function(e){return e.returnValue=!1};window.Primrose=function(){var e={};e.Controls={},e.DOM={},e.HTTP={},e.Input={},e.Network={},e.Output={},e.Random={},e.Text={},e.Text.CodePages={},e.Text.CommandPacks={},e.Text.Controls={},e.Text.Grammars={},e.Text.OperatingSystems={},e.Text.Renderers={},e.Text.Themes={},e.X={},e.SYS_FONTS="-apple-system, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif",e.SKINS=["#FFDFC4","#F0D5BE","#EECEB3","#E1B899","#E5C298","#FFDCB2","#E5B887","#E5A073","#E79E6D","#DB9065","#CE967C","#C67856","#BA6C49","#A57257","#F0C8C9","#DDA8A0","#B97C6D","#A8756C","#AD6452","#5C3836","#CB8442","#BD723C","#704139","#A3866A","#870400","#710101","#430000","#5B0001","#302E2E"],e.SKIN_VALUES=e.SKINS.map(function(e){return parseInt(e.substring(1),16)});var t=null;return e.loadTexture=function(e){return t=t||new THREE.TextureLoader,t.setCrossOrigin(THREE.ImageUtils.crossOrigin),new Promise(function(n,i){return t.load(e,n,null,i)})},window.isInIFrame=window.self!==window.top,window.isMobile=function(e){return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od|ad)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substring(0,4))}(navigator.userAgent||navigator.vendor||window.opera),window.isGearVR=navigator.userAgent.indexOf("Mobile VR")>-1,window.isiOS=/iP(hone|od|ad)/.test(navigator.userAgent||""),window.isOSX=/Macintosh/.test(navigator.userAgent||""),window.isWindows=/Windows/.test(navigator.userAgent||""),window.isOpera=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0,window.isSafari=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,window.isChrome=!!window.chrome&&!window.isOpera,window.isFirefox="undefined"!=typeof window.InstallTrigger,window.isWebKit=window.isiOS||window.isOpera||window.isChrome,window.isIE=!!document.documentMode,e}();var cache=function(){var e={};return function(t,n){return e[t]||(e[t]=n()),e[t]}}(),fmt=function(){function e(e,t){return t.replace(/( AM| PM|$)/,function(t,n){return(e.getMilliseconds()/1e3).toString().substring(1)+n})}function t(t){var i=arguments;return"string"!=typeof t&&(t=t.toString()),t.replace(n,function(t,n,r,o){if(r=parseInt(r,10),r>=0&&r<i.length){var s=i[r];if(null!==s&&void 0!==s){if(s instanceof Date&&o){switch(o.length){case 1:s=s.getYear()+1900;break;case 2:s=s.getMonth()+1+"/"+(s.getYear()+1900);break;case 3:s=s.toLocaleDateString();break;case 4:s=e(s,s.toLocaleTimeString());break;case 5:case 6:s=s.toLocaleString();break;default:s=e(s,s.toLocaleString())}return s}if(s=o&&o.length>0?sigfig(s,o.length):s.toString(),n&&n.length>0)for(var a=new RegExp("^\\d{"+(n.length+1)+"}(\\.\\d+)?");!a.test(s);)s="0"+s;return s}}})}var n=/\$(0*)(\d+)(?:\.(0+))?/g;return t}(),px=fmt.bind(void 0,"$1px"),pct=fmt.bind(void 0,"$1%"),ems=fmt.bind(void 0,"$1em"),rems=fmt.bind(void 0,"$1rem"),vws=fmt.bind(void 0,"$1vw"),rgb=fmt.bind(void 0,"rgb($1, $2, $3)"),rgba=fmt.bind(void 0,"rgba($1, $2, $3, $4)"),hsl=fmt.bind(void 0,"hsl($1, $2%, $3%)"),hsla=fmt.bind(void 0,"hsla($1, $2%, $3%, $4)"),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},FullScreen=function(){var e=findProperty(document,["fullscreenElement","mozFullScreenElement","webkitFullscreenElement","msFullscreenElement"]),t=findProperty(document,["onfullscreenchange","onmozfullscreenchange","onwebkitfullscreenchange","onmsfullscreenchange"]),n=findProperty(document,["onfullscreenerror","onmozfullscreenerror","onwebkitfullscreenerror","onmsfullscreenerror"]),i=findProperty(document.documentElement,["requestFullscreen","mozRequestFullScreen","webkitRequestFullscreen","webkitRequestFullScreen","msRequestFullscreen"]),r=findProperty(document,["exitFullscreen","mozExitFullScreen","webkitExitFullscreen","webkitExitFullScreen","msExitFullscreen"]);t=t&&t.substring(2),n=n&&n.substring(2);var o={addChangeListener:function(e,n){return document.addEventListener(t,e,n)},removeChangeListener:function(e){return document.removeEventListener(t,e)},addErrorListener:function(e,t){return document.addEventListener(n,e,t)},removeErrorListener:function(e){return document.removeEventListener(n,e)},withChange:function(e){return new Promise(function(t,n){var i,r,o,s=function(){o&&clearTimeout(o),FullScreen.removeChangeListener(i),FullScreen.removeErrorListener(r)};i=function(){setTimeout(s),t(FullScreen.element)},r=function(e){setTimeout(s),n(e)},FullScreen.addChangeListener(i,!1),FullScreen.addErrorListener(r,!1),e()?(s(),t(FullScreen.element)):o=setTimeout(function(){s(),n("Fullscreen state did not change in allotted time")},1e3)})},request:function(e,t){return FullScreen.withChange(function(){if(!i)throw console.error("No Fullscreen API support."),new Error("No Fullscreen API support.");return FullScreen.isActive?!0:void(t?e[i](t):isChrome?e[i](window.Element.ALLOW_KEYBOARD_INPUT):e[i]())})},exit:function(){return FullScreen.withChange(function(){if(!r)throw console.error("No Fullscreen API support."),new Error("No Fullscreen API support.");return FullScreen.isActive?void document[r]():!0})}};return Object.defineProperties(o,{element:{get:function(){return document[e]}},isActive:{get:function(){return!!FullScreen.element}}}),o}();"undefined"!=typeof window.THREE&&(InsideSphereGeometry.prototype=Object.create(THREE.Geometry.prototype),InsideSphereGeometry.prototype.constructor=InsideSphereGeometry);var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},textured=function(){function e(e,n,i){i=i||{},void 0===i.opacity&&(i.opacity=1);var r=n.id||n.toString(),o="Primrose.textured("+r+", "+i.txtRepeatS+", "+i.txtRepeatT+")",s="material("+o+", "+i.unshaded+", "+i.opacity+")",a=cache(s,function(){var e={transparent:!0,opacity:i.opacity,side:THREE.DoubleSide,alphaTest:.5},t=THREE.MeshStandardMaterial;return i.unshaded?(e.shading=THREE.FlatShading,t=THREE.MeshBasicMaterial):(void 0===i.roughness&&(i.roughness=.5),void 0===i.metalness&&(i.metalness=0),e.roughness=i.roughness,e.metalness=i.metalness),new t(e)});a.wireframe=!!i.wireframe;var u=null;if(e.type.indexOf("Geometry")>-1?u=new THREE.Mesh(e,a):e instanceof THREE.Object3D&&(e.material=a,u=e),"number"==typeof n||n instanceof Number)a.color.set(n);else{a.color.set(16777215);var c=function(n){if(n instanceof Primrose.Surface){if(i.scaleTextureWidth||!i.scaleTextureHeight){var r=n.imageWidth,s=n.imageHeight,u=Math.ceil(Math.log(r)/Math.LN2),c=Math.ceil(Math.log(s)/Math.LN2),l=Math.pow(2,u),h=Math.pow(2,c),d=r/l,f=s/h;1===d&&1===f||(1!==d&&(i.scaleTextureWidth=d),1!==f&&(i.scaleTextureHeight=f),n.bounds.width=l,n.bounds.height=h,n.resize(),n.invalidate())}n=n.texture}if(i.txtRepeatS*i.txtRepeatT>1&&(n.wrapS=n.wrapT=THREE.RepeatWrapping,n.repeat.set(i.txtRepeatS,i.txtRepeatT)),i.scaleTextureWidth||i.scaleTextureHeight)if(e.attributes&&e.attributes.uv&&e.attributes.uv.array){var m,p=e.attributes.uv,g=p.array;if(i.scaleTextureWidth)for(m=0;m<g.length;m+=p.itemSize)g[m]*=i.scaleTextureWidth;if(i.scaleTextureHeight)for(m=1;m<g.length;m+=p.itemSize)g[m]=1-(1-g[m])*i.scaleTextureHeight}else console.trace(e);t[o]=n,a.map=n,a.needsUpdate=!0,n.needsUpdate=!0};t[o]?c(t[o]):n instanceof Primrose.Surface?(n._material=a,Primrose.Entity.registerEntity(n),c(n),u.surface=n):"string"==typeof n?Primrose.loadTexture(n).then(c)["catch"](console.error.bind(console,"Error loading texture",n)):c(n instanceof Primrose.Text.Controls.TextBox?n.renderer.texture:n instanceof HTMLCanvasElement?new THREE.Texture(n):n)}return u}var t={};return e}();Primrose.Angle=function(){function e(e){if("number"!=typeof e)throw new Error("Angle must be initialized with a number. Initial value was: "+e);var t,n,i,r=e,o=0;Object.defineProperty(this,"degrees",{set:function(e){do t=e+o-r,n=Math.abs(t+360),i=Math.abs(t-360),t=Math.abs(t),t>n&&i>n?o+=360:t>i&&(o-=360);while(t>n||t>i);r=e+o},get:function(){return r}})}var t=Math.PI/180,n=180/Math.PI;return Object.defineProperty(e.prototype,"radians",{get:function(){return this.degrees*t},set:function(e){this.degrees=e*n}}),e}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Primrose.BaseControl=function(){var e=1,t="([+-]?(?:(?:\\d+(?:\\.\\d*)?)|(?:\\.\\d+)))",n="\\s*,\\s*",i="(?:em|px)",r=new RegExp("translate3d\\s*\\(\\s*"+t+i+n+t+i+n+t+i+"\\s*\\)","i"),o=new RegExp("rotate3d\\s*\\(\\s*"+t+n+t+n+t+n+t+"rad\\s*\\)","i"),s=function(){function t(){_classCallCheck(this,t),this.controlID=e++,this.focused=!1,this.listeners={focus:[],blur:[]}}return _createClass(t,[{key:"addEventListener",value:function(e,t){this.listeners[e]&&this.listeners[e].push(t)}},{key:"focus",value:function(){this.focused=!0,emit.call(this,"focus",{target:this})}},{key:"blur",value:function(){this.focused=!1,emit.call(this,"blur",{target:this})}},{key:"copyElement",value:function(e){if(this.element=e,e.style.transform){var t=r.exec(e.style.transform);t&&this.position.set(parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3])),t=o.exec(e.style.transform),t&&this.quaternion.setFromAxisAngle((new THREE.Vector3).set(parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3])),parseFloat(t[4]))}}}]),t}();return s}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Primrose.BrowserEnvironment=function(){function e(e){var t=e.position.clone();for(e=e.parent;null!==e;)t.applyMatrix4(e.matrix),e=e.parent;return t.toArray()}if("undefined"==typeof THREE)return function(){};var t=.001,n=new THREE.Vector3(1,0,0),i=new THREE.Vector3(0,1,0),r=new THREE.Vector3(0,0,-1),o=.01,s=20,a=["keydown","keyup","keypress","mousedown","mouseup","mousemove","wheel","touchstart","touchend","touchmove"],u=1,c=function(){function c(l,h){function d(e){for(var t="",n=0;n<e.length;++n)n>0&&(t+=","),t+=e[n];return t}function f(e,t){return e.children[0].material.color.set(t)}function m(e){var t=e.getHSL();for(t.h=t.h+.5,t.l=1-t.l;t.h>1;)t.h-=1;return e.setHSL(t.h,t.s,t.l),e}var p=this;_classCallCheck(this,c),this.options=patch(h,c.DEFAULTS);var g=emit.bind(this);this.addEventListener=function(e,t,n){p.listeners[e]?p.listeners[e].push(t):a.indexOf(e)>=0&&window.addEventListener(e,t,n)};var y=function(){return p.currentControl&&p.currentControl.lockMovement};this.zero=function(){y()||(p.player.position.set(0,p.avatarHeight,0),p.player.velocity.set(0,0,0),p.input.zero())};var v=function(e,t){var n=e;"Object3D"!==e.type&&"Group"!==e.type||!e.children[0]||(n=e.children[0],n.name=n.name||e.name);for(var i,r=n.uuid,o=new THREE.Matrix4,s=(new THREE.Matrix4).identity(),a=!1,u=b[r],c=!1,l=!!e.disabled,h={uuid:r,name:null,inScene:null,visible:null,disabled:null,matrix:null,geometry:null},f=n;null!==f;)f.updateMatrix(),o.copy(f.matrix),o.multiply(s),i=o,o=s,s=i,f=f.parent,a=a||f===p.scene;u&&u.visible===e.visible||(c=!0,h.visible=e.visible),u&&u.disabled===l||(c=!0,h.disabled=l);var m=s.elements.subarray(0,s.elements.length),g=d(m);if(u&&u.matrix&&d(u.matrix)===g||(c=!0,h.matrix=m),u&&u.inScene===a||(c=!0,h.inScene=a),t===!0&&(c=!0,h.name=e.name,h.geometry=n.geometry),c){if(u)for(var y in h)u[y]=h[y];else b[r]=h;return h}},b={};this.registerPickableObject=function(e){if(e){var t,n,i,r,o=v(e,!0),s=o.geometry;if(s instanceof THREE.BufferGeometry){var a=s.attributes,u=a.position,c=a.uv,l=a.index;for(t=[],n=[],c&&(i=[]),r=0;r<u.count;++r)t.push([u.getX(r),u.getY(r),u.getZ(r)]),c&&i.push([c.getX(r),c.getY(r)]);if(l)for(r=0;r<l.count-2;++r)n.push([l.getX(r),l.getX(r+1),l.getX(r+2)]);else for(r=0;r<u.count;r+=3)n.push([r,r+1,r+2])}else for(t=s.vertices.map(function(e){return e.toArray()}),n=[],i=[],r=0;r<s.faces.length;++r){var h=s.faces[r],d=s.faceVertexUvs[0][r];n.push([h.a,h.b,h.c]),
i[h.a]=[d[0].x,d[0].y],i[h.b]=[d[1].x,d[1].y],i[h.c]=[d[2].x,d[2].y]}o.geometry={uuid:s.uuid,vertices:t,faces:n,uvs:i},p.pickableObjects[o.uuid]=e,p.projector.setObject(o)}};var w=!1,x=function(){1===Primrose.Input.VR.Version&&isMobile&&w!==FullScreen.isActive&&(window.dispatchEvent(new Event("vrdisplaypresentchange")),w=FullScreen.isActive)},E=function(e){var t=e-F;F=e,x(),P(t),C(),_(),R(),k(),g("update",t)},P=function(e){p.input.update();var t=p.input.getValue("heading"),r=p.input.getValue("pitch"),o=p.input.getValue("strafe"),s=p.input.getValue("drive");if(p.inVR||isMobile?p.input.getOrientation(j):j.set(0,0,0,1),z.setFromAxisAngle(n,r),p.player.isOnGround?y()||(p.player.velocity.set(o,0,s).normalize().multiplyScalar(p.walkSpeed),V.setFromAxisAngle(i,H),p.player.velocity.applyQuaternion(j),p.player.velocity.y=0,p.player.velocity.applyQuaternion(V)):p.player.velocity.y-=p.options.gravity*e,p.player.position.add(G.copy(p.player.velocity).multiplyScalar(e)),!p.player.isOnGround&&p.player.position.y<p.avatarHeight&&(p.player.isOnGround=!0,p.player.position.y=p.avatarHeight,p.player.velocity.y=0),p.inVR){var a=t-H;if(!y()&&Math.abs(a)>Math.PI/5){var u=Math.sign(a)*Math.PI/100;H+=u,t-=u,a=t-H}p.player.quaternion.setFromAxisAngle(i,H),V.setFromAxisAngle(i,a).multiply(z)}else H=t,p.player.quaternion.setFromAxisAngle(i,H),p.player.quaternion.multiply(z)},C=function(){p.sky&&p.sky.position.copy(p.player.position)},_=function(){p.ground&&(p.ground.position.set(Math.floor(p.player.position.x),0,Math.floor(p.player.position.z)),p.ground.material.needsUpdate=!0)},R=function(){p.pointer.position.copy(r),p.inVR&&!isMobile&&p.pointer.position.applyQuaternion(V),y()&&!isMobile||(p.pointer.position.add(p.camera.position),p.pointer.position.applyQuaternion(p.camera.quaternion)),p.pointer.position.applyQuaternion(p.player.quaternion),p.pointer.position.add(p.player.position)},T=function(e){if("keyboard"!==e||!y())if(D){var t=p.pickableObjects[D.objectID];if(t){var n=t.button||t.surface;g("pointerstart",D),emit.call(t,"click"),p.currentControl&&p.currentControl!==n&&(p.currentControl.blur(),p.currentControl=null),!p.currentControl&&n?(p.currentControl=n,p.currentControl.focus()):t===p.ground&&(p.player.position.copy(p.pointer.position),p.player.position.y=p.avatarHeight,p.player.isOnGround=!1),p.currentControl&&p.currentControl.startUV(D.point)}}else p.currentControl&&(p.currentControl.blur(),p.currentControl=null)},M=function(e){if(("keyboard"!==e||!y())&&D){var t=p.pickableObjects[D.objectID];if(t){t.button||t.surface;g("pointerend",N),p.currentControl&&p.currentControl.endPointer()}}},k=function(){if(p.projector.ready){p.projector.ready=!1;var t=[],n=[];for(var i in p.pickableObjects){var r=p.pickableObjects[i],a=v(r);a&&(t.push(a),a.inScene===!1&&n.push(i))}t.length>0&&p.projector.updateObjects(t);for(var u=0;u<n.length;++u)delete p.pickableObjects[n[u]];p.projector.projectPointer([p.pointer.position.toArray(),e(p.player)])}var c=p.input.getValue("dButtons");if(D){var l=D.facePoint,h=D.faceNormal,d=p.pickableObjects[D.objectID];if(p.pointer.position.set(l[0]+h[0]*o,l[1]+h[1]*o,l[2]+h[2]*o),d===p.ground?p.pointer.scale.set(s,s,s):p.pointer.scale.set(1,1,1),p.pointer.material.color.setRGB(1,1,1),p.pointer.material.emissive.setRGB(.25,.25,.25),d){var f=p.input.getValue("buttons"),m=0!==c;d.button||d.surface;y()||(f|=p.input.Keyboard.getValue("select"),m=m||0!==p.input.Keyboard.getValue("dSelect")),!m&&f>0&&(N&&D&&N.objectID===D.objectID&&g("pointermove",D),p.currentControl&&D.point&&p.currentControl.moveUV(D.point))}}else p.pointer.material.color.setRGB(1,0,0),p.pointer.material.emissive.setRGB(.25,0,0),p.pointer.scale.set(1,1,1)},S=function de(e){te(de),E(e*t),A()},O=0,I=!1,A=function(){if(p.inVR){p.renderer.clear(!0,!0,!0);for(var e=xVR.transforms,t=0;e&&t<e.length;++t){var n=e[t],i=n.viewport,r=2*t-1;Primrose.Entity.eyeBlankAll(t),p.input.getVector3("headX","headY","headZ",p.camera.position),p.camera.projectionMatrix.copy(n.projection),B.set(0,0,0),B.applyMatrix4(n.translation),B.applyQuaternion(j),p.camera.position.add(B),p.camera.quaternion.copy(j),p.options.useNose&&(p.nose.visible=!0,p.nose.position.set(r*-.12,-.12,-.15),p.nose.rotation.z=.7*r),p.renderer.setViewport(i.left*u,i.top*u,i.width*u,i.height*u),p.renderer.render(p.scene,p.camera)}p.input.VR.currentDisplay.submitFrame(p.input.VR.currentPose)}isMobile||p.audio.setPlayer(p.camera),(!p.inVR||p.input.VR.currentDisplay.capabilities.hasExternalDisplay&&!p.options.disableMirroring)&&(I&&Primrose.Entity.eyeBlankAll(O=1-O),p.nose.visible=!1,p.camera.fov=p.options.defaultFOV,p.camera.aspect=p.renderer.domElement.width/p.renderer.domElement.height,p.camera.updateProjectionMatrix(),p.camera.position.set(0,0,0),p.camera.quaternion.copy(j),p.renderer.clear(!0,!0,!0),p.renderer.setViewport(0,0,p.renderer.domElement.width,p.renderer.domElement.height),p.renderer.render(p.scene,p.camera))},L=function(){var e,t,n,i=p.renderer.domElement.getBoundingClientRect(),r=i.width,o=i.height;if(isMobile)if(se()){var s=screen.orientation&&screen.orientation.type||screen.mozOrientation||"";-1===s.indexOf("landscape")&&(s="landscape-primary"),screen.orientation&&screen.orientation.lock?screen.orientation.lock(s):screen.mozLockOrientation&&screen.mozLockOrientation(s)}else screen.orientation&&screen.orientation.unlock?screen.orientation.unlock():screen.mozUnlockOrientation&&screen.mozUnlockOrientation();if(p.inVR){p.input.VR.resetTransforms(p.options.nearPlane,p.options.nearPlane+p.options.drawDistance);var a=p.input.VR.transforms,c=a[0],l=a[1];e=Math.floor((c.viewport.width+l.viewport.width)*u),t=Math.floor(Math.max(c.viewport.height,l.viewport.height)*u),n=e/2}else{var h=devicePixelRatio||1;isiOS&&(o=r*screen.width/screen.height),FullScreen.isActive&&(r=screen.width,o=screen.height),e=Math.floor(r*h*u),t=Math.floor(o*h*u),n=e,isMobile&&(document.body.style.height=Math.max(document.body.clientHeight,o)+"px",document.documentElement.style.height=Math.max(document.documentElement.clientHeight,o)+"px")}p.renderer.domElement.width=e,p.renderer.domElement.height=t,p.timer||A()},F=0,N=null,D=null,H=0,z=new THREE.Quaternion,V=new THREE.Quaternion,j=new THREE.Quaternion,B=new THREE.Vector3,G=new THREE.Vector3,U=Primrose.Random.item(Primrose.SKIN_VALUES),W={monitor:"models/monitor.obj",fullscreenText:"models/fullscreen_text.obj",cardboard:null,cardboardText:null,scene:this.options.sceneModel,button:this.options.button&&"string"==typeof this.options.button.model&&this.options.button.model},X=null,Y=null;Primrose.Input.VR.Version>0&&(W.cardboard="models/cardboard.obj",W.cardboardText="models/vr_text.obj");var K=Primrose.ModelLoader.loadObjects(W).then(function(e){e.scene&&ee(e.scene),X=e.monitor,X.rotation.set(0,270*Math.PI/180,0),X.position.set(0,.7,-1),X.name="Monitor",X.add(e.fullscreenText),X.addEventListener("click",p.goFullScreen,!1),p.scene.add(X),p.scene.Monitor=X,p.registerPickableObject(X),m(f(e.fullscreenText,p.options.backgroundColor)),e.cardboard&&(X.rotation.set(0,300*Math.PI/180,0),X.position.set(-.25,.7,-1),Y=e.cardboard,Y.rotation.set(0,250*Math.PI/180,0),Y.position.set(.2,1.75,-1),Y.name="Cardboard",Y.add(e.cardboardText),Y.addEventListener("click",p.goVR,!1),p.scene.add(Y),p.scene.Cardboard=Y,p.registerPickableObject(Y),m(f(e.cardboardText,p.options.backgroundColor))),e.button?p.buttonFactory=new Primrose.ButtonFactory(e.button,p.options.button.options):p.buttonFactory=new Primrose.ButtonFactory(brick(16711680,1,1,1),{maxThrow:.1,minDeflection:10,colorUnpressed:8323072,colorPressed:32512,toggle:!0})})["catch"](function(){p.buttonFactory||(p.buttonFactory=new Primrose.ButtonFactory(brick(16711680,1,1,1),{maxThrow:.1,minDeflection:10,colorUnpressed:8323072,colorPressed:32512,toggle:!0}))}).then(function(){p.renderer.domElement.style.cursor="default",g("ready")});this.currentControl=null,this.avatarHeight=this.options.avatarHeight,this.walkSpeed=this.options.walkSpeed,this.listeners={ready:[],update:[],gazestart:[],gazecomplete:[],gazecancel:[],pointerstart:[],pointermove:[],pointerend:[]},this.audio=new Primrose.Output.Audio3D;var q=null,Q=null;q=this.options.ambientSound&&!isMobile?this.audio.load3DSound(this.options.ambientSound,!0,-1,1,-1).then(function(e){Q=e,Q.source instanceof MediaElementAudioSourceNode||(Q.volume.gain.value=.1,console.log(Q.source),Q.source.start())}):Promise.resolve();var Z=Promise.all([K,q]);if(this.music=new Primrose.Output.Music(this.audio.context),this.pickableObjects={},this.projector=new Primrose.Workerize(Primrose.Projector),this.player=new THREE.Object3D,this.player.velocity=new THREE.Vector3,this.player.name="Player",this.player.position.set(0,this.avatarHeight,0),this.player.isOnGround=!0,this.pointer=textured(sphere(o,10,10),16711680),this.pointer.material.emissive.setRGB(.25,0,0),this.pointer.material.opacity=.75,this.nose=textured(sphere(.05,10,10),U),this.nose.name="Nose",this.nose.scale.set(.5,1,1),this.renderer=new THREE.WebGLRenderer({canvas:Primrose.DOM.cascadeElement(this.options.canvasElement,"canvas",HTMLCanvasElement),antialias:!isMobile,alpha:!0,logarithmicDepthBuffer:!1}),this.renderer.autoClear=!1,this.renderer.autoSortObjects=!0,this.renderer.setClearColor(this.options.backgroundColor),this.renderer.domElement.parentElement||document.body.appendChild(this.renderer.domElement),this.input=new Primrose.Input.FPSInput(this.renderer.domElement),this.scene=new THREE.Scene,this.options.useFog&&(this.scene.fog=new THREE.FogExp2(this.options.backgroundColor,2/this.options.drawDistance)),this.camera=new THREE.PerspectiveCamera(75,1,this.options.nearPlane,this.options.nearPlane+this.options.drawDistance),this.options.skyTexture&&(this.sky=textured(shell(this.options.drawDistance,18,9,2*Math.PI,Math.PI),this.options.skyTexture,{unshaded:!0}),this.sky.name="Sky",this.scene.add(this.sky)),this.options.groundTexture){var $=10,J=new THREE.PlaneGeometry(5*$,5*$,$,$);this.ground=textured(J,this.options.groundTexture,{txtRepeatS:5*$,txtRepeatT:5*$}),this.ground.rotation.x=-Math.PI/2,this.ground.name="Ground",this.scene.add(this.ground),this.registerPickableObject(this.ground)}this.camera.add(this.nose),this.player.add(this.camera),this.scene.add(this.player),this.scene.add(this.pointer),this.passthrough&&this.camera.add(this.passthrough.mesh);var ee=function(e){return e.buttons=[],e.traverse(function(t){t.isButton&&e.buttons.push(new Primrose.Button(t.parent,t.name)),t.name&&(e[t.name]=t)}),p.scene.add.apply(p.scene,e.children),p.scene.traverse(function(e){e.name&&(p.scene[e.name]=e)}),e.Camera&&(p.camera.position.copy(e.Camera.position),p.camera.quaternion.copy(e.Camera.quaternion)),e};put(light(16777215,1.5,50)).on(this.scene).at(0,10,10);var te=function(e){p.inVR?p.timer=p.input.VR.currentDisplay.requestAnimationFrame(e):p.timer=requestAnimationFrame(e)};this.start=function(){Z.then(L).then(function(){p.audio.start(),F=performance.now()*t,te(S)})},this.stop=function(){p.inVR?p.input.VR.currentDisplay.cancelAnimationFrame(p.timer):cancelAnimationFrame(p.timer),p.audio.stop(),p.timer=null};var ne=function(e){var t;p.projector.ready=!0,N=D,D=e,N&&D&&N.objectID===D.objectID?(D.startTime=N.startTime,D.gazeFired=N.gazeFired,t=F-D.startTime,t>=p.options.gazeLength&&!D.gazeFired&&(D.gazeFired=!0,g("gazecomplete",D))):(N&&(t=F-N.startTime,t<p.options.gazeLength&&g("gazecancel",N)),D&&(D.startTime=F,D.gazeFired=!1,g("gazestart",D)))},ie=function(e){if(y()||e.shiftKey||e.ctrlKey||e.altKey||e.metaKey){if(p.currentControl){var t=p.currentControl.focusedElement;if(t)if(t.execCommand){var n=p.operatingSystem._deadKeyState;t.execCommand(p._browser,p.codePage,p.operatingSystem.makeCommandName(e,p.codePage))&&e.preventDefault(),p.operatingSystem._deadKeyState===n&&(p.operatingSystem._deadKeyState="")}else t.keyDown(e)}}else e.keyCode===Primrose.Keys.E&&(I=!0,e.preventDefault())},re=function(e){p.currentControl&&p.currentControl.keyUp?p.currentControl.keyUp(e):e.shiftKey||e.ctrlKey||e.altKey||e.metaKey||e.keyCode===Primrose.Keys.E&&(I=!1)};this.goFullScreen=function(){return FullScreen.request(p.renderer.domElement)},this.goVR=function(){return p.input.VR?p.input.VR.requestPresent([{source:p.renderer.domElement}]).then(function(e){if(1===Primrose.Input.VR.Version&&isMobile){var t=function i(){p.input.VR.currentDisplay.exitPresent(),window.removeEventListener("vrdisplaypresentchange",i)},n=function r(){window.addEventListener("vrdisplaypresentchange",t,!1),window.removeEventListener("vrdisplaypresentchange",r)};window.addEventListener("vrdisplaypresentchange",n,!1)}return e}):void 0};var oe=function(){Y&&(Y.disabled=p.inVR,Y.visible=!p.inVR),X.disabled=se(),X.visible=!se()};window.addEventListener("vrdisplaypresentchange",oe,!1),FullScreen.addChangeListener(oe,!1),Primrose.Input.Mouse.Lock.addChangeListener(function(e){!Primrose.Input.Mouse.Lock.isActive&&p.inVR&&p.input.VR.currentDisplay.exitPresent()},!1),window.addEventListener("vrdisplaypresentchange",L,!1);var se=function(){return!(!FullScreen.isActive&&!p.inVR)};c.createSurrogate.call(this),this.operatingSystem=this.options.os,this.codePage=this.options.language;var ae=function(e){var t=p.operatingSystem.makeCommandName(e,p.codePage);"CUT"!==t&&"COPY"!==t||(p._surrogate.style.display="block",p._surrogate.focus())},ue=function(){return isGearVR?p.goVR():isMobile?p.goFullScreen():Primrose.Input.Mouse.Lock.isActive||Primrose.Input.Mouse.Lock.request(p.renderer.domElement)},ce=function(){se()||(Primrose.Input.VR.Version>0?p.goVR():p.goFullScreen())},le=function(e){return function(t){p.currentControl&&(p.currentControl[e]?p.currentControl[e](t):console.warn("Couldn't find %s on %o",e,p.currentControl))}};if(this._browser=isChrome?"CHROMIUM":isFirefox?"FIREFOX":isIE?"IE":isOpera?"OPERA":isSafari?"SAFARI":"UNKNOWN",window.addEventListener("keydown",ie,!1),window.addEventListener("keyup",re,!1),window.addEventListener("keydown",ae,!0),window.addEventListener("beforepaste",setFalse,!1),window.addEventListener("paste",le("readClipboard"),!1),window.addEventListener("wheel",le("readWheel"),!1),window.addEventListener("resize",L,!1),window.addEventListener("blur",this.stop,!1),window.addEventListener("focus",this.start,!1),this.renderer.domElement.addEventListener("webglcontextlost",this.stop,!1),this.renderer.domElement.addEventListener("webglcontextrestored",this.start,!1),this.input.addEventListener("zero",this.zero.bind(this),!1),this.input.addEventListener("lockpointer",ue,!1),this.input.addEventListener("fullscreen",ce,!1),this.input.addEventListener("pointerstart",T,!1),this.input.addEventListener("pointerend",M,!1),this.projector.addEventListener("hit",ne,!1),Object.defineProperties(this,{inVR:{get:function(){return p.input.VR&&p.input.VR.currentDisplay&&p.input.VR.currentDisplay.isPresenting}}}),window.alert.toString().indexOf("native code")>-1){var he=function(e,t){return t||(t=function(){}),function(){se()?t():e.apply(window,arguments)}};window.alert=he(window.alert),window.confirm=he(window.confirm),window.prompt=he(window.prompt)}this.start()}return _createClass(c,[{key:"operatingSystem",get:function(){return this._operatingSystem},set:function(e){this._operatingSystem=e||(isOSX?Primrose.Text.OperatingSystems.OSX:Primrose.Text.OperatingSystems.Windows)}},{key:"codePage",get:function(){return this._codePage},set:function(e){var t;if(this._codePage=e,!this._codePage){var n=navigator.languages&&navigator.languages[0]||navigator.language||navigator.userLanguage||navigator.browserLanguage;n&&"en"!==n||(n="en-US");for(t in Primrose.Text.CodePages)if(e=Primrose.Text.CodePages[t],e.language===n){this._codePage=e;break}this._codePage||(this._codePage=Primrose.Text.CodePages.EN_US)}}}],[{key:"createSurrogate",value:function(){var e=this,t=function(t,n){e.currentControl&&(e.currentControl[t+"SelectedText"](n),n.returnValue||n.preventDefault(),e._surrogate.style.display="none",e.currentControl.canvas.focus())};this._surrogate=Primrose.DOM.cascadeElement("primrose-surrogate-textarea","textarea",HTMLTextAreaElement),this._surrogateContainer=Primrose.DOM.makeHidingContainer("primrose-surrogate-textarea-container",this._surrogate),this._surrogateContainer.style.position="absolute",this._surrogateContainer.style.overflow="hidden",this._surrogateContainer.style.width=0,this._surrogateContainer.style.height=0,this._surrogate.addEventListener("beforecopy",setFalse,!1),this._surrogate.addEventListener("copy",t.bind(this,"copy"),!1),this._surrogate.addEventListener("beforecut",setFalse,!1),this._surrogate.addEventListener("cut",t.bind(this,"cut"),!1),document.body.insertBefore(this._surrogateContainer,document.body.children[0])}}]),c}();return c.DEFAULT_USER_NAME="CURRENT_USER_OFFLINE",c.DEFAULTS={useNose:!1,useLeap:!1,useFog:!1,avatarHeight:1.75,walkSpeed:2,gravity:9.8,gazeLength:1,disableMirroring:!1,backgroundColor:11517951,nearPlane:.01,drawDistance:100,defaultFOV:75,dtNetworkUpdate:.125,canvasElement:"frontBuffer",ambientSound:null},c}(),Primrose.Button=function(){var e=function(e){function t(e,n,i){_classCallCheck(this,t);var r=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));return i=patch(i,t),i.minDeflection=Math.cos(i.minDeflection),i.colorUnpressed=new THREE.Color(i.colorUnpressed),i.colorPressed=new THREE.Color(i.colorPressed),r.listeners.click=[],r.listeners.release=[],r.base=e.children[1],r.cap=e.children[0],r.cap.name=n,r.cap.material=r.cap.material.clone(),r.cap.button=r,r.cap.base=r.base,r.container=new THREE.Object3D,r.container.add(r.base),r.container.add(r.cap),r.color=r.cap.material.color,r.name=n,r.element=null,r.startUV=function(){this.color.copy(i.colorPressed),this.element?this.element.click():emit.call(this,"click")},r.moveUV=function(){},r.endPointer=function(){this.color.copy(i.colorUnpressed),emit.call(this,"release")},r}return _inherits(t,e),t}(Primrose.BaseControl);return e.DEFAULTS={maxThrow:.1,minDeflection:10,colorUnpressed:8323072,colorPressed:32512,toggle:!0},Object.defineProperty(e.prototype,"position",{get:function(){return this.container.position}}),e}(),Primrose.ButtonFactory=function(){function e(e,t){this.options=t,this.template=e}var t=0;return e.prototype.create=function(e){var n="button"+ ++t,i=this.template.clone(),r=new Primrose.Button(i,n,this.options,e);return r},e}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Primrose.Entity=function(){var e=new WeakMap,t=function(){function t(e){_classCallCheck(this,t),this.id=e,this.parent=null,this.children=[],this.focused=!1,this.listeners={focus:[],blur:[],click:[],keydown:[],keyup:[],paste:[],copy:[],cut:[],wheel:[]}}return _createClass(t,null,[{key:"registerEntity",value:function(t){e[t.id]=t}},{key:"eyeBlankAll",value:function(t){for(var n in e)e[n].eyeBlank(t)}}]),_createClass(t,[{key:"addEventListener",value:function(e,t){this.listeners[e]&&this.listeners[e].push(t)}},{key:"removeEventListener",value:function(e,t){var n=this.listeners[e];if(evt){var i=n.indexOf(t);i>=0&&i<n.length&&n.splice(i,1)}}},{key:"focus",value:function(){this.focused=!0,emit.call(this,"focus",{target:this})}},{key:"blur",value:function(){this.focused=!1;for(var e=0;e<this.children.length;++e)this.children[e].focused&&this.children[e].blur();emit.call(this,"blur",{target:this})}},{key:"appendChild",value:function(e){e&&!e.parent&&(e.parent=this,this.children.push(e))}},{key:"removeChild",value:function(e){console.log("removeChild",this.id);var t=this.children.indexOf(e);t>=0&&t<this.children.length&&(this.children.splice(t,1),e.parent=null)}},{key:"_forFocusedChild",value:function(e,t){var n=this.focusedElement;n&&n!==this&&n[e](t)}},{key:"startDOMPointer",value:function(e){for(var t=0;t<this.children.length;++t)this.children[t].startDOMPointer(e)}},{key:"eyeBlank",value:function(e){for(var t=0;t<this.children.length;++t)this.children[t].eyeBlank(e)}},{key:"moveDOMPointer",value:function(e){this._forFocusedChild("moveDOMPointer",e)}},{key:"startUV",value:function(e){this._forFocusedChild("startUV",e)}},{key:"moveUV",value:function(e){this._forFocusedChild("moveUV",e)}},{key:"endPointer",value:function(){this._forFocusedChild("endPointer")}},{key:"keyDown",value:function(e){this._forFocusedChild("keyDown",e)}},{key:"keyUp",value:function(e){this._forFocusedChild("keyUp",e)}},{key:"readClipboard",value:function(e){this._forFocusedChild("readClipboard",e)}},{key:"copySelectedText",value:function(e){this._forFocusedChild("copySelectedText",e)}},{key:"cutSelectedText",value:function(e){this._forFocusedChild("cutSelectedText",e)}},{key:"readWheel",value:function(e){this._forFocusedChild("readWheel",e)}},{key:"theme",get:function(){return null},set:function(e){for(var t=0;t<this.children.length;++t)this.children[t].theme=e}},{key:"lockMovement",get:function(){for(var e=!1,t=0;t<this.children.length&&!e;++t)e|=this.children[t].lockMovement;return e}},{key:"focusedElement",get:function(){if(this.focused){for(var e=0;e<this.children.length;++e){var t=this.children[e];if(t.focused)return t.focusedElement}return this}}}]),t}();return t}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Primrose.InputProcessor=function(){var e=function(){function e(t,n,i){var r=this;_classCallCheck(this,e),this.name=t,this.commands={},this.commandNames=[],this.socket=i,this.enabled=!0,this.paused=!1,this.ready=!0,this.transmitting=!0,this.receiving=!0,this.socketReady=!1,this.inPhysicalUse=!0,this.inputState={buttons:[],axes:[],ctrl:!1,alt:!1,shift:!1,meta:!1},this.lastState="",this.lastT=performance.now();var o=function(e){for(var t=0;t<Primrose.Keys.MODIFIER_KEYS.length;++t){var n=Primrose.Keys.MODIFIER_KEYS[t];r.inputState[n]=e[n+"Key"]}r.update()};window.addEventListener("keydown",o,!1),window.addEventListener("keyup",o,!1),i&&(i.on("open",function(){this.socketReady=!0,this.inPhysicalUse=!this.receiving}.bind(this)),i.on(t,function(e){this.receiving&&(this.inPhysicalUse=!1,this.decodeStateSnapshot(e),this.fireCommands())}.bind(this)),i.on("close",function(){this.inPhysicalUse=!0,this.socketReady=!1}.bind(this)));for(var s in n)this.addCommand(s,n[s]);for(var a=0;a<Primrose.Keys.MODIFIER_KEYS.length;++a)this.inputState[Primrose.Keys.MODIFIER_KEYS[a]]=!1;this.axisNames=Primrose.Input[t]&&Primrose.Input[t].AXES||[];for(var a=0;a<this.axisNames.length;++a)this.inputState.axes[a]=0}return _createClass(e,null,[{key:"defineAxisProperties",value:function(e,t){e.AXES=t,t.forEach(function(t,n){e[t]=n+1,Object.defineProperty(e.prototype,t,{get:function(){return this.getAxis(t)},set:function(e){this.setAxis(t,e)}})})}}]),_createClass(e,[{key:"addCommand",value:function(e,t){t.name=e,t=this.cloneCommand(t),t.repetitions=t.repetitions||1,t.state={value:null,pressed:!1,wasPressed:!1,fireAgain:!1,lt:0,ct:0,repeatCount:0},this.commands[e]=t,this.commandNames.push(e)}},{key:"cloneCommand",value:function(e){return{name:e.name,disabled:!!e.disabled,dt:e.dt||0,deadzone:e.deadzone||0,threshold:e.threshold||0,repetitions:e.repetitions||-1,scale:e.scale,offset:e.offset,min:e.min,max:e.max,integrate:e.integrate||!1,delta:e.delta||!1,axes:this.maybeClone(e.axes),commands:e.commands&&e.commands.slice()||[],buttons:this.maybeClone(e.buttons),metaKeys:this.maybeClone(e.metaKeys&&e.metaKeys.map(function(e){for(var t=0;t<Primrose.Keys.MODIFIER_KEYS.length;++t){var n=Primrose.Keys.MODIFIER_KEYS[t];if(Math.abs(e)===Primrose.Keys[n.toLocaleUpperCase()])return Math.sign(e)*(t+1)}}.bind(this))),commandDown:e.commandDown,commandUp:e.commandUp}}},{key:"update",value:function(){var e=performance.now()/1e3,t=e-this.lastT;if(this.lastT=e,this.ready&&this.enabled&&this.inPhysicalUse&&!this.paused&&t>0){for(var n in this.commands){var i=this.commands[n];if(i.state.wasPressed=i.state.pressed,i.state.pressed=!1,!i.disabled){var r=!0;if(i.metaKeys)for(var o=0;o<i.metaKeys.length&&r;++o){var s=i.metaKeys[o];r=r&&(this.inputState[Primrose.Keys.MODIFIER_KEYS[s.index]]&&!s.toggle||!this.inputState[Primrose.Keys.MODIFIER_KEYS[s.index]]&&s.toggle)}if(r){var o,a,u=!0,c=0,l=!1;for(o in this.inputState.buttons)if(this.inputState.buttons[o]){l=!0;break}if(i.buttons)for(o=0;o<i.buttons.length;++o){var h=i.buttons[o],d=h.index===Primrose.Keys.ANY-1&&l||!!this.inputState.buttons[h.index+1];a=d?h.sign:0,u=u&&(d&&!h.toggle||!d&&h.toggle),Math.abs(a)>Math.abs(c)&&(c=a)}if(i.axes)for(o=0;o<i.axes.length;++o){var f=i.axes[o];a=f.sign*this.inputState.axes[f.index],Math.abs(a)>Math.abs(c)&&(c=a)}for(o=0;o<i.commands.length;++o)a=this.getValue(i.commands[o]),Math.abs(a)>Math.abs(c)&&(c=a);if(void 0!==i.scale&&(c*=i.scale),void 0!==i.offset&&(c+=i.offset),i.deadzone&&Math.abs(c)<i.deadzone&&(c=0),i.integrate)c=this.getValue(i.name)+c*t;else if(i.delta){var m=c;void 0!==i.state.lv&&(c=(c-i.state.lv)/t),i.state.lv=m}void 0!==i.min&&(c=Math.max(i.min,c)),void 0!==i.max&&(c=Math.min(i.max,c)),i.threshold&&(u=u&&c>i.threshold),i.state.pressed=u,i.state.value=c}i.state.lt+=t,i.state.fireAgain=i.state.pressed&&i.state.lt>=i.dt&&(-1===i.repetitions||i.state.repeatCount<i.repetitions),i.state.fireAgain?(i.state.lt=0,++i.state.repeatCount):i.state.pressed||(i.state.repeatCount=0)}}if(this.socketReady&&this.transmitting){var p=this.makeStateSnapshot();p!==this.lastState&&(this.socket.emit(this.name,p),this.lastState=p)}this.fireCommands()}}},{key:"fireCommands",value:function(){if(this.ready&&!this.paused)for(var e in this.commands){var t=this.commands[e];t.state.fireAgain&&t.commandDown&&t.commandDown(this.name),!t.state.pressed&&t.state.wasPressed&&t.commandUp&&t.commandUp(this.name)}}},{key:"makeStateSnapshot",value:function(){var e="",t=0,n=Object.keys(this.commands).length;for(var i in this.commands){var r=this.commands[i];r.state&&(e+=t<<2|(r.state.pressed?1:0)|(r.state.fireAgain?2:0)+":"+r.state.value,n-1>t&&(e+="|")),++t}return e}},{key:"decodeStateSnapshot",value:function(e){var t,n;for(n in this.commands)t=this.commands[n],t.state.wasPressed=t.state.pressed;for(var i=e.split("|"),r=0;r<i.length;++r){var o=i[r],s=o.split(":"),a=parseInt(s[0],10),u=0!==(1&a),c=0!==(2&l),l=parseInt(s[2],10);a>>=2,n=this.commandNames(a),t=this.commands[n],t.state={value:parseFloat(s[1]),pressed:u,fireAgain:c}}}},{key:"setProperty",value:function(e,t,n){this.commands[t]&&(this.commands[t][e]=n)}},{key:"setDeadzone",value:function(e,t){this.setProperty("deadzone",e,t)}},{key:"setScale",value:function(e,t){this.setProperty("scale",e,t)}},{key:"setDT",value:function(e,t){this.setProperty("dt",e,t)}},{key:"setMin",value:function(e,t){this.setProperty("min",e,t)}},{key:"setMax",value:function(e,t){this.setProperty("max",e,t)}},{key:"addToArray",value:function(e,t,n){this.commands[t]&&this.commands[t][e]&&this.commands[t][e].push(n)}},{key:"addMetaKey",value:function(e,t){this.addToArray("metaKeys",e,t)}},{key:"addAxis",value:function(e,t){this.addToArray("axes",e,t)}},{key:"addButton",value:function(e,t){this.addToArray("buttons",e,t)}},{key:"removeMetaKey",value:function(e,t){this.removeFromArray("metaKeys",e,t)}},{key:"removeAxis",value:function(e,t){this.removeFromArray("axes",e,t)}},{key:"removeButton",value:function(e,t){this.removeFromArray("buttons",e,t)}},{key:"invertAxis",value:function(e,t){this.invertInArray("axes",e,t)}},{key:"invertButton",value:function(e,t){this.invertInArray("buttons",e,t)}},{key:"invertMetaKey",value:function(e,t){this.invertInArray("metaKeys",e,t)}},{key:"removeFromArray",value:function(e,t,n){if(this.commands[t]&&this.commands[t][e]){var i=this.commands[t][e],r=i.indexOf(n);r>-1&&i.splice(r,1)}}},{key:"invertInArray",value:function(e,t,n){if(this.commands[t]&&this.commands[t][e]){var i=this.commands[t][e],r=i.indexOf(n);r>-1&&(i[r]*=-1)}}},{key:"pause",value:function(e){this.paused=e}},{key:"isPaused",value:function(){return this.paused}},{key:"enable",value:function(e,t){void 0!==t&&null!==t||(t=e,e=null),e?this.setProperty("disabled",e,!t):this.enabled=t}},{key:"isEnabled",value:function(e){return e&&this.commands[e]&&!this.commands[e].disabled}},{key:"transmit",value:function(e){this.transmitting=e}},{key:"isTransmitting",value:function(){return this.transmitting}},{key:"receive",value:function(e){this.receiving=e}},{key:"isReceiving",value:function(){return this.receiving}},{key:"getAxis",value:function(e){var t=this.axisNames.indexOf(e);if(t>-1){var n=this.inputState.axes[t]||0;return n}return null}},{key:"setAxis",value:function(e,t){var n=this.axisNames.indexOf(e);n>-1&&(this.inPhysicalUse=!0,this.inputState.axes[n]=t)}},{key:"setButton",value:function(e,t){this.inPhysicalUse=!0,this.inputState.buttons[e]=t}},{key:"getValue",value:function(e){return(this.enabled||this.receiving&&this.socketReady)&&this.isEnabled(e)&&this.commands[e].state.value||this.getAxis(e)||0}},{key:"setValue",value:function(e,t){var n=this.axisNames.indexOf(e);!this.commands[e]&&n>-1?this.setAxis(e,t):this.commands[e]&&!this.commands[e].disabled&&(this.commands[e].state.value=t)}},{key:"getVector3",value:function(e,t,n,i){return i=i||new THREE.Vector3,i.set(this.getValue(e),this.getValue(t),this.getValue(n)),i}},{key:"addVector3",value:function(e,t,n,i){return i.x+=this.getValue(e),i.y+=this.getValue(t),i.z+=this.getValue(n),i}},{key:"isDown",value:function(e){return(this.enabled||this.receiving&&this.socketReady)&&this.isEnabled(e)&&this.commands[e].state.pressed}},{key:"isUp",value:function(e){return(this.enabled||this.receiving&&this.socketReady)&&this.isEnabled(e)&&this.commands[e].state.pressed}},{key:"maybeClone",value:function(e){var t=[];if(e)for(var n=0;n<e.length;++n)t[n]={index:Math.abs(e[n])-1,toggle:e[n]<0,sign:e[n]<0?-1:1};return t}}]),e}();return e}(),Primrose.Keys=function(){var e={ANY:0,MODIFIER_KEYS:["ctrl","shift","alt","meta","meta_l","meta_r"],SHIFT:16,CTRL:17,ALT:18,META:91,META_L:91,META_R:92,BACKSPACE:8,TAB:9,ENTER:13,SPACE:32,DELETE:46,PAUSEBREAK:19,CAPSLOCK:20,NUMLOCK:144,SCROLLLOCK:145,INSERT:45,ESCAPE:27,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,LEFTARROW:37,UPARROW:38,RIGHTARROW:39,DOWNARROW:40,SELECTKEY:93,NUMBER0:48,NUMBER1:49,NUMBER2:50,NUMBER3:51,NUMBER4:52,NUMBER5:53,NUMBER6:54,NUMBER7:55,NUMBER8:56,NUMBER9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUMPAD0:96,NUMPAD1:97,NUMPAD2:98,NUMPAD3:99,NUMPAD4:100,NUMPAD5:101,NUMPAD6:102,NUMPAD7:103,NUMPAD8:104,NUMPAD9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMALPOINT:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,VOLUME_DOWN:174,VOLUME_UP:175,TRACK_NEXT:176,TRACK_PREVIOUS:177};for(var t in e){var n=e[t];e.hasOwnProperty(t)&&"number"==typeof n&&(e[n]=t)}return e}(),Primrose.ModelLoader=function(){function e(e){return e.traverse(function(e){e.geometry&&(e.geometry.computeBoundingSphere(),e.geometry.computeBoundingBox())}),e}function t(e){return e.traverse(function(e){if(e instanceof THREE.Mesh)for(var t in a)e[t]=e[t]||a[t](e)}),e}function n(e){this.template=e}function i(e,t){return function(i){return n.loadObject(e[t]).then(function(e){return i[t]=e,i})}}if("undefined"==typeof THREE)return function(){};var r={json:THREE.ObjectLoader&&new THREE.ObjectLoader,fbx:THREE.FBXLoader&&new THREE.FBXLoader,mtl:THREE.MTLLoader&&new THREE.MTLLoader,obj:THREE.OBJLoader&&new THREE.OBJLoader,stl:THREE.STLLoader&&new THREE.STLLoader},o=/\.(\w+)$/,s=/([^/]+)\.\w+$/,a={isButton:function(e){return e.material&&e.material.name.match(/^button\d+$/)},isSolid:function(e){return!e.name.match(/^(water|sky)/)},isGround:function(e){return e.material&&e.material.name&&e.material.name.match(/\bground\b/)}};return n.loadModel=function(e,t,i){return n.loadObject(e,t,i).then(function(e){return new n(e)})},n.prototype.clone=function(){
var e=this.template.clone();return e.traverse(function(t){t instanceof THREE.SkinnedMesh&&(e.animation=new THREE.Animation(t,t.geometry.animation),!this.template.originalAnimationData&&e.animation.data&&(this.template.originalAnimationData=e.animation.data),e.animation.data||(e.animation.data=this.template.originalAnimationData))}.bind(this)),t(e),e},n.loadObject=function(i,a,u){var c=a||i.match(o)[1];if(c){c=c.toLowerCase();var l=r[c];if(l){var h=i.match(s)[1],d=h+"_"+c.toLowerCase(),f=document.getElementById(d),m=Promise.resolve();if("obj"===c){var p=i.replace(o,".mtl");m=m.then(function(){return n.loadObject(p,"mtl",u)}),m=m.then(function(e){e.preload(),l.setMaterials(e)})}if(f){var g=f.innerHTML.split(/\r?\n/g).map(function(e){return e.trim()}).join("\n");m=m.then(function(){return l.parse(g)})}else l.setCrossOrigin&&l.setCrossOrigin(THREE.ImageUtils.crossOrigin),m=m.then(function(){return new Promise(function(e,t){return l.load(i,e,u,t)})});return"json"===c&&(m=m.then(e)),"mtl"!==c&&(m=m.then(t)),m}return Promise.reject("There is no loader type for the file extension: "+c)}return Promise.reject("File path `"+i+"` does not have a file extension, and a type was not provided as a parameter, so we can't determine the type.")},n.loadObjects=function(e){var t={},n=Promise.resolve(t);for(var r in e)e[r]&&(n=n.then(i(e,r)));return n},n}(),Primrose.Projector=function(){function e(e){!function(){"undefined"==typeof THREE&&(self.THREE={REVISION:"72dev"},void 0===Math.sign&&(Math.sign=function(e){return 0>e?-1:e>0?1:+e}),void 0===Function.prototype.name&&void 0!==Object.defineProperty&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*(\S*)\s*\(/)[1]}}),THREE.Quaternion=function(e,t,n,i){this._x=e||0,this._y=t||0,this._z=n||0,this._w=void 0!==i?i:1},THREE.Quaternion.prototype={constructor:THREE.Quaternion,get x(){return this._x},set x(e){this._x=e,this.onChangeCallback()},get y(){return this._y},set y(e){this._y=e,this.onChangeCallback()},get z(){return this._z},set z(e){this._z=e,this.onChangeCallback()},get w(){return this._w},set w(e){this._w=e,this.onChangeCallback()},set:function(e,t,n,i){return this._x=e,this._y=t,this._z=n,this._w=i,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._w)},copy:function(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this.onChangeCallback(),this},setFromEuler:function(e,t){if(e instanceof THREE.Euler==!1)throw new Error("THREE.Quaternion: .setFromEuler() now expects a Euler rotation rather than a Vector3 and order.");var n=Math.cos(e._x/2),i=Math.cos(e._y/2),r=Math.cos(e._z/2),o=Math.sin(e._x/2),s=Math.sin(e._y/2),a=Math.sin(e._z/2);return"XYZ"===e.order?(this._x=o*i*r+n*s*a,this._y=n*s*r-o*i*a,this._z=n*i*a+o*s*r,this._w=n*i*r-o*s*a):"YXZ"===e.order?(this._x=o*i*r+n*s*a,this._y=n*s*r-o*i*a,this._z=n*i*a-o*s*r,this._w=n*i*r+o*s*a):"ZXY"===e.order?(this._x=o*i*r-n*s*a,this._y=n*s*r+o*i*a,this._z=n*i*a+o*s*r,this._w=n*i*r-o*s*a):"ZYX"===e.order?(this._x=o*i*r-n*s*a,this._y=n*s*r+o*i*a,this._z=n*i*a-o*s*r,this._w=n*i*r+o*s*a):"YZX"===e.order?(this._x=o*i*r+n*s*a,this._y=n*s*r+o*i*a,this._z=n*i*a-o*s*r,this._w=n*i*r-o*s*a):"XZY"===e.order&&(this._x=o*i*r-n*s*a,this._y=n*s*r-o*i*a,this._z=n*i*a+o*s*r,this._w=n*i*r+o*s*a),t!==!1&&this.onChangeCallback(),this},setFromAxisAngle:function(e,t){var n=t/2,i=Math.sin(n);return this._x=e.x*i,this._y=e.y*i,this._z=e.z*i,this._w=Math.cos(n),this.onChangeCallback(),this},setFromRotationMatrix:function(e){var t,n=e.elements,i=n[0],r=n[4],o=n[8],s=n[1],a=n[5],u=n[9],c=n[2],l=n[6],h=n[10],d=i+a+h;return d>0?(t=.5/Math.sqrt(d+1),this._w=.25/t,this._x=(l-u)*t,this._y=(o-c)*t,this._z=(s-r)*t):i>a&&i>h?(t=2*Math.sqrt(1+i-a-h),this._w=(l-u)/t,this._x=.25*t,this._y=(r+s)/t,this._z=(o+c)/t):a>h?(t=2*Math.sqrt(1+a-i-h),this._w=(o-c)/t,this._x=(r+s)/t,this._y=.25*t,this._z=(u+l)/t):(t=2*Math.sqrt(1+h-i-a),this._w=(s-r)/t,this._x=(o+c)/t,this._y=(u+l)/t,this._z=.25*t),this.onChangeCallback(),this},setFromUnitVectors:function(){var e,t,n=1e-6;return function(i,r){return void 0===e&&(e=new THREE.Vector3),t=i.dot(r)+1,n>t?(t=0,Math.abs(i.x)>Math.abs(i.z)?e.set(-i.y,i.x,0):e.set(0,-i.z,i.y)):e.crossVectors(i,r),this._x=e.x,this._y=e.y,this._z=e.z,this._w=t,this.normalize(),this}}(),inverse:function(){return this.conjugate().normalize(),this},conjugate:function(){return this._x*=-1,this._y*=-1,this._z*=-1,this.onChangeCallback(),this},dot:function(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w},lengthSq:function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w},length:function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},normalize:function(){var e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this.onChangeCallback(),this},multiply:function(e,t){return void 0!==t?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(e,t)):this.multiplyQuaternions(this,e)},multiplyQuaternions:function(e,t){var n=e._x,i=e._y,r=e._z,o=e._w,s=t._x,a=t._y,u=t._z,c=t._w;return this._x=n*c+o*s+i*u-r*a,this._y=i*c+o*a+r*s-n*u,this._z=r*c+o*u+n*a-i*s,this._w=o*c-n*s-i*a-r*u,this.onChangeCallback(),this},multiplyVector3:function(e){return console.warn("THREE.Quaternion: .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead."),e.applyQuaternion(this)},slerp:function(e,t){if(0===t)return this;if(1===t)return this.copy(e);var n=this._x,i=this._y,r=this._z,o=this._w,s=o*e._w+n*e._x+i*e._y+r*e._z;if(0>s?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,s=-s):this.copy(e),s>=1)return this._w=o,this._x=n,this._y=i,this._z=r,this;var a=Math.acos(s),u=Math.sqrt(1-s*s);if(Math.abs(u)<.001)return this._w=.5*(o+this._w),this._x=.5*(n+this._x),this._y=.5*(i+this._y),this._z=.5*(r+this._z),this;var c=Math.sin((1-t)*a)/u,l=Math.sin(t*a)/u;return this._w=o*c+this._w*l,this._x=n*c+this._x*l,this._y=i*c+this._y*l,this._z=r*c+this._z*l,this.onChangeCallback(),this},equals:function(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w},fromArray:function(e,t){return void 0===t&&(t=0),this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this.onChangeCallback(),this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e},onChange:function(e){return this.onChangeCallback=e,this},onChangeCallback:function(){}},THREE.Quaternion.slerp=function(e,t,n,i){return n.copy(e).slerp(t,i)},THREE.Vector3=function(e,t,n){this.x=e||0,this.y=t||0,this.z=n||0},THREE.Vector3.prototype={constructor:THREE.Vector3,set:function(e,t,n){return this.x=e,this.y=t,this.z=n,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y,this.z)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this)},subScalar:function(e){return this.x-=e,this.y-=e,this.z-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this},multiply:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(e,t)):(this.x*=e.x,this.y*=e.y,this.z*=e.z,this)},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this},multiplyVectors:function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this},applyEuler:function(){var e;return function(t){return t instanceof THREE.Euler==!1&&console.error("THREE.Vector3: .applyEuler() now expects a Euler rotation rather than a Vector3 and order."),void 0===e&&(e=new THREE.Quaternion),this.applyQuaternion(e.setFromEuler(t)),this}}(),applyAxisAngle:function(){var e;return function(t,n){return void 0===e&&(e=new THREE.Quaternion),this.applyQuaternion(e.setFromAxisAngle(t,n)),this}}(),applyMatrix3:function(e){var t=this.x,n=this.y,i=this.z,r=e.elements;return this.x=r[0]*t+r[3]*n+r[6]*i,this.y=r[1]*t+r[4]*n+r[7]*i,this.z=r[2]*t+r[5]*n+r[8]*i,this},applyMatrix4:function(e){var t=this.x,n=this.y,i=this.z,r=e.elements;return this.x=r[0]*t+r[4]*n+r[8]*i+r[12],this.y=r[1]*t+r[5]*n+r[9]*i+r[13],this.z=r[2]*t+r[6]*n+r[10]*i+r[14],this},applyProjection:function(e){var t=this.x,n=this.y,i=this.z,r=e.elements,o=1/(r[3]*t+r[7]*n+r[11]*i+r[15]);return this.x=(r[0]*t+r[4]*n+r[8]*i+r[12])*o,this.y=(r[1]*t+r[5]*n+r[9]*i+r[13])*o,this.z=(r[2]*t+r[6]*n+r[10]*i+r[14])*o,this},applyQuaternion:function(e){var t=this.x,n=this.y,i=this.z,r=e.x,o=e.y,s=e.z,a=e.w,u=a*t+o*i-s*n,c=a*n+s*t-r*i,l=a*i+r*n-o*t,h=-r*t-o*n-s*i;return this.x=u*a+h*-r+c*-s-l*-o,this.y=c*a+h*-o+l*-r-u*-s,this.z=l*a+h*-s+u*-o-c*-r,this},project:function(){var e;return function(t){return void 0===e&&(e=new THREE.Matrix4),e.multiplyMatrices(t.projectionMatrix,e.getInverse(t.matrixWorld)),this.applyProjection(e)}}(),unproject:function(){var e;return function(t){return void 0===e&&(e=new THREE.Matrix4),e.multiplyMatrices(t.matrixWorld,e.getInverse(t.projectionMatrix)),this.applyProjection(e)}}(),transformDirection:function(e){var t=this.x,n=this.y,i=this.z,r=e.elements;return this.x=r[0]*t+r[4]*n+r[8]*i,this.y=r[1]*t+r[5]*n+r[9]*i,this.z=r[2]*t+r[6]*n+r[10]*i,this.normalize(),this},divide:function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},divideScalar:function(e){if(0!==e){var t=1/e;this.x*=t,this.y*=t,this.z*=t}else this.x=0,this.y=0,this.z=0;return this},min:function(e){return this.x>e.x&&(this.x=e.x),this.y>e.y&&(this.y=e.y),this.z>e.z&&(this.z=e.z),this},max:function(e){return this.x<e.x&&(this.x=e.x),this.y<e.y&&(this.y=e.y),this.z<e.z&&(this.z=e.z),this},clamp:function(e,t){return this.x<e.x?this.x=e.x:this.x>t.x&&(this.x=t.x),this.y<e.y?this.y=e.y:this.y>t.y&&(this.y=t.y),this.z<e.z?this.z=e.z:this.z>t.z&&(this.z=t.z),this},clampScalar:function(){var e,t;return function(n,i){return void 0===e&&(e=new THREE.Vector3,t=new THREE.Vector3),e.set(n,n,n),t.set(i,i,i),this.clamp(e,t)}}(),floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){var t=this.length();return 0!==t&&e!==t&&this.multiplyScalar(e/t),this},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this},lerpVectors:function(e,t,n){return this.subVectors(t,e).multiplyScalar(n).add(e),this},cross:function(e,t){if(void 0!==t)return console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(e,t);var n=this.x,i=this.y,r=this.z;return this.x=i*e.z-r*e.y,this.y=r*e.x-n*e.z,this.z=n*e.y-i*e.x,this},crossVectors:function(e,t){var n=e.x,i=e.y,r=e.z,o=t.x,s=t.y,a=t.z;return this.x=i*a-r*s,this.y=r*o-n*a,this.z=n*s-i*o,this},projectOnVector:function(){var e,t;return function(n){return void 0===e&&(e=new THREE.Vector3),e.copy(n).normalize(),t=this.dot(e),this.copy(e).multiplyScalar(t)}}(),projectOnPlane:function(){var e;return function(t){return void 0===e&&(e=new THREE.Vector3),e.copy(this).projectOnVector(t),this.sub(e)}}(),reflect:function(){var e;return function(t){return void 0===e&&(e=new THREE.Vector3),this.sub(e.copy(t).multiplyScalar(2*this.dot(t)))}}(),angleTo:function(e){var t=this.dot(e)/(this.length()*e.length());return Math.acos(THREE.Math.clamp(t,-1,1))},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,n=this.y-e.y,i=this.z-e.z;return t*t+n*n+i*i},setEulerFromRotationMatrix:function(e,t){console.error("THREE.Vector3: .setEulerFromRotationMatrix() has been removed. Use Euler.setFromRotationMatrix() instead.")},setEulerFromQuaternion:function(e,t){console.error("THREE.Vector3: .setEulerFromQuaternion() has been removed. Use Euler.setFromQuaternion() instead.")},getPositionFromMatrix:function(e){return console.warn("THREE.Vector3: .getPositionFromMatrix() has been renamed to .setFromMatrixPosition()."),this.setFromMatrixPosition(e)},getScaleFromMatrix:function(e){return console.warn("THREE.Vector3: .getScaleFromMatrix() has been renamed to .setFromMatrixScale()."),this.setFromMatrixScale(e)},getColumnFromMatrix:function(e,t){return console.warn("THREE.Vector3: .getColumnFromMatrix() has been renamed to .setFromMatrixColumn()."),this.setFromMatrixColumn(e,t)},setFromMatrixPosition:function(e){return this.x=e.elements[12],this.y=e.elements[13],this.z=e.elements[14],this},setFromMatrixScale:function(e){var t=this.set(e.elements[0],e.elements[1],e.elements[2]).length(),n=this.set(e.elements[4],e.elements[5],e.elements[6]).length(),i=this.set(e.elements[8],e.elements[9],e.elements[10]).length();return this.x=t,this.y=n,this.z=i,this},setFromMatrixColumn:function(e,t){var n=4*e,i=t.elements;return this.x=i[n],this.y=i[n+1],this.z=i[n+2],this},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e},fromAttribute:function(e,t,n){return void 0===n&&(n=0),t=t*e.itemSize+n,this.x=e.array[t],this.y=e.array[t+1],this.z=e.array[t+2],this}},THREE.Matrix4=function(){this.elements=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},THREE.Matrix4.prototype={constructor:THREE.Matrix4,set:function(e,t,n,i,r,o,s,a,u,c,l,h,d,f,m,p){var g=this.elements;return g[0]=e,g[4]=t,g[8]=n,g[12]=i,g[1]=r,g[5]=o,g[9]=s,g[13]=a,g[2]=u,g[6]=c,g[10]=l,g[14]=h,g[3]=d,g[7]=f,g[11]=m,g[15]=p,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},clone:function(){return(new THREE.Matrix4).fromArray(this.elements)},copy:function(e){return this.elements.set(e.elements),this},extractPosition:function(e){return console.warn("THREE.Matrix4: .extractPosition() has been renamed to .copyPosition()."),this.copyPosition(e)},copyPosition:function(e){var t=this.elements,n=e.elements;return t[12]=n[12],t[13]=n[13],t[14]=n[14],this},extractBasis:function(e,t,n){var i=this.elements;return e.set(i[0],i[1],i[2]),t.set(i[4],i[5],i[6]),n.set(i[8],i[9],i[10]),this},makeBasis:function(e,t,n){return this.set(e.x,t.x,n.x,0,e.y,t.y,n.y,0,e.z,t.z,n.z,0,0,0,0,1),this},extractRotation:function(){var e;return function(t){void 0===e&&(e=new THREE.Vector3);var n=this.elements,i=t.elements,r=1/e.set(i[0],i[1],i[2]).length(),o=1/e.set(i[4],i[5],i[6]).length(),s=1/e.set(i[8],i[9],i[10]).length();return n[0]=i[0]*r,n[1]=i[1]*r,n[2]=i[2]*r,n[4]=i[4]*o,n[5]=i[5]*o,n[6]=i[6]*o,n[8]=i[8]*s,n[9]=i[9]*s,n[10]=i[10]*s,this}}(),makeRotationFromEuler:function(e){e instanceof THREE.Euler==!1&&console.error("THREE.Matrix: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");var t=this.elements,n=e.x,i=e.y,r=e.z,o=Math.cos(n),s=Math.sin(n),a=Math.cos(i),u=Math.sin(i),c=Math.cos(r),l=Math.sin(r);if("XYZ"===e.order){var h=o*c,d=o*l,f=s*c,m=s*l;t[0]=a*c,t[4]=-a*l,t[8]=u,t[1]=d+f*u,t[5]=h-m*u,t[9]=-s*a,t[2]=m-h*u,t[6]=f+d*u,t[10]=o*a}else if("YXZ"===e.order){var p=a*c,g=a*l,y=u*c,v=u*l;t[0]=p+v*s,t[4]=y*s-g,t[8]=o*u,t[1]=o*l,t[5]=o*c,t[9]=-s,t[2]=g*s-y,t[6]=v+p*s,t[10]=o*a}else if("ZXY"===e.order){var p=a*c,g=a*l,y=u*c,v=u*l;t[0]=p-v*s,t[4]=-o*l,t[8]=y+g*s,t[1]=g+y*s,t[5]=o*c,t[9]=v-p*s,t[2]=-o*u,t[6]=s,t[10]=o*a}else if("ZYX"===e.order){var h=o*c,d=o*l,f=s*c,m=s*l;t[0]=a*c,t[4]=f*u-d,t[8]=h*u+m,t[1]=a*l,t[5]=m*u+h,t[9]=d*u-f,t[2]=-u,t[6]=s*a,t[10]=o*a}else if("YZX"===e.order){var b=o*a,w=o*u,x=s*a,E=s*u;t[0]=a*c,t[4]=E-b*l,t[8]=x*l+w,t[1]=l,t[5]=o*c,t[9]=-s*c,t[2]=-u*c,t[6]=w*l+x,t[10]=b-E*l}else if("XZY"===e.order){var b=o*a,w=o*u,x=s*a,E=s*u;t[0]=a*c,t[4]=-l,t[8]=u*c,t[1]=b*l+E,t[5]=o*c,t[9]=w*l-x,t[2]=x*l-w,t[6]=s*c,t[10]=E*l+b}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},setRotationFromQuaternion:function(e){return console.warn("THREE.Matrix4: .setRotationFromQuaternion() has been renamed to .makeRotationFromQuaternion()."),this.makeRotationFromQuaternion(e)},makeRotationFromQuaternion:function(e){var t=this.elements,n=e.x,i=e.y,r=e.z,o=e.w,s=n+n,a=i+i,u=r+r,c=n*s,l=n*a,h=n*u,d=i*a,f=i*u,m=r*u,p=o*s,g=o*a,y=o*u;return t[0]=1-(d+m),t[4]=l-y,t[8]=h+g,t[1]=l+y,t[5]=1-(c+m),t[9]=f-p,t[2]=h-g,t[6]=f+p,t[10]=1-(c+d),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},lookAt:function(){var e,t,n;return function(i,r,o){void 0===e&&(e=new THREE.Vector3),void 0===t&&(t=new THREE.Vector3),void 0===n&&(n=new THREE.Vector3);var s=this.elements;return n.subVectors(i,r).normalize(),0===n.length()&&(n.z=1),e.crossVectors(o,n).normalize(),0===e.length()&&(n.x+=1e-4,e.crossVectors(o,n).normalize()),t.crossVectors(n,e),s[0]=e.x,s[4]=t.x,s[8]=n.x,s[1]=e.y,s[5]=t.y,s[9]=n.y,s[2]=e.z,s[6]=t.z,s[10]=n.z,this}}(),multiply:function(e,t){return void 0!==t?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(e,t)):this.multiplyMatrices(this,e)},multiplyMatrices:function(e,t){var n=e.elements,i=t.elements,r=this.elements,o=n[0],s=n[4],a=n[8],u=n[12],c=n[1],l=n[5],h=n[9],d=n[13],f=n[2],m=n[6],p=n[10],g=n[14],y=n[3],v=n[7],b=n[11],w=n[15],x=i[0],E=i[4],P=i[8],C=i[12],_=i[1],R=i[5],T=i[9],M=i[13],k=i[2],S=i[6],O=i[10],I=i[14],A=i[3],L=i[7],F=i[11],N=i[15];return r[0]=o*x+s*_+a*k+u*A,r[4]=o*E+s*R+a*S+u*L,r[8]=o*P+s*T+a*O+u*F,r[12]=o*C+s*M+a*I+u*N,r[1]=c*x+l*_+h*k+d*A,r[5]=c*E+l*R+h*S+d*L,r[9]=c*P+l*T+h*O+d*F,r[13]=c*C+l*M+h*I+d*N,r[2]=f*x+m*_+p*k+g*A,r[6]=f*E+m*R+p*S+g*L,r[10]=f*P+m*T+p*O+g*F,r[14]=f*C+m*M+p*I+g*N,r[3]=y*x+v*_+b*k+w*A,r[7]=y*E+v*R+b*S+w*L,r[11]=y*P+v*T+b*O+w*F,r[15]=y*C+v*M+b*I+w*N,this},multiplyToArray:function(e,t,n){var i=this.elements;return this.multiplyMatrices(e,t),n[0]=i[0],n[1]=i[1],n[2]=i[2],n[3]=i[3],n[4]=i[4],n[5]=i[5],n[6]=i[6],n[7]=i[7],n[8]=i[8],n[9]=i[9],n[10]=i[10],n[11]=i[11],n[12]=i[12],n[13]=i[13],n[14]=i[14],n[15]=i[15],this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this},multiplyVector3:function(e){return console.warn("THREE.Matrix4: .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) or vector.applyProjection( matrix ) instead."),e.applyProjection(this)},multiplyVector4:function(e){return console.warn("THREE.Matrix4: .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},multiplyVector3Array:function(e){return console.warn("THREE.Matrix4: .multiplyVector3Array() has been renamed. Use matrix.applyToVector3Array( array ) instead."),this.applyToVector3Array(e)},applyToVector3Array:function(){var e;return function(t,n,i){void 0===e&&(e=new THREE.Vector3),void 0===n&&(n=0),void 0===i&&(i=t.length);for(var r=0,o=n;i>r;r+=3,o+=3)e.fromArray(t,o),e.applyMatrix4(this),e.toArray(t,o);return t}}(),applyToBuffer:function(){var e;return function(t,n,i){void 0===e&&(e=new THREE.Vector3),void 0===n&&(n=0),void 0===i&&(i=t.length/t.itemSize);for(var r=0,o=n;i>r;r++,o++)e.x=t.getX(o),e.y=t.getY(o),e.z=t.getZ(o),e.applyMatrix4(this),t.setXYZ(e.x,e.y,e.z);return t}}(),rotateAxis:function(e){console.warn("THREE.Matrix4: .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),e.transformDirection(this)},crossVector:function(e){return console.warn("THREE.Matrix4: .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},determinant:function(){var e=this.elements,t=e[0],n=e[4],i=e[8],r=e[12],o=e[1],s=e[5],a=e[9],u=e[13],c=e[2],l=e[6],h=e[10],d=e[14],f=e[3],m=e[7],p=e[11],g=e[15];return f*(+r*a*l-i*u*l-r*s*h+n*u*h+i*s*d-n*a*d)+m*(+t*a*d-t*u*h+r*o*h-i*o*d+i*u*c-r*a*c)+p*(+t*u*l-t*s*d-r*o*l+n*o*d+r*s*c-n*u*c)+g*(-i*s*c-t*a*l+t*s*h+i*o*l-n*o*h+n*a*c)},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},flattenToArrayOffset:function(e,t){var n=this.elements;return e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e[t+9]=n[9],e[t+10]=n[10],e[t+11]=n[11],e[t+12]=n[12],e[t+13]=n[13],e[t+14]=n[14],e[t+15]=n[15],e},getPosition:function(){var e;return function(){void 0===e&&(e=new THREE.Vector3),console.warn("THREE.Matrix4: .getPosition() has been removed. Use Vector3.setFromMatrixPosition( matrix ) instead.");var t=this.elements;return e.set(t[12],t[13],t[14])}}(),setPosition:function(e){var t=this.elements;return t[12]=e.x,t[13]=e.y,t[14]=e.z,this},getInverse:function(e,t){var n=this.elements,i=e.elements,r=i[0],o=i[4],s=i[8],a=i[12],u=i[1],c=i[5],l=i[9],h=i[13],d=i[2],f=i[6],m=i[10],p=i[14],g=i[3],y=i[7],v=i[11],b=i[15];n[0]=l*p*y-h*m*y+h*f*v-c*p*v-l*f*b+c*m*b,n[4]=a*m*y-s*p*y-a*f*v+o*p*v+s*f*b-o*m*b,n[8]=s*h*y-a*l*y+a*c*v-o*h*v-s*c*b+o*l*b,n[12]=a*l*f-s*h*f-a*c*m+o*h*m+s*c*p-o*l*p,n[1]=h*m*g-l*p*g-h*d*v+u*p*v+l*d*b-u*m*b,n[5]=s*p*g-a*m*g+a*d*v-r*p*v-s*d*b+r*m*b,n[9]=a*l*g-s*h*g-a*u*v+r*h*v+s*u*b-r*l*b,n[13]=s*h*d-a*l*d+a*u*m-r*h*m-s*u*p+r*l*p,n[2]=c*p*g-h*f*g+h*d*y-u*p*y-c*d*b+u*f*b,n[6]=a*f*g-o*p*g-a*d*y+r*p*y+o*d*b-r*f*b,n[10]=o*h*g-a*c*g+a*u*y-r*h*y-o*u*b+r*c*b,n[14]=a*c*d-o*h*d-a*u*f+r*h*f+o*u*p-r*c*p,n[3]=l*f*g-c*m*g-l*d*y+u*m*y+c*d*v-u*f*v,n[7]=o*m*g-s*f*g+s*d*y-r*m*y-o*d*v+r*f*v,n[11]=s*c*g-o*l*g-s*u*y+r*l*y+o*u*v-r*c*v,n[15]=o*l*d-s*c*d+s*u*f-r*l*f-o*u*m+r*c*m;var w=r*n[0]+u*n[4]+d*n[8]+g*n[12];if(0===w){var x="THREE.Matrix4.getInverse(): can't invert matrix, determinant is 0";if(t)throw new Error(x);return console.warn(x),this.identity(),this}return this.multiplyScalar(1/w),this},translate:function(e){console.error("THREE.Matrix4: .translate() has been removed.")},rotateX:function(e){console.error("THREE.Matrix4: .rotateX() has been removed.")},rotateY:function(e){console.error("THREE.Matrix4: .rotateY() has been removed.")},rotateZ:function(e){console.error("THREE.Matrix4: .rotateZ() has been removed.")},rotateByAxis:function(e,t){console.error("THREE.Matrix4: .rotateByAxis() has been removed.")},scale:function(e){var t=this.elements,n=e.x,i=e.y,r=e.z;return t[0]*=n,t[4]*=i,t[8]*=r,t[1]*=n,t[5]*=i,t[9]*=r,t[2]*=n,t[6]*=i,t[10]*=r,t[3]*=n,t[7]*=i,t[11]*=r,this},getMaxScaleOnAxis:function(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],n=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],i=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,Math.max(n,i)))},makeTranslation:function(e,t,n){return this.set(1,0,0,e,0,1,0,t,0,0,1,n,0,0,0,1),this},makeRotationX:function(e){var t=Math.cos(e),n=Math.sin(e);return this.set(1,0,0,0,0,t,-n,0,0,n,t,0,0,0,0,1),this},makeRotationY:function(e){var t=Math.cos(e),n=Math.sin(e);return this.set(t,0,n,0,0,1,0,0,-n,0,t,0,0,0,0,1),this},makeRotationZ:function(e){var t=Math.cos(e),n=Math.sin(e);return this.set(t,-n,0,0,n,t,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(e,t){var n=Math.cos(t),i=Math.sin(t),r=1-n,o=e.x,s=e.y,a=e.z,u=r*o,c=r*s;return this.set(u*o+n,u*s-i*a,u*a+i*s,0,u*s+i*a,c*s+n,c*a-i*o,0,u*a-i*s,c*a+i*o,r*a*a+n,0,0,0,0,1),this},makeScale:function(e,t,n){return this.set(e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1),this},compose:function(e,t,n){return this.makeRotationFromQuaternion(t),this.scale(n),this.setPosition(e),this},decompose:function(){var e,t;return function(n,i,r){void 0===e&&(e=new THREE.Vector3),void 0===t&&(t=new THREE.Matrix4);var o=this.elements,s=e.set(o[0],o[1],o[2]).length(),a=e.set(o[4],o[5],o[6]).length(),u=e.set(o[8],o[9],o[10]).length(),c=this.determinant();0>c&&(s=-s),n.x=o[12],n.y=o[13],n.z=o[14],t.elements.set(this.elements);var l=1/s,h=1/a,d=1/u;return t.elements[0]*=l,t.elements[1]*=l,t.elements[2]*=l,t.elements[4]*=h,t.elements[5]*=h,t.elements[6]*=h,t.elements[8]*=d,t.elements[9]*=d,t.elements[10]*=d,i.setFromRotationMatrix(t),r.x=s,r.y=a,r.z=u,this}}(),makeFrustum:function(e,t,n,i,r,o){var s=this.elements,a=2*r/(t-e),u=2*r/(i-n),c=(t+e)/(t-e),l=(i+n)/(i-n),h=-(o+r)/(o-r),d=-2*o*r/(o-r);return s[0]=a,s[4]=0,s[8]=c,s[12]=0,s[1]=0,s[5]=u,s[9]=l,s[13]=0,s[2]=0,s[6]=0,s[10]=h,s[14]=d,s[3]=0,s[7]=0,s[11]=-1,s[15]=0,this},makePerspective:function(e,t,n,i){var r=n*Math.tan(THREE.Math.degToRad(.5*e)),o=-r,s=o*t,a=r*t;return this.makeFrustum(s,a,o,r,n,i)},makeOrthographic:function(e,t,n,i,r,o){var s=this.elements,a=t-e,u=n-i,c=o-r,l=(t+e)/a,h=(n+i)/u,d=(o+r)/c;return s[0]=2/a,s[4]=0,s[8]=0,s[12]=-l,s[1]=0,s[5]=2/u,s[9]=0,s[13]=-h,s[2]=0,s[6]=0,s[10]=-2/c,s[14]=-d,s[3]=0,s[7]=0,s[11]=0,s[15]=1,this},equals:function(e){for(var t=this.elements,n=e.elements,i=0;16>i;i++)if(t[i]!==n[i])return!1;return!0},fromArray:function(e){return this.elements.set(e),this},toArray:function(){var e=this.elements;return[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15]]}},THREE.Math={generateUUID:function(){var e,t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),n=new Array(36),i=0;return function(){for(var r=0;36>r;r++)8===r||13===r||18===r||23===r?n[r]="-":14===r?n[r]="4":(2>=i&&(i=33554432+16777216*Math.random()|0),e=15&i,i>>=4,n[r]=t[19===r?3&e|8:e]);return n.join("")}}(),clamp:function(e,t,n){return t>e?t:e>n?n:e},clampBottom:function(e,t){return t>e?t:e},euclideanModulo:function(e,t){return(e%t+t)%t},mapLinear:function(e,t,n,i,r){return i+(e-t)*(r-i)/(n-t)},smoothstep:function(e,t,n){return t>=e?0:e>=n?1:(e=(e-t)/(n-t),e*e*(3-2*e))},smootherstep:function(e,t,n){return t>=e?0:e>=n?1:(e=(e-t)/(n-t),e*e*e*(e*(6*e-15)+10))},random16:function(){return(65280*Math.random()+255*Math.random())/65535},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},degToRad:function(){var e=Math.PI/180;return function(t){return t*e}}(),radToDeg:function(){var e=180/Math.PI;return function(t){return t*e}}(),isPowerOfTwo:function(e){return 0===(e&e-1)&&0!==e},nextPowerOfTwo:function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e++,e}})}(),this.objectIDs=[],this.objects={},this.geometryCache={},this.a=new THREE.Vector3,this.b=new THREE.Vector3,this.c=new THREE.Vector3,this.d=new THREE.Vector3,this.f=new THREE.Vector3,this.p=new THREE.Vector3,this.m=new THREE.Matrix4,this.listeners={hit:[]},this.ready=!0}return e.prototype.addEventListener=function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)},e.prototype._emit=emit,e.prototype._transform=function(e,t){return t.clone().applyMatrix4(e.matrix)},e.prototype._getVerts=function(e){for(var t=[],n=this.geometryCache[e.geomID],i=n.vertices,r=0;r<i.length;++r)t[r]=this._transform(e,i[r]);return t},e.prototype.setObject=function(e){this.objectIDs.push(e.uuid),this.objects[e.uuid]=e,e.matrix=(new THREE.Matrix4).fromArray(e.matrix);var t=e.geometry.uvs,n=Number.MAX_VALUE,i=Number.MAX_VALUE,r=Number.MIN_VALUE,o=Number.MIN_VALUE;if(t&&t.length>0)for(var s=0;s<t.length;++s){var a=t[s];if(a){var u=a[0],c=a[1];n=Math.min(n,u),r=Math.max(r,u),i=Math.min(i,c),o=Math.max(o,c)}}else n=0,r=1,i=0,o=1;if(this.setProperty(e.uuid,"minU",n),this.setProperty(e.uuid,"maxU",r),this.setProperty(e.uuid,"minV",i),this.setProperty(e.uuid,"maxV",o),this.setProperty(e.uuid,"geomID",e.geometry.uuid),!this.geometryCache[e.geometry.uuid]){this.geometryCache[e.geometry.uuid]=e.geometry;for(var l=0,h=e.geometry.vertices,d=h.length;d>l;++l)h[l]=(new THREE.Vector3).fromArray(h[l])}this.updateObjects([e])},e.prototype.updateObjects=function(e){for(var t=0;t<e.length;++t){var n=e[t];if(n.inScene!==!1){var i=this.objects[n.uuid];null!==n.matrix&&i.matrix.fromArray(n.matrix),null!==n.visible&&this.setProperty(n.uuid,"visible",n.visible),null!==n.disabled&&this.setProperty(n.uuid,"disabled",n.disabled)}else{delete this.objects[n.uuid];for(var r=!1,o=0;!r&&o<this.objectIDs.length;++o)r=r||this.objects[this.objectIDs[o]].geomID===n.geomID;r||delete this.geometryCache[n.geomID],this.objectIDs.splice(this.objectIDs.indexOf(n.uuid),1)}}},e.prototype.setProperty=function(e,t,n){for(var i=this.objects[e],r=t.split(".");r.length>1;)t=r.shift(),i[t]||(i[t]={}),i=i[t];1===r.length&&(t=r[0],i[r[0]]=n)},e.prototype.projectPointer=function(e){var t=e[0],n=e[1],i=null;this.p.fromArray(t),this.f.fromArray(n);for(var r=0;r<this.objectIDs.length;++r){var o=this.objectIDs[r],s=this.objects[o];if(!s.disabled)for(var a=this._getVerts(s),u=s.geometry.faces,c=s.geometry.uvs,l=0;l<u.length;++l){var h=u[l],d=a[h[0]%a.length],f=a[h[1]%a.length],m=a[h[2]%a.length];if(this.a.subVectors(f,d),this.b.subVectors(m,d),this.c.subVectors(this.p,this.f),this.m.set(this.a.x,this.b.x,-this.c.x,0,this.a.y,this.b.y,-this.c.y,0,this.a.z,this.b.z,-this.c.z,0,0,0,0,1),Math.abs(this.m.determinant())>1e-10&&(this.m.getInverse(this.m),this.d.subVectors(this.f,d).applyMatrix4(this.m),0<=this.d.x&&this.d.x<=1&&0<=this.d.y&&this.d.y<=1&&this.d.z>0)){this.c.multiplyScalar(this.d.z).add(this.f);var p=Math.sign(this.d.z)*this.p.distanceTo(this.c);if((!i||p<i.distance)&&(i={objectID:o,distance:p,faceIndex:l,facePoint:this.c.toArray(),faceNormal:this.d.toArray()},c)){d=c[h[0]%c.length],f=c[h[1]%c.length],m=c[h[2]%c.length];var g=this.d.x*(f[0]-d[0])+this.d.y*(m[0]-d[0])+d[0],y=this.d.x*(f[1]-d[1])+this.d.y*(m[1]-d[1])+d[1];s.minU<=g&&g<=s.maxU&&s.minV<=y&&y<s.maxV?i.point=[g,y]:i=null}}}}this._emit("hit",i)},e}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),_get=function e(t,n,i){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,n);if(void 0===r){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,n,i)}if("value"in r)return r.value;
var s=r.get;if(void 0!==s)return s.call(i)};Primrose.Surface=function(){var e=0,t=function(t){function n(t){_classCallCheck(this,n);var i=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this));if(t=patch(t,{id:"Primrose.Surface["+e++ +"]"}),i.listeners.move=[],i.bounds=t.bounds||new Primrose.Text.Rectangle,i.canvas=null,i.context=null,t.id instanceof n)throw new Error("Object is already a Surface. Please don't try to wrap them.");if(t.id instanceof CanvasRenderingContext2D?(i.context=t.id,i.canvas=i.context.canvas):t.id instanceof HTMLCanvasElement?i.canvas=t.id:("string"==typeof t.id||t.id instanceof String)&&(i.canvas=document.getElementById(t.id),null===i.canvas?(i.canvas=document.createElement("canvas"),i.canvas.id=t.id):"CANVAS"!==i.canvas.tagName&&(i.canvas=null)),null===i.canvas)throw console.error(_typeof(t.id)),console.error(t.id),new Error(t.id+" does not refer to a valid canvas element.");return i.id=i.canvas.id,0===i.bounds.width&&(i.bounds.width=i.imageWidth,i.bounds.height=i.imageHeight),i.imageWidth=i.bounds.width,i.imageHeight=i.bounds.height,null===i.context&&(i.context=i.canvas.getContext("2d")),i.canvas.style.imageRendering=isChrome?"pixelated":"optimizespeed",i.context.imageSmoothingEnabled=!1,i.context.textBaseline="top",i._texture=null,i._material=null,i}return _inherits(n,t),_createClass(n,[{key:"invalidate",value:function(e){e?e instanceof Primrose.Text.Rectangle&&(e=e.clone()):(e=this.bounds.clone(),e.left=0,e.top=0);for(var t=0;t<this.children.length;++t){var n=this.children[t],i=e.overlap(n.bounds);if(i){var r=i.left-n.bounds.left,o=i.top-n.bounds.top;this.context.drawImage(n.canvas,r,o,i.width,i.height,i.x,i.y,i.width,i.height)}}this._texture&&(this._texture.needsUpdate=!0),this._material&&(this._material.needsUpdate=!0),this.parent&&this.parent.invalidate&&(e.left+=this.bounds.left,e.top+=this.bounds.top,this.parent.invalidate(e))}},{key:"resize",value:function(){this.setSize(this.surfaceWidth,this.surfaceHeight)}},{key:"setSize",value:function(e,t){var n=this.context.textBaseline,i=this.context.textAlign;this.imageWidth=e,this.imageHeight=t,this.context.textBaseline=n,this.context.textAlign=i}},{key:"appendChild",value:function(e){if(!(e instanceof n))throw new Error("Can only append other Surfaces to a Surface. You gave: "+e);_get(Object.getPrototypeOf(n.prototype),"appendChild",this).call(this,e),this.invalidate()}},{key:"mapUV",value:function(e){return{x:e[0]*this.imageWidth,y:(1-e[1])*this.imageHeight}}},{key:"unmapUV",value:function(e){return[e.x/this.imageWidth,1-e.y/this.imageHeight]}},{key:"_findChild",value:function(e,t,n){for(var i=this.inBounds(e,t),r=null,o=this.children.length-1;o>=0;--o){var s=this.children[o];!r&&s.inBounds(e-this.bounds.left,t-this.bounds.top)?r=s:s.focused&&s.blur()}return r||i&&this}},{key:"DOMInBounds",value:function(e,t){return this.inBounds(e*devicePixelRatio,t*devicePixelRatio)}},{key:"UVInBounds",value:function(e){return this.inBounds(e[0]*this.imageWidth,(1-e[1])*this.imageHeight)}},{key:"inBounds",value:function(e,t){return this.bounds.left<=e&&e<this.bounds.right&&this.bounds.top<=t&&t<this.bounds.bottom}},{key:"startDOMPointer",value:function(e){this.startPointer(x*devicePixelRatio,y*devicePixelRatio)}},{key:"moveDOMPointer",value:function(e){this.movePointer(x*devicePixelRatio,y*devicePixelRatio)}},{key:"startPointer",value:function(e,t){if(this.inBounds(e,t)){var n=this._findChild(e,t,function(e,t,n){return e.startPointer(t,n)});n?(this.focused||this.focus(),emit.call(this,"click",{target:n,x:e,y:t}),n!==this&&n.startPointer(e-this.bounds.left,t-this.bounds.top)):this.focused&&this.blur()}}},{key:"movePointer",value:function(e,t){var n=this._findChild(e,t,function(e,t,n){return e.startPointer(t,n)});n&&(emit.call(this,"move",{target:n,x:e,y:t}),n!==this&&n.movePointer(e-this.bounds.left,t-this.bounds.top))}},{key:"startUV",value:function(e){var t=this.mapUV(e);this.startPointer(t.x,t.y)}},{key:"moveUV",value:function(e){var t=this.mapUV(e);this.movePointer(t.x,t.y)}},{key:"imageWidth",get:function(){return this.canvas.width},set:function(e){this.canvas.width=e,this.bounds.width=e}},{key:"imageHeight",get:function(){return this.canvas.height},set:function(e){this.canvas.height=e,this.bounds.height=e}},{key:"elementWidth",get:function(){return this.canvas.clientWidth*devicePixelRatio},set:function(e){this.canvas.style.width=e/devicePixelRatio+"px"}},{key:"elementHeight",get:function(){return this.canvas.clientHeight*devicePixelRatio},set:function(e){this.canvas.style.height=e/devicePixelRatio+"px"}},{key:"surfaceWidth",get:function(){return this.canvas.parentElement?this.elementWidth:this.bounds.width}},{key:"surfaceHeight",get:function(){return this.canvas.parentElement?this.elementHeight:this.bounds.height}},{key:"resized",get:function(){return this.imageWidth!==this.surfaceWidth||this.imageHeight!==this.surfaceHeight}},{key:"texture",get:function(){return this._texture||(this._texture=new THREE.Texture(this.canvas)),this._texture}}]),n}(Primrose.Entity);return t}(),Primrose.WebRTCSocket=function(){function e(e,t){function n(e,t,n){n.fromIndex=e,n.toIndex=t,s[t].setLocalDescription(n,function(){o.emit(n.type,n)})}function i(e,t,n){if(t.fromIndex===e){var i=new RTCSessionDescription(t);s[e].setRemoteDescription(i,n)}}function r(e){function t(){a[e]=null,s[e]=null;var t=0===a.filter(function(e){return e}).length;if(t&&u.close)for(var n=0;n<u.close.length;++n){var i=u.close[n];i&&i.call(this)}}a[e].addEventListener("open",function(){if(u.open)for(var e=0;e<u.open.length;++e){var t=u.open[e];t&&t.call(this)}},!1),a[e].addEventListener("message",function(e){var t=JSON.parse(e.data),n=t.shift();if(u[n])for(var i=0;i<u[n].length;++i){var r=u[n][i];r&&r.apply(this,t)}},!1),a[e].addEventListener("error",t,!1),a[e].addEventListener("close",t,!1)}var o,s=[],a=[],u={},c=null;if("string"==typeof e)o=io.connect(e,{reconnect:!0,"reconnection delay":1e3,"max reconnection attempts":60});else{if(!(e&&e.on&&e.emit))throw console.error("proxy error",o),new Error("need a socket");o=e}this.on=function(e,t){u[e]||(u[e]=[]),u[e].push(t)},this.emit=function(e){for(var t=JSON.stringify(e),n=0;n<a.length;++n){var i=a[n];i&&"open"===i.readyState&&i.send(t)}},this.close=function(){a.forEach(function(e){e&&"open"===e.readyState&&e.close()}),s.forEach(function(e){e&&e.close()})},window.addEventListener("unload",this.close.bind(this)),this.connect=function(e){o.emit("handshake","peer"),o.on("handshakeComplete",function(t){"peer"===t&&o.emit("joinRequest",e)})},o.on("user",function(e,u){try{if(null===c&&(c=e),!s[u]){var l=new RTCPeerConnection({iceServers:["stun.l.google.com:19302","stun1.l.google.com:19302","stun2.l.google.com:19302","stun3.l.google.com:19302","stun4.l.google.com:19302"].map(function(e){return{url:"stun:"+e}})});if(s[u]=l,l.addEventListener("icecandidate",function(e){e.candidate&&(e.candidate.fromIndex=c,e.candidate.toIndex=u,o.emit("ice",e.candidate))},!1),o.on("ice",function(e){e.fromIndex===u&&s[u].addIceCandidate(new RTCIceCandidate(e))}),t===!0||void 0===t&&u>c){l.addEventListener("negotiationneeded",function(e){l.createOffer(n.bind(this,c,u),console.error.bind(console,"createOffer error"))});var h=l.createDataChannel("data-channel-"+c+"-to-"+u,{id:c,ordered:!1,maxRetransmits:0});a[u]=h,r(u),o.on("answer",function(e){e.fromIndex===u&&i(u,e)})}else(t===!1||void 0===t&&c>u)&&(l.addEventListener("datachannel",function(e){e.channel.id===u&&(a[e.channel.id]=e.channel,r(u))},!1),o.on("offer",function(e){e.fromIndex===u&&i(u,e,function(){s[u].createAnswer(n,console.error.bind(console,"createAnswer error"))})}))}}catch(d){console.error(d)}})}return Window.prototype.RTCPeerConnection=Window.prototype.RTCPeerConnection||Window.prototype.webkitRTCPeerConnection||Window.prototype.mozRTCPeerConnection||function(){},Window.prototype.RTCIceCandidate=Window.prototype.RTCIceCandidate||Window.prototype.mozRTCIceCandidate||function(){},Window.prototype.RTCSessionDescription=Window.prototype.RTCSessionDescription||Window.prototype.mozRTCSessionDescription||function(){},e}(),Primrose.Workerize=function(){function e(t){var n,i=t.toString(),r=i.match(/function\s+(\w+)\s*\(/),o=r[1];for(n in t.prototype)i+="\n\n"+o+".prototype."+n+" = "+t.prototype[n].toString()+";";i+="\n\n(function(){\n  var instance = new "+o+"(true);",i+="\n  if(instance.addEventListener){\n    self.args = [null, null];\n    for(var k in instance.listeners) {\n      instance.addEventListener(k, function(eventName, args){\n        self.args[0] = eventName;\n        self.args[1] = args;\n        postMessage(self.args);\n      }.bind(this, k));\n    }\n  }",i+="\n\n  onmessage = function(evt){\n    var f = evt.data[0],\n        t = instance[f];\n    if(t){\n      t.call(instance, evt.data[1]);\n    }\n  };\n\n})();",this.worker=e.createWorker(i,!1),this.args=[null,null],this.listeners={},this.worker.onmessage=function(e){emit.call(this,e.data[0],e.data[1])}.bind(this);for(n in t.prototype)"addEventListener"!==n&&"_"!==n[0]&&(this[n]=this.methodShim.bind(this,n));this.ready=!0}return e.prototype.methodShim=function(e,t){this.args[0]=e,this.args[1]=t,this.worker.postMessage(this.args)},e.prototype.addEventListener=function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)},e.createWorker=function(e,t){if("function"==typeof e&&(e=e.toString()),t){e=e.trim();var n=e.indexOf("{");e=e.substring(n+1,e.length-1)}var i=new Blob([e],{type:"text/javascript"}),r=URL.createObjectURL(i);return new Worker(r)},e}(),Primrose.X.LoginForm=function(){var e=0,t=function(t){function n(){_classCallCheck(this,n);var t=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,"Primrose.X.LoginForm["+e++ +"]"));return t.listeners.login=[],t.listeners.signup=[],t.frame=new Primrose.Surface({id:t.id+"-frame",bounds:new Primrose.Text.Rectangle(0,0,512,150)}),t.labelUserName=new Primrose.Controls.Label({id:t.id+"-labelUserName",bounds:new Primrose.Text.Rectangle(0,0,256,50),fontSize:32,value:"User name:",textAlign:"right"}),t.userName=new Primrose.Text.Controls.TextInput({id:t.id+"-userName",bounds:new Primrose.Text.Rectangle(256,0,256,50),fontSize:32}),t.labelPassword=new Primrose.Controls.Label({id:t.id+"-labelPassword",bounds:new Primrose.Text.Rectangle(0,50,256,50),fontSize:32,value:"Password:",textAlign:"right"}),t.password=new Primrose.Text.Controls.TextInput({id:t.id+"-password",bounds:new Primrose.Text.Rectangle(256,50,256,50),fontSize:32,passwordCharacter:"*"}),t.signupButton=new Primrose.Controls.Button2D({id:t.id+"-signupButton",bounds:new Primrose.Text.Rectangle(0,100,256,50),fontSize:32,value:"Sign up"}),t.loginButton=new Primrose.Controls.Button2D({id:t.id+"-loginButton",bounds:new Primrose.Text.Rectangle(256,100,256,50),fontSize:32,value:"Login"}),t.loginButton.addEventListener("click",function(e){return emit.call(t,"login",{target:t})},!1),t.signupButton.addEventListener("click",function(e){return emit.call(t,"signup",{target:t})},!1),t.mesh=textured(quad(1,150/512),t.frame),t.mesh.name="LoginForm",t.frame.appendChild(t.labelUserName),t.frame.appendChild(t.userName),t.frame.appendChild(t.labelPassword),t.frame.appendChild(t.password),t.frame.appendChild(t.signupButton),t.frame.appendChild(t.loginButton),t.appendChild(t.frame),t}return _inherits(n,t),n}(Primrose.Entity);return t}(),Primrose.X.SignupForm=function(){var e=0,t=function(t){function n(){_classCallCheck(this,n);var t=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,"Primrose.X.SignupForm["+e++ +"]"));return t.listeners.login=[],t.listeners.signup=[],t.frame=new Primrose.Surface({id:t.id+"-frame",bounds:new Primrose.Text.Rectangle(0,0,512,200)}),t.labelUserName=new Primrose.Controls.Label({id:t.id+"-labelUserName",bounds:new Primrose.Text.Rectangle(0,0,256,50),fontSize:32,value:"User name:",textAlign:"right"}),t.userName=new Primrose.Text.Controls.TextInput({id:t.id+"-userName",bounds:new Primrose.Text.Rectangle(256,0,256,50),fontSize:32}),t.labelEmail=new Primrose.Controls.Label({id:t.id+"-labelEmail",bounds:new Primrose.Text.Rectangle(0,50,256,50),fontSize:32,value:"Email:",textAlign:"center"}),t.email=new Primrose.Text.Controls.TextInput({id:t.id+"-email",bounds:new Primrose.Text.Rectangle(256,50,256,50),fontSize:32}),t.labelPassword=new Primrose.Controls.Label({id:t.id+"-labelPassword",bounds:new Primrose.Text.Rectangle(0,100,256,50),fontSize:32,value:"Password:",textAlign:"left"}),t.password=new Primrose.Text.Controls.TextInput({id:t.id+"-password",bounds:new Primrose.Text.Rectangle(256,100,256,50),fontSize:32,passwordCharacter:"*"}),t.loginButton=new Primrose.Controls.Button2D({id:t.id+"-loginButton",bounds:new Primrose.Text.Rectangle(0,150,256,50),fontSize:32,value:"Login"}),t.signupButton=new Primrose.Controls.Button2D({id:t.id+"-signupButton",bounds:new Primrose.Text.Rectangle(256,150,256,50),fontSize:32,value:"Sign up"}),t.loginButton.addEventListener("click",function(e){return emit.call(t,"login",{target:t})},!1),t.signupButton.addEventListener("click",function(e){return emit.call(t,"signup",{target:t})},!1),t.mesh=textured(quad(1,.390625),t.frame),t.mesh.name="SignupForm",t.frame.appendChild(t.labelUserName),t.frame.appendChild(t.userName),t.frame.appendChild(t.labelEmail),t.frame.appendChild(t.email),t.frame.appendChild(t.labelPassword),t.frame.appendChild(t.password),t.frame.appendChild(t.loginButton),t.frame.appendChild(t.signupButton),t.appendChild(t.frame),t}return _inherits(n,t),n}(Primrose.Entity);return t}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Primrose.Controls.Label=function(){var e=0,t=function(t){function n(t){_classCallCheck(this,n);var i=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,patch(t,{id:"Primrose.Controls.Label["+e++ +"]"})));return"string"==typeof t?i.options={value:i.options}:i.options=t||{},i._lastFont=null,i._lastText=null,i._lastCharacterWidth=null,i._lastCharacterHeight=null,i._lastPadding=null,i._lastWidth=-1,i._lastHeight=-1,i._lastTextAlign=null,i.textAlign=i.options.textAlign,i.character=new Primrose.Text.Size,i.theme=i.options.theme,i.fontSize=i.options.fontSize||16,i.refreshCharacter(),i.value=i.options.value,i}return _inherits(n,t),_createClass(n,[{key:"refreshCharacter",value:function(){this.character.height=this.fontSize,this.context.font=this.character.height+"px "+this.theme.fontFamily,this.character.width=this.context.measureText("MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM").width/100}},{key:"_isChanged",value:function(){var e=this._lastText!==this.value,t=this.character.width!==this._lastCharacterWidth,n=this.character.height!==this._lastCharacterHeight,i=this.context.font!==this._lastFont,r=this.textAlign!==this._lastTextAlign,o=this.resized||e||t||n||this.resized||i||r;return o}},{key:"render",value:function(){if(this.resized&&this.resize(),this.theme&&this._isChanged){this._lastText=this.value,this._lastCharacterWidth=this.character.width,this._lastCharacterHeight=this.character.height,this._lastWidth=this.imageWidth,this._lastHeight=this.imageHeight,this._lastFont=this.context.font,this._lastTextAlign=this.textAlign,this.context.textAlign=this.textAlign||"left";var e=this.options.backgroundColor||this.theme.regular.backColor,t=this.options.color||this.theme.regular.foreColor,n=e?"fillRect":"clearRect";if(this.theme.regular.backColor&&(this.context.fillStyle=e),this.context[n](0,0,this.imageWidth,this.imageHeight),this.value)for(var i=this.value.split("\n"),r=0;r<i.length;++r){var o=i[r],s=(this.imageHeight-i.length*this.character.height)/2+r*this.character.height,a=null;switch(this.textAlign){case"right":a=this.imageWidth;break;case"center":a=this.imageWidth/2;break;default:a=0}var u=(this.theme.regular.fontWeight||"")+" "+(this.theme.regular.fontStyle||"")+" "+this.character.height+"px "+this.theme.fontFamily;this.context.font=u.trim(),this.context.fillStyle=t,this.context.fillText(o,a,s)}this.renderCanvasTrim(),this.invalidate()}}},{key:"renderCanvasTrim",value:function(){}},{key:"textAlign",get:function(){return this.context.textAlign},set:function(e){this.context.textAlign=e,this.render()}},{key:"value",get:function(){return this._value},set:function(e){e=e||"",this._value=e.replace(/\r\n/g,"\n"),this.render()}},{key:"theme",get:function(){return this._theme},set:function(e){this._theme=clone(e||Primrose.Text.Themes.Default),this._theme.fontSize=this.fontSize,this.refreshCharacter(),this.render()}}]),n}(Primrose.Surface);return t}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),_get=function t(e,n,i){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,n);if(void 0===r){var o=Object.getPrototypeOf(e);return null===o?void 0:t(o,n,i)}if("value"in r)return r.value;var s=r.get;if(void 0!==s)return s.call(i)};Primrose.Controls.Button2D=function(){var e=0,t=function(t){function n(t){_classCallCheck(this,n);var i=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,patch(t,{id:"Primrose.Controls.Button2D["+e++ +"]",textAlign:"center"})));return i._lastActivated=null,i}return _inherits(n,t),_createClass(n,[{key:"startPointer",value:function(e,t){this.focus(),this._activated=!0,this.render()}},{key:"endPointer",value:function(){this._activated&&(this._activated=!1,emit.call(this,"click",{target:this}),this.render())}},{key:"_isChanged",value:function(){var e=this._activated!==this._lastActivated,t=_get(Object.getPrototypeOf(n.prototype),"_isChanged",this)||e;return t}},{key:"renderCanvasTrim",value:function(){this.context.lineWidth=this._activated?4:2,this.context.strokeStyle=this.theme.regular.foreColor||Primrose.Text.Themes.Default.regular.foreColor,this.context.strokeRect(0,0,this.imageWidth,this.imageHeight)}}]),n}(Primrose.Controls.Label);return t}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Primrose.Controls.Image=function(){var e=0,t=window.Image,n={},i=function(i){function r(t){_classCallCheck(this,r),t=t||{},"string"==typeof t&&(t={value:t});var n=_possibleConstructorReturn(this,Object.getPrototypeOf(r).call(this,patch(t,{id:"Primrose.Controls.Image["+e++ +"]",bounds:new Primrose.Text.Rectangle(0,0,1,1)})));return n.listeners.load=[],n._lastWidth=-1,n._lastHeight=-1,n._lastImage=null,n._images=[],n._currentImageIndex=0,setTimeout(function(){t.value&&(/\.stereo\./.test(t.value)?n.loadStereoImage(t.value):n.loadImage(t.value))}),n}return _inherits(r,i),_createClass(r,[{key:"_loadImage",value:function(e,i){return new Promise(function(e,r){if(n[i])e(n[i]);else if(i){var o=new t;o.addEventListener("load",function(){n[i]=o,e(n[i])},!1),o.addEventListener("error",function(){r("error loading image")},!1),o.src=i}else r("Image was null")})}},{key:"loadImage",value:function(e,t){var n=this;return"number"==typeof e||e instanceof Number||(t=e,e=0),this._loadImage(e,t).then(function(t){return n.setImage(e,t),t})["catch"](function(i){console.error("Failed to load image %s. Reason: %s",t,i),n.setImage(e,null)})}},{key:"loadStereoImage",value:function(e){var t=this;return this.loadImage(e).then(function(e){var n={bounds:new Primrose.Text.Rectangle(0,0,e.width/2,e.height)},i=new Primrose.Surface(n),r=new Primrose.Surface(n);return i.context.drawImage(e,0,0),r.context.drawImage(e,-n.bounds.width,0),t.setImage(0,i.canvas),t.setImage(1,r.canvas),t.bounds.width=n.bounds.width,t.bounds.height=n.bounds.height,t.render(),t})}},{key:"getImage",value:function(e){return this._images[e%this._images.length]}},{key:"setImage",value:function(e,t){this._images[e]=t,this.render(),emit.call(this,"load",{target:this})}},{key:"eyeBlank",value:function(e){this._currentImageIndex=e,this.render()}},{key:"render",value:function(){this._changed&&(this.resized?this.resize():this.context.clearRect(0,0,this.imageWidth,this.imageHeight),this.image&&this.context.drawImage(this.image,0,0),this._lastWidth=this.imageWidth,this._lastHeight=this.imageHeight,this._lastImage=this.image,this.invalidate())}},{key:"image",get:function(){return this.getImage(this._currentImageIndex)},set:function(e){this.setImage(this._currentImageIndex,e)}},{key:"_changed",get:function(){return this.resized||this.image!==this._lastImage}}]),r}(Primrose.Surface);return i}(),Primrose.DOM.cascadeElement=function(e,t,n){var i=null;if(null===e?(i=document.createElement(t),i.id=e="auto_"+t+Date.now()):void 0===n||e instanceof n?i=e:"string"==typeof e&&(i=document.getElementById(e),null===i?(i=document.createElement(t),i.id=e):i.tagName!==t.toUpperCase()&&(i=null)),null===i)throw new Error(e+" does not refer to a valid "+t+" element.");return"canvas"!==t&&(i.innerHTML=""),i},Primrose.DOM.findEverything=function(e,t){e=e||document,t=t||{};for(var n=e.querySelectorAll("*"),i=0;i<n.length;++i){var r=n[i];r.id&&r.id.length>0&&(t[r.id]=r,r.parentElement&&(r.parentElement[r.id]=r))}return t},Primrose.DOM.makeHidingContainer=function(e,t){var n=Primrose.DOM.cascadeElement(e,"div",window.HTMLDivElement);return n.style.position="absolute",n.style.left=0,n.style.top=0,n.style.width=0,n.style.height=0,n.style.overflow="hidden",n.appendChild(t),n},Primrose.DOM.StateList=function(){var e=function t(e,n,i,r,o){_classCallCheck(this,t);for(var s=Primrose.DOM.cascadeElement(e,"select",HTMLSelectElement),a=0;a<i.length;++a){var u=document.createElement("option");u.appendChild(document.createTextNode(i[a].name)),s.appendChild(u)}s.addEventListener("change",function(){var e=i[s.selectedIndex].values;if(void 0!==e){for(var t in e)if(e.hasOwnProperty(t)){var o=e[t];for(var a in o)o.hasOwnProperty(a)&&(n[t][a]=o[a])}r&&r()}}.bind(this),!1),this.DOMElement=s,o&&o.appendChild(this.DOMElement)};return e}(),Primrose.HTTP.get=function(e,t,n){return Primrose.HTTP.XHR("GET",e||"text",t,n)},Primrose.HTTP.getBuffer=function(e,t){return Primrose.HTTP.get("arraybuffer",e,t)},Primrose.HTTP.getObject=function(e,t){return Primrose.HTTP.get("json",e,t)},Primrose.HTTP.getText=function(e,t){return Primrose.HTTP.get("text",e,t)},Primrose.HTTP.post=function(e,t,n){return Primrose.HTTP.XHR("POST",e,t,n)},Primrose.HTTP.sendObject=function(e,t){return console.original_log("sendObject",t),Primrose.HTTP.post("json",e,t)},Primrose.HTTP.XHR=function(e,t,n,i){return new Promise(function(r,o){i=i||{},i.headers=i.headers||{},"POST"===e&&(i.headers["Content-Type"]=i.headers["Content-Type"]||t);var s=new XMLHttpRequest;s.onerror=function(e){return o(new Error("Request error: "+e.message))},s.onabort=function(e){return o(new Error("Request abort: "+e.message))},s.onload=function(){s.status<400?r(s.response):o(s)},s.open(e,n),t&&(s.responseType=t),s.onprogress=i.progress;for(var a in i.headers)s.setRequestHeader(a,i.headers[a]);s.withCredentials=!!i.withCredentials,i.data?s.send(JSON.stringify(i.data)):s.send()})},Primrose.Input.Camera=function(){function e(t,n,i,r,o,s,a){MediaStreamTrack.getSources(function(e){var i=document.createElement("option");i.value="",i.innerHTML="-- select camera --",t.appendChild(i);for(var r=0;r<e.length;++r)"video"===e[r].kind&&(i=document.createElement("option"),i.value=e[r].id,i.innerHTML=fmt("[Facing: $1] [ID: $2...]",e[r].facing||"N/A",e[r].id.substring(0,8)),i.selected=e[r].id===n,t.appendChild(i))}),this.options=patch(a,e),this.videoElement=document.createElement("video"),this.buffer=document.createElement("canvas"),this.gfx=this.buffer.getContext("2d"),this.texture=new THREE.Texture(this.buffer);var u=new THREE.MeshBasicMaterial({map:this.texture,useScreenCoordinates:!1,color:16777215,shading:THREE.FlatShading});this.gfx.width=500,this.gfx.height=500,this.gfx.fillStyle="white",this.gfx.fillRect(0,0,500,500);var c=new THREE.PlaneGeometry(i,i);c.computeBoundingBox(),c.computeVertexNormals(),this.mesh=new THREE.Mesh(c,u),this.mesh.position.set(r,o,s),this.streaming=!1,this.videoElement.autoplay=1;var l=function(e,t,n){navigator.getUserMedia({video:e},function(e){streamURL=window.URL.createObjectURL(e),this.videoElement.src=streamURL,t()}.bind(this),n)}.bind(this),h=function(e,t,n){if(n=n||0,this.options.videoModes&&n<this.options.videoModes.length){var i=this.options.videoModes[n],r={optional:[{sourceId:e}]};"default"!==i&&(r.mandatory={minWidth:i.w,minHeight:i.h},i=fmt("[w:$1, h:$2]",i.w,i.h)),l(r,function(){console.log(fmt("Connected to camera at mode $1.",i))},function(t){console.error(fmt("Failed to connect at mode $1. Reason: $2",i,t)),h(e,t,n+1)})}else t("no video modes specified.")}.bind(this);this.videoElement.addEventListener("canplay",function(){this.streaming||(this.streaming=!0)}.bind(this),!1),this.videoElement.addEventListener("playing",function(){this.videoElement.height=this.buffer.height=this.videoElement.videoHeight,this.videoElement.width=this.buffer.width=this.videoElement.videoWidth;var e=this.videoElement.videoWidth/this.videoElement.videoHeight;this.mesh.scale.set(e,1,1)}.bind(this),!1),this.connect=function(e){if(this.streaming)try{window.stream&&window.stream.stop(),this.videoElement.src=null,this.streaming=!1}catch(t){console.error("While stopping",t)}h(e,function(e){console.error(fmt("Couldn't connect at requested resolutions. Reason: $1",e)),l(!0,console.log.bind(console,"Connected to camera at default resolution"),console.error.bind(console,"Final connect attempt"))})}.bind(this),n&&this.connect(n)}return Navigator.prototype.getUserMedia=Navigator.prototype.getUserMedia||Navigator.prototype.webkitGetUserMedia||Navigator.prototype.mozGetUserMedia||Navigator.prototype.msGetUserMedia||Navigator.prototype.oGetUserMedia||function(){},e.DEFAULTS={videoModes:[{w:320,h:240},{w:640,h:480},"default"]},e.prototype.update=function(){this.gfx.drawImage(this.videoElement,0,0),this.texture.needsUpdate=!0},e}(),Primrose.Input.FPSInput=function(){function e(e){var t=this;if(e=e||window,this.listeners={zero:[],lockpointer:[],fullscreen:[],pointerstart:[],pointerend:[]},this.managers=[new Primrose.Input.Keyboard(window,{lockPointer:{buttons:[Primrose.Keys.ANY],commandUp:emit.bind(this,"lockpointer")},pointer1:{buttons:[Primrose.Keys.SPACE],repetitions:1,commandDown:emit.bind(this,"pointerstart"),commandUp:emit.bind(this,"pointerend")},pointer2:{buttons:[Primrose.Keys.ENTER],repetitions:1,commandDown:emit.bind(this,"pointerstart"),commandUp:emit.bind(this,"pointerend")},fullScreen:{buttons:[Primrose.Keys.F],commandDown:emit.bind(this,"fullscreen")},strafeLeft:{buttons:[-Primrose.Keys.A,-Primrose.Keys.LEFTARROW]},strafeRight:{buttons:[Primrose.Keys.D,Primrose.Keys.RIGHTARROW]},strafe:{commands:["strafeLeft","strafeRight"]},driveForward:{buttons:[-Primrose.Keys.W,-Primrose.Keys.UPARROW]},driveBack:{buttons:[Primrose.Keys.S,Primrose.Keys.DOWNARROW]},drive:{commands:["driveForward","driveBack"]},select:{buttons:[Primrose.Keys.ENTER]},dSelect:{buttons:[Primrose.Keys.ENTER],delta:!0},zero:{buttons:[Primrose.Keys.Z],metaKeys:[-Primrose.Keys.CTRL,-Primrose.Keys.ALT,-Primrose.Keys.SHIFT,-Primrose.Keys.META],commandUp:emit.bind(this,"zero")}}),new Primrose.Input.Mouse(e,{lockPointer:{buttons:[Primrose.Keys.ANY],commandDown:emit.bind(this,"lockpointer")},pointer:{buttons:[Primrose.Keys.ANY],repetitions:1,commandDown:emit.bind(this,"pointerstart"),commandUp:emit.bind(this,"pointerend")},buttons:{axes:[Primrose.Input.Mouse.BUTTONS]},dButtons:{axes:[Primrose.Input.Mouse.BUTTONS],delta:!0},pointerX:{axes:[Primrose.Input.Mouse.X]},pointerY:{axes:[Primrose.Input.Mouse.Y]},dx:{axes:[-Primrose.Input.Mouse.X],delta:!0,scale:.005,min:-5,max:5},heading:{commands:["dx"],integrate:!0},dy:{axes:[-Primrose.Input.Mouse.Y],delta:!0,scale:.005,min:-5,max:5},pitch:{commands:["dy"],integrate:!0,min:.5*-Math.PI,max:.5*Math.PI},pointerPitch:{commands:["dy"],integrate:!0,min:.25*-Math.PI,max:.25*Math.PI}}),new Primrose.Input.Touch(e,{lockPointer:{buttons:[Primrose.Keys.ANY],commandUp:emit.bind(this,"lockpointer")},pointer:{buttons:[Primrose.Keys.ANY],repetitions:1,commandDown:emit.bind(this,"pointerstart"),commandUp:emit.bind(this,"pointerend")},buttons:{axes:[Primrose.Input.Touch.FINGERS]},dButtons:{axes:[Primrose.Input.Touch.FINGERS],delta:!0},pointerX:{axes:[Primrose.Input.Touch.X0]},pointerY:{axes:[Primrose.Input.Touch.Y0]},dx:{axes:[-Primrose.Input.Touch.X0],delta:!0,scale:.005,min:-5,max:5},heading:{commands:["dx"],integrate:!0},dy:{axes:[-Primrose.Input.Touch.Y0],delta:!0,scale:.005,min:-5,max:5},pitch:{commands:["dy"],integrate:!0,min:.5*-Math.PI,max:.5*Math.PI}}),new Primrose.Input.Gamepad({pointer:{buttons:[Primrose.Input.Gamepad.XBOX_BUTTONS.A],repetitions:1,commandDown:emit.bind(this,"pointerstart"),commandUp:emit.bind(this,"pointerend")},strafe:{axes:[Primrose.Input.Gamepad.LSX]},drive:{axes:[Primrose.Input.Gamepad.LSY]},heading:{axes:[-Primrose.Input.Gamepad.RSX],integrate:!0},dheading:{commands:["heading"],delta:!0},pitch:{axes:[Primrose.Input.Gamepad.RSY],integrate:!0}})],Primrose.Input.VR.Version>0){var n=new Primrose.Input.VR;this.managers.push(n),n.init()}this.managers.forEach(function(e){return t[e.name]=e})}var t=["heading","pitch","roll","pointerPitch","headX","headY","headZ"];if(e.prototype.zero=function(){this.vr&&this.vr.currentDisplay&&this.vr.currentDisplay.resetPose(),this.motion&&this.motion.zeroAxes();for(var e=0;e<this.managers.length;++e)for(var n=this.managers[e],i=0;n.enabled&&i<t.length;++i)n.setValue(t[i],0)},e.prototype.update=function(){for(var e=0;e<this.managers.length;++e){var t=this.managers[e];t.enabled&&(t.poll&&t.poll(),t.update())}},e.prototype.addEventListener=function(e,t,n){this.listeners[e]?this.listeners[e].push(t):this.managers.forEach(function(i){i.addEventListener&&i.addEventListener(e,t,n)})},e.prototype.getValue=function(e){for(var t=0,n=0;n<this.managers.length;++n){var i=this.managers[n];i.enabled&&(t+=i.getValue(e))}return t},e.prototype.getLatestValue=function(e){for(var t=0,n=Number.MIN_VALUE,i=0;i<this.managers.length;++i){var r=this.managers[i];r.enabled&&r.lastT>n&&(n=r.lastT,t=r.getValue(e))}return t},window.THREE){e.prototype.getVector3=function(e,t,n,i){i=i||new THREE.Vector3,i.set(0,0,0);for(var r=0;r<this.managers.length;++r){var o=this.managers[r];o.enabled&&o.addVector3(e,t,n,i)}return i},e.prototype.getVector3s=function(e,t,n,i){i=i||[];for(var r=0;r<this.managers.length;++r){var o=this.managers[r];o.enabled&&(i[r]=o.getVector3(e,t,n,i[r]))}return i};var n=new THREE.Quaternion;return e.prototype.getOrientation=function(e,t,i,r,o,s){o=o||new THREE.Quaternion,o.set(0,0,0,1);for(var a=0;a<this.managers.length;++a){var u=this.managers[a];if(u.enabled&&u.getOrientation&&(u.getOrientation(e,t,i,r,n),o.multiply(n),!s))break}return o},Object.defineProperty(e.prototype,"transforms",{get:function(){return this.vr&&this.vr.transforms?this.vr.transforms:Primrose.Input.Motion.DEFAULT_TRANSFORMS}}),e}}(),Primrose.Input.Gamepad=function(){var e=function(e){function t(e,n,i){function r(e,t){var n=e.indexOf(t);n>-1&&e.splice(n,1)}function o(e,t){for(var n=0;n<e.length;++n)e[n](t)}function s(e){o(l.gamepadconnected,e)}function a(e){o(l.gamepaddisconnected,e)}_classCallCheck(this,t);var u=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,"Gamepad",e,n)),c=[],l={gamepadconnected:[],gamepaddisconnected:[]};u.checkDevice=function(e){var n;for(n=0;n<e.buttons.length;++n)this.setButton(n,e.buttons[n].pressed);for(n=0;n<e.axes.length;++n)this.setAxis(t.AXES[n],e.axes[n])},u.poll=function(){var e,t,n=[];if(navigator.getGamepads?e=navigator.getGamepads():navigator.webkitGetGamepads&&(e=navigator.webkitGetGamepads()),
e)for(t=0;t<e.length;++t){var r=e[t];r&&(i||(i=r.id),-1===c.indexOf(r.id)&&(c.push(r.id),s(r.id)),r.id===i&&this.checkDevice(r),n.push(r.id))}for(t=c.length-1;t>=0;--t)-1===n.indexOf(c[t])&&(a(c[t]),c.splice(t,1))},u.getErrorMessage=function(){return errorMessage},u.setGamepad=function(e){i=e,this.inPhysicalUse=!0},u.clearGamepad=function(){i=null,this.inPhysicalUse=!1},u.isGamepadSet=function(){return!!i},u.getConnectedGamepads=function(){return c.slice()},u.addEventListener=function(e,t,n){l[e]&&l[e].push(t),"gamepadconnected"===e&&c.forEach(s)},u.removeEventListener=function(e,t,n){l[e]&&r(l[e],t)};try{u.update(),u.available=!0}catch(h){u.avaliable=!1,u.errorMessage=h}return u}return _inherits(t,e),t}(Primrose.InputProcessor);return Primrose.InputProcessor.defineAxisProperties(e,["LSX","LSY","RSX","RSY"]),e}(),Primrose.Input.Gamepad.XBOX_BUTTONS={A:1,B:2,X:3,Y:4,leftBumper:5,rightBumper:6,leftTrigger:7,rightTrigger:8,back:9,start:10,leftStick:11,rightStick:12,up:13,down:14,left:15,right:16},Primrose.Input.Keyboard=function(){var e=function(e){function t(e,n,i){function r(e,t){this.setButton(t.keyCode,e),this.update()}_classCallCheck(this,t);var o=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,"Keyboard",n,i));return e=e||window,e.addEventListener("keydown",r.bind(o,!0),!1),e.addEventListener("keyup",r.bind(o,!1),!1),o}return _inherits(t,e),t}(Primrose.InputProcessor);return e}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Primrose.Input.LeapMotion=function(){var e=function(e){function t(e,n){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,"LeapMotion",e,n));return i.isStreaming=!1,i.controller=new Leap.Controller({enableGestures:!0}),i}return _inherits(t,e),_createClass(t,[{key:"E",value:function(e,t){t?this.controller.on(e,t):this.controller.on(e,console.log.bind(console,"Leap Motion Event: "+e))}},{key:"start",value:function(e){if(this.isEnabled()){var n=null,i=null;if(e){var r=function s(t){requestAnimationFrame(s),e(t)};i=requestAnimationFrame.bind(window,r);var o=setTimeout(i,t.CONNECTION_TIMEOUT);n=function(){clearTimeout(o),this.isStreaming=!0}.bind(this),this.E("deviceStreaming",n),this.E("streamingStarted",n),this.E("streamingStopped",i)}this.E("connect"),this.E("deviceStopped"),this.E("disconnect"),this.E("frame",this.setState.bind(this,e)),this.controller.connect()}}},{key:"setState",value:function(e,n){var i,r,o=this.controller.history.get(1);if(!o||n.hands.length!==o.hands.length)for(i=0;i<this.commands.length;++i)this.enable(this.commands[i].name,n.hands.length>0);for(i=0;i<n.hands.length;++i){var s=n.hands[i].palmPosition,a="HAND"+i;for(r=0;r<t.COMPONENTS.length;++r)this.setAxis(a+t.COMPONENTS[r],s[r])}for(i=0;i<n.fingers.length;++i){var u=n.fingers[i],c="FINGER"+i;for(r=0;r<t.FINGER_PARTS.length;++r)for(var l=u[t.FINGER_PARTS[r]+"Position"],h=c+t.FINGER_PARTS[r].toUpperCase(),d=0;d<t.COMPONENTS.length;++d)this.setAxis(h+t.COMPONENTS[d],l[d])}e&&e(.001*n.timestamp),this.update()}}]),t}(Primrose.InputProcessor);return e.COMPONENTS=["X","Y","Z"],e.NUM_HANDS=2,e.NUM_FINGERS=10,e.FINGER_PARTS=["tip","dip","pip","mcp","carp"],Primrose.InputProcessor.defineAxisProperties(e,["X0","Y0","Z0","X1","Y1","Z1","FINGER0TIPX","FINGER0TIPY","FINGER0DIPX","FINGER0DIPY","FINGER0PIPX","FINGER0PIPY","FINGER0MCPX","FINGER0MCPY","FINGER0CARPX","FINGER0CARPY","FINGER1TIPX","FINGER1TIPY","FINGER1DIPX","FINGER1DIPY","FINGER1PIPX","FINGER1PIPY","FINGER1MCPX","FINGER1MCPY","FINGER1CARPX","FINGER1CARPY","FINGER2TIPX","FINGER2TIPY","FINGER2DIPX","FINGER2DIPY","FINGER2PIPX","FINGER2PIPY","FINGER2MCPX","FINGER2MCPY","FINGER2CARPX","FINGER2CARPY","FINGER3TIPX","FINGER3TIPY","FINGER3DIPX","FINGER3DIPY","FINGER3PIPX","FINGER3PIPY","FINGER3MCPX","FINGER3MCPY","FINGER3CARPX","FINGER3CARPY","FINGER4TIPX","FINGER4TIPY","FINGER4DIPX","FINGER4DIPY","FINGER4PIPX","FINGER4PIPY","FINGER4MCPX","FINGER4MCPY","FINGER4CARPX","FINGER4CARPY","FINGER5TIPX","FINGER5TIPY","FINGER5DIPX","FINGER5DIPY","FINGER5PIPX","FINGER5PIPY","FINGER5MCPX","FINGER5MCPY","FINGER5CARPX","FINGER5CARPY","FINGER6TIPX","FINGER6TIPY","FINGER6DIPX","FINGER6DIPY","FINGER6PIPX","FINGER6PIPY","FINGER6MCPX","FINGER6MCPY","FINGER6CARPX","FINGER6CARPY","FINGER7TIPX","FINGER7TIPY","FINGER7DIPX","FINGER7DIPY","FINGER7PIPX","FINGER7PIPY","FINGER7MCPX","FINGER7MCPY","FINGER7CARPX","FINGER7CARPY","FINGER8TIPX","FINGER8TIPY","FINGER8DIPX","FINGER8DIPY","FINGER8PIPX","FINGER8PIPY","FINGER8MCPX","FINGER8MCPY","FINGER8CARPX","FINGER8CARPY","FINGER9TIPX","FINGER9TIPY","FINGER9DIPX","FINGER9DIPY","FINGER9PIPX","FINGER9PIPY","FINGER9MCPX","FINGER9MCPY","FINGER9CARPX","FINGER9CARPY"]),e.CONNECTION_TIMEOUT=5e3,e}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Primrose.Input.Location=function(){var e=function(e){function t(e,n,i){_classCallCheck(this,t);var r=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,"Location",e,n));return r.options=patch(i,t.DEFAULTS),r.available=!!navigator.geolocation,r.available&&navigator.geolocation.watchPosition(r.setState.bind(r),function(){this.available=!1}.bind(r),r.options),r}return _inherits(t,e),_createClass(t,[{key:"setState",value:function(e){for(var n in e.coords){var i=n.toUpperCase();t.AXES.indexOf(i)>-1&&this.setAxis(i,e.coords[n])}this.update()}}]),t}(Primrose.InputProcessor);return Primrose.InputProcessor.defineAxisProperties(e,["LONGITUDE","LATITUDE","ALTITUDE","HEADING","SPEED"]),e.DEFAULTS={enableHighAccuracy:!0,maximumAge:3e4,timeout:25e3},e}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Primrose.Input.Motion=function(){function e(e,t){var n=Math.max(screen.width,screen.height),i=Math.min(screen.width,screen.height),r=Math.floor(n*devicePixelRatio/2),o=Math.floor(i*devicePixelRatio),s=(t+1)/2;window.THREE&&(e.transform=(new THREE.Matrix4).makeTranslation(.034*t,0,0)),e.viewport={x:s*r,y:0,width:r,height:o,top:0,right:(s+1)*r,bottom:o,left:s*r},e.fov=75}var t=function(e){function t(e,n){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,"Motion",e,n)),r=new MotionCorrector,o=new THREE.Quaternion,s=new THREE.Quaternion,a=new THREE.Vector3(1,0,0),u=new THREE.Vector3(0,1,0),c=new THREE.Vector3(0,0,-1);return r.addEventListener("deviceorientation",function(e){for(var n=0;n<t.AXES.length;++n){var r=t.AXES[n];i.setAxis(r,e[r])}o.set(0,0,0,1).multiply(s.setFromAxisAngle(u,e.HEADING)).multiply(s.setFromAxisAngle(a,e.PITCH)).multiply(s.setFromAxisAngle(c,e.ROLL)),i.headRX=o.x,i.headRY=o.y,i.headRZ=o.z,i.headRW=o.w,i.update()}),i.zeroAxes=r.zeroAxes.bind(r),i}return _inherits(t,e),_createClass(t,[{key:"getOrientation",value:function(e){return e=e||new THREE.Quaternion,e.set(this.getValue("headRX"),this.getValue("headRY"),this.getValue("headRZ"),this.getValue("headRW")),e}}]),t}(Primrose.InputProcessor);return Primrose.InputProcessor.defineAxisProperties(t,["HEADING","PITCH","ROLL","D_HEADING","D_PITCH","D_ROLL","headAX","headAY","headAZ","headRX","headRY","headRZ","headRW"]),t.DEFAULT_TRANSFORMS=[{},{}],e(t.DEFAULT_TRANSFORMS[0],-1),e(t.DEFAULT_TRANSFORMS[1],1),t}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Primrose.Input.Mouse=function(){var e=function(e){function t(e,n,i){_classCallCheck(this,t);var r=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,"Mouse",n,i));return e=e||window,e.addEventListener("mousedown",function(e){r.setButton(e.button,!0),r.BUTTONS=e.buttons<<10,r.update()},!1),e.addEventListener("mouseup",function(e){r.setButton(e.button,!1),r.BUTTONS=e.buttons<<10,r.update()},!1),e.addEventListener("mousemove",function(e){if(r.BUTTONS=e.buttons<<10,t.Lock.isActive){var n=e.movementX,i=e.movementY;void 0===n&&(n=e.webkitMovementX||e.mozMovementX||0,i=e.webkitMovementY||e.mozMovementY||0),r.setMovement(n,i)}else r.setLocation(e.layerX,e.layerY);r.update()},!1),e.addEventListener("wheel",function(e){isChrome?(r.W+=e.deltaX,r.Z+=e.deltaY):e.shiftKey?r.W+=e.deltaY:r.Z+=e.deltaY,e.preventDefault(),r.update()},!1),r}return _inherits(t,e),_createClass(t,[{key:"setLocation",value:function(e,t){this.X=e,this.Y=t}},{key:"setMovement",value:function(e,t){this.X+=e,this.Y+=t}}]),t}(Primrose.InputProcessor),t=findProperty(document,["pointerLockElement","mozPointerLockElement","webkitPointerLockElement"]),n=findProperty(document,["onpointerlockchange","onmozpointerlockchange","onwebkitpointerlockchange"]),i=findProperty(document,["onpointerlockerror","onmozpointerlockerror","onwebkitpointerlockerror"]),r=findProperty(document.documentElement,["requestPointerLock","mozRequestPointerLock","webkitRequestPointerLock","webkitRequestPointerLock"]),o=findProperty(document,["exitPointerLock","mozExitPointerLock","webkitExitPointerLock","webkitExitPointerLock"]);return n=n&&n.substring(2),i=i&&i.substring(2),e.Lock={addChangeListener:function(e,t){return document.addEventListener(n,e,t)},removeChangeListener:function(e){return document.removeEventListener(n,e)},addErrorListener:function(e,t){return document.addEventListener(i,e,t)},removeErrorListener:function(e){return document.removeEventListener(i,e)},withChange:function(t){return new Promise(function(n,i){var r,o,s,a=function(){s&&clearTimeout(s),e.Lock.removeChangeListener(r),e.Lock.removeErrorListener(o)};r=function(){setTimeout(a),n(e.Lock.element)},o=function(e){setTimeout(a),i(e)},e.Lock.addChangeListener(r,!1),e.Lock.addErrorListener(o,!1),t()?(a(),n()):s=setTimeout(function(){a(),i("Pointer Lock state did not change in allotted time")},1e3)})},request:function(t){return e.Lock.withChange(function(){if(!r)throw console.error("No Pointer Lock API support."),new Error("No Pointer Lock API support.");return e.Lock.isActive?!0:void t[r]()})},exit:function(){return e.Lock.withChange(function(){if(!o)throw console.error("No Pointer Lock API support."),new Error("No Pointer Lock API support.");return e.Lock.isActive?void document[o]():!0})}},Object.defineProperties(e.Lock,{element:{get:function(){return document[t]}},isActive:{get:function(){return!!e.Lock.element}}}),Primrose.InputProcessor.defineAxisProperties(e,["X","Y","Z","W","BUTTONS"]),e}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),_get=function n(e,t,i){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,t);if(void 0===r){var o=Object.getPrototypeOf(e);return null===o?void 0:n(o,t,i)}if("value"in r)return r.value;var s=r.get;if(void 0!==s)return s.call(i)};Primrose.Input.Speech=function(){var e=function(e){function t(e,n){function i(){var e=fmt("Failed to initialize speech engine. Reason: $1",c.message);return console.error(e),!1}function r(){return available?a?!1:(a=!0,u.start(),!0):i()}function o(){return available?a?(u.stop(),!0):!1:i()}_classCallCheck(this,t);var s=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,"Speech",e,n)),a=!1,u=null,c=null;s.check=function(){this.enabled&&!a?r():!this.enabled&&a&&o()},s.getErrorMessage=function(){return c};try{u=window.SpeechRecognition?new SpeechRecognition:new webkitSpeechRecognition,u.continuous=!0,u.interimResults=!0,u.lang="en-US";var l=!1;u.addEventListener("start",function(){console.log("speech started"),command=""}.bind(s),!0),u.addEventListener("error",function(e){l=!0,console.log("speech error",e),a=!1,command="speech error"}.bind(s),!0),u.addEventListener("end",function(){console.log("speech ended",arguments),a=!1,command="speech ended",l&&(l=!1,this.enable(!0))}.bind(s),!0),u.addEventListener("result",function(e){var t=[],n=e.results[e.resultIndex],i=0,r=-1;if(n&&n.isFinal)for(var o=0;o<n.length;++o){var s=n[o];s.confidence>i&&(i=s.confidence,r=o)}i>.85&&t.push(n[r].transcript.trim()),t=t.join(" "),t!==this.inputState&&(this.inputState.text=t),this.update()}.bind(s),!0),available=!0}catch(h){c=h,available=!1}return s}return _inherits(t,e),_createClass(t,[{key:"cloneCommand",value:function(e){return{name:e.name,preamble:e.preamble,keywords:t.maybeClone(e.keywords),commandUp:e.commandUp,disabled:e.disabled}}},{key:"evalCommand",value:function(e,t,n,i){if(n&&this.inputState.text)for(var r=0;r<e.keywords.length;++r)0!==this.inputState.text.indexOf(e.keywords[r])||!e.preamble&&e.keywords[r].length!==this.inputState.text.length||(t.pressed=!0,t.value=this.inputState.text.substring(e.keywords[r].length).trim(),this.inputState.text=null)}},{key:"enable",value:function(e,n){_get(Object.getPrototypeOf(t.prototype),"enable",this).call(this,e,n),this.check()}},{key:"transmit",value:function(e){_get(Object.getPrototypeOf(t.prototype),"transmit",this).call(this,e),this.check()}}],[{key:"maybeClone",value:function(e){return e&&e.slice()||[]}}]),t}(Primrose.InputProcessor);return e}(),Primrose.Input.Touch=function(){var e=function(e){function t(e,n,i){function r(e,t,n){for(var i=n.changedTouches,r=0;r<i.length;++r){var o=i[r];t?(this.setAxis("X"+o.identifier,o.pageX),this.setAxis("Y"+o.identifier,o.pageY)):(this.setAxis("LX"+o.identifier,o.pageX),this.setAxis("LY"+o.identifier,o.pageY));var s=1<<o.identifier;e?this.FINGERS|=s:(s=~s,this.FINGERS&=s)}this.update()}_classCallCheck(this,t);var o=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,"Touch",n,i));return e=e||window,e.addEventListener("touchstart",r.bind(o,!0,!1),!1),e.addEventListener("touchend",r.bind(o,!1,!0),!1),e.addEventListener("touchmove",r.bind(o,!0,!0),!1),o}return _inherits(t,e),t}(Primrose.InputProcessor);e.NUM_FINGERS=10;for(var t=["FINGERS"],n=0;n<e.NUM_FINGERS;++n)t.push("X"+n),t.push("Y"+n);return Primrose.InputProcessor.defineAxisProperties(e,t),e}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Primrose.Input.VR=function(){function e(e,n,i,r){var o=n.offset;e.translation=(new THREE.Matrix4).makeTranslation(o[0],o[1],o[2]),e.projection=t(n.fieldOfView,i,r),e.viewport={left:0,top:0,width:n.renderWidth,height:n.renderHeight}}function t(e,t,n){var i=Math.tan(e.upDegrees*Math.PI/180),r=Math.tan(e.downDegrees*Math.PI/180),o=Math.tan(e.leftDegrees*Math.PI/180),s=Math.tan(e.rightDegrees*Math.PI/180),a=2/(o+s),u=2/(i+r),c=new THREE.Matrix4;return c.elements[0]=a,c.elements[1]=0,c.elements[2]=0,c.elements[3]=0,c.elements[4]=0,c.elements[5]=u,c.elements[6]=0,c.elements[7]=0,c.elements[8]=-((o-s)*a*.5),c.elements[9]=(i-r)*u*.5,c.elements[10]=-(t+n)/(n-t),c.elements[11]=-1,c.elements[12]=0,c.elements[13]=0,c.elements[14]=-(2*n*t)/(n-t),c.elements[15]=0,c}var n=function(t){function n(e,t,i,r){function o(e){for(var t=0;t<l.vrdeviceconnected.length;++t)l.vrdeviceconnected[t](e)}function s(e,t){return console.log("Displays found:",t.length),this.displays=t,this.displays.forEach(o),"number"!=typeof r&&this.displays.length>=1&&(r=0),"number"==typeof r?(this.connect(r),this.currentDisplay):void 0}function a(e,t){console.log("Devices found:",t.length);for(var n={},i=null,r=0;r<t.length;++r){var o=t[r];i=o.hardwareUnitId,n[i]||(n[i]={});var a=n[i];o instanceof HMDVRDevice?a.display=o:t[r]instanceof PositionSensorVRDevice&&(a.sensor=o)}var u=[];for(i in n)u.push(new Primrose.Input.VR.LegacyVRDisplay(n[i]));return s.call(this,e,u)}function u(e){var t=[new Primrose.Input.VR.CardboardVRDisplay];return s.call(this,e,t)}_classCallCheck(this,n);var c=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,"VR",e,t));void 0!==e&&null!==e||(e=n.AXES.map(function(e){return{name:e,axes:[Primrose.Input.VR[e]]}}));var l={vrdeviceconnected:[],vrdevicelost:[]};return c.addEventListener=function(e,t,n){l[e]&&l[e].push(t),"vrdeviceconnected"===e&&Object.keys(this.displays).forEach(t)},c.displays=[],c.currentDisplay=null,c.currentPose=null,c.transforms=null,c.init=function(){var e=this;return console.info("Checking for VR Displays..."),navigator.getVRDisplays?(console.info("Using WebVR API 1"),navigator.getVRDisplays().then(s.bind(this,i))):navigator.getVRDevices?(console.info("Using Chromium Experimental WebVR API"),navigator.getVRDevices().then(a.bind(this,i))["catch"](console.error.bind(console,"Could not find VR devices"))):new Promise(function(t,n){var r=setTimeout(n,1e3),o=function s(n){n.alpha&&(clearTimeout(r),r=null,window.removeEventListener("deviceorientation",s),console.info("Using Device Motion API"),t(u.call(e,i)))};console.info("Your browser doesn't have WebVR capability. Check out http://mozvr.com/. We're still going to try for Device Motion API, but there is no way to know ahead of time if your device has a motion sensor."),window.addEventListener("deviceorientation",o,!1)})},c}return _inherits(n,t),_createClass(n,[{key:"requestPresent",value:function(e){return this.currentDisplay?this.currentDisplay.requestPresent(1===n.Version&&isMobile?e[0]:e).then(function(t){return t||e[0].source}):Promise.reject("No display")}},{key:"poll",value:function(){if(this.currentDisplay){var e=this.currentDisplay.getPose();e&&(this.currentPose=e,e.position&&(this.headX=e.position[0],this.headY=e.position[1],this.headZ=e.position[2]),e.linearVelocity&&(this.headVX=e.linearVelocity[0],this.headVY=e.linearVelocity[1],this.headVZ=e.linearVelocity[2]),e.linearAcceleration&&(this.headAX=e.linearAcceleration[0],this.headAY=e.linearAcceleration[1],this.headAZ=e.linearAcceleration[2]),e.orientation&&(this.headRX=e.orientation[0],this.headRY=e.orientation[1],this.headRZ=e.orientation[2],this.headRW=e.orientation[3]),e.angularVelocity&&(this.headRVX=e.angularVelocity[0],this.headRVY=e.angularVelocity[1],this.headRVZ=e.angularVelocity[2]),e.angularAcceleration&&(this.headRAX=e.angularAcceleration[0],this.headRAY=e.angularAcceleration[1],this.headRAZ=e.angularAcceleration[2]))}}},{key:"getOrientation",value:function(e){return e=e||new THREE.Quaternion,e.set(this.getValue("headRX"),this.getValue("headRY"),this.getValue("headRZ"),this.getValue("headRW")),e}},{key:"resetTransforms",value:function(t,n){if(this.currentDisplay){this.enabled=!0;var i={left:this.currentDisplay.getEyeParameters("left"),right:this.currentDisplay.getEyeParameters("right")},r=[{},{}];e(r[0],i.left,t,n),e(r[1],i.right,t,n),r[1].viewport.left=r[0].viewport.width,this.transforms=r}}},{key:"connect",value:function(e){this.currentDisplay=this.displays[e]}}],[{key:"Version",get:function(){return navigator.getVRDisplays?1:navigator.getVRDevices?.5:navigator.mozGetVRDevices?.4:isMobile?.1:0}}]),n}(Primrose.InputProcessor);return Primrose.InputProcessor.defineAxisProperties(n,["headX","headY","headZ","headVX","headVY","headVZ","headAX","headAY","headAZ","headRX","headRY","headRZ","headRW","headRVX","headRVY","headRVZ","headRAX","headRAY","headRAZ"]),n}(),Primrose.Output.Audio3D=function(){function e(){var e=this;try{this.context=new AudioContext,this.sampleRate=this.context.sampleRate,this.mainVolume=this.context.createGain();var t=new THREE.Vector3,n=new THREE.Vector3,i=(new THREE.Matrix4).identity(),r=(new THREE.Matrix4).identity(),o=null;this.setVelocity=this.context.listener.setVelocity.bind(this.context.listener),this.setPlayer=function(s){var a=s;for(i.identity(),r.identity();null!==a;)i.fromArray(a.matrix.elements),i.multiply(r),o=i,i=r,r=o,a=a.parent;o=i;var u=o.elements[12],c=o.elements[13],l=o.elements[14];o.elements[12]=o.elements[13]=o.elements[14]=0,e.context.listener.setPosition(u,c,l),t.set(0,0,1),t.applyProjection(r),t.normalize(),n.set(0,-1,0),n.applyProjection(r),n.normalize(),e.context.listener.setOrientation(t.x,t.y,t.z,n.x,n.y,n.z),r.elements[12]=u,r.elements[13]=c,r.elements[14]=l},this.isAvailable=!0}catch(s){this.isAvailable=!1,this.setPosition=function(){},this.setVelocity=function(){},this.setOrientation=function(){},this.start=function(){},this.stop=function(){},this.error=s,console.error("AudioContext not available. Reason: ",s.message)}}return Window.prototype.AudioContext=Window.prototype.AudioContext||Window.prototype.webkitAudioContext||function(){},e.prototype.start=function(){this.mainVolume.connect(this.context.destination)},e.prototype.stop=function(){this.mainVolume.disconnect()},e.prototype.loadURL=function(e){var t=this;return Primrose.HTTP.getBuffer(e).then(function(e){return new Promise(function(n,i){return t.context.decodeAudioData(e,n,i)})})},e.prototype.loadURLCascadeSrcList=function(e,t){var n=this;return t=t||0,t>=e.length?Promise.reject("Failed to load a file from "+e.length+" files."):this.loadURL(e[t])["catch"](function(){return setTimeout(n.loadURLCascadeSrcList(n,e,t+1),0)})},e.prototype.createRawSound=function(e){if(1!==e.length&&2!==e.length)throw new Error("Incorrect number of channels. Expected 1 or 2, got "+e.length);var t=e[0].length;if(e.length>1&&e[1].length!==t)throw new Error("Second channel is not the same length as the first channel. Expected "+t+", but was "+e[1].length);for(var n=this.context.createBuffer(e.length,t,this.sampleRate),i=0;i<e.length;++i)for(var r=n.getChannelData(i),o=0;t>o;++o)r[o]=e[i][o];return n},e.prototype.createSound=function(e,t){var n={volume:this.context.createGain(),source:this.context.createBufferSource()};return n.source.buffer=t,n.source.loop=e,n.source.connect(n.volume),n},e.prototype.create3DSound=function(e,t,n,i){return i.panner=this.context.createPanner(),i.panner.setPosition(e,t,n),i.panner.connect(this.mainVolume),i.volume.connect(i.panner),i},e.prototype.createFixedSound=function(e){return e.volume.connect(this.mainVolume),e},e.prototype.loadSource=function(e,t){var n=this;return new Promise(function(i,r){e instanceof Array||(e=[e]);var o=document.createElement("audio");o.autoplay=!0,o.loop=t,e.map(function(e){var t=document.createElement("source");return t.src=e,t}).forEach(o.appendChild.bind(o)),o.oncanplay=function(){o.oncanplay=null;var e={volume:n.context.createGain(),source:n.context.createMediaElementSource(o)};e.source.connect(e.volume),i(e)},o.onerror=r,document.body.appendChild(o)})},e.prototype.load3DSound=function(e,t,n,i,r){return this.loadSource(e,t).then(this.create3DSound.bind(this,n,i,r))},e.prototype.loadFixedSound=function(e,t){return this.loadSource(e,t).then(this.createFixedSound.bind(this))},e.prototype.playBufferImmediate=function(e,t){var n=this,i=this.createSound(!1,e);return i=this.createFixedSound(i),i.volume.gain.value=t,i.source.addEventListener("ended",function(e){i.volume.disconnect(n.mainVolume)}),i.source.start(0),i},e}(),Primrose.Output.HapticGlove=function(){function e(t){function n(e){if(e.valid){i=e.hands.length>0;for(var n=0;n<t.hands&&n<e.hands.length;++n)for(var r=e.hands[n],o=0;o<t.fingers;++o)for(var a=r.fingers[o],u=0;u<t.joints;++u){var c=n*t.fingers*t.joints+o*t.joints+u;if(c<this.tips.length){var l=a[s[u]],h=this.tips[c];h.position.set(l[0],l[1],l[2])}}}}t.port=t.port||e.DEFAULT_PORT,t.addr=t.addr||e.DEFAULT_HOST,this.tips=[],this.numJoints=t.hands*t.fingers*t.joints;var i=!1,r=!1;Leap.loop(),this.setEnvironment=function(e){t.world=e.world,t.scene=e.scene,t.camera=e.camera,Leap.loopController.on("frame",n.bind(this))};var o,s=["tipPosition","dipPosition","pipPosition","mcpPosition","carpPosition"],a=0;80!==t.port&&(t.addr+=":"+t.port),o=io.connect(t.addr,{reconnect:!0,"reconnection delay":1e3,"max reconnection attempts":5}),o.on("connect",function(){r=!0,console.log("Connected!")}),o.on("disconnect",function(){r=!1,console.log("Disconnected!")}),this.readContacts=function(e){for(var n=0,r=0;i&&2>n&&r<e.length;++r)for(var o=e[r],s=0;s<t.hands&&2>n;++s)for(var a=0;a<t.fingers;++a){var u=this.tips[a],c=!1;o.bi===u&&o.bj.graphics&&o.bj.graphics.isSolid&&(this.setFingerState(a,!0),c=!0,++n),c||this.setFingerState(a,!1)}},this.setFingerState=function(e,t){var n=1<<e;t?a|=n:a=a&~n&31,r&&o.emit("data",a)}}return e.DEFAULT_PORT=8383,e.DEFAULT_HOST=document.location.hostname,e}(),Primrose.Output.Music=function(){function e(e){return 440*Math.pow(n,e-49)}function t(e,t,n){if(this.audio=e||new AudioContext,this.audio&&this.audio.createGain){void 0===n&&(n=i),void 0===t&&(t="sawtooth"),this.available=!0,this.mainVolume=this.audio.createGain(),this.mainVolume.connect(this.audio.destination),this.numNotes=n,this.oscillators=[];for(var r=0;r<this.numNotes;++r){var o=this.audio.createOscillator(),s=this.audio.createGain();o.type=t,o.frequency.value=0,o.connect(s),o.start(),s.connect(this.mainVolume),this.oscillators.push({osc:o,gn:s,timeout:null})}}else this.available=!1}Window.prototype.AudioContext=Window.prototype.AudioContext||Window.prototype.webkitAudioContext||function(){};var n=Math.pow(2,1/12),i=(navigator.maxTouchPoints||10)+1;return t.prototype.noteOn=function(t,n,i){if(this.available){void 0===i&&(i=0);var r=this.oscillators[i%this.numNotes],o=e(parseFloat(n)+1);return r.gn.gain.value=t,r.osc.frequency.setValueAtTime(o,0),r}},t.prototype.noteOff=function(e){if(this.available){void 0===e&&(e=0);var t=this.oscillators[e%this.numNotes];t.osc.frequency.setValueAtTime(0,0)}},t.prototype.play=function(e,t,n,i){if(this.available){"number"!=typeof i&&(i=0);var r=this.noteOn(t,e,i);r.timeout&&(clearTimeout(r.timeout),r.timeout=null),r.timeout=setTimeout(function(e,t){this.noteOff(e),t.timeout=null}.bind(this,i,r),1e3*n)}},t}(),Primrose.Output.Speech=function(){function e(e,t,n,i){return void 0===e[t]?e[t]=n+(i-n)*Math.random():e[t]=Math.min(i,Math.max(n,e[t])),e[t]}try{return function(t){t=t||{};var n=speechSynthesis.getVoices().filter(function(e){return e["default"]||e.localService}.bind(this)),i=n[Math.floor(e(t,"voice",0,n.length))];this.speak=function(n,r){var o=new SpeechSynthesisUtterance;o.voice=i,o.volume=e(t,"volume",1,1),o.rate=e(t,"rate",.1,5),o.pitch=e(t,"pitch",0,2),o.text=n,o.onend=r,speechSynthesis.speak(o)}}}catch(t){return function(){this.speak=function(){}}}}(),Primrose.Random["int"]=function(e,t,n){n=n||1,void 0===t&&(t=e,e=0);var i=t-e,r=Math.pow(Math.random(),n);return Math.floor(e+r*i)},Primrose.Random.item=function(e){return e[Primrose.Random["int"](e.length)]},Primrose.Random.number=function(e,t){return Math.random()*(t-e)+e},Primrose.Random.steps=function(e,t,n){return e+Primrose.Random["int"](0,(1+t-e)/n)*n};var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};Primrose.Text.CodePage=function(){function e(e,t,n){function i(e,t,n){t.selectedText=e}this.name=e,this.language=t;var r={NORMAL:{65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z"},SHIFT:{65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z"}};copyObject(r,n);for(var o,s,a,u=0;9>=u;++u)s=Primrose.Keys["NUMPAD"+u],r.NORMAL[s]=u.toString();r.NORMAL[Primrose.Keys.MULTIPLY]="*",r.NORMAL[Primrose.Keys.ADD]="+",r.NORMAL[Primrose.Keys.SUBTRACT]="-",r.NORMAL[Primrose.Keys.DECIMALPOINT]=".",r.NORMAL[Primrose.Keys.DIVIDE]="/",this.keyNames={},this.commandNames=[];for(o in Primrose.Keys)s=Primrose.Keys[o],isNaN(s)||(this.keyNames[s]=o);for(var c in r){var l=r[c];if("object"===("undefined"==typeof l?"undefined":_typeof(l)))for(s in l){if(s.indexOf("_")>-1){var h=s.split(" "),d=h[0];s=h[1],o=r.NORMAL[s],a=d+"_"+c+" "+o}else o=r.NORMAL[s],a=c+"_"+o;this.commandNames.push(a),this.keyNames[s]=o;var f=l[s];"function"!=typeof f&&(f=i.bind(null,f)),this[a]=f}}}return e.DEAD=function(e){return function(t){t.setDeadKeyState("DEAD"+e)}},e}(),Primrose.Text.CommandPack=function(){function e(e,t){this.name=e,copyObject(this,t)}return e}(),Primrose.Text.Cursor=function(){function e(e,t,n){this.i=e||0,this.x=t||0,this.y=n||0,this.moved=!0}var t=function(){function e(i){i=i.replace(t,function(t,n,i){return e(i)+n}).replace(n,"$2$1");for(var r="",o=i.length-1;o>=0;--o)r+=i[o];return r}var t=/(<%= allExceptCombiningMarks %>)(<%= combiningMarks %>+)/g,n=/(<%= highSurrogates %>)(<%= lowSurrogates %>)/g;return e}();return e.min=function(e,t){return e.i<=t.i?e:t},e.max=function(e,t){return e.i>t.i?e:t},e.prototype.clone=function(){return new e(this.i,this.x,this.y)},e.prototype.toString=function(){return"[i:"+this.i+" x:"+this.x+" y:"+this.y+"]"},e.prototype.copy=function(e){this.i=e.i,this.x=e.x,this.y=e.y,this.moved=!1},e.prototype.fullhome=function(){this.i=0,this.x=0,this.y=0,this.moved=!0},e.prototype.fullend=function(e){this.i=0;for(var t=0,n=0;n<e.length;++n){var i=e[n];t=i.length,this.i+=t}this.y=e.length-1,this.x=t,this.moved=!0},e.prototype.skipleft=function(e){if(0===this.x)this.left(e);else{var n=this.x-1,i=e[this.y],r=t(i.substring(0,n)),o=r.match(/(\s|\W)+/),s=o?o.index+o[0].length+1:r.length;this.i-=s,this.x-=s}this.moved=!0},e.prototype.left=function(e){if(this.i>0){if(--this.i,--this.x,this.x<0){--this.y;var t=e[this.y];this.x=t.length}this.reverseFromNewline(e)&&++this.i}this.moved=!0},e.prototype.skipright=function(e){var t=e[this.y];if(this.x===t.length||"\n"===t[this.x])this.right(e);else{var n=this.x+1;t=t.substring(n);var i=t.match(/(\s|\W)+/),r=i?i.index+i[0].length+1:t.length-this.x;this.i+=r,this.x+=r,this.reverseFromNewline(e)}this.moved=!0},e.prototype.fixCursor=function(e){this.x=this.i,this.y=0;for(var t=0,n=e[this.y];this.x>n.length;){if(this.x-=n.length,t+=n.length,this.y>=e.length-1){this.i=t,this.x=n.length,this.moved=!0;break}++this.y,n=e[this.y]}return this.moved},e.prototype.right=function(e){this.advanceN(e,1)},e.prototype.advanceN=function(e,t){var n=e[this.y];(this.y<e.length-1||this.x<n.length)&&(this.i+=t,this.fixCursor(e),n=e[this.y],this.x>0&&"\n"===n[this.x-1]&&(++this.y,this.x=0)),this.moved=!0},e.prototype.home=function(){this.i-=this.x,this.x=0,this.moved=!0},e.prototype.end=function(e){var t=e[this.y],n=t.length-this.x;this.i+=n,this.x+=n,this.reverseFromNewline(e),this.moved=!0},e.prototype.up=function(e){if(this.y>0){--this.y;var t=e[this.y],n=Math.min(0,t.length-this.x);this.x+=n,this.i-=t.length-n,this.reverseFromNewline(e)}this.moved=!0},e.prototype.down=function(e){if(this.y<e.length-1){++this.y;var t=e[this.y],n=e[this.y-1],i=Math.min(0,t.length-this.x);this.x+=i,this.i+=n.length+i,this.reverseFromNewline(e)}this.moved=!0},e.prototype.incY=function(e,t){this.y=Math.max(0,Math.min(t.length-1,this.y+e));var n=t[this.y];this.x=Math.max(0,Math.min(n.length,this.x)),this.i=this.x;for(var i=0;i<this.y;++i)this.i+=t[i].length;this.reverseFromNewline(t),this.moved=!0},e.prototype.setXY=function(e,t,n){this.y=Math.max(0,Math.min(n.length-1,t));var i=n[this.y];this.x=Math.max(0,Math.min(i.length,e)),this.i=this.x;for(var r=0;r<this.y;++r)this.i+=n[r].length;this.reverseFromNewline(n),this.moved=!0},e.prototype.setI=function(e,t){this.i=e,this.fixCursor(t),this.moved=!0},e.prototype.reverseFromNewline=function(e){var t=e[this.y];return this.x>0&&"\n"===t[this.x-1]?(--this.x,--this.i,!0):!1},e}(),Primrose.Text.Grammar=function(){function e(t,n){function i(e){var t,n,i=null,r=null,o=0;for(t=0;t<e.length;++t)n=e[t],
n.line=o,"newlines"===n.type&&++o,r?("stringDelim"!==n.type||n.value!==r||0!==t&&"\\"===e[t-1].value[e[t-1].value.length-1]||(r=null),"newlines"!==n.type&&(n.type="strings")):i?(("startBlockComments"===i&&"endBlockComments"===n.type||"startLineComments"===i&&"newlines"===n.type)&&(i=null),"newlines"!==n.type&&(n.type="comments")):"stringDelim"===n.type?(r=n.value,n.type="strings"):"startBlockComments"!==n.type&&"startLineComments"!==n.type||(i=n.type,n.type="comments");for(t=e.length-1;t>0;--t){var s=e[t-1];n=e[t],s.type===n.type&&"newlines"!==s.type&&(s.value+=n.value,e.splice(t,1))}}this.name=t,this.grammar=n.map(function(e){return new Primrose.Text.Rule(e[0],e[1])}),e.prototype.toHTML=function(e){for(var t=this.tokenize(e),n=document.createElement("div"),i=0;i<t.length;++i){var r=t[i];if("newlines"===r.type)n.appendChild(document.createElement("br"));else{var o=Primrose.Text.Themes.Default[r.type]||{},s=document.createElement("span");s.style.fontWeight=o.fontWeight||Primrose.Text.Themes.Default.regular.fontWeight,s.style.fontStyle=o.fontStyle||Primrose.Text.Themes.Default.regular.fontStyle||"",s.style.color=o.foreColor||Primrose.Text.Themes.Default.regular.foreColor,s.style.backgroundColor=o.backColor||Primrose.Text.Themes.Default.regular.backColor,s.style.fontFamily=o.fontFamily||Primrose.Text.Themes.Default.fontFamily,s.appendChild(document.createTextNode(r.value)),n.appendChild(s)}}return n.innerHTML},this.tokenize=function(e){for(var t=[new Primrose.Text.Token(e,"regular",0)],n=0;n<this.grammar.length;++n)for(var r=this.grammar[n],o=0;o<t.length;++o)r.carveOutMatchedToken(t,o);return i(t),t}}return e}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Primrose.Text.OperatingSystem=function(){var e=function(){function e(t,n,i,r,o,s,a,u,c,l){_classCallCheck(this,e);var h=o;o=o.length>0?o:"NORMAL",this[n+"_a"]="SELECT_ALL",this[n+"_c"]="COPY",this[n+"_x"]="CUT",this[n+"_v"]="PASTE",this[r]="REDO",this[n+"_z"]="UNDO",this[n+"_DOWNARROW"]="WINDOW_SCROLL_DOWN",this[n+"_UPARROW"]="WINDOW_SCROLL_UP",this[i+"_LEFTARROW"]="NORMAL_SKIPLEFT",this[i+"SHIFT_LEFTARROW"]="SHIFT_SKIPLEFT",this[i+"_RIGHTARROW"]="NORMAL_SKIPRIGHT",this[i+"SHIFT_RIGHTARROW"]="SHIFT_SKIPRIGHT",this[o+"_HOME"]="NORMAL_HOME",this[h+"SHIFT_HOME"]="SHIFT_HOME",this[o+"_END"]="NORMAL_END",this[h+"SHIFT_END"]="SHIFT_END",this[u+"_HOME"]="CTRL_HOME",this[u+"SHIFT_HOME"]="CTRLSHIFT_HOME",this[u+"_END"]="CTRL_END",this[u+"SHIFT_END"]="CTRLSHIFT_END",this._deadKeyState=""}return _createClass(e,[{key:"makeCommandName",value:function(e,t){var n=e.keyCode;if(n!==Primrose.Keys.CTRL&&n!==Primrose.Keys.ALT&&n!==Primrose.Keys.META_L&&n!==Primrose.Keys.META_R&&n!==Primrose.Keys.SHIFT){var i=(this._deadKeyState,this._deadKeyState);return e.ctrlKey&&(i+="CTRL"),e.altKey&&(i+="ALT"),e.metaKey&&(i+="META"),e.shiftKey&&(i+="SHIFT"),i===this._deadKeyState&&(i+="NORMAL"),i+="_"+t.keyNames[n],this[i]||i}}}]),e}();return e}(),Primrose.Text.Point=function(){function e(e,t){this.set(e||0,t||0)}return e.prototype.set=function(e,t){this.x=e,this.y=t},e.prototype.copy=function(e){e&&(this.x=e.x,this.y=e.y)},e.prototype.clone=function(){return new e(this.x,this.y)},e.prototype.toString=function(){return"(x:"+this.x+", y:"+this.y+")"},e}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Primrose.Text.Rectangle=function(){var e=function(){function e(t,n,i,r){_classCallCheck(this,e),this.point=new Primrose.Text.Point(t,n),this.size=new Primrose.Text.Size(i,r)}return _createClass(e,[{key:"set",value:function(e,t,n,i){this.point.set(e,t),this.size.set(n,i)}},{key:"copy",value:function(e){e&&(this.point.copy(e.point),this.size.copy(e.size))}},{key:"clone",value:function(){return new e(this.point.x,this.point.y,this.size.width,this.size.height)}},{key:"toString",value:function(){return"["+this.point.toString()+" x "+this.size.toString()+"]"}},{key:"overlap",value:function(t){var n=Math.max(this.left,t.left),i=Math.max(this.top,t.top),r=Math.min(this.right,t.right),o=Math.min(this.bottom,t.bottom);return r>n&&o>i?new e(n,i,r-n,o-i):void 0}},{key:"x",get:function(){return this.point.x},set:function(e){this.point.x=e}},{key:"left",get:function(){return this.point.x},set:function(e){this.point.x=e}},{key:"width",get:function(){return this.size.width},set:function(e){this.size.width=e}},{key:"right",get:function(){return this.point.x+this.size.width},set:function(e){this.point.x=e-this.size.width}},{key:"y",get:function(){return this.point.y},set:function(e){this.point.y=e}},{key:"top",get:function(){return this.point.y},set:function(e){this.point.y=e}},{key:"height",get:function(){return this.size.height},set:function(e){this.size.height=e}},{key:"bottom",get:function(){return this.point.y+this.size.height},set:function(e){this.point.y=e-this.size.height}},{key:"area",get:function(){return this.width*this.height}}]),e}();return e}(),Primrose.Text.Rule=function(){function e(e,t){this.name=e,this.test=t}return e.prototype.carveOutMatchedToken=function(e,t){var n=e[t];if("regular"===n.type){var i=this.test.exec(n.value);if(i){var r=i[i.length-1],o=i.input.indexOf(r),s=o+r.length;if(0===o){if(n.type=this.name,s<n.value.length){var a=n.splitAt(s);a.type="regular",e.splice(t+1,0,a)}}else{var u=n.splitAt(o);if(r.length<u.value.length){var c=u.splitAt(r.length);e.splice(t+1,0,c)}u.type=this.name,e.splice(t+1,0,u)}}}},e}(),Primrose.Text.Size=function(){function e(e,t){this.set(e||0,t||0)}return e.prototype.set=function(e,t){this.width=e,this.height=t},e.prototype.copy=function(e){e&&(this.width=e.width,this.height=e.height)},e.prototype.clone=function(){return new e(this.width,this.height)},e.prototype.toString=function(){return"<w:"+this.width+", h:"+this.height+">"},e}(),Primrose.Text.Terminal=function(e,t){function n(e){e.selectionStart=e.selectionEnd=e.value.length,e.scrollIntoView(e.frontCursor)}function i(){g.running&&(o(),g.running=!1,p&&(e.tokenizer=l,e.value=c),n(e))}function r(){return t.selectionStart=t.selectionEnd=0,t.value="",!0}function o(){if(m.length>0){for(var e=m.split("\n"),t=0;d>t&&e.length>0;++t)f.push(e.shift());e.length>0&&f.push(" ----- more -----"),m=e.join("\n")}}function s(e){u=e,g.waitingForInput=!0,o()}function a(e){m+=e}t=t||e;var u=null,c=null,l=null,h=0,d=40,f=[],m="",p=e===t,g=this;this.running=!1,this.waitingForInput=!1,this.sendInput=function(e){if(m.length>0)o();else{t.keyDown(e);var n=t.value.substring(h);u(n.trim()),u=null,this.waitingForInput=!1}},this.execute=function(n){if(d=n?10:40,l=e.tokenizer,l&&l.interpret){this.running=!0;var o,u=function(){g.running&&setTimeout(o,1)};c=e.value,o=l.interpret(c,s,a,a,u,r,this.loadFile.bind(this),i),t.tokenizer=Primrose.Text.Grammars.PlainText,r(),u()}},this.loadFile=function(t){return Primrose.HTTP.getText(t.toLowerCase()).then(function(t){return isOSX&&(t=t.replace("CTRL+SHIFT+SPACE","CMD+OPT+E")),e.value=c=t,t})},this.update=function(){f.length>0&&(t.value+=f.shift()+"\n",n(t),h=t.selectionStart)}},Primrose.Text.Token=function(){function e(e,t,n,i){this.value=e,this.type=t,this.index=n,this.line=i}return e.prototype.clone=function(){return new e(this.value,this.type,this.index,this.line)},e.prototype.splitAt=function(t){var n=this.value.substring(t);return this.value=this.value.substring(0,t),new e(n,this.type,this.index+t,this.line)},e.prototype.toString=function(){return"["+this.type+": "+this.value+"]"},e}(),Primrose.Input.VR.CardboardVRDisplay=function(){function e(){var t=this;this.capabilities={canPresent:!0,hasExternalDisplay:!1,hasOrientation:isMobile,hasPosition:!1};var n=new Primrose.Input.VR.MotionCorrector,i=null,r=0,o=null;this.displayId="B4CEAE28-1A89-4314-872E-9C223DDABD02",this.displayName="Device Motion API",this.isConnected=!0,this.isPresenting=!1,this.stageParameters=null,this.getEyeParameters=function(t){var n="left"===t?-1:1;return{renderWidth:Math.floor(screen.width*devicePixelRatio/2)*e.SUPERSAMPLE,renderHeight:screen.height*devicePixelRatio*e.SUPERSAMPLE,offset:new Float32Array([.03*n,0,0]),fieldOfView:{upDegrees:40,downDegrees:40,leftDegrees:40,rightDegrees:40}}},n.addEventListener("deviceorientation",function(e){i={timestamp:performance.now(),frameID:++r,orientation:new Float32Array(e.toArray())}}),this.getImmediatePose=function(){return i},this.getPose=function(){return i},this.resetPose=n.zeroAxes.bind(n),this.getLayers=function(){return[o]},this._onFullScreenRemoved=function(){console.log("exiting cardboard presentation"),FullScreen.removeChangeListener(t._onFullScreenRemoved),t.exitPresent(),window.dispatchEvent(new Event("vrdisplaypresentchange"))},this.requestPresent=function(e){return t.capabilities.canPresent?e?e instanceof Array?1!==e.length?Promise.reject(new Error("Only one layer at a time is supported right now.")):e[0].source?FullScreen.request(e[0].source).then(function(n){return o=e[0],t.isPresenting=n===o.source,FullScreen.addChangeListener(t._onFullScreenRemoved,!1),window.dispatchEvent(new Event("vrdisplaypresentchange")),n}):Promise.reject(new Error("No source on layer parameter.")):Promise.reject(new Error("Layers parameters must be an array")):Promise.reject(new Error("No layers provided to requestPresent")):Promrise.reject(new Error("This device cannot be used as a presentation display. DisplayID: "+t.displayId+". Name: "+t.displayName))},this.exitPresent=function(){var e=this,t=function(){console.log("exit presenting"),e.isPresenting=!1,o=null};return FullScreen.exit().then(function(e){return t(),e})["catch"](t)}}return e.SUPERSAMPLE=1,e.prototype.requestAnimationFrame=window.requestAnimationFrame.bind(window),e.prototype.cancelAnimationFrame=window.cancelAnimationFrame.bind(window),e.prototype.submitFrame=function(){},e}(),Primrose.Input.VR.LegacyVRDisplay=function(){function e(e){function t(e){var t={timestamp:e.timestamp,frameID:++s};return e.position&&(t.position=new Float32Array([e.position.x,e.position.y,e.position.z])),e.linearVelocity&&(t.linearVelocity=new Float32Array([e.linearVelocity.x,e.linearVelocity.y,e.linearVelocity.z])),e.linearAcceleration&&(t.linearAcceleration=new Float32Array([e.linearAcceleration.x,e.linearAcceleration.y,e.linearAcceleration.z])),e.orientation&&(t.orientation=new Float32Array([e.orientation.x,e.orientation.y,e.orientation.z,e.orientation.w])),e.angularVelocity&&(t.angularVelocity=new Float32Array([e.angularVelocity.x,e.angularVelocity.y,e.angularVelocity.z])),e.angularAcceleration&&(t.angularAcceleration=new Float32Array([e.angularAcceleration.x,e.angularAcceleration.y,e.angularAcceleration.z])),t}var n=this;this.capabilities={canPresent:!!e.display,hasExternalDisplay:!1,hasOrientation:!!e.sensor,hasPosition:!!e.sensor&&!isMobile},this.displayId=e.display.hardwareUnitId,this.displayName="";for(var i=e.display.deviceName,r=e.sensor.deviceName,o=0;o<i.length&&o<r.length&&i[o]===r[o];++o)this.displayName+=i[o];for(;this.displayName.length>0&&!/\w/.test(this.displayName[this.displayName.length-1]);)this.displayName=this.displayName.substring(0,this.displayName.length-1);this.isConnected=!0,this.isPresenting=!1,this.stageParameters=null,this.getEyeParameters=function(t){var n=null;n=e.display.getEyeParameters?e.display.getEyeParameters(t):{renderRect:e.display.getRecommendedEyeRenderRect(t),eyeTranslation:e.display.getEyeTranslation(t),recommendedFieldOfView:e.display.getRecommendedEyeFieldOfView(t)};var i={renderWidth:n.renderRect.width,renderHeight:n.renderRect.height,offset:new Float32Array([n.eyeTranslation.x,n.eyeTranslation.y,n.eyeTranslation.z]),fieldOfView:n.recommendedFieldOfView};return i};var s=0;this.getImmediatePose=function(){return t(e.sensor.getImmediateState())},this.getPose=function(){return t(e.sensor.getState())},this.resetPose=e.sensor.resetSensor.bind(e.sensor);var a=null;this.getLayers=function(){return[a]},this._onFullScreenRemoved=function(){FullScreen.removeChangeListener(n._onFullScreenRemoved),n.exitPresent(),window.dispatchEvent(new Event("vrdisplaypresentchange"))},this.requestPresent=function(t){return n.capabilities.canPresent?t?t instanceof Array?1!==t.length?Promise.reject(new Error("Only one layer at a time is supported right now.")):t[0].source?FullScreen.request(t[0].source,{vrDisplay:e.display,vrDistortion:!0}).then(function(e){return a=t[0],n.isPresenting=e===a.source,FullScreen.addChangeListener(n._onFullScreenRemoved,!1),window.dispatchEvent(new Event("vrdisplaypresentchange")),e}):Promise.reject(new Error("No source on layer parameter.")):Promise.reject(new Error("Layers parameters must be an array")):Promise.reject(new Error("No layers provided to requestPresent")):Promrise.reject(new Error("This device cannot be used as a presentation display. DisplayID: "+n.displayId+". Name: "+n.displayName))},this.exitPresent=function(){var e=this,t=function(t){return e.isPresenting=!1,a=null,t};return FullScreen.exit().then(t)["catch"](t)}}return e.prototype.requestAnimationFrame=window.requestAnimationFrame.bind(window),e.prototype.cancelAnimationFrame=window.cancelAnimationFrame.bind(window),e.prototype.submitFrame=function(){},e}(),Primrose.Input.VR.MotionCorrector=function(){function e(){function e(i){i.alpha&&(window.removeEventListener("deviceorientation",e),n(i),t(),window.addEventListener("deviceorientation",n,!1),window.addEventListener("orientationchange",t,!1))}function t(){var e=Math.PI*-window.orientation/360;s.set(0,Math.sin(e),0,Math.cos(e))}function n(e){i.set(e.beta*Math.PI/180,e.alpha*Math.PI/180,-e.gamma*Math.PI/180,"YXZ"),r.setFromEuler(i),o.copy(u).multiply(r).multiply(s).multiply(a);for(var t=0;t<l.length;++t)l[t](o)}var i=new THREE.Euler,r=new THREE.Quaternion,o=new THREE.Quaternion,s=new THREE.Quaternion,a=new THREE.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5)),u=new THREE.Quaternion,c=!0,l=[];this.addEventListener=function(t,n,i){if("deviceorientation"!==t)throw new Error('The only event type that is supported is "deviceorientation". Type parameter was: '+t);if("function"!=typeof n)throw new Error("A function must be provided as a callback parameter. Callback parameter was: "+n);c&&(window.addEventListener("deviceorientation",e,!1),c=!1),l.push(n)},this.zeroAxes=function(){u.set(0,i.y,0,1)}}return e.ZERO_EULER={gamma:90,alpha:270,beta:0},e}(),Primrose.Text.CodePages.DE_QWERTZ=function(){var e=Primrose.Text.CodePage;return new e("Deutsch: QWERTZ","de",{deadKeys:[220,221,160,192],NORMAL:{32:" ",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",60:"<",63:"ß",160:e.DEAD(3),163:"#",171:"+",173:"-",186:"ü",187:"+",188:",",189:"-",190:".",191:"#",192:e.DEAD(4),219:"ß",220:e.DEAD(1),221:e.DEAD(2),222:"ä",226:"<"},DEAD1NORMAL:{65:"â",69:"ê",73:"î",79:"ô",85:"û",190:"."},DEAD2NORMAL:{65:"á",69:"é",73:"í",79:"ó",83:"s",85:"ú",89:"ý"},SHIFT:{32:" ",48:"=",49:"!",50:'"',51:"§",52:"$",53:"%",54:"&",55:"/",56:"(",57:")",60:">",63:"?",163:"'",171:"*",173:"_",186:"Ü",187:"*",188:";",189:"_",190:":",191:"'",192:"Ö",219:"?",222:"Ä",226:">"},CTRLALT:{48:"}",50:"²",51:"³",55:"{",56:"[",57:"]",60:"|",63:"\\",69:"€",77:"µ",81:"@",171:"~",187:"~",219:"\\",226:"|"},CTRLALTSHIFT:{63:"ẞ",219:"ẞ"},DEAD3NORMAL:{65:"a",69:"e",73:"i",79:"o",85:"u",190:"."},DEAD4NORMAL:{65:"a",69:"e",73:"i",79:"o",83:"s",85:"u",89:"y"}})}(),Primrose.Text.CodePages.EN_UKX=function(){var e=Primrose.Text.CodePage;return new e("English: UK Extended","en-GB",{CTRLALT:{52:"€",65:"á",69:"é",73:"í",79:"ó",85:"ú",163:"\\",192:"¦",222:"\\",223:"¦"},CTRLALTSHIFT:{65:"Á",69:"É",73:"Í",79:"Ó",85:"Ú",222:"|"},NORMAL:{32:" ",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",61:"=",163:"#",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"'",219:"[",220:"\\",221:"]",222:"#",223:"`"},SHIFT:{32:" ",48:")",49:"!",50:'"',51:"£",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",59:":",61:"+",163:"~",173:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",192:"@",219:"{",220:"|",221:"}",222:"~",223:"¬"}})}(),Primrose.Text.CodePages.EN_US=function(){var e=Primrose.Text.CodePage;return new e("English: USA","en-US",{NORMAL:{32:" ",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",61:"=",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",219:"[",220:"\\",221:"]",222:"'"},SHIFT:{32:" ",48:")",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",59:":",61:"+",173:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",219:"{",220:"|",221:"}",222:'"'}})}(),Primrose.Text.CodePages.FR_AZERTY=function(){var e=Primrose.Text.CodePage;return new e("Français: AZERTY","fr",{deadKeys:[221,50,55],NORMAL:{32:" ",48:"à",49:"&",50:"é",51:'"',52:"'",53:"(",54:"-",55:"è",56:"_",57:"ç",186:"$",187:"=",188:",",190:";",191:":",192:"ù",219:")",220:"*",221:e.DEAD(1),222:"²",223:"!",226:"<"},SHIFT:{32:" ",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",186:"£",187:"+",188:"?",190:".",191:"/",192:"%",219:"°",220:"µ",223:"§",226:">"},CTRLALT:{48:"@",50:e.DEAD(2),51:"#",52:"{",53:"[",54:"|",55:e.DEAD(3),56:"\\",57:"^",69:"€",186:"¤",187:"}",219:"]"},DEAD1NORMAL:{65:"â",69:"ê",73:"î",79:"ô",85:"û"},DEAD2NORMAL:{65:"ã",78:"ñ",79:"õ"},DEAD3NORMAL:{48:"à",50:"é",55:"è",65:"à",69:"è",73:"ì",79:"ò",85:"ù"}})}(),Primrose.Text.CommandPacks.BasicTextInput=function(){var e=function(e){function t(e,n){_classCallCheck(this,t);var i={NORMAL_LEFTARROW:function(e,t){e.cursorLeft(t,e.frontCursor)},NORMAL_SKIPLEFT:function(e,t){e.cursorSkipLeft(t,e.frontCursor)},NORMAL_RIGHTARROW:function(e,t){e.cursorRight(t,e.frontCursor)},NORMAL_SKIPRIGHT:function(e,t){e.cursorSkipRight(t,e.frontCursor)},NORMAL_HOME:function(e,t){e.cursorHome(t,e.frontCursor)},NORMAL_END:function(e,t){e.cursorEnd(t,e.frontCursor)},NORMAL_BACKSPACE:function(e,t){e.frontCursor.i===e.backCursor.i&&e.frontCursor.left(t),e.selectedText="",e.scrollIntoView(e.frontCursor)},NORMAL_ENTER:function(e,t,n){emit.call(e,"change",{target:e})},NORMAL_DELETE:function(e,t){e.frontCursor.i===e.backCursor.i&&e.backCursor.right(t),e.selectedText="",e.scrollIntoView(e.frontCursor)},NORMAL_TAB:function(e,t){e.selectedText=e.tabString},SHIFT_LEFTARROW:function(e,t){e.cursorLeft(t,e.backCursor)},SHIFT_SKIPLEFT:function(e,t){e.cursorSkipLeft(t,e.backCursor)},SHIFT_RIGHTARROW:function(e,t){e.cursorRight(t,e.backCursor)},SHIFT_SKIPRIGHT:function(e,t){e.cursorSkipRight(t,e.backCursor)},SHIFT_HOME:function(e,t){e.cursorHome(t,e.backCursor)},SHIFT_END:function(e,t){e.cursorEnd(t,e.backCursor)},SHIFT_DELETE:function(e,t){e.frontCursor.i===e.backCursor.i&&(e.frontCursor.home(t),e.backCursor.end(t)),e.selectedText="",e.scrollIntoView(e.frontCursor)},CTRL_HOME:function(e,t){e.cursorFullHome(t,e.frontCursor)},CTRL_END:function(e,t){e.cursorFullEnd(t,e.frontCursor)},CTRLSHIFT_HOME:function(e,t){e.cursorFullHome(t,e.backCursor)},CTRLSHIFT_END:function(e,t){e.cursorFullEnd(t,e.backCursor)},SELECT_ALL:function(e,t){e.frontCursor.fullhome(t),e.backCursor.fullend(t)},REDO:function(e,t){e.redo(),e.scrollIntoView(e.frontCursor)},UNDO:function(e,t){e.undo(),e.scrollIntoView(e.frontCursor)}};if(n)for(var r in n)i[r]=n[r];return _possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,e||"Text editor commands",i))}return _inherits(t,e),t}(Primrose.Text.CommandPack);return e}(),Primrose.Text.CommandPacks.TextEditor=function(){return new Primrose.Text.CommandPacks.BasicTextInput("Text Area input commands",{NORMAL_UPARROW:function(e,t){e.cursorUp(t,e.frontCursor)},NORMAL_DOWNARROW:function(e,t){e.cursorDown(t,e.frontCursor)},NORMAL_PAGEUP:function(e,t){e.cursorPageUp(t,e.frontCursor)},NORMAL_PAGEDOWN:function(e,t){e.cursorPageDown(t,e.frontCursor)},NORMAL_ENTER:function(e,t,n){var i="",r=t[e.frontCursor.y];r.length>0&&"whitespace"===r[0].type&&(i=r[0].value),e.selectedText="\n"+i,e.scrollIntoView(e.frontCursor)},SHIFT_UPARROW:function(e,t){e.cursorUp(t,e.backCursor)},SHIFT_DOWNARROW:function(e,t){e.cursorDown(t,e.backCursor)},SHIFT_PAGEUP:function(e,t){e.cursorPageUp(t,e.backCursor)},SHIFT_PAGEDOWN:function(e,t){e.cursorPageDown(t,e.backCursor)},WINDOW_SCROLL_DOWN:function(e,t){e.scroll.y<t.length&&++e.scroll.y},WINDOW_SCROLL_UP:function(e,t){e.scroll.y>0&&--e.scroll.y}})}(),Primrose.Text.CommandPacks.TextInput=function(){return new Primrose.Text.CommandPacks.BasicTextInput("Text Line input commands")}(),Primrose.Text.Controls.PlainText=function(){function e(e,t,n,i,r,o,s,a){e=e.replace(/\r\n/g,"\n");var u=e.split("\n");a=a||"center";var c=1e3*t,l=c*u.length,h=document.createElement("canvas"),d=h.getContext("2d");d.font=c+"px Arial";var f=d.measureText(e).width;h.width=f,h.height=l,d.font=.8*c+"px Arial","transparent"!==i&&(d.fillStyle=i,d.fillRect(0,0,h.width,h.height)),d.fillStyle=n;for(var m=0;m<u.length;++m)d.fillText(u[m],0,m*c);var p=new THREE.Texture(h);p.needsUpdate=!0;var g=new THREE.MeshBasicMaterial({map:p,transparent:"transparent"===i,useScreenCoordinates:!1,color:16777215,shading:THREE.FlatShading}),y=new THREE.PlaneGeometry(t*f/c,t*u.length);y.computeBoundingBox(),y.computeVertexNormals();var v=new THREE.Mesh(y,g);return"left"===a?r-=y.boundingBox.min.x:"right"===a&&(r+=y.boundingBox.min.x),v.position.set(r,o,s),v}return e}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),_get=function i(e,t,n){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,t);if(void 0===r){var o=Object.getPrototypeOf(e);return null===o?void 0:i(o,t,n)}if("value"in r)return r.value;var s=r.get;if(void 0!==s)return s.call(n)};Primrose.Text.Controls.TextBox=function(){var e=isFirefox?3:100,t=0,n=function(n){function i(e){_classCallCheck(this,i);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(i).call(this,patch(e,{id:"Primrose.Text.Controls.TextBox["+t++ +"]"})));n.listeners.change=[],"string"==typeof e?n.options={value:n.options}:n.options=e||{},n.useCaching=!isFirefox||!isMobile;var r=function(e){var t=e.toLowerCase();this["cursor"+e]=function(e,n){n[t](e),this.scrollIntoView(n)}};["Left","Right","SkipLeft","SkipRight","Up","Down","Home","End","FullHome","FullEnd"].map(r.bind(n)),n.tokens=null,n.lines=null,n._commandPack=null,n._tokenRows=null,n._tokenHashes=null,n._tabString=null,n._currentTouchID=null,n._lineCountWidth=null,n._lastFont=null,n._lastText=null,n._lastCharacterWidth=null,n._lastCharacterHeight=null,n._lastGridBounds=null,n._lastPadding=null,n._lastFrontCursor=null,n._lastBackCursor=null,n._lastWidth=-1,n._lastHeight=-1,n._lastScrollX=-1,n._lastScrollY=-1,n._lastFocused=!1,n._lastThemeName=null,n._lastPointer=new Primrose.Text.Point,n._browser=isChrome?"CHROMIUM":isFirefox?"FIREFOX":isIE?"IE":isOpera?"OPERA":isSafari?"SAFARI":"UNKNOWN",n._pointer=new Primrose.Text.Point,n._deadKeyState="",n._history=[],n._historyFrame=-1,n._topLeftGutter=new Primrose.Text.Size,n._bottomRightGutter=new Primrose.Text.Size,n._dragging=!1,n._scrolling=!1,n._wheelScrollSpeed=4;var o=new Primrose.Text.Rectangle(0,0,n.bounds.width,n.bounds.height);return n._fg=new Primrose.Surface({id:n.id+"-fore",bounds:o}),n._fgCanvas=n._fg.canvas,n._fgfx=n._fg.context,n._bg=new Primrose.Surface({id:n.id+"-back",bounds:o}),n._bgCanvas=n._bg.canvas,n._bgfx=n._bg.context,n._trim=new Primrose.Surface({id:n.id+"-trim",bounds:o}),n._trimCanvas=n._trim.canvas,n._tgfx=n._trim.context,n._rowCache={},n._VSCROLL_WIDTH=2,n.tabWidth=n.options.tabWidth,n.showLineNumbers=!n.options.hideLineNumbers,n.showScrollBars=!n.options.hideScrollBars,n.wordWrap=!n.options.disableWordWrap,n.readOnly=!!n.options.readOnly,n.multiline=!n.options.singleLine,n.gridBounds=new Primrose.Text.Rectangle,n.frontCursor=new Primrose.Text.Cursor,n.backCursor=new Primrose.Text.Cursor,n.scroll=new Primrose.Text.Point,n.character=new Primrose.Text.Size,n.theme=n.options.theme,n.fontSize=n.options.fontSize,n.tokenizer=n.options.tokenizer,n.commandPack=n.options.commands||Primrose.Text.CommandPacks.TextEditor,n.value=n.options.value,n.padding=n.options.padding||1,n.addEventListener("focus",n.render.bind(n),!1),n.addEventListener("blur",n.render.bind(n),!1),n}return _inherits(i,n),_createClass(i,[{key:"cursorPageUp",value:function(e,t){t.incY(-this.gridBounds.height,e),this.scrollIntoView(t)}},{key:"cursorPageDown",value:function(e,t){t.incY(this.gridBounds.height,e),this.scrollIntoView(t)}},{key:"setDeadKeyState",value:function(e){this._deadKeyState=e||""}},{key:"pushUndo",value:function(e){this._historyFrame<this._history.length-1&&this._history.splice(this._historyFrame+1),this._history.push(e),this._historyFrame=this._history.length-1,this.refreshTokens(),this.render()}},{key:"redo",value:function(){this._historyFrame<this._history.length-1&&++this._historyFrame,this.refreshTokens(),this.fixCursor(),this.render()}},{key:"undo",value:function(){this._historyFrame>0&&--this._historyFrame,this.refreshTokens(),this.fixCursor(),this.render()}},{key:"scrollIntoView",value:function(e){this.scroll.y+=this.minDelta(e.y,this.scroll.y,this.scroll.y+this.gridBounds.height),this.wordWrap||(this.scroll.x+=this.minDelta(e.x,this.scroll.x,this.scroll.x+this.gridBounds.width)),this.clampScroll()}},{key:"readWheel",value:function(t){this.focused&&((t.shiftKey||isChrome)&&(this.fontSize+=t.deltaX/e),t.shiftKey&&!isChrome||(this.scroll.y+=Math.floor(t.deltaY*this._wheelScrollSpeed/e)),this.clampScroll(),this.render(),t.preventDefault())}},{key:"startPointer",value:function(e,t){_get(Object.getPrototypeOf(i.prototype),"startPointer",this).call(this,e,t)||(this._dragging=!0,this.setCursorXY(this.frontCursor,e,t))}},{key:"movePointer",value:function(e,t){this._dragging&&this.setCursorXY(this.backCursor,e,t)}},{key:"endPointer",value:function(){_get(Object.getPrototypeOf(i.prototype),"endPointer",this).call(this),this._dragging=!1,this._scrolling=!1}},{key:"bindEvents",value:function(e){var t=this;e instanceof HTMLCanvasElement&&(void 0===e.tabindex||null===e.tabindex)&&(e.tabindex=0),BrowserEnvironment.createSurrogate.call(this),e.addEventListener("wheel",this.readWheel.bind(this),!1),e.addEventListener("mousedown",this.mouseButtonDown.bind(this),!1),e.addEventListener("mousemove",this.mouseMove.bind(this),!1),e.addEventListener("mouseup",this.mouseButtonUp.bind(this),!1),e.addEventListener("touchstart",this.touchStart.bind(this),!1),e.addEventListener("touchmove",this.touchMove.bind(this),!1),e.addEventListener("touchend",this.touchEnd.bind(this),!1),e.addEventListener("keydown",this.keyDown.bind(this),!1),e.addEventListener("beforepaste",function(e){return e.returnValue=!1},!1),e.addEventListener("paste",this.readClipboard.bind(this),!1),e.addEventListener("keydown",function(e){var n=isOSX?Primrose.Text.OperatingSystems.OSX:Primrose.Text.OperatingSystems.Windows;t.focused&&n.isClipboardReadingEvent(e)&&(t._surrogate.style.display="block",t._surrogate.focus())},!0)}},{key:"copySelectedText",value:function(e){if(this.focused&&this.frontCursor.i!==this.backCursor.i){var t=e.clipboardData||window.clipboardData;t.setData(window.clipboardData?"Text":"text/plain",this.selectedText),e.returnValue=!1}}},{key:"cutSelectedText",value:function(e){this.focused&&(this.copySelectedText(e),this.readOnly||(this.selectedText=""))}},{key:"execCommand",value:function(e,t,n){if(n&&this.focused&&!this.readOnly){var i=e+"_"+n,r=this.commandPack[i]||this.commandPack[n]||t[i]||t[n];return(r instanceof String||"string"==typeof r)&&(console.log("okay"),r=this.commandPack[r]||this.commandPack[r]||r),void 0===r?!1:(this.frontCursor.moved=!1,this.backCursor.moved=!1,r instanceof Function?r(this,this.lines):(r instanceof String||"string"==typeof r)&&(console.log(r),this.selectedText=r),this.frontCursor.moved&&!this.backCursor.moved&&this.backCursor.copy(this.frontCursor),this.clampScroll(),this.render(),!0)}}},{key:"readClipboard",value:function(e){if(this.focused&&!this.readOnly){e.returnValue=!1;var t=e.clipboardData||window.clipboardData,n=t.getData(window.clipboardData?"Text":"text/plain");n&&(this.selectedText=n)}}},{key:"resize",value:function(){_get(Object.getPrototypeOf(i.prototype),"resize",this).call(this),this._bg.setSize(this.surfaceWidth,this.surfaceHeight),this._fg.setSize(this.surfaceWidth,this.surfaceHeight),this._trim.setSize(this.surfaceWidth,this.surfaceHeight),this.theme&&(this.character.height=this.fontSize,this.context.font=this.character.height+"px "+this.theme.fontFamily,this.character.width=this.context.measureText("MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM").width/100),this.render()}},{key:"pixel2cell",value:function(e){e.x*this.imageWidth/this.surfaceWidth,e.y*this.imageHeight/this.surfaceHeight;e.set(Math.round(e.x/this.character.width)+this.scroll.x-this.gridBounds.x,Math.floor(e.y/this.character.height-.25)+this.scroll.y)}},{key:"clampScroll",value:function(){if(this.scroll.y<0)this.scroll.y=0;else for(;0<this.scroll.y&&this.scroll.y>this.lines.length-this.gridBounds.height;)--this.scroll.y}},{key:"refreshTokens",value:function(){this.tokens=this.tokenizer.tokenize(this.value)}},{key:"fixCursor",value:function(){var e=this.frontCursor.fixCursor(this.lines)||this.backCursor.fixCursor(this.lines);e&&this.render()}},{key:"setCursorXY",value:function(e,t,n){t=Math.round(t),n=Math.round(n),this._pointer.set(t,n),this.pixel2cell(this._pointer,this.scroll,this.gridBounds);var i=this._pointer.x-this.scroll.x,r=this._pointer.y-this.scroll.y,o=r>=this.gridBounds.height,s=0>i,a=this._pointer.x>=this.gridBounds.width;if(this._scrolling||o||s||a){if(this._scrolling||a&&!o){this._scrolling=!0;var u=this.lines.length-this.gridBounds.height;if(r>=0&&u>=0){var c=r*u/this.gridBounds.height;this.scroll.y=Math.floor(c)}}else if(o&&!s){for(var l=0,h=0;h<this.lines.length;++h)l=Math.max(l,this.lines[h].length);var d=l-this.gridBounds.width;if(i>=0&&d>=0){var f=i*d/this.gridBounds.width;this.scroll.x=Math.floor(f)}}}else e.setXY(this._pointer.x,this._pointer.y,this.lines),this.backCursor.copy(e);this._lastPointer.copy(this._pointer),this.render()}},{key:"mouseButtonDown",value:function(e){0===e.button&&(this.startDOMPointer(e),e.preventDefault())}},{key:"mouseMove",value:function(e){this.focused&&this.moveDOMPointer(e)}},{key:"mouseButtonUp",value:function(e){this.focused&&0===e.button&&this.endPointer()}},{key:"touchStart",value:function(e){if(this.focused&&e.touches.length>0&&!this._dragging){var t=e.touches[0];this.startDOMPointer(t),this._currentTouchID=t.identifier}}},{key:"touchMove",value:function(e){for(var t=0;t<e.changedTouches.length&&this._dragging;++t){var n=e.changedTouches[t];if(n.identifier===this._currentTouchID){this.moveDOMPointer(n);break}}}},{key:"touchEnd",value:function(e){for(var t=0;t<e.changedTouches.length&&this._dragging;++t){var n=e.changedTouches[t];n.identifier===this._currentTouchID&&this.endPointer()}}},{key:"setGutter",value:function(){this.showLineNumbers?this._topLeftGutter.width=1:this._topLeftGutter.width=0,this.showScrollBars?this.wordWrap?this._bottomRightGutter.set(this._VSCROLL_WIDTH,0):this._bottomRightGutter.set(this._VSCROLL_WIDTH,1):this._bottomRightGutter.set(0,0)}},{key:"refreshGridBounds",value:function(){this._lineCountWidth=0,this.showLineNumbers&&(this._lineCountWidth=Math.max(1,Math.ceil(Math.log(this._history[this._historyFrame].length)/Math.LN10)));var e=Math.floor(this._topLeftGutter.width+this._lineCountWidth+this.padding/this.character.width),t=Math.floor(this.padding/this.character.height),n=Math.floor((this.imageWidth-2*this.padding)/this.character.width)-e-this._bottomRightGutter.width,i=Math.floor((this.imageHeight-2*this.padding)/this.character.height)-t-this._bottomRightGutter.height;
this.gridBounds.set(e,t,n,i)}},{key:"performLayout",value:function(){this._tokenRows=[[]],this._tokenHashes=[""],this.lines=[""];for(var e=0,t=this.tokens.slice(),n=0;n<t.length;++n){var i=t[n].clone(),r=this.gridBounds.width-e,o=this.wordWrap&&"newlines"!==i.type&&i.value.length>r,s="newlines"===i.type||o;if(o){var a=i.value.length>this.gridBounds.width?r:0;t.splice(n+1,0,i.splitAt(a))}i.value.length>0&&(this._tokenRows[this._tokenRows.length-1].push(i),this._tokenHashes[this._tokenHashes.length-1]+=JSON.stringify(i),this.lines[this.lines.length-1]+=i.value,e+=i.value.length),s&&(this._tokenRows.push([]),this._tokenHashes.push(""),this.lines.push(""),e=0)}}},{key:"minDelta",value:function(e,t,n){var i=e-t,r=e-n+5,o=0;return(0>i||r>=0)&&(o=Math.abs(i)<Math.abs(r)?i:r),o}},{key:"fillRect",value:function(e,t,n,i,r,o){e.fillStyle=t,e.fillRect(n*this.character.width,i*this.character.height,r*this.character.width+1,o*this.character.height+1)}},{key:"strokeRect",value:function(e,t,n,i,r,o){e.strokeStyle=t,e.strokeRect(n*this.character.width,i*this.character.height,r*this.character.width+1,o*this.character.height+1)}},{key:"renderCanvasBackground",value:function(){var e=Primrose.Text.Cursor.min(this.frontCursor,this.backCursor),t=Primrose.Text.Cursor.max(this.frontCursor,this.backCursor),n=new Primrose.Text.Cursor,i=new Primrose.Text.Cursor,r=this.theme.regular.backColor?"fillRect":"clearRect";this.theme.regular.backColor&&(this._bgfx.fillStyle=this.theme.regular.backColor),this._bgfx[r](0,0,this.imageWidth,this.imageHeight),this._bgfx.save(),this._bgfx.translate((this.gridBounds.x-this.scroll.x)*this.character.width+this.padding,-this.scroll.y*this.character.height+this.padding),this.focused&&this.fillRect(this._bgfx,this.theme.regular.currentRowBackColor||Primrose.Text.Themes.Default.regular.currentRowBackColor,0,e.y,this.gridBounds.width,t.y-e.y+1);for(var o=0;o<this._tokenRows.length;++o){for(var s=this._tokenRows[o],a=0;a<s.length;++a){var u=s[a];if(i.x+=u.value.length,i.i+=u.value.length,this.scroll.y<=o&&o<this.scroll.y+this.gridBounds.height&&this.scroll.x<=i.x&&n.x<this.scroll.x+this.gridBounds.width){var c=e.i<=i.i&&n.i<t.i;if(c){var l=Primrose.Text.Cursor.max(e,n),h=Primrose.Text.Cursor.min(t,i),d=h.i-l.i;this.fillRect(this._bgfx,this.theme.regular.selectedBackColor||Primrose.Text.Themes.Default.regular.selectedBackColor,l.x,l.y,d,1)}}n.copy(i)}n.x=0,++n.y,i.copy(n)}if(this.focused){var f=this.theme.cursorColor||"black",m=1/this.character.width;this.fillRect(this._bgfx,f,e.x,e.y,m,1),this.fillRect(this._bgfx,f,t.x,t.y,m,1)}this._bgfx.restore()}},{key:"renderCanvasForeground",value:function(){var e=new Primrose.Text.Cursor,t=new Primrose.Text.Cursor,n=Math.ceil(.2*this.character.height);this._fgfx.clearRect(0,0,this.imageWidth,this.imageHeight),this._fgfx.save(),this._fgfx.translate((this.gridBounds.x-this.scroll.x)*this.character.width+this.padding,this.padding);for(var i=0;i<this._tokenRows.length;++i){for(var r=this.lines[i]+this.padding,o=this._tokenRows[i],s=!1,a=(i-.2-this.scroll.y)*this.character.height,u=a+n,c=0;c<o.length;++c){var l=o[c];if(t.x+=l.value.length,t.i+=l.value.length,this.scroll.y<=i&&i<this.scroll.y+this.gridBounds.height&&this.scroll.x<=t.x&&e.x<this.scroll.x+this.gridBounds.width)if(this.useCaching&&void 0!==this._rowCache[r])0===c&&this._fgfx.putImageData(this._rowCache[r],this.padding,u+this.padding);else{var h=this.theme[l.type]||{},d=(h.fontWeight||this.theme.regular.fontWeight||"")+" "+(h.fontStyle||this.theme.regular.fontStyle||"")+" "+this.character.height+"px "+this.theme.fontFamily;this._fgfx.font=d.trim(),this._fgfx.fillStyle=h.foreColor||this.theme.regular.foreColor,this.drawText(this._fgfx,l.value,e.x*this.character.width,a),s=!0}e.copy(t)}e.x=0,++e.y,t.copy(e),this.useCaching&&s&&void 0===this._rowCache[r]&&(this._rowCache[r]=this._fgfx.getImageData(this.padding,u+this.padding,this.imageWidth-2*this.padding,this.character.height))}this._fgfx.restore()}},{key:"drawText",value:function(e,t,n,i){e.fillText(t,n,i)}},{key:"renderCanvasTrim",value:function(){var e=new Primrose.Text.Cursor,t=new Primrose.Text.Cursor,n=0;this._tgfx.clearRect(0,0,this.imageWidth,this.imageHeight),this._tgfx.save(),this._tgfx.translate(this.padding,this.padding),this._tgfx.save(),this._tgfx.lineWidth=2,this._tgfx.translate(0,-this.scroll.y*this.character.height);for(var i=0,r=-1;i<this._tokenRows.length;++i){for(var o=this._tokenRows[i],s=0;s<o.length;++s){var a=o[s];t.x+=a.value.length,t.i+=a.value.length,e.copy(t)}if(n=Math.max(n,t.x),e.x=0,++e.y,t.copy(e),this.showLineNumbers&&this.scroll.y<=i&&i<this.scroll.y+this.gridBounds.height){for(var u=o.length>0?o[0].line:r+1,c=u.toString();c.length<this._lineCountWidth;)c=" "+c;this.fillRect(this._tgfx,this.theme.regular.selectedBackColor||Primrose.Text.Themes.Default.regular.selectedBackColor,0,i,this.gridBounds.x,1),this._tgfx.font="bold "+this.character.height+"px "+this.theme.fontFamily,u>r&&(this._tgfx.fillStyle=this.theme.regular.foreColor,this._tgfx.fillText(c,0,(i-.2)*this.character.height)),r=u}}if(this._tgfx.restore(),this.showLineNumbers&&this.strokeRect(this._tgfx,this.theme.regular.foreColor||Primrose.Text.Themes.Default.regular.foreColor,0,0,this.gridBounds.x,this.gridBounds.height),this.showScrollBars){var l=this.gridBounds.width*this.character.width-this.padding,h=this.gridBounds.height*this.character.height,d=this.scroll.x*l/n+this.gridBounds.x*this.character.width,f=this.scroll.y*h/this._tokenRows.length;this._tgfx.fillStyle=this.theme.regular.selectedBackColor||Primrose.Text.Themes.Default.regular.selectedBackColor;var m;if(!this.wordWrap&&n>this.gridBounds.width){var p=l*(this.gridBounds.width/n),g=this.gridBounds.height*this.character.height;m=Math.max(this.character.width,p),this._tgfx.fillRect(d,g,m,this.character.height),this._tgfx.strokeRect(d,g,m,this.character.height)}if(this._tokenRows.length>this.gridBounds.height){var y=h*(this.gridBounds.height/this._tokenRows.length),v=this.image-this._VSCROLL_WIDTH*this.character.width-2*this.padding,b=Math.max(this.character.height,y);m=this._VSCROLL_WIDTH*this.character.width,this._tgfx.fillRect(v,f,m,b),this._tgfx.strokeRect(v,f,m,b)}}this._tgfx.lineWidth=2,this._tgfx.restore(),this._tgfx.strokeRect(1,1,this.imageWidth-2,this.imageHeight-2),this.focused||(this._tgfx.fillStyle=this.theme.regular.unfocused||Primrose.Text.Themes.Default.regular.unfocused,this._tgfx.fillRect(0,0,this.imageWidth,this.imageHeight))}},{key:"render",value:function(){if(this.tokens&&this.theme){this.refreshGridBounds();var e=this.gridBounds.toString()!==this._lastGridBounds,t=this._lastText!==this.value,n=this.character.width!==this._lastCharacterWidth,i=this.character.height!==this._lastCharacterHeight,r=this.padding!==this._lastPadding,o=!this._lastFrontCursor||!this._lastBackCursor||this.frontCursor.i!==this._lastFrontCursor.i||this._lastBackCursor.i!==this.backCursor.i,s=this.scroll.x!==this._lastScrollX||this.scroll.y!==this._lastScrollY,a=(this.context.font!==this._lastFont,this.theme.name!==this._lastThemeName),u=this.focused!==this._lastFocused,c=null,l=this.resized||e||t||n||i||r,h=l||o||s||a,d=h||t,f=h||u,m=d||h||f;if(l&&(this.performLayout(this.gridBounds),this._rowCache={}),m){if(o&&!(l||s||a||u)){var p=Math.min(this.frontCursor.y,this._lastFrontCursor.y,this.backCursor.y,this._lastBackCursor.y)-this.scroll.y+this.gridBounds.y,g=Math.max(this.frontCursor.y,this._lastFrontCursor.y,this.backCursor.y,this._lastBackCursor.y)-this.scroll.y+1;c=new Primrose.Text.Rectangle(0,p*this.character.height,this.bounds.width,(g-p)*this.character.height+2)}h&&this.renderCanvasBackground(),d&&this.renderCanvasForeground(),f&&this.renderCanvasTrim(),this.context.clearRect(0,0,this.imageWidth,this.imageHeight),this.context.drawImage(this._bgCanvas,0,0),this.context.drawImage(this._fgCanvas,0,0),this.context.drawImage(this._trimCanvas,0,0),this.invalidate(c)}this._lastGridBounds=this.gridBounds.toString(),this._lastText=this.value,this._lastCharacterWidth=this.character.width,this._lastCharacterHeight=this.character.height,this._lastWidth=this.imageWidth,this._lastHeight=this.imageHeight,this._lastPadding=this.padding,this._lastFrontCursor=this.frontCursor.clone(),this._lastBackCursor=this.backCursor.clone(),this._lastFocused=this.focused,this._lastFont=this.context.font,this._lastThemeName=this.theme.name,this._lastScrollX=this.scroll.x,this._lastScrollY=this.scroll.y}}},{key:"value",get:function(){return this._history[this._historyFrame].join("\n")},set:function(e){e=e||"",e=e.replace(/\r\n/g,"\n"),this.multiline||(e=e.replace(/\n/g,""));var t=e.split("\n");this.pushUndo(t),this.render(),emit.call(this,"change",{target:this})}},{key:"selectedText",get:function(){var e=Primrose.Text.Cursor.min(this.frontCursor,this.backCursor),t=Primrose.Text.Cursor.max(this.frontCursor,this.backCursor);return this.value.substring(e.i,t.i)},set:function(e){if(e=e||"",e=e.replace(/\r\n/g,"\n"),this.frontCursor.i!==this.backCursor.i||e.length>0){var t=Primrose.Text.Cursor.min(this.frontCursor,this.backCursor),n=Primrose.Text.Cursor.max(this.frontCursor,this.backCursor),i=this.value,r=i.substring(0,t.i),o=i.substring(n.i),s=r+e+o;this.value=s,this.refreshGridBounds(),this.performLayout(),t.advanceN(this.lines,Math.max(0,e.length)),this.scrollIntoView(n),this.clampScroll(),n.copy(t),this.render()}}},{key:"padding",get:function(){return this._padding},set:function(e){this._padding=e,this.render()}},{key:"wordWrap",get:function(){return this._wordWrap},set:function(e){this._wordWrap=e||!1,this.setGutter()}},{key:"showLineNumbers",get:function(){return this._showLineNumbers},set:function(e){this._showLineNumbers=e,this.setGutter()}},{key:"showScrollBars",get:function(){return this._showScrollBars},set:function(e){this._showScrollBars=e,this.setGutter()}},{key:"theme",get:function(){return this._theme},set:function(e){this._theme=clone(e||Primrose.Text.Themes.Default),this._theme.fontSize=this.fontSize,this._rowCache={},this.render()}},{key:"commandPack",get:function(){return this._commandPack},set:function(e){this._commandPack=e}},{key:"selectionStart",get:function(){return this.frontCursor.i},set:function(e){this.frontCursor.setI(e,this.lines)}},{key:"selectionEnd",get:function(){return this.backCursor.i},set:function(e){this.backCursor.setI(e,this.lines)}},{key:"selectionDirection",get:function(){return this.frontCursor.i<=this.backCursor.i?"forward":"backward"}},{key:"tokenizer",get:function(){return this._tokenizer},set:function(e){this._tokenizer=e||Primrose.Text.Grammars.JavaScript,this._history&&this._history.length>0&&(this.refreshTokens(),this.render())}},{key:"tabWidth",get:function(){return this._tabWidth},set:function(e){this._tabWidth=e||4,this._tabString="";for(var t=0;t<this._tabWidth;++t)this._tabString+=" "}},{key:"tabString",get:function(){return this._tabString}},{key:"fontSize",get:function(){return this._fontSize||16},set:function(e){e=e||16,this._fontSize=e,this.theme&&(this.theme.fontSize=this._fontSize,this.resize(),this.render())}},{key:"lockMovement",get:function(){return this.focused&&!this.readOnly}}]),i}(Primrose.Surface);return n}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),_set=function r(e,t,n,i){var o=Object.getOwnPropertyDescriptor(e,t);if(void 0===o){var s=Object.getPrototypeOf(e);null!==s&&r(s,t,n,i)}else if("value"in o&&o.writable)o.value=n;else{var a=o.set;void 0!==a&&a.call(i,n)}return n},_get=function o(e,t,n){null===e&&(e=Function.prototype);var i=Object.getOwnPropertyDescriptor(e,t);if(void 0===i){var r=Object.getPrototypeOf(e);return null===r?void 0:o(r,t,n)}if("value"in i)return i.value;var s=i.get;if(void 0!==s)return s.call(n)};Primrose.Text.Controls.TextInput=function(){var e=0,t=function(t){function n(t){_classCallCheck(this,n);var i=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,overwrite(patch(t,{id:"Primrose.Text.Controls.TextInput["+e++ +"]",padding:5}),{singleLine:!0,disableWordWrap:!0,hideLineNumbers:!0,hideScrollBars:!0,tabWidth:1,tokenizer:Primrose.Text.Grammars.PlainText,commands:Primrose.Text.CommandPacks.TextInput})));return i.passwordCharacter=i.options.passwordCharacter,i}return _inherits(n,t),_createClass(n,[{key:"drawText",value:function(e,t,i,r){if(this.passwordCharacter){for(var o="",s=0;s<t.length;++s)o+=this.passwordCharacter;t=o}_get(Object.getPrototypeOf(n.prototype),"drawText",this).call(this,e,t,i,r)}},{key:"value",get:function(){return _get(Object.getPrototypeOf(n.prototype),"value",this)},set:function(e){e=e||"",e=e.replace(/\r?\n/g,""),_set(Object.getPrototypeOf(n.prototype),"value",e,this)}},{key:"selectedText",get:function(){return _get(Object.getPrototypeOf(n.prototype),"selectedText",this)},set:function(e){e=e||"",e=e.replace(/\r?\n/g,""),_set(Object.getPrototypeOf(n.prototype),"selectedText",e,this)}}]),n}(Primrose.Text.Controls.TextBox);return t}(),Primrose.Text.Grammars.Basic=function(){var basicGrammar=new Primrose.Text.Grammar("BASIC",[["newlines",/(?:\r\n|\r|\n)/],["lineNumbers",/^\d+\s+/],["startLineComments",/^REM\s/],["strings",/"(?:\\"|[^"])*"/],["strings",/'(?:\\'|[^'])*'/],["numbers",/-?(?:(?:\b\d*)?\.)?\b\d+\b/],["keywords",/\b(?:RESTORE|REPEAT|RETURN|LOAD|LABEL|DATA|READ|THEN|ELSE|FOR|DIM|LET|IF|TO|STEP|NEXT|WHILE|WEND|UNTIL|GOTO|GOSUB|ON|TAB|AT|END|STOP|PRINT|INPUT|RND|INT|CLS|CLK|LEN)\b/],["keywords",/^DEF FN/],["operators",/(?:\+|;|,|-|\*\*|\*|\/|>=|<=|=|<>|<|>|OR|AND|NOT|MOD|\(|\)|\[|\])/],["identifiers",/\w+\$?/]]),oldTokenize=basicGrammar.tokenize;return basicGrammar.tokenize=function(e){return oldTokenize.call(this,e.toUpperCase())},basicGrammar.interpret=function(sourceCode,input,output,errorOut,next,clearScreen,loadFile,done){function toNum(e){return new Primrose.Text.Token(e.toString(),"numbers")}function toStr(e){return new Primrose.Text.Token('"'+e.replace("\n","\\n").replace('"','\\"')+'"',"strings")}function process(e){if(e&&e.length>0){var t=e.shift();if(t){if(commands.hasOwnProperty(t.value))return commands[t.value](e);if(!isNaN(t.value))return setProgramCounter([t]);if(state[t.value]||e.length>0&&"operators"===e[0].type&&"="===e[0].value)return e.unshift(t),translate(e);error("Unknown command. >>> "+t.value)}}return pauseBeforeComplete()}function error(e){errorOut("At line "+lineNumbers[counter]+": "+e)}function getLine(e){var t=lineNumbers[e],n=program[t];return n&&n.slice()}function evaluate(line){for(var script="",i=0;i<line.length;++i){var t=line[i],nest=0;if("identifiers"===t.type&&"function"!=typeof state[t.value]&&i<line.length-1&&"("===line[i+1].value)for(var j=i+1;j<line.length;++j){var t2=line[j];if("("===t2.value?(0===nest&&(t2.value="["),++nest):")"===t2.value?(--nest,0===nest&&(t2.value="]")):","===t2.value&&1===nest&&(t2.value="]["),0===nest)break}script+=t.value}try{return eval(script)}catch(exp){console.debug(line.join(", ")),console.error(exp),console.error(script),error(exp.message+": "+script)}}function declareVariable(e){var t,n=[],i=[n],r=0;for(t=0;t<e.length;++t){var o=e[t];"("===o.value?++r:")"===o.value&&--r,0===r&&","===o.value?(n=[],i.push(n)):n.push(o)}for(t=0;t<i.length;++t){n=i[t];var s=n.shift();if("identifiers"===s.type){var a,u=null;if(s=s.value,"("===n[0].value&&")"===n[n.length-1].value){var c=[];for(a=1;a<n.length-1;++a)"numbers"===n[a].type&&c.push(0|n[a].value);if(0===c.length)u=[];else{u=new Array(c[0]);var l=[u];for(a=1;a<c.length;++a)for(var h=c[a],d=0,f=l.length;f>d;++d)for(var m=l.shift(),p=0;p<m.length;++p)m[p]=new Array(h),a<c.length-1&&l.push(m[p])}}return state[s]=u,!0}error("Identifier expected: "+s.value)}}function print(e){var t="\n",n=0;e=e.map(function(i,r){return i=i.clone(),"operators"===i.type&&(","===i.value?0===n&&(i.value='+ ", " + '):";"===i.value?(i.value='+ " "',r<e.length-1?i.value+=" + ":t=""):"("===i.value?++n:")"===i.value&&--n),i});var i=evaluate(e);return void 0===i&&(i=""),output(i+t),!0}function setProgramCounter(e){var t=parseFloat(evaluate(e));for(counter=-1;counter<lineNumbers.length-1&&lineNumbers[counter+1]<t;)++counter;return!0}function checkConditional(e){var t,n=-1,i=-1;for(t=0;t<e.length;++t)"keywords"===e[t].type&&"THEN"===e[t].value?n=t:"keywords"===e[t].type&&"ELSE"===e[t].value&&(i=t);if(-1===n)error("Expected THEN clause.");else{var r=e.slice(0,n);for(t=0;t<r.length;++t){var o=r[t];"operators"===o.type&&"="===o.value&&(o.value="==")}var s,a;if(-1===i?s=e.slice(n+1):(s=e.slice(n+1,i),a=e.slice(i+1)),evaluate(r))return process(s);if(a)return process(a)}return!0}function pauseBeforeComplete(){return output("PROGRAM COMPLETE - PRESS RETURN TO FINISH."),input(function(){isDone=!0,done&&done()}),!1}function labelLine(e){return e.push(EQUAL_SIGN),e.push(toNum(lineNumbers[counter])),translate(e)}function waitForInput(e){var t=e.pop();return e.length>0&&print(e),input(function(e){e=e.toUpperCase();var n=null;n=isNaN(e)?toStr(e):toNum(e),evaluate([t,EQUAL_SIGN,n]),next&&next()}),!1}function onStatement(e){var t=[],n=null,i=[];try{for(;e.length>0&&("keywords"!==e[0].type||"GOTO"!==e[0].value);)t.push(e.shift());if(e.length>0){e.shift();for(var r=0;r<e.length;++r){var o=e[r];"operators"===o.type&&","===o.value||i.push(o)}if(n=evaluate(t)-1,n>=0&&n<i.length)return setProgramCounter([i[n]])}}catch(s){console.error(s)}return!0}function gotoSubroutine(e){return returnStack.push(toNum(lineNumbers[counter+1])),setProgramCounter(e)}function setRepeat(){return returnStack.push(toNum(lineNumbers[counter])),!0}function conditionalReturn(e){var t=!0,n=returnStack.pop();return n&&e&&(t=setProgramCounter([n])),t}function untilLoop(e){var t=!evaluate(e);return conditionalReturn(t)}function findNext(e){for(i=counter+1;i<lineNumbers.length;++i){var t=getLine(i);if(t[0].value===e)return i}return lineNumbers.length}function whileLoop(e){var t=evaluate(e);return t?returnStack.push(toNum(lineNumbers[counter])):counter=findNext("WEND"),!0}function forLoop(e){var t=lineNumbers[counter],n=[],i=[],r=[],o=[],s=[n,i,r,o],a=0,u=0;for(u=0;u<e.length;++u){var c=e[u];c.value===FOR_LOOP_DELIMS[a]?(0===a&&n.push(c),++a):s[a].push(c)}var l=1;o.length>0&&(l=evaluate(o)),void 0===forLoopCounters[t]&&(forLoopCounters[t]=evaluate(i));var h=evaluate(r),d=forLoopCounters[t]<=h;return d?(n.push(toNum(forLoopCounters[t])),process(n),forLoopCounters[t]+=l,returnStack.push(toNum(lineNumbers[counter]))):(delete forLoopCounters[t],counter=findNext("NEXT")),!0}function stackReturn(){return conditionalReturn(!0)}function loadCodeFile(e){return loadFile(evaluate(e)).then(next),!1}function noop(){return!0}function loadData(e){for(;e.length>0;){var t=e.shift();"operators"!==t.type&&data.push(t.value)}return!0}function readData(e){if(0===data.length){var t=findNext("DATA");process(getLine(t))}var n=data[dataCounter];return++dataCounter,e.push(EQUAL_SIGN),e.push(toNum(n)),translate(e)}function restoreData(){return dataCounter=0,!0}function defineFunction(line){for(var name=line.shift().value,signature="",body="",fillSig=!0,i=0;i<line.length;++i){var t=line[i];"operators"===t.type&&"="===t.value?fillSig=!1:fillSig?signature+=t.value:body+=t.value}name="FN"+name;var script="(function "+name+signature+"{ return "+body+"; })";return state[name]=eval(script),!0}function translate(e){return evaluate(e),!0}for(var tokens=this.tokenize(sourceCode),EQUAL_SIGN=new Primrose.Text.Token("=","operators"),counter=0,isDone=!1,program={},lineNumbers=[],currentLine=[],lines=[currentLine],data=[],returnStack=[],forLoopCounters={},dataCounter=0,state={INT:function(e){return 0|e},RND:function(){return Math.random()},CLK:function(){return Date.now()/36e5},LEN:function(e){return e.length},LINE:function(){return lineNumbers[counter]},TAB:function(e){for(var t="",n=0;e>n;++n)t+=" ";return t},POW:function(e,t){return Math.pow(e,t)}},tokenMap={OR:"||",AND:"&&",NOT:"!",MOD:"%","<>":"!="};tokens.length>0;){var token=tokens.shift();"newlines"===token.type?(currentLine=[],lines.push(currentLine)):"regular"!==token.type&&"comments"!==token.type&&(token.value=tokenMap[token.value]||token.value,currentLine.push(token))}for(var i=0;i<lines.length;++i){var line=lines[i];if(line.length>0){var lastLine=lineNumbers[lineNumbers.length-1],lineNumber=line.shift();if("lineNumbers"!==lineNumber.type&&(line.unshift(lineNumber),void 0===lastLine&&(lastLine=-1),lineNumber=toNum(lastLine+1)),lineNumber=parseFloat(lineNumber.value),lastLine&&lastLine>=lineNumber)throw new Error("expected line number greater than "+lastLine+", but received "+lineNumber+".");line.length>0&&(lineNumbers.push(lineNumber),program[lineNumber]=line)}}var FOR_LOOP_DELIMS=["=","TO","STEP"],commands={DIM:declareVariable,LET:translate,PRINT:print,GOTO:setProgramCounter,IF:checkConditional,INPUT:waitForInput,END:pauseBeforeComplete,STOP:pauseBeforeComplete,REM:noop,"'":noop,CLS:clearScreen,ON:onStatement,GOSUB:gotoSubroutine,RETURN:stackReturn,LOAD:loadCodeFile,DATA:loadData,READ:readData,RESTORE:restoreData,REPEAT:setRepeat,UNTIL:untilLoop,"DEF FN":defineFunction,WHILE:whileLoop,WEND:stackReturn,FOR:forLoop,NEXT:stackReturn,LABEL:labelLine};return function(){if(!isDone)for(var e=!0;e;){var t=getLine(counter);e=process(t),++counter}}},basicGrammar}(),Primrose.Text.Grammars.JavaScript=function(){return new Primrose.Text.Grammar("JavaScript",[["newlines",/(?:\r\n|\r|\n)/],["startBlockComments",/\/\*/],["endBlockComments",/\*\//],["regexes",/(?:^|,|;|\(|\[|\{)(?:\s*)(\/(?:\\\/|[^\n\/])+\/)/],["stringDelim",/("|')/],["startLineComments",/\/\/.*$/m],["numbers",/-?(?:(?:\b\d*)?\.)?\b\d+\b/],["keywords",/\b(?:break|case|catch|const|continue|debugger|default|delete|do|else|export|finally|for|function|if|import|in|instanceof|let|new|return|super|switch|this|throw|try|typeof|var|void|while|with)\b/],["functions",/(\w+)(?:\s*\()/],["members",/(\w+)\./],["members",/((\w+\.)+)(\w+)/]])}(),Primrose.Text.Grammars.PlainText=function(){return new Primrose.Text.Grammar("PlainText",[["newlines",/(?:\r\n|\r|\n)/]])}(),Primrose.Text.Grammars.TestResults=function(){return new Primrose.Text.Grammar("TestResults",[["newlines",/(?:\r\n|\r|\n)/,!0],["numbers",/(\[)(o+)/,!0],["numbers",/(\d+ succeeded), 0 failed/,!0],["numbers",/^    Successes:/,!0],["functions",/(x+)\]/,!0],["functions",/[1-9]\d* failed/,!0],["functions",/^    Failures:/,!0],["comments",/(\d+ms:)(.*)/,!0],["keywords",/(Test results for )(\w+):/,!0],["strings",/        \w+/,!0]])}(),Primrose.Text.OperatingSystems.OSX=function(){return new Primrose.Text.OperatingSystem("OS X","META","ALT","METASHIFT_z","META","LEFTARROW","RIGHTARROW","META","UPARROW","DOWNARROW")}(),Primrose.Text.OperatingSystems.Windows=function(){return new Primrose.Text.OperatingSystem("Windows","CTRL","CTRL","CTRL_y","","HOME","END","CTRL","HOME","END")}(),Primrose.Text.Themes.Dark=function(){return{name:"Dark",fontFamily:"'Droid Sans Mono', 'Consolas', 'Lucida Console', 'Courier New', 'Courier', monospace",cursorColor:"white",fontSize:16,lineNumbers:{foreColor:"white"},regular:{backColor:"black",foreColor:"#c0c0c0",currentRowBackColor:"#202020",selectedBackColor:"#404040",unfocused:"rgba(0, 0, 255, 0.25)"},strings:{foreColor:"#aa9900",fontStyle:"italic"},regexes:{foreColor:"#aa0099",fontStyle:"italic"},numbers:{foreColor:"green"},comments:{foreColor:"yellow",fontStyle:"italic"},keywords:{foreColor:"cyan"},functions:{foreColor:"brown",fontWeight:"bold"},members:{foreColor:"green"},error:{foreColor:"red",fontStyle:"underline italic"}}}(),Primrose.Text.Themes.Default=function(){return{name:"Light",fontFamily:"'Droid Sans Mono', 'Consolas', 'Lucida Console', 'Courier New', 'Courier', monospace",cursorColor:"black",fontSize:16,lineNumbers:{foreColor:"black"},regular:{backColor:"white",foreColor:"black",currentRowBackColor:"#f0f0f0",selectedBackColor:"#c0c0c0",unfocused:"rgba(0, 0, 255, 0.25)"},strings:{foreColor:"#aa9900",fontStyle:"italic"},regexes:{foreColor:"#aa0099",fontStyle:"italic"},numbers:{foreColor:"green"},comments:{foreColor:"grey",fontStyle:"italic"},keywords:{foreColor:"blue"},functions:{foreColor:"brown",fontWeight:"bold"},members:{foreColor:"green"},error:{foreColor:"red",fontStyle:"underline italic"}}}();